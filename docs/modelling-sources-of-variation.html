<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

<meta charset="utf-8" />
<meta name="generator" content="pandoc" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<meta property="og:title" content="Chapter 6 Modelling sources of variation | Statistical analysis for proteomics data" />
<meta property="og:type" content="book" />




<meta name="author" content="Christophe Vanderaa, Stijn Vandenbulcke, Lieven Clement" />

<meta name="date" content="2025-09-03" />

<script type="text/x-mathjax-config">
MathJax.Hub.Config({
  TeX: { equationNumbers: { autoNumber: "AMS" } }
});
</script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<meta name="description" content="Chapter 6 Modelling sources of variation | Statistical analysis for proteomics data">

<title>Chapter 6 Modelling sources of variation | Statistical analysis for proteomics data</title>

<link href="libs/tufte-css-2015.12.29/tufte.css" rel="stylesheet" />
<link href="libs/tufte-css-2015.12.29/envisioned.css" rel="stylesheet" />
<link href="libs/msmb-css-0/msmb.css" rel="stylesheet" />
<script>
function toggle_visibility(id1, id2) {
var e = document.getElementById(id1);
var f = document.getElementById(id2);

e.style.display = ((e.style.display!='none') ? 'none' : 'block');

if(f.classList.contains('fa-plus-square')) {
    f.classList.add('fa-minus-square')
    f.classList.remove('fa-plus-square')
} else {
    f.classList.add('fa-plus-square')
    f.classList.remove('fa-minus-square')
}

}
</script>
<script>
function copy_link(id) {
  var dummy = document.createElement('input'),
  text = window.location.href.split(/[?#]/)[0] + '#' + id;
  document.body.appendChild(dummy);
  dummy.value = text;
  dummy.select();
  document.execCommand('copy');
  document.body.removeChild(dummy);
  
  var tooltip = document.getElementById(id + '-tooltip');
  tooltip.innerHTML = 'Copied!';
}

function reset_tooltip(id) {
  var tooltip = document.getElementById(id);
  tooltip.innerHTML = 'Copy link';
}
</script>


<style type="text/css">code{white-space: pre;}</style>
<style type="text/css">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }

code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {  background-color: #f8f8f8; }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ef2929; } /* Alert */
code span.an { color: #8f5902; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #204a87; } /* Attribute */
code span.bn { color: #0000cf; } /* BaseN */
code span.cf { color: #204a87; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4e9a06; } /* Char */
code span.cn { color: #8f5902; } /* Constant */
code span.co { color: #8f5902; font-style: italic; } /* Comment */
code span.cv { color: #8f5902; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #8f5902; font-weight: bold; font-style: italic; } /* Documentation */
code span.dt { color: #204a87; } /* DataType */
code span.dv { color: #0000cf; } /* DecVal */
code span.er { color: #a40000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #0000cf; } /* Float */
code span.fu { color: #204a87; font-weight: bold; } /* Function */
code span.im { } /* Import */
code span.in { color: #8f5902; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #204a87; font-weight: bold; } /* Keyword */
code span.op { color: #ce5c00; font-weight: bold; } /* Operator */
code span.ot { color: #8f5902; } /* Other */
code span.pp { color: #8f5902; font-style: italic; } /* Preprocessor */
code span.sc { color: #ce5c00; font-weight: bold; } /* SpecialChar */
code span.ss { color: #4e9a06; } /* SpecialString */
code span.st { color: #4e9a06; } /* String */
code span.va { color: #000000; } /* Variable */
code span.vs { color: #4e9a06; } /* VerbatimString */
code span.wa { color: #8f5902; font-weight: bold; font-style: italic; } /* Warning */
</style>


<style type="text/css">
/* Used with Pandoc 2.11+ new --citeproc when CSL is used */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
  margin-bottom: 0em;
}
.hanging div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}
</style>

<link rel="stylesheet" href="style.css" type="text/css" />

</head>

<body>



<div class="row">
<div class="col-sm-12">
<div id="TOC">
<ul class="navbar">
<li class="msmb"><p class="title">Statistical analysis for proteomics data<p><p class="author">Christophe Vanderaa, Stijn Vandenbulcke, Lieven Clement</p>
<li class="dropdown" style="float:right">
<a href="javascript:void(0)" class="dropbtn">&#x25BE; Chapters</a>
<div class="dropdown-content">
<a href="index.html" id="toc-preamble"><span class="toc-section-number">1</span> Preamble</a>
<a href="statistical-analysis-with-msqrob2.html" id="toc-statistical-analysis-with-msqrob2"><span class="toc-section-number">2</span> Statistical analysis with msqrob2</a>
<a href="load-packages.html" id="toc-load-packages"><span class="toc-section-number">3</span> Load packages</a>
<a href="load-data.html" id="toc-load-data"><span class="toc-section-number">4</span> Load data</a>
<a href="data-preprocessing.html" id="toc-data-preprocessing"><span class="toc-section-number">5</span> Data preprocessing</a>
<a id="active-page" href="modelling-sources-of-variation.html" id="toc-modelling-sources-of-variation"><span class="toc-section-number">6</span> Modelling sources of variation</a><ul class="toc-sections">
<li class="toc"><a href="#effect-of-treatment-of-interest"> Effect of treatment of interest</a></li>
<li class="toc"><a href="#effect-of-tmt-channel-and-run"> Effect of TMT channel and run</a></li>
<li class="toc"><a href="#effect-of-replication"> Effect of replication</a></li>
<li class="toc"><a href="#psm-level-modelling"> PSM-level modelling</a></li>
</ul>
<a href="statistical-inference.html" id="toc-statistical-inference"><span class="toc-section-number">7</span> Statistical inference</a>
<a href="dealing-with-fiterrors.html" id="toc-dealing-with-fiterrors"><span class="toc-section-number">8</span> Dealing with <code>fitErrors</code></a>
<a href="conclusion.html" id="toc-conclusion"><span class="toc-section-number">9</span> Conclusion</a>
</div>
</li>
</ul>
</div>
</div>
</div>
<div class="row">
<div class="col-sm-12">
<div id="modelling-sources-of-variation" class="section level1" number="6">
<h1>
<span class="header-section-number">Chapter 6</span> Modelling sources of variation</h1>
<p>Proteomics data contain several sources of variation that need to be
accounted for by the model. The code below shows how to run the model
that accounts for all relevant sources of variation in the spike-in
experiment, which we have shown performs best in the Msqrob2TMT
<a href="http://dx.doi.org/10.1101/2024.03.29.587218">paper</a>.</p>
<div class="sourceCode" id="cb23"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb23-1"><a href="modelling-sources-of-variation.html#cb23-1" tabindex="-1"></a>spikein <span class="ot">&lt;-</span> <span class="fu">msqrobAggregate</span>(</span>
<span id="cb23-2"><a href="modelling-sources-of-variation.html#cb23-2" tabindex="-1"></a>    spikein,  <span class="at">i =</span> <span class="st">"ions"</span>,</span>
<span id="cb23-3"><a href="modelling-sources-of-variation.html#cb23-3" tabindex="-1"></a>    <span class="at">formula =</span> <span class="sc">~</span> <span class="dv">0</span> <span class="sc">+</span> Condition <span class="sc">+</span> <span class="do">## fixed effect for experimental condition</span></span>
<span id="cb23-4"><a href="modelling-sources-of-variation.html#cb23-4" tabindex="-1"></a>        <span class="co"># (1 | Channel) + ## random effect for channel</span></span>
<span id="cb23-5"><a href="modelling-sources-of-variation.html#cb23-5" tabindex="-1"></a>        (<span class="dv">1</span> <span class="sc">|</span> Mixture) <span class="sc">+</span> <span class="do">## random effect for mixture</span></span>
<span id="cb23-6"><a href="modelling-sources-of-variation.html#cb23-6" tabindex="-1"></a>        (<span class="dv">1</span> <span class="sc">|</span> Run) <span class="sc">+</span> <span class="do">## random effect for run</span></span>
<span id="cb23-7"><a href="modelling-sources-of-variation.html#cb23-7" tabindex="-1"></a>        (<span class="dv">1</span> <span class="sc">|</span> Run<span class="sc">:</span>Channel) <span class="sc">+</span> <span class="do">## random effect for PSMs for the same protein in a channel of a run</span></span>
<span id="cb23-8"><a href="modelling-sources-of-variation.html#cb23-8" tabindex="-1"></a>        (<span class="dv">1</span> <span class="sc">|</span> Run<span class="sc">:</span>ionID), <span class="do">## random effect for ions in the same spectrum of an MS run</span></span>
<span id="cb23-9"><a href="modelling-sources-of-variation.html#cb23-9" tabindex="-1"></a>    <span class="at">fcol =</span> <span class="st">"Protein.Accessions"</span>,</span>
<span id="cb23-10"><a href="modelling-sources-of-variation.html#cb23-10" tabindex="-1"></a>    <span class="at">modelColumnName =</span> <span class="st">"msqrob_psms_rrilm"</span>,</span>
<span id="cb23-11"><a href="modelling-sources-of-variation.html#cb23-11" tabindex="-1"></a>    <span class="at">robust =</span><span class="cn">TRUE</span>, <span class="at">ridge =</span> <span class="cn">TRUE</span></span>
<span id="cb23-12"><a href="modelling-sources-of-variation.html#cb23-12" tabindex="-1"></a>)</span></code></pre></div>
<p>Note, that we use an encoding without intercept <code>~ 0 +</code>.
This makes it more straightforward to define contrasts for one-way ANOVA designs with a treatment involving a single factor.
Indeed, by suppressing the intercept, a model parameters is estimated for each group.
Otherwise, <code>msqrob2</code> selects one of the groups as the reference group, for which its model parameter is absorbed in the intercept.</p>
<p>We will now build up the model by progressively adding the
different sources of variation.</p>
<div id="effect-of-treatment-of-interest" class="section level2" number="6.1">
<h2>
<span class="header-section-number">6.1</span> Effect of treatment of interest<div class="tooltip"><button class="internal-link-btn" onclick="copy_link('effect-of-treatment-of-interest')" onmouseout="reset_tooltip('effect-of-treatment-of-interest-tooltip')"><span class="tooltiptext" id="effect-of-treatment-of-interest-tooltip">Copy link</span><i class="fa fa-link"></i></button></div>
</h2>
<p>We model the source of variation induced by the experimental
treatment of interest as a fixed effect, which we consider non-random,
i.e. the treatment effect is assumed to be the same in repeated
experiments, but it is unknown and has to be estimated. When modelling
a typical label-free experiment at the protein level, the model boils
down to a linear model, again we suppress the index for protein:</p>
<p><span class="math display">\[
y_r = \mathbf{x}^T_r \boldsymbol{\beta} + \epsilon_r,
\]</span></p>
<p>with <span class="math inline">\(y_r\)</span> the <span class="math inline">\(\log_2\)</span>-normalized protein intensities in run r;
<span class="math inline">\(\mathbf{x}_r\)</span> a vector with the covariate pattern for the sample in
run <span class="math inline">\(r\)</span> encoding the intercept, treatment, potential batch effects and
confounders; <span class="math inline">\(\boldsymbol{\beta}\)</span> the vector of parameters that model the
association between the covariates and the outcome; and <span class="math inline">\(\epsilon_r\)</span>
the residuals reflecting variation that is not captured by the fixed
effects. Note that <span class="math inline">\(\mathbf{x}_r\)</span> allows for a flexible
parameterization of the treatment beyond a single covariate, i.e. including a 1 for the intercept,
continuous and categorical variables as well as their interactions.
For all models considered in this work, we assume the residuals to be
independent and identically distributed (i.i.d) according to a normal
distribution with zero mean and constant variance, i.e. <span class="math inline">\(\epsilon_{r}
\sim N(0,\sigma_\epsilon^2)\)</span>, that can differ from protein to protein.</p>
<p>Using <code>msqrob2</code>, the model translates into the following code:</p>
<div class="sourceCode" id="cb24"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb24-1"><a href="modelling-sources-of-variation.html#cb24-1" tabindex="-1"></a>spikein <span class="ot">&lt;-</span> <span class="fu">msqrob</span>(</span>
<span id="cb24-2"><a href="modelling-sources-of-variation.html#cb24-2" tabindex="-1"></a>    spikein,  <span class="at">i =</span> <span class="st">"proteins"</span>,</span>
<span id="cb24-3"><a href="modelling-sources-of-variation.html#cb24-3" tabindex="-1"></a>    <span class="at">formula =</span> <span class="sc">~</span>  <span class="dv">0</span> <span class="sc">+</span> Condition, <span class="do">## fixed effect for experimental condition</span></span>
<span id="cb24-4"><a href="modelling-sources-of-variation.html#cb24-4" tabindex="-1"></a>    <span class="at">robust =</span> <span class="cn">TRUE</span>, <span class="at">ridge =</span> <span class="cn">TRUE</span>,</span>
<span id="cb24-5"><a href="modelling-sources-of-variation.html#cb24-5" tabindex="-1"></a>    <span class="at">modelColumnName =</span> <span class="st">"msqrob_rrilm"</span></span>
<span id="cb24-6"><a href="modelling-sources-of-variation.html#cb24-6" tabindex="-1"></a>)</span></code></pre></div>
<p>The function takes the <code>QFeatures</code> object, extracts the quantitative
values from the <code>"proteins"</code> set generated during summarisation, and
fits a simple linear model with <code>Condition</code> as covariate, which is
automatically retrieved from <code>colData(spikein)</code>.
We also enabled M-estimation (<code>robust = TRUE</code>) for improved robustness against
outliers and ridge penalisation (<code>ridge = TRUE</code>) to stabilise the
parameter estimation. The fitting results are available in the
<code>msqrob_rrilm</code> column of the <code>rowData</code>. More specifically, the
function will store the modelling output for each protein in a
<code>statModel</code> object, which are then saved in the <code>rowData</code>, one model
per row. We will see in a later section how to perform statistical
inference on the estimated parameters</p>
<div class="sourceCode" id="cb25"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb25-1"><a href="modelling-sources-of-variation.html#cb25-1" tabindex="-1"></a>models <span class="ot">&lt;-</span> <span class="fu">rowData</span>(spikein[[<span class="st">"proteins"</span>]])[[<span class="st">"msqrob_rrilm"</span>]]</span>
<span id="cb25-2"><a href="modelling-sources-of-variation.html#cb25-2" tabindex="-1"></a>models[<span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>]</span></code></pre></div>
<p>Note, that we use an encoding without intercept <code>~ 0 +</code>.
This makes it more straightforward to define contrasts for one-way ANOVA designs with a treatment involving a single factor.
Indeed, by suppressing the intercept, a model parameters is estimated for each group.
Otherwise, <code>msqrob2</code> selects one of the groups as the reference group, for which its model parameter is absorbed in the intercept.</p>
</div>
<div id="effect-of-tmt-channel-and-run" class="section level2" number="6.2">
<h2>
<span class="header-section-number">6.2</span> Effect of TMT channel and run<div class="tooltip"><button class="internal-link-btn" onclick="copy_link('effect-of-tmt-channel-and-run')" onmouseout="reset_tooltip('effect-of-tmt-channel-and-run-tooltip')"><span class="tooltiptext" id="effect-of-tmt-channel-and-run-tooltip">Copy link</span><i class="fa fa-link"></i></button></div>
</h2>
<p>As label-free experiments contain only a single sample per run,
run-specific effects will be absorbed in the residuals. However, the
data analysis of labeled experiments, e.g. using TMT multiplexing,
involving multiple MS runs has to account for run- and label-specific
effects, explicitly. If all treatments are present in each run, and if
channel swaps are performed so as to avoid confounding between channel
and treatment, then the model parameters can be estimated using fixed
channel and run effects. Indeed, for these designs run acts as a
blocking variable as all treatment effects can be estimated within
each run.</p>
<p>However, for more complex designs this is no longer possible and the
uncertainty in the estimation of the mean model parameters can involve
both within and between channel and run variability. For these designs
we can resort to mixed models where the channel and run effect are
modelled using random effects, i.e. they are considered as a random
sample from the population of all possible runs (channel labels),
which are assumed to be i.i.d normally distributed with mean 0 and
constant variance, <span class="math inline">\(u_r \sim N(0,\sigma^{2,\text{run}})\)</span>
(<span class="math inline">\(u_{channel} \sim N(0,\sigma^{2,\text{channel}})\)</span>). The use of random
effects thus models the correlation in the data, explicitly. Indeed,
protein intensities that are measured within the same run (channel)
will be more similar than protein intensities between runs (channels).</p>
<p>Hence, the model is extended to:</p>
<p><span class="math display">\[
y_{rc} =
\mathbf{x}^T_{rc} \boldsymbol{\beta} + u_c^\text{channel} + u_r^\text{run} +
\epsilon_{rc}
\]</span>
with <span class="math inline">\(y_{rc}\)</span> the normalised <span class="math inline">\(\log_2\)</span> protein intensities in run <span class="math inline">\(r\)</span>
and channel <span class="math inline">\(c\)</span>, <span class="math inline">\(u_c^\text{channel}\)</span> the effect introduced by
the label of channel <span class="math inline">\(c\)</span>, and <span class="math inline">\(u_r^\text{run}\)</span> the effect for MS run
<span class="math inline">\(r\)</span>.</p>
<p>This translates in the following code:</p>
<div class="sourceCode" id="cb26"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb26-1"><a href="modelling-sources-of-variation.html#cb26-1" tabindex="-1"></a>spikein <span class="ot">&lt;-</span> <span class="fu">msqrob</span>(</span>
<span id="cb26-2"><a href="modelling-sources-of-variation.html#cb26-2" tabindex="-1"></a>    spikein,  <span class="at">i =</span> <span class="st">"proteins"</span>,</span>
<span id="cb26-3"><a href="modelling-sources-of-variation.html#cb26-3" tabindex="-1"></a>    <span class="at">formula =</span> <span class="sc">~</span>  <span class="dv">0</span> <span class="sc">+</span> Condition <span class="sc">+</span> <span class="do">## fixed effect for experimental condition</span></span>
<span id="cb26-4"><a href="modelling-sources-of-variation.html#cb26-4" tabindex="-1"></a>        <span class="co"># (1 | Channel) + ## random effect for channel</span></span>
<span id="cb26-5"><a href="modelling-sources-of-variation.html#cb26-5" tabindex="-1"></a>        (<span class="dv">1</span> <span class="sc">|</span> Run), <span class="do">## random effect for MS run</span></span>
<span id="cb26-6"><a href="modelling-sources-of-variation.html#cb26-6" tabindex="-1"></a>    <span class="at">robust =</span> <span class="cn">TRUE</span>, <span class="at">ridge =</span> <span class="cn">TRUE</span>,</span>
<span id="cb26-7"><a href="modelling-sources-of-variation.html#cb26-7" tabindex="-1"></a>    <span class="at">modelColumnName =</span> <span class="st">"msqrob_rrilmm"</span></span>
<span id="cb26-8"><a href="modelling-sources-of-variation.html#cb26-8" tabindex="-1"></a>    )</span></code></pre></div>
<p>Note here that we have commented out the random effect for channel. In
practice, normalisation already removes part of the channel effect and
is sufficient. You can experiment this yourself by removing the
comment sign <code>#</code> in front of <code>(1 | Channel) +</code> across the vignette,
and see how the results may change.</p>
</div>
<div id="effect-of-replication" class="section level2" number="6.3">
<h2>
<span class="header-section-number">6.3</span> Effect of replication<div class="tooltip"><button class="internal-link-btn" onclick="copy_link('effect-of-replication')" onmouseout="reset_tooltip('effect-of-replication-tooltip')"><span class="tooltiptext" id="effect-of-replication-tooltip">Copy link</span><i class="fa fa-link"></i></button></div>
</h2>
<p>Some experiments also include technical replication where a TMT
mixture can be acquired multiple times. This again will induce
correlation. Indeed, protein intensities from the same mixture will be
more alike than those of different mixtures. Hence, we also include a
random effect to account for this pseudo-replication, i.e.
<span class="math inline">\(u^\text{mix}_m \sim N(0, \sigma^{2,\text{mix}})\)</span>. The model thus
extends to:</p>
<p><span class="math display">\[
y_{rcm} =
\mathbf{x}^T_{rcm} \boldsymbol{\beta} +  u_{c}^\text{channel} +
u_r^\text{run} + u_m^\text{mix} + \epsilon_{rcm}
\]</span></p>
<p>with <span class="math inline">\(m\)</span> the index for mixture.</p>
<p>The model translates to the following code:</p>
<div class="sourceCode" id="cb27"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb27-1"><a href="modelling-sources-of-variation.html#cb27-1" tabindex="-1"></a>spikein <span class="ot">&lt;-</span> <span class="fu">msqrob</span>(</span>
<span id="cb27-2"><a href="modelling-sources-of-variation.html#cb27-2" tabindex="-1"></a>    spikein,  <span class="at">i =</span> <span class="st">"proteins"</span>,</span>
<span id="cb27-3"><a href="modelling-sources-of-variation.html#cb27-3" tabindex="-1"></a>    <span class="at">formula =</span> <span class="sc">~</span>  <span class="dv">0</span> <span class="sc">+</span> Condition <span class="sc">+</span> <span class="do">## fixed effect for experimental condition</span></span>
<span id="cb27-4"><a href="modelling-sources-of-variation.html#cb27-4" tabindex="-1"></a>        <span class="co"># (1 | Channel) + ## random effect for channel</span></span>
<span id="cb27-5"><a href="modelling-sources-of-variation.html#cb27-5" tabindex="-1"></a>        (<span class="dv">1</span> <span class="sc">|</span> Run) <span class="sc">+</span> <span class="do">## random effect for MS run</span></span>
<span id="cb27-6"><a href="modelling-sources-of-variation.html#cb27-6" tabindex="-1"></a>        (<span class="dv">1</span> <span class="sc">|</span> Mixture), <span class="do">## random effect for mixture</span></span>
<span id="cb27-7"><a href="modelling-sources-of-variation.html#cb27-7" tabindex="-1"></a>    <span class="at">robust =</span> <span class="cn">TRUE</span>, <span class="at">ridge =</span> <span class="cn">TRUE</span>,</span>
<span id="cb27-8"><a href="modelling-sources-of-variation.html#cb27-8" tabindex="-1"></a>    <span class="at">modelColumnName =</span> <span class="st">"msqrob_rrilmm"</span>,</span>
<span id="cb27-9"><a href="modelling-sources-of-variation.html#cb27-9" tabindex="-1"></a>    <span class="at">overwrite =</span> <span class="cn">TRUE</span></span>
<span id="cb27-10"><a href="modelling-sources-of-variation.html#cb27-10" tabindex="-1"></a>)</span></code></pre></div>
<p>We use <code>overwrite = TRUE</code> to overwrite the previous results in the
<code>rowData</code>.</p>
</div>
<div id="psm-level-modelling" class="section level2" number="6.4">
<h2>
<span class="header-section-number">6.4</span> PSM-level modelling<div class="tooltip"><button class="internal-link-btn" onclick="copy_link('psm-level-modelling')" onmouseout="reset_tooltip('psm-level-modelling-tooltip')"><span class="tooltiptext" id="psm-level-modelling-tooltip">Copy link</span><i class="fa fa-link"></i></button></div>
</h2>
<p>Above, we modelled the data at the protein level. However, we could
also directly estimate the treatment effect from PSM-level data. This
will again induce additional levels of correlation. Indeed, the
intensities for the different reporter ions in a TMT run within the
same spectrum (PSM) will be more similar than the intensities between
PSMs. We therefore need to add a random effect term to account for the
within PSM correlation structure, i.e. <span class="math inline">\(u^\text{PSM}_{rp} \sim
N(0,\sigma^{2,\text{PSM}})\)</span>. Moreover, in each channel of a run
multiple PSM intensities are picked up for each protein.
Hence, intensities from different PSMs for a protein in the same channel of a run will be more alike
than intensities of different PSMs for the same protein between
channels of runs, and we will address this correlation with a channel-specific
random effect nested in run, i.e. <span class="math inline">\(u_{rc}^{channel} \sim
N(0,\sigma^{2,\text{channel}})\)</span>. The model then becomes:</p>
<p><span class="math display">\[
y_{rcmp} =
\mathbf{x}^T_{rcmp} \beta + u_{c}^\text{channel} +
u_r^\text{run} + u_m^\text{mix}  +
u_{rc}^\text{channel} + u_{rp}^\text{PSM} + \epsilon_{rcmp}
\]</span>
with <span class="math inline">\(y_{rcmp}\)</span> the <span class="math inline">\(\log_2\)</span>-normalized PSM intensities for run <span class="math inline">\(r\)</span>
with label <span class="math inline">\(c\)</span> in mixture <span class="math inline">\(m\)</span> and peptide ion <span class="math inline">\(p\)</span>. Note, that the peptide ion random
effect is also nested within each run since each spectrum is described
by run-specific characteristics.</p>
<p>The model translates to the code below. Note that we here no longer
use <code>msqrob()</code>, but <code>msqrobAggregate()</code>. The latter will combine
annotations from the <code>colData</code> (i.e. <code>"Condition"</code>, <code>"Channel"</code>,
<code>"Run"</code>, <code>"Mixture"</code>) and from the <code>rowData</code> (i.e.
<code>"ionID"</code>). Moreover, we need to tell the function how the PSM-level
data is grouped to protein data through the <code>fcol</code> argument, here we
will group PSMs by the <code>Protein.Accessions</code>.</p>
<div class="sourceCode" id="cb28"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb28-1"><a href="modelling-sources-of-variation.html#cb28-1" tabindex="-1"></a>spikein <span class="ot">&lt;-</span> <span class="fu">msqrobAggregate</span>(</span>
<span id="cb28-2"><a href="modelling-sources-of-variation.html#cb28-2" tabindex="-1"></a>    spikein,  <span class="at">i =</span> <span class="st">"ions"</span>,</span>
<span id="cb28-3"><a href="modelling-sources-of-variation.html#cb28-3" tabindex="-1"></a>    <span class="at">formula =</span> <span class="sc">~</span>  <span class="dv">0</span> <span class="sc">+</span> Condition <span class="sc">+</span> <span class="do">## fixed effect for experimental condition</span></span>
<span id="cb28-4"><a href="modelling-sources-of-variation.html#cb28-4" tabindex="-1"></a>        <span class="co"># (1 | Channel) + ## random effect for channel</span></span>
<span id="cb28-5"><a href="modelling-sources-of-variation.html#cb28-5" tabindex="-1"></a>        (<span class="dv">1</span> <span class="sc">|</span> Run) <span class="sc">+</span> <span class="do">## random effect for Run</span></span>
<span id="cb28-6"><a href="modelling-sources-of-variation.html#cb28-6" tabindex="-1"></a>        (<span class="dv">1</span> <span class="sc">|</span> Mixture) <span class="sc">+</span> <span class="do">## random effect for mixture</span></span>
<span id="cb28-7"><a href="modelling-sources-of-variation.html#cb28-7" tabindex="-1"></a>        (<span class="dv">1</span> <span class="sc">|</span> Run<span class="sc">:</span>Channel) <span class="sc">+</span> <span class="do">## random effect for channel nested in run</span></span>
<span id="cb28-8"><a href="modelling-sources-of-variation.html#cb28-8" tabindex="-1"></a>        (<span class="dv">1</span> <span class="sc">|</span> Run<span class="sc">:</span>ionID), <span class="do">## random effect for ion nested in run</span></span>
<span id="cb28-9"><a href="modelling-sources-of-variation.html#cb28-9" tabindex="-1"></a>    <span class="at">fcol =</span> <span class="st">"Protein.Accessions"</span>,</span>
<span id="cb28-10"><a href="modelling-sources-of-variation.html#cb28-10" tabindex="-1"></a>    <span class="at">modelColumnName =</span> <span class="st">"msqrob_psm_rrilmm"</span>,</span>
<span id="cb28-11"><a href="modelling-sources-of-variation.html#cb28-11" tabindex="-1"></a>    <span class="at">name =</span> <span class="st">"proteins_msqrob"</span>,</span>
<span id="cb28-12"><a href="modelling-sources-of-variation.html#cb28-12" tabindex="-1"></a>    <span class="at">robust =</span> <span class="cn">TRUE</span>, <span class="at">ridge =</span> <span class="cn">TRUE</span></span>
<span id="cb28-13"><a href="modelling-sources-of-variation.html#cb28-13" tabindex="-1"></a>)</span></code></pre></div>
<p>So, we built the model shown at the beginning of this section,
effectively accounting for all sources of variation in TMT-based
proteomics data.</p>
</div>
</div>
<p style="text-align: center;">
<a href="data-preprocessing.html"><button class="btn btn-default">Previous</button></a>
<a href="statistical-inference.html"><button class="btn btn-default">Next</button></a>
</p>
<p class="build-date">Page built: 
2025-09-03
 using 
R version 4.5.1 (2025-06-13)
</p>
</div>
</div>



</body>
</html>
