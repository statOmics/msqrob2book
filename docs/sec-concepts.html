<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

<meta charset="utf-8" />
<meta name="generator" content="pandoc" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<meta property="og:title" content="Chapter 2 Statistical analysis with msqrob2 | Statistical analysis for proteomics data" />
<meta property="og:type" content="book" />




<meta name="author" content="Christophe Vanderaa, Stijn Vandenbulcke, Lieven Clement" />

<meta name="date" content="2025-09-12" />

<script type="text/x-mathjax-config">
MathJax.Hub.Config({
  TeX: { equationNumbers: { autoNumber: "AMS" } }
});
</script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<meta name="description" content="Chapter 2 Statistical analysis with msqrob2 | Statistical analysis for proteomics data">

<title>Chapter 2 Statistical analysis with msqrob2 | Statistical analysis for proteomics data</title>

<link href="libs/tufte-css-2015.12.29/tufte.css" rel="stylesheet" />
<link href="libs/tufte-css-2015.12.29/envisioned.css" rel="stylesheet" />
<link href="libs/msmb-css-0/msmb.css" rel="stylesheet" />
<script>
function toggle_visibility(id1, id2) {
var e = document.getElementById(id1);
var f = document.getElementById(id2);

e.style.display = ((e.style.display!='none') ? 'none' : 'block');

if(f.classList.contains('fa-plus-square')) {
    f.classList.add('fa-minus-square')
    f.classList.remove('fa-plus-square')
} else {
    f.classList.add('fa-plus-square')
    f.classList.remove('fa-minus-square')
}

}
</script>
<script>
function copy_link(id) {
  var dummy = document.createElement('input'),
  text = window.location.href.split(/[?#]/)[0] + '#' + id;
  document.body.appendChild(dummy);
  dummy.value = text;
  dummy.select();
  document.execCommand('copy');
  document.body.removeChild(dummy);
  
  var tooltip = document.getElementById(id + '-tooltip');
  tooltip.innerHTML = 'Copied!';
}

function reset_tooltip(id) {
  var tooltip = document.getElementById(id);
  tooltip.innerHTML = 'Copy link';
}
</script>


<style type="text/css">code{white-space: pre;}</style>
<style type="text/css">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }

code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {  background-color: #f8f8f8; }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ef2929; } /* Alert */
code span.an { color: #8f5902; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #204a87; } /* Attribute */
code span.bn { color: #0000cf; } /* BaseN */
code span.cf { color: #204a87; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4e9a06; } /* Char */
code span.cn { color: #8f5902; } /* Constant */
code span.co { color: #8f5902; font-style: italic; } /* Comment */
code span.cv { color: #8f5902; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #8f5902; font-weight: bold; font-style: italic; } /* Documentation */
code span.dt { color: #204a87; } /* DataType */
code span.dv { color: #0000cf; } /* DecVal */
code span.er { color: #a40000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #0000cf; } /* Float */
code span.fu { color: #204a87; font-weight: bold; } /* Function */
code span.im { } /* Import */
code span.in { color: #8f5902; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #204a87; font-weight: bold; } /* Keyword */
code span.op { color: #ce5c00; font-weight: bold; } /* Operator */
code span.ot { color: #8f5902; } /* Other */
code span.pp { color: #8f5902; font-style: italic; } /* Preprocessor */
code span.sc { color: #ce5c00; font-weight: bold; } /* SpecialChar */
code span.ss { color: #4e9a06; } /* SpecialString */
code span.st { color: #4e9a06; } /* String */
code span.va { color: #000000; } /* Variable */
code span.vs { color: #4e9a06; } /* VerbatimString */
code span.wa { color: #8f5902; font-weight: bold; font-style: italic; } /* Warning */
</style>


<style type="text/css">
/* Used with Pandoc 2.11+ new --citeproc when CSL is used */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
  margin-bottom: 0em;
}
.hanging div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}
</style>

<link rel="stylesheet" href="style.css" type="text/css" />

</head>

<body>



<div class="row">
<div class="col-sm-12">
<div id="TOC">
<ul class="navbar">
<li class="msmb"><p class="title">Statistical analysis for proteomics data<p><p class="author">Christophe Vanderaa, Stijn Vandenbulcke, Lieven Clement</p>
<li class="dropdown" style="float:right">
<a href="javascript:void(0)" class="dropbtn">&#x25BE; Chapters</a>
<div class="dropdown-content">
<a href="index.html" id="toc-preamble"><span class="toc-section-number">1</span> Preamble</a>
<a id="active-page" href="sec-concepts.html" id="toc-sec-concepts"><span class="toc-section-number">2</span> Statistical analysis with msqrob2</a><ul class="toc-sections">
<li class="toc"><a href="#why-msqrob2"> Why msqrob2?</a></li>
<li class="toc"><a href="#software"> Software</a></li>
<li class="toc"><a href="#data"> Data</a></li>
<li class="toc"><a href="#data-preprocessing"> Data preprocessing</a></li>
<li class="toc"><a href="#data-exploration"> Data exploration</a></li>
<li class="toc"><a href="#sec-modelling"> Data modelling</a></li>
<li class="toc"><a href="#statistical-inference"> Statistical inference</a></li>
<li class="toc"><a href="#protein-level-models"> Protein-level models</a></li>
<li class="toc"><a href="#dealing-with-fiterrors"> Dealing with <code id="sec-fiterror">fitErrors</code></a></li>
<li class="toc"><a href="#NA"> Testing muliple contrasts at once</a></li>
<li class="toc"><a href="#conclusion"> Conclusion</a></li>
</ul>
<a href="sec-francisella.html" id="toc-sec-francisella"><span class="toc-section-number">3</span> The francisella use case: a MaxQuant LFQ DDA dataset</a>
<a href="sec-mouse_diet.html#sec-mouse_diet" id="toc-sec-mouse_diet"><span class="toc-section-number">4</span> The mouse diet use case: a Skyline TMT DDA dataset</a>
<a href="sec-end.html" id="toc-sec-end"><span class="toc-section-number">5</span> Usefull links and session information</a>
</div>
</li>
</ul>
</div>
</div>
</div>
<div class="row">
<div class="col-sm-12">
<div id="sec-concepts" class="section level1" number="2">
<h1>
<span class="header-section-number">Chapter 2</span> Statistical analysis with msqrob2</h1>
<p>This chapter explains the important concepts when it comes to
statistical analysis of proteomics data using <code>msqrob2</code>. To illustrate
these concepts, we will use the spike-in study published by
<span class="citation">Huang et al. (<label for="tufte-mn-1" class="margin-toggle">⊕</label><input type="checkbox" id="tufte-mn-1" class="margin-toggle">2020<span class="marginnote">Huang, Ting, Meena Choi, Manuel Tzouros, Sabrina Golling, Nikhil Janak Pandya, Balazs Banfai, Tom Dunkley, and Olga Vitek. 2020. <span>“<span>MSstatsTMT</span>: Statistical Detection of Differentially Abundant Proteins in Experiments with Isobaric Labeling and Multiple Mixtures.”</span> <em>Mol. Cell. Proteomics</em> 19 (10): 1706–23.</span>)</span>. We chose this dataset because</p>
<ol style="list-style-type: decimal">
<li>Spike-in data contain ground truth information about which proteins
are differentially abundant, enabling us to show the impact of
different analysis strategies.</li>
<li>It has been acquired with a TMT-labelling strategy that require a
more complex experimental design. This provides an excellent example
to explain the different sources of variability in an MS experiment
and demonstrate the flexibility of <code>msqrob2</code> to model this
variability.</li>
</ol>
<p><strong>TODO</strong>: throughout the book, we must make sure we stick to one of
the following terms for low-level modellig: peptide ion-, ion-,
precursor ion-, precursor- or psm-leve. I prefer “precursor” for its
simplicity and think we should replace “ionID” by “precursor_id”</p>
<div id="why-msqrob2" class="section level2" number="2.1">
<h2>
<span class="header-section-number">2.1</span> Why msqrob2?<div class="tooltip"><button class="internal-link-btn" onclick="copy_link('why-msqrob2')" onmouseout="reset_tooltip('why-msqrob2-tooltip')"><span class="tooltiptext" id="why-msqrob2-tooltip">Copy link</span><i class="fa fa-link"></i></button></div>
</h2>
<p>Mass spectrometry (MS)-based proteomics experiments often imposes a
complex correlation structure among observations. Addressing this
correlation is key for correct statistical inference and reliable
biomarker discovery. msqrob2TMT is a set of mixed model-based
workflows tailored toward differential abundance analysis for labelled
MS-based proteomics data. The key features of <code>msqrob2TMT</code> workflows
are:</p>
<ol style="list-style-type: decimal">
<li>Modularity: all core functions rely on the <code>QFeatures</code> class, a
standardised data structure, meaning that output of a function can
be fed as input to any other function. Hence, different functions
are assembled as modular blocks into a complete data analysis
workflows that can be easily adapted to the peculiarities of any
MS-based proteomics data set. Therefore, the approach extends well
beyond the use case presented in this chapter</li>
<li>Flexibility: the <code>msqrob2</code> modelling approach relies on the
<code>lme4::lmer()</code> model specification syntax, meaning that any linear
model can be specified. For fixed effects, this includes modelling
categorical and numerical variables, as well as their interaction.
Moreover, <code>msqrob2</code> can model both sample-specific and
feature-specific (e.g. peptide or protein) covariates, which
unlocks the inference to experiments with arbitrarily complex
designs as well as to correct explicitly for feature-specific
properties.</li>
<li>Performance: thanks to the inclusion of robust ridge regression, we
demonstrated improved performance of <code>msqrob2</code> workflows upon the
competing software <span class="citation">(<label for="tufte-mn-2" class="margin-toggle">⊕</label><input type="checkbox" id="tufte-mn-2" class="margin-toggle">Goeminne, Gevaert, and Clement 2016<span class="marginnote">Goeminne, Ludger J E, Kris Gevaert, and Lieven Clement. 2016. <span>“Peptide-Level Robust Ridge Regression Improves Estimation, Sensitivity, and Specificity in Data-Dependent Quantitative Label-Free Shotgun Proteomics.”</span> <em>Mol. Cell. Proteomics</em> 15 (2): 657–68.</span>; <label for="tufte-mn-3" class="margin-toggle">⊕</label><input type="checkbox" id="tufte-mn-3" class="margin-toggle">Sticker et al. 2020<span class="marginnote">Sticker, Adriaan, Ludger Goeminne, Lennart Martens, and Lieven Clement. 2020. <span>“Robust Summarization and Inference in Proteome-Wide Label-Free Quantification.”</span> <em>Mol. Cell. Proteomics</em> 19 (7): 1209–19.</span>; <label for="tufte-mn-4" class="margin-toggle">⊕</label><input type="checkbox" id="tufte-mn-4" class="margin-toggle">Vandenbulcke et al. 2025<span class="marginnote">Vandenbulcke, Stijn, Christophe Vanderaa, Oliver Crook, Lennart Martens, and Lieven Clement. 2025. <span>“<span>Msqrob2TMT</span>: Robust Linear Mixed Models for Inferring Differential Abundant Proteins in Labeled Experiments with Arbitrarily Complex Design.”</span> <em>Mol. Cell. Proteomics</em> 24 (7): 101002.</span>)</span>.</li>
</ol>
</div>
<div id="software" class="section level2" number="2.2">
<h2>
<span class="header-section-number">2.2</span> Software<div class="tooltip"><button class="internal-link-btn" onclick="copy_link('software')" onmouseout="reset_tooltip('software-tooltip')"><span class="tooltiptext" id="software-tooltip">Copy link</span><i class="fa fa-link"></i></button></div>
</h2>
<div id="load-packages" class="section level3" number="2.2.1">
<h3>
<span class="header-section-number">2.2.1</span> Load packages<div class="tooltip"><button class="internal-link-btn" onclick="copy_link('load-packages')" onmouseout="reset_tooltip('load-packages-tooltip')"><span class="tooltiptext" id="load-packages-tooltip">Copy link</span><i class="fa fa-link"></i></button></div>
</h3>
<p>We load the <code>msqrob2</code> package, along with additional packages for
data manipulation and visualisation.</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb2-1"><a href="sec-concepts.html#cb2-1" tabindex="-1"></a><span class="fu">library</span>(<span class="st">"msqrob2"</span>)</span>
<span id="cb2-2"><a href="sec-concepts.html#cb2-2" tabindex="-1"></a><span class="fu">library</span>(<span class="st">"dplyr"</span>)</span>
<span id="cb2-3"><a href="sec-concepts.html#cb2-3" tabindex="-1"></a><span class="fu">library</span>(<span class="st">"ggplot2"</span>)</span>
<span id="cb2-4"><a href="sec-concepts.html#cb2-4" tabindex="-1"></a><span class="fu">library</span>(<span class="st">"patchwork"</span>)</span></code></pre></div>
</div>
<div id="sec-parallel" class="section level3" number="2.2.2">
<h3>
<span class="header-section-number">2.2.2</span> Parallelisation<div class="tooltip"><button class="internal-link-btn" onclick="copy_link('sec-parallel')" onmouseout="reset_tooltip('sec-parallel-tooltip')"><span class="tooltiptext" id="sec-parallel-tooltip">Copy link</span><i class="fa fa-link"></i></button></div>
</h3>
<p><code>msqrob2</code> can parallelisation computations during the model estimation
to improve speed. However, we will disable parallelisation to ensure
this vignette can be run regardless of hardware. Parallelisation is
controlled using the <code>BiocParallel</code> package.</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb3-1"><a href="sec-concepts.html#cb3-1" tabindex="-1"></a><span class="fu">library</span>(<span class="st">"BiocParallel"</span>)</span>
<span id="cb3-2"><a href="sec-concepts.html#cb3-2" tabindex="-1"></a><span class="fu">register</span>(<span class="fu">SerialParam</span>())</span></code></pre></div>
<p>If you want to use <code>msqrob2</code> with parallelisation enabled and using
4 cores, you can run the following:</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb4-1"><a href="sec-concepts.html#cb4-1" tabindex="-1"></a><span class="fu">register</span>(<span class="fu">MulticoreParam</span>(<span class="at">workers =</span> <span class="dv">4</span>))</span></code></pre></div>
<p>Be mindful that, while parallelisation can improve speed, it will also
consume more RAM because part of the data will be copied multiple
times over your different workers. If you experience crashes because
you exceeded the amount of available RAM on your machine, you should
reduce the number of requested workers.</p>
</div>
</div>
<div id="data" class="section level2" number="2.3">
<h2>
<span class="header-section-number">2.3</span> Data<div class="tooltip"><button class="internal-link-btn" onclick="copy_link('data')" onmouseout="reset_tooltip('data-tooltip')"><span class="tooltiptext" id="data-tooltip">Copy link</span><i class="fa fa-link"></i></button></div>
</h2>
<p>The data set used in this chapter is a spike-in experiment
(PXD0015258). It consists of controlled mixtures with known ground
truth. UPS1 peptides at concentrations of 500, 333, 250, and 62.5 fmol
were spiked into 50 g of SILAC HeLa peptides, each in duplicate. These
concentrations form a dilution series of 1, 0.667, 0.5, and 0.125
relative to the highest UPS1 peptide amount (500 fmol). A reference
sample was created by combining the diluted UPS1 peptide samples with
50g of SILAC HeLa peptides. All dilutions and the reference sample
were prepared in duplicate, resulting in a total of ten samples. These
samples were then treated with TMT10-plex reagents and combined before
LC-MS/MS analysis. This protocol was repeated five times, each with
three technical replicates, totaling 15 MS runs.</p>
<div id="getting-the-data" class="section level3" number="2.3.1">
<h3>
<span class="header-section-number">2.3.1</span> Getting the data<div class="tooltip"><button class="internal-link-btn" onclick="copy_link('getting-the-data')" onmouseout="reset_tooltip('getting-the-data-tooltip')"><span class="tooltiptext" id="getting-the-data-tooltip">Copy link</span><i class="fa fa-link"></i></button></div>
</h3>
<p>The data have been deposited by the authors in the <code>MSV000084264</code>
MASSiVE repository, but we will retrieve the timestamped data from our
<a href="https://zenodo.org/records/14767905">Zenodo repository</a>. We need 2
files: the Skyline identification and quantification table generated
by the authors and the sample annotation files.</p>
<div id="sec-caching" class="section level4" number="2.3.1.1">
<h4>
<span class="header-section-number">2.3.1.1</span> File caching</h4>
<p>To facilitate management of the files, we download the required files
using the <code>BiocFileCache</code> package, which ensures that the files are
downloaded only once. The chunk below will take some time to complete
the first time you run it as it needs to download the (large) file
locally, but will fetch the local copy the following times.</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb5-1"><a href="sec-concepts.html#cb5-1" tabindex="-1"></a><span class="fu">library</span>(<span class="st">"BiocFileCache"</span>)</span>
<span id="cb5-2"><a href="sec-concepts.html#cb5-2" tabindex="-1"></a>bfc <span class="ot">&lt;-</span> <span class="fu">BiocFileCache</span>()</span>
<span id="cb5-3"><a href="sec-concepts.html#cb5-3" tabindex="-1"></a>psmFile <span class="ot">&lt;-</span> <span class="fu">bfcrpath</span>(bfc, <span class="st">"https://zenodo.org/records/14767905/files/spikein1_psms.txt?download=1"</span>)</span>
<span id="cb5-4"><a href="sec-concepts.html#cb5-4" tabindex="-1"></a>annotFile <span class="ot">&lt;-</span> <span class="fu">bfcrpath</span>(bfc, <span class="st">"https://zenodo.org/records/14767905/files/spikein1_annotations.csv?download=1"</span>)</span></code></pre></div>
<p>Now the files are downloaded, we can load the two tables.</p>
</div>
<div id="sec-psm_table" class="section level4" number="2.3.1.2">
<h4>
<span class="header-section-number">2.3.1.2</span> The PSM table</h4>
<p>An MS experiment generates spectra. Each MS2 spectra are used to infer
the peptide identity thanks to a search engine. When
an observed spectrum is matched to a theoretical peptide spectrum, we
have a peptide-to-spectrum match (PSM). The identification software
compiles all the PSMs inside a table. Each row in the PSM data table
contains information for one PSM (the table below shows the first 6
rows). The columns contains various information about the PSM, such as
the peptide sequence and charge, the quantified value, the inferred
protein group, the measured and predicted retention time and precursor
mass, the score of the match, … In the case of TMT data, the
quantification values are provides in multiple columns (start with
<code>"Abundance."</code>), one for each TMT label. Regardless of TMT or LFQ
experiments, quantitative values from samples in different runs are
stacked below each other. This is known as the “long format”.</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb6-1"><a href="sec-concepts.html#cb6-1" tabindex="-1"></a>psms <span class="ot">&lt;-</span> <span class="fu">read.delim</span>(psmFile)</span>
<span id="cb6-2"><a href="sec-concepts.html#cb6-2" tabindex="-1"></a>qcols <span class="ot">&lt;-</span> <span class="fu">grep</span>(<span class="st">"Abundance"</span>, <span class="fu">colnames</span>(psms), <span class="at">value =</span> <span class="cn">TRUE</span>)</span></code></pre></div>
<table style="width:100%;">
<colgroup>
<col width="0%">
<col width="1%">
<col width="1%">
<col width="1%">
<col width="4%">
<col width="6%">
<col width="1%">
<col width="1%">
<col width="1%">
<col width="2%">
<col width="8%">
<col width="1%">
<col width="8%">
<col width="2%">
<col width="0%">
<col width="1%">
<col width="0%">
<col width="0%">
<col width="1%">
<col width="1%">
<col width="0%">
<col width="1%">
<col width="1%">
<col width="1%">
<col width="1%">
<col width="0%">
<col width="2%">
<col width="2%">
<col width="2%">
<col width="0%">
<col width="1%">
<col width="4%">
<col width="0%">
<col width="1%">
<col width="1%">
<col width="1%">
<col width="1%">
<col width="1%">
<col width="1%">
<col width="1%">
<col width="1%">
<col width="1%">
<col width="1%">
<col width="1%">
<col width="1%">
<col width="1%">
<col width="1%">
<col width="1%">
<col width="1%">
<col width="1%">
</colgroup>
<thead><tr class="header">
<th align="left">Checked</th>
<th align="left">Confidence</th>
<th align="left">Identifying.Node</th>
<th align="left">PSM.Ambiguity</th>
<th align="left">Annotated.Sequence</th>
<th align="left">Modifications</th>
<th align="left">Marked.as</th>
<th align="right">X..Protein.Groups</th>
<th align="right">X..Proteins</th>
<th align="left">Master.Protein.Accessions</th>
<th align="left">Master.Protein.Descriptions</th>
<th align="left">Protein.Accessions</th>
<th align="left">Protein.Descriptions</th>
<th align="right">X..Missed.Cleavages</th>
<th align="right">Charge</th>
<th align="right">DeltaScore</th>
<th align="right">DeltaCn</th>
<th align="right">Rank</th>
<th align="right">Search.Engine.Rank</th>
<th align="right">m.z..Da.</th>
<th align="right">MH…Da.</th>
<th align="right">Theo..MH…Da.</th>
<th align="right">DeltaM..ppm.</th>
<th align="right">Deltam.z..Da.</th>
<th align="left">Activation.Type</th>
<th align="left">MS.Order</th>
<th align="right">Isolation.Interference….</th>
<th align="right">Average.Reporter.S.N</th>
<th align="right">Ion.Inject.Time..ms.</th>
<th align="right">RT..min.</th>
<th align="right">First.Scan</th>
<th align="left">Spectrum.File</th>
<th align="left">File.ID</th>
<th align="right">Abundance..126</th>
<th align="right">Abundance..127N</th>
<th align="right">Abundance..127C</th>
<th align="right">Abundance..128N</th>
<th align="right">Abundance..128C</th>
<th align="right">Abundance..129N</th>
<th align="right">Abundance..129C</th>
<th align="right">Abundance..130N</th>
<th align="right">Abundance..130C</th>
<th align="right">Abundance..131</th>
<th align="left">Quan.Info</th>
<th align="right">Ions.Score</th>
<th align="right">Identity.Strict</th>
<th align="right">Identity.Relaxed</th>
<th align="right">Expectation.Value</th>
<th align="right">Percolator.q.Value</th>
<th align="right">Percolator.PEP</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="left">False</td>
<td align="left">High</td>
<td align="left">Mascot (O4)</td>
<td align="left">Unambiguous</td>
<td align="left">[K].gFQQILAGEYDHLPEQAFYMVGPIEEAVAk.[A]</td>
<td align="left">N-Term(TMT6plex); K30(TMT6plex)</td>
<td align="left"></td>
<td align="right">1</td>
<td align="right">1</td>
<td align="left">P06576</td>
<td align="left">ATP synthase subunit beta, mitochondrial OS=Homo sapiens GN=ATP5B PE=1 SV=3</td>
<td align="left">P06576</td>
<td align="left">ATP synthase subunit beta, mitochondrial OS=Homo sapiens GN=ATP5B PE=1 SV=3</td>
<td align="right">0</td>
<td align="right">3</td>
<td align="right">1.0000</td>
<td align="right">0</td>
<td align="right">1</td>
<td align="right">1</td>
<td align="right">1270.3249</td>
<td align="right">3808.960</td>
<td align="right">3808.966</td>
<td align="right">-1.51</td>
<td align="right">-0.00192</td>
<td align="left">CID</td>
<td align="left">MS2</td>
<td align="right">47.955590</td>
<td align="right">8.7</td>
<td align="right">50.000</td>
<td align="right">212.2487</td>
<td align="right">112815</td>
<td align="left">161117_SILAC_HeLa_UPS1_TMT10_Mixture1_03.raw</td>
<td align="left">F1</td>
<td align="right">2548.326</td>
<td align="right">3231.929</td>
<td align="right">2760.839</td>
<td align="right">4111.639</td>
<td align="right">3127.254</td>
<td align="right">1874.163</td>
<td align="right">2831.423</td>
<td align="right">2298.401</td>
<td align="right">3798.876</td>
<td align="right">3739.067</td>
<td align="left">NA</td>
<td align="right">90</td>
<td align="right">28</td>
<td align="right">21</td>
<td align="right">0.0000000</td>
<td align="right">0</td>
<td align="right">0.0000140</td>
</tr>
<tr class="even">
<td align="left">False</td>
<td align="left">High</td>
<td align="left">Mascot (K2)</td>
<td align="left">Unambiguous</td>
<td align="left">[R].qYPWGVAEVENGEHcDFTILr.[N]</td>
<td align="left">N-Term(TMT6plex); C15(Carbamidomethyl); R21(Label:13C(6)15N(4))</td>
<td align="left"></td>
<td align="right">1</td>
<td align="right">1</td>
<td align="left">Q16181</td>
<td align="left">Septin-7 OS=Homo sapiens GN=SEPT7 PE=1 SV=2</td>
<td align="left">Q16181</td>
<td align="left">Septin-7 OS=Homo sapiens GN=SEPT7 PE=1 SV=2</td>
<td align="right">0</td>
<td align="right">3</td>
<td align="right">1.0000</td>
<td align="right">0</td>
<td align="right">1</td>
<td align="right">1</td>
<td align="right">920.4493</td>
<td align="right">2759.333</td>
<td align="right">2759.332</td>
<td align="right">0.31</td>
<td align="right">0.00028</td>
<td align="left">CID</td>
<td align="left">MS2</td>
<td align="right">9.377507</td>
<td align="right">8.1</td>
<td align="right">3.242</td>
<td align="right">164.7507</td>
<td align="right">87392</td>
<td align="left">161117_SILAC_HeLa_UPS1_TMT10_Mixture3_03.raw</td>
<td align="left">F5</td>
<td align="right">22861.765</td>
<td align="right">25817.946</td>
<td align="right">23349.498</td>
<td align="right">29449.609</td>
<td align="right">25995.929</td>
<td align="right">22955.769</td>
<td align="right">30578.971</td>
<td align="right">30660.488</td>
<td align="right">38728.853</td>
<td align="right">25047.280</td>
<td align="left">NA</td>
<td align="right">76</td>
<td align="right">24</td>
<td align="right">17</td>
<td align="right">0.0000001</td>
<td align="right">0</td>
<td align="right">0.0000003</td>
</tr>
<tr class="odd">
<td align="left">False</td>
<td align="left">High</td>
<td align="left">Mascot (K2)</td>
<td align="left">Unambiguous</td>
<td align="left">[R].dkPSVEPVEEYDYEDLk.[E]</td>
<td align="left">N-Term(TMT6plex); K2(Label); K17(Label)</td>
<td align="left"></td>
<td align="right">1</td>
<td align="right">1</td>
<td align="left">Q9Y450</td>
<td align="left">HBS1-like protein OS=Homo sapiens GN=HBS1L PE=1 SV=1</td>
<td align="left">Q9Y450</td>
<td align="left">HBS1-like protein OS=Homo sapiens GN=HBS1L PE=1 SV=1</td>
<td align="right">1</td>
<td align="right">3</td>
<td align="right">0.9730</td>
<td align="right">0</td>
<td align="right">1</td>
<td align="right">1</td>
<td align="right">920.1605</td>
<td align="right">2758.467</td>
<td align="right">2758.461</td>
<td align="right">2.08</td>
<td align="right">0.00192</td>
<td align="left">CID</td>
<td align="left">MS2</td>
<td align="right">38.317050</td>
<td align="right">17.8</td>
<td align="right">13.596</td>
<td align="right">143.4534</td>
<td align="right">74786</td>
<td align="left">161117_SILAC_HeLa_UPS1_TMT10_Mixture3_03.raw</td>
<td align="left">F5</td>
<td align="right">25504.083</td>
<td align="right">27740.450</td>
<td align="right">25144.974</td>
<td align="right">25754.579</td>
<td align="right">29923.176</td>
<td align="right">34097.637</td>
<td align="right">31650.255</td>
<td align="right">27632.692</td>
<td align="right">23886.881</td>
<td align="right">35331.092</td>
<td align="left">NA</td>
<td align="right">74</td>
<td align="right">30</td>
<td align="right">23</td>
<td align="right">0.0000004</td>
<td align="right">0</td>
<td align="right">0.0000010</td>
</tr>
<tr class="even">
<td align="left">False</td>
<td align="left">High</td>
<td align="left">Mascot (F2)</td>
<td align="left">Selected</td>
<td align="left">[R].hEHQVMLmr.[Q]</td>
<td align="left">N-Term(TMT6plex); M8(Oxidation); R9(Label:13C(6)15N(4))</td>
<td align="left"></td>
<td align="right">1</td>
<td align="right">1</td>
<td align="left">Q15233</td>
<td align="left">Non-POU domain-containing octamer-binding protein OS=Homo sapiens GN=NONO PE=1 SV=4</td>
<td align="left">Q15233</td>
<td align="left">Non-POU domain-containing octamer-binding protein OS=Homo sapiens GN=NONO PE=1 SV=4</td>
<td align="right">0</td>
<td align="right">4</td>
<td align="right">0.5250</td>
<td align="right">0</td>
<td align="right">1</td>
<td align="right">1</td>
<td align="right">359.6898</td>
<td align="right">1435.737</td>
<td align="right">1435.738</td>
<td align="right">-0.04</td>
<td align="right">-0.00002</td>
<td align="left">CID</td>
<td align="left">MS2</td>
<td align="right">21.390040</td>
<td align="right">36.5</td>
<td align="right">50.000</td>
<td align="right">21.6426</td>
<td align="right">6458</td>
<td align="left">161117_SILAC_HeLa_UPS1_TMT10_Mixture4_02.raw</td>
<td align="left">F10</td>
<td align="right">13493.228</td>
<td align="right">14674.490</td>
<td align="right">11187.900</td>
<td align="right">12831.495</td>
<td align="right">13839.426</td>
<td align="right">12441.353</td>
<td align="right">13450.885</td>
<td align="right">14777.844</td>
<td align="right">13039.995</td>
<td align="right">12057.121</td>
<td align="left">NA</td>
<td align="right">40</td>
<td align="right">25</td>
<td align="right">18</td>
<td align="right">0.0003351</td>
<td align="right">0</td>
<td align="right">0.0001175</td>
</tr>
<tr class="odd">
<td align="left">False</td>
<td align="left">High</td>
<td align="left">Mascot (K2)</td>
<td align="left">Unambiguous</td>
<td align="left">[R].dNLTLWTADNAGEEGGEAPQEPQS.[-]</td>
<td align="left">N-Term(TMT6plex)</td>
<td align="left"></td>
<td align="right">1</td>
<td align="right">1</td>
<td align="left">P31947</td>
<td align="left">14-3-3 protein sigma OS=Homo sapiens GN=SFN PE=1 SV=1</td>
<td align="left">P31947</td>
<td align="left">14-3-3 protein sigma OS=Homo sapiens GN=SFN PE=1 SV=1</td>
<td align="right">0</td>
<td align="right">3</td>
<td align="right">1.0000</td>
<td align="right">0</td>
<td align="right">1</td>
<td align="right">1</td>
<td align="right">920.0943</td>
<td align="right">2758.268</td>
<td align="right">2758.264</td>
<td align="right">1.53</td>
<td align="right">0.00141</td>
<td align="left">CID</td>
<td align="left">MS2</td>
<td align="right">0.000000</td>
<td align="right">16.7</td>
<td align="right">6.723</td>
<td align="right">174.1863</td>
<td align="right">92950</td>
<td align="left">161117_SILAC_HeLa_UPS1_TMT10_Mixture3_03.raw</td>
<td align="left">F5</td>
<td align="right">64582.786</td>
<td align="right">50576.417</td>
<td align="right">47126.037</td>
<td align="right">56285.129</td>
<td align="right">46257.310</td>
<td align="right">52634.885</td>
<td align="right">49716.850</td>
<td align="right">60660.574</td>
<td align="right">55830.488</td>
<td align="right">40280.577</td>
<td align="left">NA</td>
<td align="right">38</td>
<td align="right">21</td>
<td align="right">14</td>
<td align="right">0.0002153</td>
<td align="right">0</td>
<td align="right">0.0000138</td>
</tr>
<tr class="even">
<td align="left">False</td>
<td align="left">High</td>
<td align="left">Mascot (K2)</td>
<td align="left">Unambiguous</td>
<td align="left">[R].aLVAIGTHDLDTLSGPFTYTAk.[R]</td>
<td align="left">N-Term(TMT6plex); K22(Label)</td>
<td align="left"></td>
<td align="right">1</td>
<td align="right">1</td>
<td align="left">Q9NSD9</td>
<td align="left">Phenylalanine–tRNA ligase beta subunit OS=Homo sapiens GN=FARSB PE=1 SV=3</td>
<td align="left">Q9NSD9</td>
<td align="left">Phenylalanine–tRNA ligase beta subunit OS=Homo sapiens GN=FARSB PE=1 SV=3</td>
<td align="right">0</td>
<td align="right">3</td>
<td align="right">0.9783</td>
<td align="right">0</td>
<td align="right">1</td>
<td align="right">1</td>
<td align="right">919.8502</td>
<td align="right">2757.536</td>
<td align="right">2757.532</td>
<td align="right">1.48</td>
<td align="right">0.00136</td>
<td align="left">CID</td>
<td align="left">MS2</td>
<td align="right">30.619960</td>
<td align="right">26.7</td>
<td align="right">8.958</td>
<td align="right">176.4863</td>
<td align="right">94294</td>
<td align="left">161117_SILAC_HeLa_UPS1_TMT10_Mixture3_03.raw</td>
<td align="left">F5</td>
<td align="right">35404.709</td>
<td align="right">31905.852</td>
<td align="right">30993.941</td>
<td align="right">36854.351</td>
<td align="right">37506.001</td>
<td align="right">25703.444</td>
<td align="right">38626.598</td>
<td align="right">35447.942</td>
<td align="right">33788.409</td>
<td align="right">32031.516</td>
<td align="left">NA</td>
<td align="right">46</td>
<td align="right">29</td>
<td align="right">22</td>
<td align="right">0.0002060</td>
<td align="right">0</td>
<td align="right">0.0000720</td>
</tr>
</tbody>
</table>
<p><strong>TODO</strong>: explain reading peptide and protein tables.</p>
</div>
<div id="sec-annotation_table" class="section level4" number="2.3.1.3">
<h4>
<span class="header-section-number">2.3.1.3</span> The sample annotation table</h4>
<p>The annotation table should be generated by the researcher and
provides information about Without an annotation table, no analysis
can be performed. Note that annotations are sometimes extracted from
the column names, but reporting a detailed design of experiments in a
table is seen as better practice <span class="citation">(<label for="tufte-mn-5" class="margin-toggle">⊕</label><input type="checkbox" id="tufte-mn-5" class="margin-toggle">Gatto et al. 2023<span class="marginnote">Gatto, Laurent, Ruedi Aebersold, Juergen Cox, Vadim Demichev, Jason Derks, Edward Emmott, Alexander M Franks, et al. 2023. <span>“Initial Recommendations for Performing, Benchmarking and Reporting Single-Cell Proteomics Experiments.”</span> <em>Nat. Methods</em> 20 (3): 375–86.</span>)</span>.</p>
<p>The annotation table used in this tutorial has been generated by the
authors, and we perform an additional little cleanup for concise
output.</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb7-1"><a href="sec-concepts.html#cb7-1" tabindex="-1"></a>coldata <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(annotFile)</span>
<span id="cb7-2"><a href="sec-concepts.html#cb7-2" tabindex="-1"></a><span class="do">## Lines below are optional</span></span>
<span id="cb7-3"><a href="sec-concepts.html#cb7-3" tabindex="-1"></a>coldata <span class="ot">&lt;-</span> coldata[, <span class="fu">c</span>(<span class="st">"Run"</span>, <span class="st">"Channel"</span>, <span class="st">"Condition"</span>, <span class="st">"Mixture"</span>, <span class="st">"TechRepMixture"</span>)]</span>
<span id="cb7-4"><a href="sec-concepts.html#cb7-4" tabindex="-1"></a>coldata<span class="sc">$</span>File.Name <span class="ot">&lt;-</span> coldata<span class="sc">$</span>Run</span>
<span id="cb7-5"><a href="sec-concepts.html#cb7-5" tabindex="-1"></a>coldata<span class="sc">$</span>Run <span class="ot">&lt;-</span> <span class="fu">sub</span>(<span class="st">"^.*(Mix.*).raw"</span>, <span class="st">"</span><span class="sc">\\</span><span class="st">1"</span>, coldata<span class="sc">$</span>Run)</span></code></pre></div>
<table>
<colgroup>
<col width="12%">
<col width="8%">
<col width="10%">
<col width="9%">
<col width="15%">
<col width="45%">
</colgroup>
<thead><tr class="header">
<th align="left">Run</th>
<th align="left">Channel</th>
<th align="left">Condition</th>
<th align="left">Mixture</th>
<th align="right">TechRepMixture</th>
<th align="left">File.Name</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="left">Mixture1_01</td>
<td align="left">126</td>
<td align="left">Norm</td>
<td align="left">Mixture1</td>
<td align="right">1</td>
<td align="left">161117_SILAC_HeLa_UPS1_TMT10_Mixture1_01.raw</td>
</tr>
<tr class="even">
<td align="left">Mixture1_01</td>
<td align="left">127N</td>
<td align="left">0.667</td>
<td align="left">Mixture1</td>
<td align="right">1</td>
<td align="left">161117_SILAC_HeLa_UPS1_TMT10_Mixture1_01.raw</td>
</tr>
<tr class="odd">
<td align="left">Mixture1_01</td>
<td align="left">127C</td>
<td align="left">0.125</td>
<td align="left">Mixture1</td>
<td align="right">1</td>
<td align="left">161117_SILAC_HeLa_UPS1_TMT10_Mixture1_01.raw</td>
</tr>
<tr class="even">
<td align="left">Mixture1_01</td>
<td align="left">128N</td>
<td align="left">0.5</td>
<td align="left">Mixture1</td>
<td align="right">1</td>
<td align="left">161117_SILAC_HeLa_UPS1_TMT10_Mixture1_01.raw</td>
</tr>
<tr class="odd">
<td align="left">Mixture1_01</td>
<td align="left">128C</td>
<td align="left">1</td>
<td align="left">Mixture1</td>
<td align="right">1</td>
<td align="left">161117_SILAC_HeLa_UPS1_TMT10_Mixture1_01.raw</td>
</tr>
<tr class="even">
<td align="left">Mixture1_01</td>
<td align="left">129N</td>
<td align="left">0.125</td>
<td align="left">Mixture1</td>
<td align="right">1</td>
<td align="left">161117_SILAC_HeLa_UPS1_TMT10_Mixture1_01.raw</td>
</tr>
</tbody>
</table>
</div>
<div id="custom-subseting" class="section level4" number="2.3.1.4">
<h4>
<span class="header-section-number">2.3.1.4</span> Custom subseting</h4>
<p>There is a peculiarity with the dataset: the spectra have been
identified with 2 nodes. In one node, the authors searched the
SwissProt database for proteins with static modifications related to
the metabolic labelling, in the other node they searched the Sigma_UPS
protein database without these static modifications. However, some
spectra were identified by both nodes leading to duplicate PSMs. We
here remove these duplicated PSMs that are identification artefacts.</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb8-1"><a href="sec-concepts.html#cb8-1" tabindex="-1"></a>duplicatesQuants <span class="ot">&lt;-</span> <span class="fu">duplicated</span>(psms[, qcols]) <span class="sc">|</span> <span class="fu">duplicated</span>(psms[, qcols], <span class="at">fromLast =</span> <span class="cn">TRUE</span>)</span>
<span id="cb8-2"><a href="sec-concepts.html#cb8-2" tabindex="-1"></a>psms <span class="ot">&lt;-</span> psms[<span class="sc">!</span>duplicatesQuants, ]</span></code></pre></div>
<p>We will also subset the data set to reduce computational costs. If you
want to run the analysis on the full data set, you can skip this code
chunk. The subsetting will keep all UPS proteins, known to be
differentially abundant by experimental design, and we will keep 500
background proteins known to be unchanged across condition.</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb9-1"><a href="sec-concepts.html#cb9-1" tabindex="-1"></a>allProteins <span class="ot">&lt;-</span> <span class="fu">unique</span>(psms<span class="sc">$</span>Protein.Accessions)</span>
<span id="cb9-2"><a href="sec-concepts.html#cb9-2" tabindex="-1"></a>upsProteins <span class="ot">&lt;-</span> <span class="fu">grep</span>(<span class="st">"ups"</span>, allProteins, <span class="at">value =</span> <span class="cn">TRUE</span>)</span>
<span id="cb9-3"><a href="sec-concepts.html#cb9-3" tabindex="-1"></a>helaProteins <span class="ot">&lt;-</span> <span class="fu">grep</span>(<span class="st">"ups"</span>, allProteins, <span class="at">value =</span> <span class="cn">TRUE</span>, <span class="at">invert =</span> <span class="cn">TRUE</span>)</span>
<span id="cb9-4"><a href="sec-concepts.html#cb9-4" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">1234</span>)</span>
<span id="cb9-5"><a href="sec-concepts.html#cb9-5" tabindex="-1"></a>keepProteins <span class="ot">&lt;-</span> <span class="fu">c</span>(upsProteins, <span class="fu">sample</span>(helaProteins, <span class="dv">500</span>))</span>
<span id="cb9-6"><a href="sec-concepts.html#cb9-6" tabindex="-1"></a>psms <span class="ot">&lt;-</span> psms[psms<span class="sc">$</span>Protein.Accessions <span class="sc">%in%</span> keepProteins, ]</span></code></pre></div>
</div>
</div>
<div id="sec-qfeatures" class="section level3" number="2.3.2">
<h3>
<span class="header-section-number">2.3.2</span> The QFeatures class<div class="tooltip"><button class="internal-link-btn" onclick="copy_link('sec-qfeatures')" onmouseout="reset_tooltip('sec-qfeatures-tooltip')"><span class="tooltiptext" id="sec-qfeatures-tooltip">Copy link</span><i class="fa fa-link"></i></button></div>
</h3>
<p><code>msqrob2</code> is built around the <code>QFeatures</code> class. We refer to the <a href="https://rformassspectrometry.github.io/book/sec-quant.html">R
for mass spectrometry
book</a> for
a comprehensive description of the class. In a nutshell, the
<code>QFeatures</code> package provides infrastructure to manage and analyse
quantitative features from mass spectrometry experiments. It is based
on the <code>SummarizedExperiment</code> and <code>MultiAssayExperiment</code> classes. It
leverages the hierarchical structure of proteomics experiments: data
proteins are composed of peptides, themselves produced by spectra.
Each pieces of information in stored in an individual
<code>SummarizedExperiment</code> object, later referred to as a “set”.
Throughout the aggregation and processing of these data, the relations
between sets are tracked and recorded, thus allowing users to easily
navigate across spectra, peptide and protein quantitative data.</p>
<div class="figure">
<span style="display:block;" id="fig:unnamed-chunk-11"></span>
<p class="caption marginnote shownote">
Figure 2.1: Illustration of the <code>QFeatures</code> data class.
</p>
<img src="figs/QFeatures.png" alt="Illustration of the `QFeatures` data class." width="80%">
</div>
<p>The <code>readQFeatures()</code> allows for seamless conversion of tabular data
into a <code>QFeatures</code> object. In order to link the annotation table with
the PSM data (from the Skyline evidence table), the annotation table
must contain a <code>runCol</code> column with run names to be matched with the
run names in the PSM table (for Skyline, it is stored in the
<code>Spectrum.File</code> column). We also add a <code>quantCols</code> column in the
annotation table. It will allow to link each sample to the
quantification column in the PSM table. See <code>?readQFeatures()</code> for
more details.</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb10-1"><a href="sec-concepts.html#cb10-1" tabindex="-1"></a>coldata<span class="sc">$</span>runCol <span class="ot">&lt;-</span> coldata<span class="sc">$</span>File.Name</span>
<span id="cb10-2"><a href="sec-concepts.html#cb10-2" tabindex="-1"></a>coldata<span class="sc">$</span>quantCols <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">"Abundance.."</span>, coldata<span class="sc">$</span>Channel)</span>
<span id="cb10-3"><a href="sec-concepts.html#cb10-3" tabindex="-1"></a>(spikein <span class="ot">&lt;-</span> <span class="fu">readQFeatures</span>(</span>
<span id="cb10-4"><a href="sec-concepts.html#cb10-4" tabindex="-1"></a>  psms, <span class="at">colData =</span> coldata,</span>
<span id="cb10-5"><a href="sec-concepts.html#cb10-5" tabindex="-1"></a>  <span class="at">quantCols =</span> qcols,</span>
<span id="cb10-6"><a href="sec-concepts.html#cb10-6" tabindex="-1"></a>  <span class="at">runCol =</span> <span class="st">"Spectrum.File"</span>, <span class="at">name =</span> <span class="st">"psms"</span></span>
<span id="cb10-7"><a href="sec-concepts.html#cb10-7" tabindex="-1"></a>))</span></code></pre></div>
<pre><code>## An instance of class QFeatures (type: bulk) with 15 sets:
## 
##  [1] 161117_SILAC_HeLa_UPS1_TMT10_Mixture1_01.raw: SummarizedExperiment with 1905 rows and 10 columns 
##  [2] 161117_SILAC_HeLa_UPS1_TMT10_Mixture1_02.raw: SummarizedExperiment with 1902 rows and 10 columns 
##  [3] 161117_SILAC_HeLa_UPS1_TMT10_Mixture1_03.raw: SummarizedExperiment with 1952 rows and 10 columns 
##  ...
##  [13] 161117_SILAC_HeLa_UPS1_TMT10_Mixture5_01.raw: SummarizedExperiment with 1919 rows and 10 columns 
##  [14] 161117_SILAC_HeLa_UPS1_TMT10_Mixture5_02.raw: SummarizedExperiment with 1909 rows and 10 columns 
##  [15] 161117_SILAC_HeLa_UPS1_TMT10_Mixture5_03.raw: SummarizedExperiment with 1844 rows and 10 columns</code></pre>
<p>We now have a <code>QFeatures</code> object with 15 sets, each containing data
associated with an MS run. The name of each set is defined by the name
of the corresponding file name of the run, which rather unnecessarily
long. We simplify the set names, although this step is optional and
only meant to improve the clarity of the output.</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb12-1"><a href="sec-concepts.html#cb12-1" tabindex="-1"></a><span class="fu">names</span>(spikein) <span class="ot">&lt;-</span> <span class="fu">sub</span>(<span class="st">"^.*(Mix.*).raw"</span>, <span class="st">"</span><span class="sc">\\</span><span class="st">1"</span>, <span class="fu">names</span>(spikein))</span>
<span id="cb12-2"><a href="sec-concepts.html#cb12-2" tabindex="-1"></a>spikein</span></code></pre></div>
<pre><code>## An instance of class QFeatures (type: bulk) with 15 sets:
## 
##  [1] Mixture1_01: SummarizedExperiment with 1905 rows and 10 columns 
##  [2] Mixture1_02: SummarizedExperiment with 1902 rows and 10 columns 
##  [3] Mixture1_03: SummarizedExperiment with 1952 rows and 10 columns 
##  ...
##  [13] Mixture5_01: SummarizedExperiment with 1919 rows and 10 columns 
##  [14] Mixture5_02: SummarizedExperiment with 1909 rows and 10 columns 
##  [15] Mixture5_03: SummarizedExperiment with 1844 rows and 10 columns</code></pre>
</div>
</div>
<div id="data-preprocessing" class="section level2" number="2.4">
<h2>
<span class="header-section-number">2.4</span> Data preprocessing<div class="tooltip"><button class="internal-link-btn" onclick="copy_link('data-preprocessing')" onmouseout="reset_tooltip('data-preprocessing-tooltip')"><span class="tooltiptext" id="data-preprocessing-tooltip">Copy link</span><i class="fa fa-link"></i></button></div>
</h2>
<p>Since we have a <code>QFeatures</code> object, we can directly make use of
<code>QFeatures</code>’ data preprocessing functionality. Again, we refer to the
<a href="https://rformassspectrometry.github.io/book/sec-quant.html">R for mass spectrometry
book</a> for
an in-depth tutorial about the data preprocessing of quantitatice MS
data. We demonstrate a typical data preprocessing workflow suitable
for <code>msqrob2</code> analysis, pinpointing some steps that are specific to
the data set at hand. Indeed, a major advantage of <code>QFeatures</code> is it
provides the power to build highly modular workflows, where each step
carried out by a dedicated function with a large choice of available
methods and parameters. This means that users can adapt the workflow
to their specific use case and their specific needs.</p>
<div id="encoding-missing-values" class="section level3" number="2.4.1">
<h3>
<span class="header-section-number">2.4.1</span> Encoding missing values<div class="tooltip"><button class="internal-link-btn" onclick="copy_link('encoding-missing-values')" onmouseout="reset_tooltip('encoding-missing-values-tooltip')"><span class="tooltiptext" id="encoding-missing-values-tooltip">Copy link</span><i class="fa fa-link"></i></button></div>
</h3>
<p>The first preprocessing step is to correctly encode the missing
values. It is important that missing values are encoded using <code>NA</code>.
For instance, in MS experiments, non-observed values should not be
encoded with a zero. This is because true zeros (the proteomic feature
is absent from the sample) cannot be distinguished from technical
zeros (the feature was missed by the instrument or could not be
identified). We therefore replace any zero in the quantitative data
with an <code>NA</code>.</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb14-1"><a href="sec-concepts.html#cb14-1" tabindex="-1"></a>spikein <span class="ot">&lt;-</span> <span class="fu">zeroIsNA</span>(spikein, <span class="fu">names</span>(spikein))</span></code></pre></div>
<p>Note that <code>msqrob2</code> can handle missing data without having to rely on
hard-to-verify imputation assumptions. However, <code>msqrob2</code> does not
block users from using imputation, which can be used performed with
<code>impute()</code> from the <code>QFeatures</code> package. Below, we show how one could
perform KNN imputation (see <code>?impute</code> for more options), but note that
we will note evaluate the code in this tutorial to exclude imputation
from the current workflow.</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb15-1"><a href="sec-concepts.html#cb15-1" tabindex="-1"></a>spikein <span class="ot">&lt;-</span> <span class="fu">impute</span>(</span>
<span id="cb15-2"><a href="sec-concepts.html#cb15-2" tabindex="-1"></a>    spikein, <span class="at">method =</span> <span class="st">"knn"</span>,</span>
<span id="cb15-3"><a href="sec-concepts.html#cb15-3" tabindex="-1"></a>    <span class="at">i =</span> <span class="fu">names</span>(spikein), <span class="at">name =</span> <span class="fu">paste0</span>(<span class="fu">names</span>(spikein), <span class="st">"_imput"</span>)</span>
<span id="cb15-4"><a href="sec-concepts.html#cb15-4" tabindex="-1"></a>)</span></code></pre></div>
<p><strong>TODO</strong> mention the hurdle model here?</p>
</div>
<div id="sample-filtering" class="section level3" number="2.4.2">
<h3>
<span class="header-section-number">2.4.2</span> Sample filtering<div class="tooltip"><button class="internal-link-btn" onclick="copy_link('sample-filtering')" onmouseout="reset_tooltip('sample-filtering-tooltip')"><span class="tooltiptext" id="sample-filtering-tooltip">Copy link</span><i class="fa fa-link"></i></button></div>
</h3>
<p>We first remove the reference channels. These channels were used by
the MSstatsTMT authors to obtain normalisation factors <span class="citation">(<label for="tufte-mn-6" class="margin-toggle">⊕</label><input type="checkbox" id="tufte-mn-6" class="margin-toggle">Huang et al. 2020<span class="marginnote">Huang, Ting, Meena Choi, Manuel Tzouros, Sabrina Golling, Nikhil Janak Pandya, Balazs Banfai, Tom Dunkley, and Olga Vitek. 2020. <span>“<span>MSstatsTMT</span>: Statistical Detection of Differentially Abundant Proteins in Experiments with Isobaric Labeling and Multiple Mixtures.”</span> <em>Mol. Cell. Proteomics</em> 19 (10): 1706–23.</span>)</span>. However, this
approach ignores the uncertainty associated with the measurement with
these channels, potentially inflating the noise in the samples of
interest. Hence, <code>msqrob2</code> workflows do not use reference
channels. In practice, we found no impact of reference channel
normalisation on model performance <span class="citation">(<label for="tufte-mn-7" class="margin-toggle">⊕</label><input type="checkbox" id="tufte-mn-7" class="margin-toggle">Vandenbulcke et al. 2025<span class="marginnote">Vandenbulcke, Stijn, Christophe Vanderaa, Oliver Crook, Lennart Martens, and Lieven Clement. 2025. <span>“<span>Msqrob2TMT</span>: Robust Linear Mixed Models for Inferring Differential Abundant Proteins in Labeled Experiments with Arbitrarily Complex Design.”</span> <em>Mol. Cell. Proteomics</em> 24 (7): 101002.</span>)</span>. The
information is available from the <code>colData</code>, under the <code>Condition</code>
column. We remove any sample that is marked as <code>Norm</code>.</p>
<div class="sourceCode" id="cb16"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb16-1"><a href="sec-concepts.html#cb16-1" tabindex="-1"></a>spikein <span class="ot">&lt;-</span> <span class="fu">subsetByColData</span>(spikein, spikein<span class="sc">$</span>Condition <span class="sc">!=</span> <span class="st">"Norm"</span>)</span></code></pre></div>
</div>
<div id="sec-filter" class="section level3" number="2.4.3">
<h3>
<span class="header-section-number">2.4.3</span> PSM filtering<div class="tooltip"><button class="internal-link-btn" onclick="copy_link('sec-filter')" onmouseout="reset_tooltip('sec-filter-tooltip')"><span class="tooltiptext" id="sec-filter-tooltip">Copy link</span><i class="fa fa-link"></i></button></div>
</h3>
<p>Filter removes low-quality and unreliable PSMs that would otherwise
introduce noise and artefacts in the data. We use <code>filterFeatures()</code>
to perform the filtering. It uses information from the <code>rowData</code> and a
formula to generate a filter for each feature (row) in each set across
the object. If the filter returns <code>TRUE</code>, the corresponding row is
retained, otherwise it is removed. Defining a filter through a formula
offers a flexible approach, allowing for any customised filter. This
dataset requires an extensive PSM filtering which is an ideal use case
to demonstrate the customisation of a filtering workflow.</p>
<p><strong>TODO</strong>: use some of the QFeaturesGUI functions?</p>
<div id="remove-ambiguous-identifications" class="section level4" number="2.4.3.1">
<h4>
<span class="header-section-number">2.4.3.1</span> Remove ambiguous identifications</h4>
<p>The background proteins originate from HeLa cells, which also contain
UPS proteins. The background UPS proteins and the spiked-in UPS
proteins differ in metabolic labelling, so we should be able to
distinguish them. We used the PSM-level data searched with mascot, as
provided by the MSstatsTMT authors who used two mascot identification
nodes. In one node they searched the SwissProt database for proteins
with static modifications related to the metabolic labelling, in the
other node they searched the Sigma_UPS protein database without these
static modifications. Ideally, this should separate the spiked-in UPS
proteins and the UPS proteins from the HeLa cells, however, this is
not always the case. The SwissProt search is expected to return
peptide-spectrum matches (PSMs) for all proteins, including non-UPS
HeLa, UPS HeLa, and spike-in UPS proteins. Conversely, the Sigma_UPS
search is expected to return PSMs exclusively for spike-in UPS
proteins. However, a PSM that matches a UPS protein in the SwissProt
search but is not identified as such in the Sigma_UPS search could
either correctly originate from a HeLa protein or represent a
spiked-in UPS protein that was not recognised as such in the Sigma_UPS
search. Additionally, there are ambiguous PSMs that are not matched to
a UPS protein in the HeLa search but are matched to a UPS protein in
the SwissProt search. To address this, we exclude these ambiguous
proteins from the analysis.</p>
<p>To define amibiguous PSMs, we retrieve the PSM annotations from the
<code>rowData</code> and create a new colum indicating whether a PSM belongs to a
UPS protein or not, based on the protein SwissProt identifiers. For
this, we first need to:</p>
<ol style="list-style-type: decimal">
<li>Combine all the <code>rowData</code> information in a single table</li>
<li>Define whether the PSM’s protein group is a UPS protein</li>
<li>Define an ambiguous PSM as a PSM that is marked as UPS by the
SwissProt identifier but not by the Sigma_UPS node (<code>Marked.as</code>
column), and inversely.</li>
<li>Inject this information back in the <code>rowData</code> of the different sets</li>
<li>Apply the filter</li>
</ol>
<div class="sourceCode" id="cb17"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb17-1"><a href="sec-concepts.html#cb17-1" tabindex="-1"></a><span class="do">## 1.</span></span>
<span id="cb17-2"><a href="sec-concepts.html#cb17-2" tabindex="-1"></a>rowdata <span class="ot">&lt;-</span> <span class="fu">rbindRowData</span>(spikein, <span class="fu">names</span>(spikein))</span>
<span id="cb17-3"><a href="sec-concepts.html#cb17-3" tabindex="-1"></a><span class="do">## 2.</span></span>
<span id="cb17-4"><a href="sec-concepts.html#cb17-4" tabindex="-1"></a>rowdata<span class="sc">$</span>isUps <span class="ot">&lt;-</span> <span class="st">"no"</span></span>
<span id="cb17-5"><a href="sec-concepts.html#cb17-5" tabindex="-1"></a>isUpsProtein <span class="ot">&lt;-</span> <span class="fu">grepl</span>(<span class="st">"ups"</span>, rowdata<span class="sc">$</span>Protein.Accessions)</span>
<span id="cb17-6"><a href="sec-concepts.html#cb17-6" tabindex="-1"></a>rowdata<span class="sc">$</span>isUps[isUpsProtein] <span class="ot">&lt;-</span> <span class="st">"yes"</span></span>
<span id="cb17-7"><a href="sec-concepts.html#cb17-7" tabindex="-1"></a><span class="do">## 3.</span></span>
<span id="cb17-8"><a href="sec-concepts.html#cb17-8" tabindex="-1"></a>rowdata<span class="sc">$</span>isUps[<span class="sc">!</span>isUpsProtein <span class="sc">&amp;</span> <span class="fu">grepl</span>(<span class="st">"UPS"</span>, rowdata<span class="sc">$</span>Marked.as)] <span class="ot">&lt;-</span> <span class="st">"amb"</span></span>
<span id="cb17-9"><a href="sec-concepts.html#cb17-9" tabindex="-1"></a>rowdata<span class="sc">$</span>isUps[isUpsProtein <span class="sc">&amp;</span> <span class="sc">!</span><span class="fu">grepl</span>(<span class="st">"UPS"</span>, rowdata<span class="sc">$</span>Marked.as)] <span class="ot">&lt;-</span> <span class="st">"amb"</span></span>
<span id="cb17-10"><a href="sec-concepts.html#cb17-10" tabindex="-1"></a><span class="do">## 4.</span></span>
<span id="cb17-11"><a href="sec-concepts.html#cb17-11" tabindex="-1"></a><span class="fu">rowData</span>(spikein) <span class="ot">&lt;-</span> <span class="fu">split</span>(rowdata, rowdata<span class="sc">$</span>assay)</span>
<span id="cb17-12"><a href="sec-concepts.html#cb17-12" tabindex="-1"></a><span class="do">## 5. </span></span>
<span id="cb17-13"><a href="sec-concepts.html#cb17-13" tabindex="-1"></a>spikein <span class="ot">&lt;-</span> <span class="fu">filterFeatures</span>(spikein, <span class="sc">~</span> isUps <span class="sc">!=</span> <span class="st">"amb"</span>)</span></code></pre></div>
</div>
<div id="remove-failed-protein-inference" class="section level4" number="2.4.3.2">
<h4>
<span class="header-section-number">2.4.3.2</span> Remove failed protein inference</h4>
<p>Next, we remove PSMs that could not be mapped to a protein or that map
to multiple proteins, i.e. a protein group. For the latter, the
protein identifier contains multiple identifiers separated by a <code>;</code>).</p>
<div class="sourceCode" id="cb18"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb18-1"><a href="sec-concepts.html#cb18-1" tabindex="-1"></a>spikein <span class="ot">&lt;-</span> <span class="fu">filterFeatures</span>(</span>
<span id="cb18-2"><a href="sec-concepts.html#cb18-2" tabindex="-1"></a>    spikein, <span class="sc">~</span> Protein.Accessions <span class="sc">!=</span> <span class="st">""</span> <span class="sc">&amp;</span> <span class="do">## Remove failed protein inference</span></span>
<span id="cb18-3"><a href="sec-concepts.html#cb18-3" tabindex="-1"></a>        <span class="sc">!</span><span class="fu">grepl</span>(<span class="st">";"</span>, Protein.Accessions)) <span class="do">## Remove protein groups</span></span></code></pre></div>
</div>
<div id="remove-inconsistent-protein-inference" class="section level4" number="2.4.3.3">
<h4>
<span class="header-section-number">2.4.3.3</span> Remove inconsistent protein inference</h4>
<p>We also remove peptide ions that map to a different protein depending
on the run.</p>
<div class="sourceCode" id="cb19"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb19-1"><a href="sec-concepts.html#cb19-1" tabindex="-1"></a>rowdata <span class="ot">&lt;-</span> <span class="fu">rbindRowData</span>(spikein, <span class="fu">names</span>(spikein))</span>
<span id="cb19-2"><a href="sec-concepts.html#cb19-2" tabindex="-1"></a>rowdata <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(rowdata) <span class="sc">|&gt;</span></span>
<span id="cb19-3"><a href="sec-concepts.html#cb19-3" tabindex="-1"></a>    <span class="fu">group_by</span>(Annotated.Sequence, Charge) <span class="sc">|&gt;</span></span>
<span id="cb19-4"><a href="sec-concepts.html#cb19-4" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">nProtsMapped =</span> <span class="fu">length</span>(<span class="fu">unique</span>(Protein.Accessions)))</span>
<span id="cb19-5"><a href="sec-concepts.html#cb19-5" tabindex="-1"></a><span class="fu">rowData</span>(spikein) <span class="ot">&lt;-</span> <span class="fu">split</span>(rowdata, rowdata<span class="sc">$</span>assay)</span>
<span id="cb19-6"><a href="sec-concepts.html#cb19-6" tabindex="-1"></a>spikein <span class="ot">&lt;-</span> <span class="fu">filterFeatures</span>(spikein, <span class="sc">~</span> nProtsMapped <span class="sc">==</span> <span class="dv">1</span>)</span></code></pre></div>
</div>
<div id="remove-one-run-wonders" class="section level4" number="2.4.3.4">
<h4>
<span class="header-section-number">2.4.3.4</span> Remove one-run wonders</h4>
<p>We also remove proteins that can only be found in one run as such
proteins may not be trustworthy.</p>
<div class="sourceCode" id="cb20"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb20-1"><a href="sec-concepts.html#cb20-1" tabindex="-1"></a>idProteins <span class="ot">&lt;-</span> <span class="fu">lapply</span>(<span class="fu">rowData</span>(spikein), <span class="cf">function</span>(x) <span class="fu">unique</span>(x<span class="sc">$</span>Protein.Accessions))</span>
<span id="cb20-2"><a href="sec-concepts.html#cb20-2" tabindex="-1"></a>idInNRuns <span class="ot">&lt;-</span> <span class="fu">table</span>(<span class="fu">unlist</span>(idProteins))</span>
<span id="cb20-3"><a href="sec-concepts.html#cb20-3" tabindex="-1"></a>oneRunWonders <span class="ot">&lt;-</span> <span class="fu">names</span>(idInNRuns)[idInNRuns <span class="sc">==</span> <span class="dv">1</span>]</span>
<span id="cb20-4"><a href="sec-concepts.html#cb20-4" tabindex="-1"></a>spikein <span class="ot">&lt;-</span> <span class="fu">filterFeatures</span>(spikein, <span class="sc">~</span> <span class="sc">!</span>Protein.Accessions <span class="sc">%in%</span> oneRunWonders)</span></code></pre></div>
</div>
<div id="remove-duplicated-psms" class="section level4" number="2.4.3.5">
<h4>
<span class="header-section-number">2.4.3.5</span> Remove duplicated PSMs</h4>
<p>Finally, peptide ions that were identified with multiple PSMs in a run
are collapsed to the PSM with the highest summed intensity over the
channels, a strategy that is also used by MSstats.</p>
<p>We therefore</p>
<ol style="list-style-type: decimal">
<li>Make a new variable for ionID in the rowData.</li>
<li>We calculate the <code>rowSums</code> for each ion.</li>
<li>Make a new variable <code>psmRank</code> that ranks the PSMs for each ionID
based on the summed intensity.</li>
<li>We store the new information back in the <code>rowData</code>.</li>
<li>For each ion that maps to multiple PSMs, only keep the PSM with the
highest summed intensity, that is that ranks first.</li>
<li>Filter ions for which the rowSum equals 0.</li>
</ol>
<div class="sourceCode" id="cb21"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb21-1"><a href="sec-concepts.html#cb21-1" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="fu">names</span>(spikein)) {</span>
<span id="cb21-2"><a href="sec-concepts.html#cb21-2" tabindex="-1"></a>    rowdata <span class="ot">&lt;-</span> <span class="fu">rowData</span>(spikein[[i]])</span>
<span id="cb21-3"><a href="sec-concepts.html#cb21-3" tabindex="-1"></a>    rowdata<span class="sc">$</span>ionID <span class="ot">&lt;-</span> <span class="fu">paste0</span>(rowdata<span class="sc">$</span>Annotated.Sequence, rowdata<span class="sc">$</span>Charge) <span class="do">## 1.</span></span>
<span id="cb21-4"><a href="sec-concepts.html#cb21-4" tabindex="-1"></a>    rowdata<span class="sc">$</span>rowSums <span class="ot">&lt;-</span> <span class="fu">rowSums</span>(<span class="fu">assay</span>(spikein[[i]]), <span class="at">na.rm=</span><span class="cn">TRUE</span>) <span class="do">## 2.</span></span>
<span id="cb21-5"><a href="sec-concepts.html#cb21-5" tabindex="-1"></a>    rowdata <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(rowdata) <span class="sc">|&gt;</span></span>
<span id="cb21-6"><a href="sec-concepts.html#cb21-6" tabindex="-1"></a>        <span class="fu">group_by</span>(ionID) <span class="sc">|&gt;</span></span>
<span id="cb21-7"><a href="sec-concepts.html#cb21-7" tabindex="-1"></a>        <span class="fu">mutate</span>(<span class="at">psmRank =</span> <span class="fu">rank</span>(<span class="sc">-</span>rowSums)) <span class="do">## 3.</span></span>
<span id="cb21-8"><a href="sec-concepts.html#cb21-8" tabindex="-1"></a>    <span class="fu">rowData</span>(spikein[[i]]) <span class="ot">&lt;-</span> <span class="fu">DataFrame</span>(rowdata) <span class="do">## 4.</span></span>
<span id="cb21-9"><a href="sec-concepts.html#cb21-9" tabindex="-1"></a>}</span>
<span id="cb21-10"><a href="sec-concepts.html#cb21-10" tabindex="-1"></a>spikein <span class="ot">&lt;-</span> <span class="fu">filterFeatures</span>(spikein, <span class="sc">~</span> psmRank <span class="sc">==</span> <span class="dv">1</span>) <span class="do">## 5.</span></span>
<span id="cb21-11"><a href="sec-concepts.html#cb21-11" tabindex="-1"></a>spikein <span class="ot">&lt;-</span> <span class="fu">filterFeatures</span>(spikein, <span class="sc">~</span> rowSums <span class="sc">&gt;</span> <span class="dv">0</span>) <span class="do">## 6.</span></span></code></pre></div>
</div>
<div id="remove-highly-missing-psms" class="section level4" number="2.4.3.6">
<h4>
<span class="header-section-number">2.4.3.6</span> Remove highly missing PSMs</h4>
<p>We then remove PSMs with 5 or more missing values out of 10 TMT
channels (&gt;= 50%). This is an arbitrary value that may need to be
adjusted depending on the experiment and the data set.</p>
<div class="sourceCode" id="cb22"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb22-1"><a href="sec-concepts.html#cb22-1" tabindex="-1"></a>spikein <span class="ot">&lt;-</span> <span class="fu">filterNA</span>(spikein, <span class="fu">names</span>(spikein), <span class="at">pNA =</span> <span class="fl">0.5</span>)</span></code></pre></div>
</div>
</div>
<div id="sec-log2" class="section level3" number="2.4.4">
<h3>
<span class="header-section-number">2.4.4</span> Log2 transformation<div class="tooltip"><button class="internal-link-btn" onclick="copy_link('sec-log2')" onmouseout="reset_tooltip('sec-log2-tooltip')"><span class="tooltiptext" id="sec-log2-tooltip">Copy link</span><i class="fa fa-link"></i></button></div>
</h3>
<p>We need to log2 transform the intensities. The plot below shows the
intensities (left) and log2-intensities (right) for one of the UPS
precursor ions as the UPS spike-in concentration increases. We can
clearly see that the variation around the mean for each dilution
factor increases as the mean increases. This is known as
heteroskedasticity. We will later see that <code>msqrob2</code> assumes that
variance of the error should be consistent across the different
conditions. Upon, log2-transformation we can see that the problem of
unequal variation is solved.</p>
<p><img src="msqrob2_book_files/figure-html/unnamed-chunk-23-1.png" width="672"></p>
<p>Another advantages of log2-transformation is that it provides a scale
that directly relates to biological interpretation. In biology, a
change induced by some condition often results in a fold change in
concentration. Interestingly, the log2 fold change (logFC), which is
the log of the ratio between two conditions, is identical to the
difference between the log of each condition.</p>
<p><span class="math display">\[log_2FC_{B-A} = log_2B - log_2A = log_2 \frac{B}{A}\]</span></p>
<p>This simplifies the modelling since the effects are now additive, and
the interpretration since a logFC of 1 means that the abundance in B
are <span class="math inline">\(2\times\)</span> higher in <span class="math inline">\(B\)</span> than in <span class="math inline">\(A\)</span>, a logFC of 2 means an
increase of <span class="math inline">\(4\times\)</span>, for instance.</p>
<p>We perform log2-transformation with <code>logTransform()</code> from the
<code>QFeatures</code> package.</p>
<div class="sourceCode" id="cb23"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb23-1"><a href="sec-concepts.html#cb23-1" tabindex="-1"></a>sNames <span class="ot">&lt;-</span> <span class="fu">names</span>(spikein)</span>
<span id="cb23-2"><a href="sec-concepts.html#cb23-2" tabindex="-1"></a>spikein <span class="ot">&lt;-</span> <span class="fu">logTransform</span>(</span>
<span id="cb23-3"><a href="sec-concepts.html#cb23-3" tabindex="-1"></a>    spikein, sNames, <span class="at">name =</span> <span class="fu">paste0</span>(sNames, <span class="st">"_log"</span>), <span class="at">base =</span> <span class="dv">2</span></span>
<span id="cb23-4"><a href="sec-concepts.html#cb23-4" tabindex="-1"></a>)</span></code></pre></div>
</div>
<div id="normalisation" class="section level3" number="2.4.5">
<h3>
<span class="header-section-number">2.4.5</span> Normalisation<div class="tooltip"><button class="internal-link-btn" onclick="copy_link('normalisation')" onmouseout="reset_tooltip('normalisation-tooltip')"><span class="tooltiptext" id="normalisation-tooltip">Copy link</span><i class="fa fa-link"></i></button></div>
</h3>
<p>The most common application of <code>msqrob2</code> is understand the biological
changes in protein abundance between experimental conditions. However,
changes in measurements between groups can be caused due to technical
factors. For instance, there are systematic fluctuations from
run-to-run that shift the measured intensity distribution. We can
this explore as follows:</p>
<ol style="list-style-type: decimal">
<li>We extract the sets containing the log transformed data. This is
performed using <code>QFeatures</code>’ 3-way subsetting. The first entry will
subset particular features (we select all features so we leave it
blank), the second entry selects columns of interest (we select all
columns) and the third entry selects sets of interest (we keep only
the sets with log data).</li>
<li>We use <code>longForm()</code> to convert the <code>QFeatures</code> object into a long
table, where each row contains the quantitative information about
one observation, in which column, row and set it was found. Long
tables are particularly for manipulating data with the <code>tidyverse</code>
ecosystem, namely with <code>ggplot2</code> for visualisation. <code>longForm()</code>
also allows to include annotations, and we here include <code>Mixture</code>
and <code>TechRepMixture</code> for filtering and colouring.</li>
<li>
<code>longForm()</code> returns a <code>DataFrame</code> which we convert to a
<code>data.frame</code>. To facilitate interpretation, we filter the data to
keep only for the first TMT mixture.</li>
<li>We visualise the density of the quantitative values within each
sample using the <code>ggplot2</code> package. We colour each sample based on
its corresponding technical replicate. Remember that each TMT
mixture has been acquired in triplicate, one run per replicate.</li>
</ol>
<div class="sourceCode" id="cb24"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb24-1"><a href="sec-concepts.html#cb24-1" tabindex="-1"></a>spikein[, , <span class="fu">paste0</span>(sNames, <span class="st">"_log"</span>)] <span class="sc">|&gt;</span> <span class="do">## 1.</span></span>
<span id="cb24-2"><a href="sec-concepts.html#cb24-2" tabindex="-1"></a>    <span class="fu">longForm</span>(<span class="at">colvars =</span> <span class="fu">c</span>(<span class="st">"Mixture"</span>, <span class="st">"TechRepMixture"</span>)) <span class="sc">|&gt;</span> <span class="do">## 2.</span></span>
<span id="cb24-3"><a href="sec-concepts.html#cb24-3" tabindex="-1"></a>    <span class="fu">data.frame</span>() <span class="sc">|&gt;</span> <span class="do">## 3.</span></span>
<span id="cb24-4"><a href="sec-concepts.html#cb24-4" tabindex="-1"></a>    <span class="fu">filter</span>(Mixture <span class="sc">==</span> <span class="st">"Mixture1"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb24-5"><a href="sec-concepts.html#cb24-5" tabindex="-1"></a>    <span class="fu">ggplot</span>() <span class="sc">+</span> <span class="do">## 4.</span></span>
<span id="cb24-6"><a href="sec-concepts.html#cb24-6" tabindex="-1"></a>    <span class="fu">aes</span>(<span class="at">x =</span> value, <span class="at">colour =</span> <span class="fu">as.factor</span>(TechRepMixture), <span class="at">group =</span> colname) <span class="sc">+</span></span>
<span id="cb24-7"><a href="sec-concepts.html#cb24-7" tabindex="-1"></a>    <span class="fu">geom_density</span>() <span class="sc">+</span></span>
<span id="cb24-8"><a href="sec-concepts.html#cb24-8" tabindex="-1"></a>    <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Intensity distribution for each observational unit"</span>,</span>
<span id="cb24-9"><a href="sec-concepts.html#cb24-9" tabindex="-1"></a>         <span class="at">subtitle =</span> <span class="st">"Before normalisation"</span>,</span>
<span id="cb24-10"><a href="sec-concepts.html#cb24-10" tabindex="-1"></a>         <span class="at">colour =</span> <span class="st">"Technical replicate"</span>)</span></code></pre></div>
<p><img src="msqrob2_book_files/figure-html/unnamed-chunk-25-1.png" width="672"></p>
<p>While the intensity distributions overlap, they are not perfectly
aligned. Moreover, the intensity distributions to cluster by technical
replicate. Since each replicate contains all experimental conditions,
we know that these difference stem from technical variability and not
biological variability. Ignoring this effect will, in case of balanced
designs, increase the noise and reduce the statistical power of the
experiment, and may, in case of imbalanced designs, introduce
confounding effects that will bias the results.</p>
<p>Therefore, normalisation will transform the data to put all the
distributions on the same location, such as centering on the mean or
the median, so that the distributions better coincide and overlap.
Here, we will use <code>normalize()</code> to subtract the median intensity within
each run.</p>
<div class="sourceCode" id="cb25"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb25-1"><a href="sec-concepts.html#cb25-1" tabindex="-1"></a>spikein <span class="ot">&lt;-</span> <span class="fu">normalize</span>(</span>
<span id="cb25-2"><a href="sec-concepts.html#cb25-2" tabindex="-1"></a>    spikein, <span class="fu">paste0</span>(sNames, <span class="st">"_log"</span>), <span class="at">name =</span> <span class="fu">paste0</span>(sNames, <span class="st">"_norm"</span>),</span>
<span id="cb25-3"><a href="sec-concepts.html#cb25-3" tabindex="-1"></a>    <span class="at">method =</span> <span class="st">"center.median"</span></span>
<span id="cb25-4"><a href="sec-concepts.html#cb25-4" tabindex="-1"></a>)</span></code></pre></div>
<p>Formally, the function applies the follow operation on each sample <span class="math inline">\(i\)</span>
across all PSMs <span class="math inline">\(p\)</span>:</p>
<p><span class="math display">\[
y_{ip}^{\text{norm}} = y_{ip} - \hat{\mu}_i
\]</span></p>
<p>with <span class="math inline">\(\hat{\mu}_i\)</span> the median intensity over all observed peptides in
sample <span class="math inline">\(i\)</span>. Upon normalisation, we can see that the distribution
nicely overlap (using the same code as above)</p>
<div class="sourceCode" id="cb26"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb26-1"><a href="sec-concepts.html#cb26-1" tabindex="-1"></a>spikein[, , <span class="fu">paste0</span>(sNames, <span class="st">"_norm"</span>)] <span class="sc">|&gt;</span> <span class="do">## 1.</span></span>
<span id="cb26-2"><a href="sec-concepts.html#cb26-2" tabindex="-1"></a>    <span class="fu">longForm</span>(<span class="at">colvars =</span> <span class="fu">c</span>(<span class="st">"Mixture"</span>, <span class="st">"TechRepMixture"</span>)) <span class="sc">|&gt;</span> <span class="do">## 2.</span></span>
<span id="cb26-3"><a href="sec-concepts.html#cb26-3" tabindex="-1"></a>    <span class="fu">data.frame</span>() <span class="sc">|&gt;</span> <span class="do">## 3.</span></span>
<span id="cb26-4"><a href="sec-concepts.html#cb26-4" tabindex="-1"></a>    <span class="fu">filter</span>(Mixture <span class="sc">==</span> <span class="st">"Mixture1"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb26-5"><a href="sec-concepts.html#cb26-5" tabindex="-1"></a>    <span class="fu">ggplot</span>() <span class="sc">+</span> <span class="do">## 4.</span></span>
<span id="cb26-6"><a href="sec-concepts.html#cb26-6" tabindex="-1"></a>    <span class="fu">aes</span>(<span class="at">x =</span> value, <span class="at">colour =</span> <span class="fu">as.factor</span>(TechRepMixture), <span class="at">group =</span> colname) <span class="sc">+</span></span>
<span id="cb26-7"><a href="sec-concepts.html#cb26-7" tabindex="-1"></a>    <span class="fu">geom_density</span>() <span class="sc">+</span></span>
<span id="cb26-8"><a href="sec-concepts.html#cb26-8" tabindex="-1"></a>    <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Intensity distribution for each observational unit"</span>,</span>
<span id="cb26-9"><a href="sec-concepts.html#cb26-9" tabindex="-1"></a>         <span class="at">subtitle =</span> <span class="st">"After normalisation"</span>,</span>
<span id="cb26-10"><a href="sec-concepts.html#cb26-10" tabindex="-1"></a>         <span class="at">colour =</span> <span class="st">"Technical replicate"</span>)</span></code></pre></div>
<p><img src="msqrob2_book_files/figure-html/unnamed-chunk-27-1.png" width="672"></p>
<p>Beware there exist numerous types of normalisation methods (see
<code>?normalize</code>) and which method to use may be data set dependent. For
instance, some data set may show low overlap of distribution tails
upon normalisation indicating that a simple shift is not sufficient.
In micro-array literature, quantile normalisation is used to force the
median and all other quantiles to be equal across samples, but in
proteomics, quantile normalisation often introduces artifacts due to a
difference in missing peptides across samples</p>
<p>It is important to understand that most normalisation procedures
assume that the majority of the proteins do not change across
conditions and only a small proportion of the proteins are
differentially abundant. This assumption may not be valid in poorly
design spike-in studies <span class="citation">(<label for="tufte-mn-8" class="margin-toggle">⊕</label><input type="checkbox" id="tufte-mn-8" class="margin-toggle">O’Brien et al. 2024<span class="marginnote">O’Brien, Jonathon J, Anil Raj, Aleksandr Gaun, Adam Waite, Wenzhou Li, David G Hendrickson, Niclas Olsson, and Fiona E McAllister. 2024. <span>“A Data Analysis Framework for Combining Multiple Batches Increases the Power of Isobaric Proteomics Experiments.”</span> <em>Nat. Methods</em> 21 (2): 290–300.</span>)</span> or for pull-down studies,
for example. Dedicated normalisation strategies are then required.</p>
<p>We completed the data preprocessing for the case we want to use
precursor-level data for the modelling (we will discuss below how to
model protein-level changes from ion-level data). Up to now, the data
from different runs were kept in separate assays. We can now the
normalised sets into an <code>ions</code> set using <code>joinAssays()</code>. Sets are
joined by stacking the columns (samples) in a matrix and rows
(features) are matched according to a row identifier, here the <code>ionID</code>
from the <code>rowData</code>.</p>
<div class="sourceCode" id="cb27"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb27-1"><a href="sec-concepts.html#cb27-1" tabindex="-1"></a>(spikein <span class="ot">&lt;-</span> <span class="fu">joinAssays</span>(</span>
<span id="cb27-2"><a href="sec-concepts.html#cb27-2" tabindex="-1"></a>    spikein, <span class="fu">paste0</span>(sNames, <span class="st">"_norm"</span>), <span class="at">fcol =</span> <span class="st">"ionID"</span>, <span class="at">name =</span> <span class="st">"ions"</span></span>
<span id="cb27-3"><a href="sec-concepts.html#cb27-3" tabindex="-1"></a>))</span></code></pre></div>
<pre><code>## An instance of class QFeatures (type: bulk) with 46 sets:
## 
##  [1] Mixture1_01: SummarizedExperiment with 1649 rows and 8 columns 
##  [2] Mixture1_02: SummarizedExperiment with 1644 rows and 8 columns 
##  [3] Mixture1_03: SummarizedExperiment with 1703 rows and 8 columns 
##  ...
##  [44] Mixture5_02_norm: SummarizedExperiment with 1646 rows and 8 columns 
##  [45] Mixture5_03_norm: SummarizedExperiment with 1578 rows and 8 columns 
##  [46] ions: SummarizedExperiment with 4066 rows and 120 columns</code></pre>
<p>We have a new set contain 15 runs <span class="math inline">\(\times\)</span> 8 labelled sample = 120
data columns. Note that the 15 sets have 4066
ions in common, leading to a joined set with <code>r nrows(spikein)[["ions"]]</code> rows.</p>
<p>If we want to use protein-level data for modelling, we will need a
summarisation step. Note that this last step is optional.</p>
</div>
<div id="summarisation" class="section level3" number="2.4.6">
<h3>
<span class="header-section-number">2.4.6</span> Summarisation<div class="tooltip"><button class="internal-link-btn" onclick="copy_link('summarisation')" onmouseout="reset_tooltip('summarisation-tooltip')"><span class="tooltiptext" id="summarisation-tooltip">Copy link</span><i class="fa fa-link"></i></button></div>
</h3>
<p>The objective of summarisation (also referred to as aggregation) is to
summarise the ion-level intensities into a protein expression value.
We illustrate the motivation behind summarisation using the data for
one of the UPS proteins in Mixture 1 (separating the data for each
technical replicate). We also focus on the 0.125x and the 1x
spike-in conditions. We illustrate the different precursor ions on the
x axis and plot the log2 normalised intensities across samples on y
axis. All the points belonging to the same sample are linked through a
grey line.</p>
<p><img src="msqrob2_book_files/figure-html/unnamed-chunk-29-1.png" width="576"></p>
<ol style="list-style-type: decimal">
<li>We can see that data for a protein can consist of many precursor
ions, hence the need for summarisation.</li>
<li>We observe that different precursor ions have different
intensities, even within the same sample (same line) or within the
same experimental group (same colour). This is because different
peptides have different properties and hence different ionisation
properties which will influence the detectability in the MS.</li>
<li>Most precursors are missing in one or two replicates. This problem
is mitigated in this example as the UPS dilution groups are well
distributed within each TMT mixture<label for="tufte-sn-1" class="margin-toggle sidenote-number">1</label><input type="checkbox" id="tufte-sn-1" class="margin-toggle"><span class="sidenote"><span class="sidenote-number">1</span> For TMT experiments, there is
one MS2 spectrum for all the labeled samples within the TMT pool.
So, once the spectrum is identified, it is identified for all the
samples within that pool.</span>. However, for unbalanced TMT designs and
for LFQ experiments, the precursor identification may be
inconsistent between groups of interest. Moreover, missed
identifications can also be caused by low protein abundance.</li>
<li>We can see subtle intensity shifts for the same precursor across
different replicates. These are known as spectrum effects and are
caused by small run-to-run fluctuations. Note that the data points
from one precursor in one replicate has been extracted from a
single MS2 spectrum.</li>
<li>We also find outliers. For instance, the first precursor ion
doesn’t show the same change in intensity between conditions
compared to majority of the precursors. These outliers can be the
results of misidentification or fluctuations during MS acquisition.</li>
</ol>
<p>The fact that different precursors have different intensities (2.) and
may be inconsistently identified (3. and 4.) and/or quantified (5.)
can lead to bias if we use simple summarisation approaches such as
summing or averaging the precursor intensities for each sample.
Instead, we will resort to more advanced summarisation approaches to
accommodate for these issues.</p>
<p>Here, we summarise the precursor-level data into protein intensities
through the median polish approach, which alternately removes the
precursor and the sample medians from the data until the summaries
stabilise. Removing the precursor medians will solve issue 2. as it
removes the precursor specific effects. Using the median instead of
the mean will solve issue 5. Note that we perform summarisation for
each run separately, hence the precursor effect will be different for
each run, effectively allowing for a spectrum effect and solviing
issue 5.</p>
<p><code>aggregateFeatures()</code> streamlines this process. It requires the name
of a <code>rowData</code> column to group the precursor into proteins (or protein
groups), here <code>Protein.Accessions</code>. Summarisation methods are
available from the <code>MsCoreUtils</code> package. The function will return a
<code>QFeatures</code> object with 15 new sets, each generated from its
normalised precursor set.</p>
<div class="sourceCode" id="cb29"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb29-1"><a href="sec-concepts.html#cb29-1" tabindex="-1"></a>(spikein <span class="ot">&lt;-</span> <span class="fu">aggregateFeatures</span>(</span>
<span id="cb29-2"><a href="sec-concepts.html#cb29-2" tabindex="-1"></a>    spikein, <span class="at">i =</span> <span class="fu">paste0</span>(sNames, <span class="st">"_norm"</span>), </span>
<span id="cb29-3"><a href="sec-concepts.html#cb29-3" tabindex="-1"></a>    <span class="at">name =</span> <span class="fu">paste0</span>(sNames, <span class="st">"_proteins"</span>),</span>
<span id="cb29-4"><a href="sec-concepts.html#cb29-4" tabindex="-1"></a>    <span class="at">fcol =</span> <span class="st">"Protein.Accessions"</span>, <span class="at">fun =</span> MsCoreUtils<span class="sc">::</span>medianPolish,</span>
<span id="cb29-5"><a href="sec-concepts.html#cb29-5" tabindex="-1"></a>    <span class="at">na.rm =</span> <span class="cn">TRUE</span></span>
<span id="cb29-6"><a href="sec-concepts.html#cb29-6" tabindex="-1"></a>))</span></code></pre></div>
<pre><code>## An instance of class QFeatures (type: bulk) with 61 sets:
## 
##  [1] Mixture1_01: SummarizedExperiment with 1649 rows and 8 columns 
##  [2] Mixture1_02: SummarizedExperiment with 1644 rows and 8 columns 
##  [3] Mixture1_03: SummarizedExperiment with 1703 rows and 8 columns 
##  ...
##  [59] Mixture5_01_proteins: SummarizedExperiment with 307 rows and 8 columns 
##  [60] Mixture5_02_proteins: SummarizedExperiment with 296 rows and 8 columns 
##  [61] Mixture5_03_proteins: SummarizedExperiment with 299 rows and 8 columns</code></pre>
<p>In case of unbalanced designs where issue 3. becomes
problematic, we found that robust summarisation performs well
<span class="citation">(<label for="tufte-mn-9" class="margin-toggle">⊕</label><input type="checkbox" id="tufte-mn-9" class="margin-toggle">Sticker et al. 2020<span class="marginnote">Sticker, Adriaan, Ludger Goeminne, Lennart Martens, and Lieven Clement. 2020. <span>“Robust Summarization and Inference in Proteome-Wide Label-Free Quantification.”</span> <em>Mol. Cell. Proteomics</em> 19 (7): 1209–19.</span>)</span>. <code>MsCoreUtils::medianPolish</code> can then simply be
replaced with <code>MsCoreUtils::robustSummary</code>.</p>
<p>We can now join the different protein sets into a single set. We omit
the <code>fcol</code> argument, meaning that the set rows will be matched based
on the row names (generated by <code>aggregateFeatures()</code>).</p>
<div class="sourceCode" id="cb31"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb31-1"><a href="sec-concepts.html#cb31-1" tabindex="-1"></a>spikein <span class="ot">&lt;-</span> <span class="fu">joinAssays</span>( </span>
<span id="cb31-2"><a href="sec-concepts.html#cb31-2" tabindex="-1"></a>    spikein, <span class="fu">paste0</span>(sNames, <span class="st">"_proteins"</span>), <span class="st">"proteins"</span></span>
<span id="cb31-3"><a href="sec-concepts.html#cb31-3" tabindex="-1"></a>)</span></code></pre></div>
</div>
</div>
<div id="data-exploration" class="section level2" number="2.5">
<h2>
<span class="header-section-number">2.5</span> Data exploration<div class="tooltip"><button class="internal-link-btn" onclick="copy_link('data-exploration')" onmouseout="reset_tooltip('data-exploration-tooltip')"><span class="tooltiptext" id="data-exploration-tooltip">Copy link</span><i class="fa fa-link"></i></button></div>
</h2>
<p>Data exploration aims to highlight the main sources of variation in
the data prior to data modelling and can pinpoint to outlying or
off-behaving samples. A common approach for data exploration is to
perform Multi Dimensional Scaling (MDS). We will first extract the set
to explore using <code>getWithColData()</code>. This function extracts the set of
interest along with all the associated sample annotations (used for
plot colouring).</p>
<div class="sourceCode" id="cb32"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb32-1"><a href="sec-concepts.html#cb32-1" tabindex="-1"></a>se <span class="ot">&lt;-</span> <span class="fu">getWithColData</span>(spikein, <span class="st">"ions"</span>)</span></code></pre></div>
<p>We then use the <code>scater</code> package to compute and plot the PCA. For
technical reasons, it requires <code>SingleCellExperiment</code> class object,
but these can easily be generated from a <code>SummarizedExperiment</code>
object.</p>
<div class="sourceCode" id="cb33"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb33-1"><a href="sec-concepts.html#cb33-1" tabindex="-1"></a><span class="fu">library</span>(<span class="st">"scater"</span>)</span>
<span id="cb33-2"><a href="sec-concepts.html#cb33-2" tabindex="-1"></a>se <span class="ot">&lt;-</span> <span class="fu">runMDS</span>(<span class="fu">as</span>(se, <span class="st">"SingleCellExperiment"</span>), <span class="at">exprs_values =</span> <span class="dv">1</span>)</span></code></pre></div>
<p>We can now explore the data structure while colouring for factors of
interest, here <code>Condition</code>, <code>Run</code> and <code>Mixture</code>.</p>
<div class="sourceCode" id="cb34"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb34-1"><a href="sec-concepts.html#cb34-1" tabindex="-1"></a><span class="fu">plotMDS</span>(se, <span class="at">colour_by =</span> <span class="st">"Condition"</span>) <span class="sc">+</span></span>
<span id="cb34-2"><a href="sec-concepts.html#cb34-2" tabindex="-1"></a>  <span class="fu">plotMDS</span>(se, <span class="at">colour_by =</span> <span class="st">"Run"</span>) <span class="sc">+</span> </span>
<span id="cb34-3"><a href="sec-concepts.html#cb34-3" tabindex="-1"></a>  <span class="fu">plotMDS</span>(se, <span class="at">colour_by =</span> <span class="st">"Mixture"</span>)</span></code></pre></div>
<p><img src="msqrob2_book_files/figure-html/unnamed-chunk-34-1.png" width="768"></p>
<p>There is a strong run-to-run effect, which is partly explained by a
mixture effect as the runs from the same cluster tend to be closer
than runs from different mixtures. The condition effect is much more
subtle to find, probably because we know only a few UPS proeins were
spiked in while the majority of the background proteins are unchanged.</p>
<p>As discussed above, the median polish summarisation should remove part
of the run to run effect. We repeat the data exploration, but using
the protein-level data.</p>
<div class="sourceCode" id="cb35"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb35-1"><a href="sec-concepts.html#cb35-1" tabindex="-1"></a>se <span class="ot">&lt;-</span> <span class="fu">getWithColData</span>(spikein, <span class="st">"proteins"</span>)</span>
<span id="cb35-2"><a href="sec-concepts.html#cb35-2" tabindex="-1"></a>se <span class="ot">&lt;-</span> <span class="fu">runMDS</span>(<span class="fu">as</span>(se, <span class="st">"SingleCellExperiment"</span>), <span class="at">exprs_values =</span> <span class="dv">1</span>)</span>
<span id="cb35-3"><a href="sec-concepts.html#cb35-3" tabindex="-1"></a><span class="fu">plotMDS</span>(se, <span class="at">colour_by =</span> <span class="st">"Run"</span>)</span></code></pre></div>
<p><img src="msqrob2_book_files/figure-html/unnamed-chunk-35-1.png" width="672"></p>
<p>While the run effects are smaller on the protein-level MDS compared to
the precursor-level MDS (the samples are less clustered per run), we
can see that normalisation and summarisation alone are not sufficient
to correct for these unwanted effects. We will take care of these
effects during the data modelling.</p>
</div>
<div id="sec-modelling" class="section level2" number="2.6">
<h2>
<span class="header-section-number">2.6</span> Data modelling<div class="tooltip"><button class="internal-link-btn" onclick="copy_link('sec-modelling')" onmouseout="reset_tooltip('sec-modelling-tooltip')"><span class="tooltiptext" id="sec-modelling-tooltip">Copy link</span><i class="fa fa-link"></i></button></div>
</h2>
<p>Proteomics data contain several sources of variation that need to be
accounted for by the model. Before delving into these sources of
variation, we here show how to run the model that accounts for all
relevant sources of variation in the spike-in experiment, which we
have shown performs best <span class="citation">(<label for="tufte-mn-10" class="margin-toggle">⊕</label><input type="checkbox" id="tufte-mn-10" class="margin-toggle">Vandenbulcke et al. 2025<span class="marginnote">Vandenbulcke, Stijn, Christophe Vanderaa, Oliver Crook, Lennart Martens, and Lieven Clement. 2025. <span>“<span>Msqrob2TMT</span>: Robust Linear Mixed Models for Inferring Differential Abundant Proteins in Labeled Experiments with Arbitrarily Complex Design.”</span> <em>Mol. Cell. Proteomics</em> 24 (7): 101002.</span>)</span>.</p>
<div class="sourceCode" id="cb36"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb36-1"><a href="sec-concepts.html#cb36-1" tabindex="-1"></a>spikein <span class="ot">&lt;-</span> <span class="fu">msqrobAggregate</span>(</span>
<span id="cb36-2"><a href="sec-concepts.html#cb36-2" tabindex="-1"></a>    spikein,  <span class="at">i =</span> <span class="st">"ions"</span>,</span>
<span id="cb36-3"><a href="sec-concepts.html#cb36-3" tabindex="-1"></a>    <span class="at">formula =</span> <span class="sc">~</span> <span class="dv">0</span> <span class="sc">+</span> Condition <span class="sc">+</span> <span class="do">## fixed effect for experimental condition</span></span>
<span id="cb36-4"><a href="sec-concepts.html#cb36-4" tabindex="-1"></a>        (<span class="dv">1</span> <span class="sc">|</span> Channel) <span class="sc">+</span> <span class="do">## random effect for channel</span></span>
<span id="cb36-5"><a href="sec-concepts.html#cb36-5" tabindex="-1"></a>        (<span class="dv">1</span> <span class="sc">|</span> Mixture) <span class="sc">+</span> <span class="do">## random effect for mixture</span></span>
<span id="cb36-6"><a href="sec-concepts.html#cb36-6" tabindex="-1"></a>        (<span class="dv">1</span> <span class="sc">|</span> Run) <span class="sc">+</span> <span class="do">## random effect for run</span></span>
<span id="cb36-7"><a href="sec-concepts.html#cb36-7" tabindex="-1"></a>        (<span class="dv">1</span> <span class="sc">|</span> Run<span class="sc">:</span>Channel) <span class="sc">+</span> <span class="do">## random effect for PSMs for the same protein in a channel of a run</span></span>
<span id="cb36-8"><a href="sec-concepts.html#cb36-8" tabindex="-1"></a>        (<span class="dv">1</span> <span class="sc">|</span> Run<span class="sc">:</span>ionID), <span class="do">## random effect for ions in the same spectrum of an MS run</span></span>
<span id="cb36-9"><a href="sec-concepts.html#cb36-9" tabindex="-1"></a>    <span class="at">fcol =</span> <span class="st">"Protein.Accessions"</span>,</span>
<span id="cb36-10"><a href="sec-concepts.html#cb36-10" tabindex="-1"></a>    <span class="at">modelColumnName =</span> <span class="st">"msqrob_psms_rrilm"</span>,</span>
<span id="cb36-11"><a href="sec-concepts.html#cb36-11" tabindex="-1"></a>    <span class="at">robust =</span> <span class="cn">TRUE</span>, <span class="at">ridge =</span> <span class="cn">TRUE</span></span>
<span id="cb36-12"><a href="sec-concepts.html#cb36-12" tabindex="-1"></a>)</span></code></pre></div>
<p>We will now build up the model by progressively adding the
different sources of variation.</p>
<div id="sec-run_model" class="section level3" number="2.6.1">
<h3>
<span class="header-section-number">2.6.1</span> Effect of treatment of interest<div class="tooltip"><button class="internal-link-btn" onclick="copy_link('sec-run_model')" onmouseout="reset_tooltip('sec-run_model-tooltip')"><span class="tooltiptext" id="sec-run_model-tooltip">Copy link</span><i class="fa fa-link"></i></button></div>
</h3>
<p>We model the source of variation induced by the experimental
treatment of interest as a fixed effect, which we consider non-random,
i.e. the treatment effect is assumed to be the same in repeated
experiments, but it is unknown and has to be estimated. When modelling
a typical label-free experiment at the protein level, the model boils
down to a linear model, again we suppress the index for protein:</p>
<p><span class="math display">\[
y_r = \mathbf{x}^T_r \boldsymbol{\beta} + \epsilon_r,
\]</span></p>
<p>with <span class="math inline">\(y_r\)</span> the <span class="math inline">\(\log_2\)</span>-normalized protein intensities in run r;
<span class="math inline">\(\mathbf{x}_r\)</span> a vector with the covariate pattern for the sample in
run <span class="math inline">\(r\)</span> encoding the intercept, treatment, potential batch effects and
confounders; <span class="math inline">\(\boldsymbol{\beta}\)</span> the vector of parameters that model
the association between the covariates and the outcome; and
<span class="math inline">\(\epsilon_r\)</span> the residuals reflecting variation that is not captured
by the fixed effects. Note that <span class="math inline">\(\mathbf{x}_r\)</span> allows for a flexible
parameterization of the treatment beyond a single covariate, i.e.
including a 1 for the intercept, continuous and categorical variables
as well as their interactions. For all models considered in this work,
we assume the residuals to be independent and identically distributed
(i.i.d) according to a normal distribution with zero mean and constant
variance, i.e. <span class="math inline">\(\epsilon_{r} \sim N(0,\sigma_\epsilon^2)\)</span>, that can
differ from protein to protein.</p>
<p>Now we defined a model, we must estimate from the data. Using
<code>msqrob()</code>, the model translates into the following code:</p>
<div class="sourceCode" id="cb37"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb37-1"><a href="sec-concepts.html#cb37-1" tabindex="-1"></a>spikein <span class="ot">&lt;-</span> <span class="fu">msqrob</span>(</span>
<span id="cb37-2"><a href="sec-concepts.html#cb37-2" tabindex="-1"></a>    spikein,  <span class="at">i =</span> <span class="st">"proteins"</span>,</span>
<span id="cb37-3"><a href="sec-concepts.html#cb37-3" tabindex="-1"></a>    <span class="at">formula =</span> <span class="sc">~</span>  <span class="dv">0</span> <span class="sc">+</span> Condition, <span class="do">## fixed effect for experimental condition</span></span>
<span id="cb37-4"><a href="sec-concepts.html#cb37-4" tabindex="-1"></a>    <span class="at">robust =</span> <span class="cn">TRUE</span>, <span class="at">ridge =</span> <span class="cn">TRUE</span>,</span>
<span id="cb37-5"><a href="sec-concepts.html#cb37-5" tabindex="-1"></a>    <span class="at">modelColumnName =</span> <span class="st">"msqrob_rrilm"</span></span>
<span id="cb37-6"><a href="sec-concepts.html#cb37-6" tabindex="-1"></a>)</span></code></pre></div>
<p>The function takes the <code>QFeatures</code> object, extracts the quantitative
values from the <code>"proteins"</code> set generated during summarisation, and
fits a simple linear model with <code>Condition</code> as covariate, which is
automatically retrieved from <code>colData(spikein)</code>. Note, that we use an
encoding without intercept <code>~ 0 +</code>. This makes it more straightforward
to define contrasts for one-way ANOVA designs with a treatment
involving a single factor. Indeed, by suppressing the intercept, a
model parameters is estimated for each group. Otherwise, <code>msqrob2</code>
selects one of the groups as the reference group, for which its model
parameter is absorbed in the intercept.</p>
<p><strong>TODO</strong>: do we need to suppress the intercept? We documented this for
the msqrob2TMT vignette but my feeling is that we should learn users
to perform to build contrasts with intercepts. However, regarding
ridge regression, suppressing the intercept is better.</p>
<p><strong>TODO</strong>: expand the paragraph below?</p>
<p>We also enable M-estimation (<code>robust = TRUE</code>) for improved robustness
against outliers. We also enable ridge regression (<code>ridge = TRUE</code>)
for fixed effects. Ridge regression stabilises the parameter
estimation in case where the number of parameters are close to the
number of available samples. Keep in mind that ridge regression is
irrelevant when modelling a single fixed effect with only 2 factors.</p>
<p>The fitting results are available in the <code>msqrob_rrilm</code> column of the
<code>rowData</code> (by default, the new column is called <code>msqrobModels</code>). More
specifically, the modelling output is stored in the <code>rowData</code> as a
<code>statModel</code> object, one model per row (protein). We will see in a
later section how to perform statistical inference on the estimated
parameters.</p>
<div class="sourceCode" id="cb38"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb38-1"><a href="sec-concepts.html#cb38-1" tabindex="-1"></a>models <span class="ot">&lt;-</span> <span class="fu">rowData</span>(spikein[[<span class="st">"proteins"</span>]])[[<span class="st">"msqrob_rrilm"</span>]]</span>
<span id="cb38-2"><a href="sec-concepts.html#cb38-2" tabindex="-1"></a>models[<span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>]</span></code></pre></div>
<pre><code>## $O00151
## Object of class "StatModel"
## The type is "lmer"
## There number of elements is 5 
## 
## $O00299
## Object of class "StatModel"
## The type is "lmer"
## There number of elements is 5 
## 
## $O00410
## Object of class "StatModel"
## The type is "lmer"
## There number of elements is 5</code></pre>
</div>
<div id="effect-of-tmt-channel-and-run" class="section level3" number="2.6.2">
<h3>
<span class="header-section-number">2.6.2</span> Effect of TMT channel and run<div class="tooltip"><button class="internal-link-btn" onclick="copy_link('effect-of-tmt-channel-and-run')" onmouseout="reset_tooltip('effect-of-tmt-channel-and-run-tooltip')"><span class="tooltiptext" id="effect-of-tmt-channel-and-run-tooltip">Copy link</span><i class="fa fa-link"></i></button></div>
</h3>
<p>As label-free experiments contain only a single sample per run,
run-specific effects will be absorbed in the residuals. However, the
data analysis of labeled experiments, e.g. using TMT multiplexing,
involving multiple MS runs has to account for run- and label-specific
effects, explicitly. If all treatments are present in each run, and if
channel swaps are performed so as to avoid confounding between channel
and treatment, then the model parameters can be estimated using fixed
channel and run effects. Indeed, for these designs run acts as a
blocking variable as all treatment effects can be estimated within
each run.</p>
<p>However, for more complex designs this is no longer possible and the
uncertainty in the estimation of the mean model parameters can involve
both within and between channel and run variability. For these designs
we can resort to mixed models where the channel and run effect are
modelled using random effects, i.e. they are considered as a random
sample from the population of all possible runs (channel labels),
which are assumed to be i.i.d normally distributed with mean 0 and
constant variance, <span class="math inline">\(u_r \sim N(0,\sigma^{2,\text{run}})\)</span>
(<span class="math inline">\(u_{channel} \sim N(0,\sigma^{2,\text{channel}})\)</span>). The use of random
effects thus models the correlation in the data, explicitly. Indeed,
protein intensities that are measured within the same run (channel)
will be more similar than protein intensities between runs (channels).</p>
<p>Hence, the model is extended to:</p>
<p><span class="math display">\[
y_{rc} =
\mathbf{x}^T_{rc} \boldsymbol{\beta} + u_c^\text{channel} + u_r^\text{run} +
\epsilon_{rc}
\]</span>
with <span class="math inline">\(y_{rc}\)</span> the normalised <span class="math inline">\(\log_2\)</span> protein intensities in run <span class="math inline">\(r\)</span>
and channel <span class="math inline">\(c\)</span>, <span class="math inline">\(u_c^\text{channel}\)</span> the effect introduced by
the label of channel <span class="math inline">\(c\)</span>, and <span class="math inline">\(u_r^\text{run}\)</span> the effect for MS run
<span class="math inline">\(r\)</span>.</p>
<p>This translates in the following code:</p>
<div class="sourceCode" id="cb40"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb40-1"><a href="sec-concepts.html#cb40-1" tabindex="-1"></a>spikein <span class="ot">&lt;-</span> <span class="fu">msqrob</span>(</span>
<span id="cb40-2"><a href="sec-concepts.html#cb40-2" tabindex="-1"></a>    spikein,  <span class="at">i =</span> <span class="st">"proteins"</span>,</span>
<span id="cb40-3"><a href="sec-concepts.html#cb40-3" tabindex="-1"></a>    <span class="at">formula =</span> <span class="sc">~</span>  <span class="dv">0</span> <span class="sc">+</span> Condition <span class="sc">+</span> <span class="do">## fixed effect for experimental condition</span></span>
<span id="cb40-4"><a href="sec-concepts.html#cb40-4" tabindex="-1"></a>        (<span class="dv">1</span> <span class="sc">|</span> Channel) <span class="sc">+</span> <span class="do">## random effect for channel</span></span>
<span id="cb40-5"><a href="sec-concepts.html#cb40-5" tabindex="-1"></a>        (<span class="dv">1</span> <span class="sc">|</span> Run), <span class="do">## random effect for MS run</span></span>
<span id="cb40-6"><a href="sec-concepts.html#cb40-6" tabindex="-1"></a>    <span class="at">robust =</span> <span class="cn">TRUE</span>, <span class="at">ridge =</span> <span class="cn">TRUE</span>,</span>
<span id="cb40-7"><a href="sec-concepts.html#cb40-7" tabindex="-1"></a>    <span class="at">modelColumnName =</span> <span class="st">"msqrob_rrilmm"</span></span>
<span id="cb40-8"><a href="sec-concepts.html#cb40-8" tabindex="-1"></a>    )</span></code></pre></div>
<p>Note here that we have commented out the random effect for channel. In
practice, normalisation already removes part of the channel effect and
is sufficient. You can experiment this yourself by removing the
comment sign <code>#</code> in front of <code>(1 | Channel) +</code> across the vignette,
and see how the results may change.</p>
</div>
<div id="effect-of-replication" class="section level3" number="2.6.3">
<h3>
<span class="header-section-number">2.6.3</span> Effect of replication<div class="tooltip"><button class="internal-link-btn" onclick="copy_link('effect-of-replication')" onmouseout="reset_tooltip('effect-of-replication-tooltip')"><span class="tooltiptext" id="effect-of-replication-tooltip">Copy link</span><i class="fa fa-link"></i></button></div>
</h3>
<p>Some experiments also include technical replication where a TMT
mixture can be acquired multiple times. This again will induce
correlation. Indeed, protein intensities from the same mixture will be
more alike than those of different mixtures. Hence, we also include a
random effect to account for this pseudo-replication, i.e.
<span class="math inline">\(u^\text{mix}_m \sim N(0, \sigma^{2,\text{mix}})\)</span>. The model thus
extends to:</p>
<p><span class="math display">\[
y_{rcm} =
\mathbf{x}^T_{rcm} \boldsymbol{\beta} +  u_{c}^\text{channel} +
u_r^\text{run} + u_m^\text{mix} + \epsilon_{rcm}
\]</span></p>
<p>with <span class="math inline">\(m\)</span> the index for mixture.</p>
<p>The model translates to the following code:</p>
<div class="sourceCode" id="cb41"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb41-1"><a href="sec-concepts.html#cb41-1" tabindex="-1"></a>spikein <span class="ot">&lt;-</span> <span class="fu">msqrob</span>(</span>
<span id="cb41-2"><a href="sec-concepts.html#cb41-2" tabindex="-1"></a>    spikein,  <span class="at">i =</span> <span class="st">"proteins"</span>,</span>
<span id="cb41-3"><a href="sec-concepts.html#cb41-3" tabindex="-1"></a>    <span class="at">formula =</span> <span class="sc">~</span>  <span class="dv">0</span> <span class="sc">+</span> Condition <span class="sc">+</span> <span class="do">## fixed effect for experimental condition</span></span>
<span id="cb41-4"><a href="sec-concepts.html#cb41-4" tabindex="-1"></a>        (<span class="dv">1</span> <span class="sc">|</span> Channel) <span class="sc">+</span> <span class="do">## random effect for channel</span></span>
<span id="cb41-5"><a href="sec-concepts.html#cb41-5" tabindex="-1"></a>        (<span class="dv">1</span> <span class="sc">|</span> Run) <span class="sc">+</span> <span class="do">## random effect for MS run</span></span>
<span id="cb41-6"><a href="sec-concepts.html#cb41-6" tabindex="-1"></a>        (<span class="dv">1</span> <span class="sc">|</span> Mixture), <span class="do">## random effect for mixture</span></span>
<span id="cb41-7"><a href="sec-concepts.html#cb41-7" tabindex="-1"></a>    <span class="at">robust =</span> <span class="cn">TRUE</span>, <span class="at">ridge =</span> <span class="cn">TRUE</span>,</span>
<span id="cb41-8"><a href="sec-concepts.html#cb41-8" tabindex="-1"></a>    <span class="at">modelColumnName =</span> <span class="st">"msqrob_rrilmm"</span>,</span>
<span id="cb41-9"><a href="sec-concepts.html#cb41-9" tabindex="-1"></a>    <span class="at">overwrite =</span> <span class="cn">TRUE</span></span>
<span id="cb41-10"><a href="sec-concepts.html#cb41-10" tabindex="-1"></a>)</span></code></pre></div>
<p>We use <code>overwrite = TRUE</code> to overwrite the previous results in the
<code>rowData</code>.</p>
</div>
<div id="psm-level-modelling" class="section level3" number="2.6.4">
<h3>
<span class="header-section-number">2.6.4</span> PSM-level modelling<div class="tooltip"><button class="internal-link-btn" onclick="copy_link('psm-level-modelling')" onmouseout="reset_tooltip('psm-level-modelling-tooltip')"><span class="tooltiptext" id="psm-level-modelling-tooltip">Copy link</span><i class="fa fa-link"></i></button></div>
</h3>
<p>Above, we modelled the data at the protein level. However, we could
also directly estimate the treatment effect from PSM-level data. This
will again induce additional levels of correlation. Indeed, the
intensities for the different reporter ions in a TMT run within the
same spectrum (PSM) will be more similar than the intensities between
PSMs. We therefore need to add a random effect term to account for the
within PSM correlation structure, i.e. <span class="math inline">\(u^\text{PSM}_{rp} \sim
N(0,\sigma^{2,\text{PSM}})\)</span>. Moreover, in each channel of a run
multiple PSM intensities are picked up for each protein. Hence,
intensities from different PSMs for a protein in the same channel of a
run will be more alike than intensities of different PSMs for the same
protein between channels of runs, and we will address this correlation
with a channel-specific random effect nested in run, i.e.
<span class="math inline">\(u_{rc}^{channel} \sim N(0,\sigma^{2,\text{channel}})\)</span>. The model then
becomes:</p>
<p><span class="math display">\[
y_{rcmp} =
\mathbf{x}^T_{rcmp} \beta + u_{c}^\text{channel} +
u_r^\text{run} + u_m^\text{mix}  +
u_{rc}^\text{channel} + u_{rp}^\text{PSM} + \epsilon_{rcmp}
\]</span>
with <span class="math inline">\(y_{rcmp}\)</span> the <span class="math inline">\(\log_2\)</span>-normalized PSM intensities for run <span class="math inline">\(r\)</span>
with label <span class="math inline">\(c\)</span> in mixture <span class="math inline">\(m\)</span> and peptide ion <span class="math inline">\(p\)</span>. Note, that the peptide ion random
effect is also nested within each run since each spectrum is described
by run-specific characteristics.</p>
<p>The model translates to the code below. Note that we here no longer
use <code>msqrob()</code>, but <code>msqrobAggregate()</code>. The latter will combine
annotations from the <code>colData</code> (i.e. <code>"Condition"</code>, <code>"Channel"</code>,
<code>"Run"</code>, <code>"Mixture"</code>) and from the <code>rowData</code> (i.e.
<code>"ionID"</code>). Moreover, we need to tell the function how the PSM-level
data is grouped to protein data through the <code>fcol</code> argument, here we
will group PSMs by the <code>Protein.Accessions</code>.</p>
<div class="sourceCode" id="cb42"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb42-1"><a href="sec-concepts.html#cb42-1" tabindex="-1"></a>spikein <span class="ot">&lt;-</span> <span class="fu">msqrobAggregate</span>(</span>
<span id="cb42-2"><a href="sec-concepts.html#cb42-2" tabindex="-1"></a>    spikein,  <span class="at">i =</span> <span class="st">"ions"</span>,</span>
<span id="cb42-3"><a href="sec-concepts.html#cb42-3" tabindex="-1"></a>    <span class="at">formula =</span> <span class="sc">~</span>  <span class="dv">0</span> <span class="sc">+</span> Condition <span class="sc">+</span> <span class="do">## fixed effect for experimental condition</span></span>
<span id="cb42-4"><a href="sec-concepts.html#cb42-4" tabindex="-1"></a>        (<span class="dv">1</span> <span class="sc">|</span> Channel) <span class="sc">+</span> <span class="do">## random effect for channel</span></span>
<span id="cb42-5"><a href="sec-concepts.html#cb42-5" tabindex="-1"></a>        (<span class="dv">1</span> <span class="sc">|</span> Run) <span class="sc">+</span> <span class="do">## random effect for Run</span></span>
<span id="cb42-6"><a href="sec-concepts.html#cb42-6" tabindex="-1"></a>        (<span class="dv">1</span> <span class="sc">|</span> Mixture) <span class="sc">+</span> <span class="do">## random effect for mixture</span></span>
<span id="cb42-7"><a href="sec-concepts.html#cb42-7" tabindex="-1"></a>        (<span class="dv">1</span> <span class="sc">|</span> Run<span class="sc">:</span>Channel) <span class="sc">+</span> <span class="do">## random effect for channel nested in run</span></span>
<span id="cb42-8"><a href="sec-concepts.html#cb42-8" tabindex="-1"></a>        (<span class="dv">1</span> <span class="sc">|</span> Run<span class="sc">:</span>ionID), <span class="do">## random effect for ion nested in run</span></span>
<span id="cb42-9"><a href="sec-concepts.html#cb42-9" tabindex="-1"></a>    <span class="at">fcol =</span> <span class="st">"Protein.Accessions"</span>,</span>
<span id="cb42-10"><a href="sec-concepts.html#cb42-10" tabindex="-1"></a>    <span class="at">modelColumnName =</span> <span class="st">"msqrob_psm_rrilmm"</span>,</span>
<span id="cb42-11"><a href="sec-concepts.html#cb42-11" tabindex="-1"></a>    <span class="at">name =</span> <span class="st">"proteins_msqrob"</span>,</span>
<span id="cb42-12"><a href="sec-concepts.html#cb42-12" tabindex="-1"></a>    <span class="at">robust =</span> <span class="cn">TRUE</span>, <span class="at">ridge =</span> <span class="cn">TRUE</span></span>
<span id="cb42-13"><a href="sec-concepts.html#cb42-13" tabindex="-1"></a>)</span></code></pre></div>
<p>So, we built the model shown at the beginning of this section,
effectively accounting for all sources of variation in TMT-based
proteomics data.</p>
</div>
<div id="precursor-or-protein-level-model" class="section level3" number="2.6.5">
<h3>
<span class="header-section-number">2.6.5</span> Precursor or protein-level model?<div class="tooltip"><button class="internal-link-btn" onclick="copy_link('precursor-or-protein-level-model')" onmouseout="reset_tooltip('precursor-or-protein-level-model-tooltip')"><span class="tooltiptext" id="precursor-or-protein-level-model-tooltip">Copy link</span><i class="fa fa-link"></i></button></div>
</h3>
<p><strong>TODO</strong>: discuss precursor-level vs protein-level models</p>
</div>
<div id="robust-ridge-estimation" class="section level3" number="2.6.6">
<h3>
<span class="header-section-number">2.6.6</span> Robust ridge estimation?<div class="tooltip"><button class="internal-link-btn" onclick="copy_link('robust-ridge-estimation')" onmouseout="reset_tooltip('robust-ridge-estimation-tooltip')"><span class="tooltiptext" id="robust-ridge-estimation-tooltip">Copy link</span><i class="fa fa-link"></i></button></div>
</h3>
<p><strong>TODO</strong> discuss ridge vs no ridge and robust vs no robust</p>
</div>
</div>
<div id="statistical-inference" class="section level2" number="2.7">
<h2>
<span class="header-section-number">2.7</span> Statistical inference<div class="tooltip"><button class="internal-link-btn" onclick="copy_link('statistical-inference')" onmouseout="reset_tooltip('statistical-inference-tooltip')"><span class="tooltiptext" id="statistical-inference-tooltip">Copy link</span><i class="fa fa-link"></i></button></div>
</h2>
<p>We can now convert the biological question “does the spike-in
condition affect the protein intensities?” into a statistical
hypothesis. In other words, we must convert this question in a
combination of the model parameters, also referred to as a contrast.
To aid defining contrasts, we will visualise the experimental design
using the <code>ExploreModelMatrix</code> package. Since we are not interested in
technical effects, we will only focus on the variable of interest,
here <code>Condition</code>.</p>
<div class="sourceCode" id="cb43"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb43-1"><a href="sec-concepts.html#cb43-1" tabindex="-1"></a><span class="fu">library</span>(<span class="st">"ExploreModelMatrix"</span>)</span>
<span id="cb43-2"><a href="sec-concepts.html#cb43-2" tabindex="-1"></a>vd <span class="ot">&lt;-</span> <span class="fu">VisualizeDesign</span>(</span>
<span id="cb43-3"><a href="sec-concepts.html#cb43-3" tabindex="-1"></a>    <span class="at">sampleData =</span>  <span class="fu">colData</span>(spikein),</span>
<span id="cb43-4"><a href="sec-concepts.html#cb43-4" tabindex="-1"></a>    <span class="at">designFormula =</span> <span class="sc">~</span> <span class="dv">0</span> <span class="sc">+</span> Condition,</span>
<span id="cb43-5"><a href="sec-concepts.html#cb43-5" tabindex="-1"></a>    <span class="at">textSizeFitted =</span> <span class="dv">4</span></span>
<span id="cb43-6"><a href="sec-concepts.html#cb43-6" tabindex="-1"></a>)</span>
<span id="cb43-7"><a href="sec-concepts.html#cb43-7" tabindex="-1"></a>vd<span class="sc">$</span>plotlist</span></code></pre></div>
<pre><code>## [[1]]</code></pre>
<p><img src="msqrob2_book_files/figure-html/unnamed-chunk-38-1.png" width="672"></p>
<p>The plot above depicts that the average protein intensity for the
spike-in dilution factor 1x is provided by the parameter <code>Condition1</code>,
the <code>Condition0.667</code> parameter for the dilution factor 0.667x, etc.</p>
<p>With <code>getCoef()</code>, we can retrieve the estimated model parameters. We
will focus on the last model as an illustration, but the same approach
applies for any model estimated by <code>msqrob()</code> or <code>msqrobAggregate()</code>.
We start with extracting the model output, stored as <code>StatModel</code>
objects, from the <code>rowData</code>. Next, <code>getCoef()</code> retrieves the estimated
model parameters:</p>
<div class="sourceCode" id="cb45"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb45-1"><a href="sec-concepts.html#cb45-1" tabindex="-1"></a>models <span class="ot">&lt;-</span> <span class="fu">rowData</span>(spikein[[<span class="st">"proteins_msqrob"</span>]])<span class="sc">$</span>msqrob_psm_rrilmm</span>
<span id="cb45-2"><a href="sec-concepts.html#cb45-2" tabindex="-1"></a>params <span class="ot">&lt;-</span> <span class="fu">getCoef</span>(models[[<span class="dv">1</span>]])</span>
<span id="cb45-3"><a href="sec-concepts.html#cb45-3" tabindex="-1"></a><span class="fu">head</span>(params)</span></code></pre></div>
<pre><code>##                            (Intercept) (Intercept)Run:ChannelMixture1_01:127C 
##                              -0.913257                               0.000000 
## (Intercept)Run:ChannelMixture1_01:127N (Intercept)Run:ChannelMixture1_01:128C 
##                               0.000000                               0.000000 
## (Intercept)Run:ChannelMixture1_01:128N (Intercept)Run:ChannelMixture1_01:129C 
##                               0.000000                               0.000000</code></pre>
<p>The PSM model estimated parameters to model the
fixed and random effects. However, we are interested, for this data
set, in the parameters that model the effect of <code>Condition</code>.</p>
<div class="sourceCode" id="cb47"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb47-1"><a href="sec-concepts.html#cb47-1" tabindex="-1"></a>params[<span class="fu">grep</span>(<span class="st">"Condition"</span>, <span class="fu">names</span>(params))]</span></code></pre></div>
<pre><code>## ridgeCondition0.125   ridgeCondition0.5 ridgeCondition0.667     ridgeCondition1 
##         0.047271419        -0.007637059        -0.006342834        -0.033291526</code></pre>
<p>Note the <code>"ridge"</code> tag in front of the parameter names that indicates
the parameters have been estimated using ridge penalisation. For this
protein we can see that the effects of condition are very close to
zero, as expected since the protein is part of the HeLa background.
However, we can explore the parameters for one of the UPS proteins.</p>
<div class="sourceCode" id="cb49"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb49-1"><a href="sec-concepts.html#cb49-1" tabindex="-1"></a>params <span class="ot">&lt;-</span> <span class="fu">getCoef</span>(models[[<span class="st">"O00762ups"</span>]])</span>
<span id="cb49-2"><a href="sec-concepts.html#cb49-2" tabindex="-1"></a>params[<span class="fu">grep</span>(<span class="st">"Condition"</span>, <span class="fu">names</span>(params))]</span></code></pre></div>
<pre><code>## ridgeCondition0.125   ridgeCondition0.5 ridgeCondition0.667     ridgeCondition1 
##         -1.39369917          0.02426978          0.42348486          0.92013528</code></pre>
<p>Let’s know verify the result provide the expected fold change. To do
so we define a contrast, that is a parameter combination that provide
an answer to the research question, for instance for the average
log2 difference in intensity between condition 1x and condition 0.5x.
Since this is a benchmark study, the obvious answer is <span class="math inline">\(log_2(1) -
log_2(0.5) = 1\)</span>.</p>
<div class="sourceCode" id="cb51"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb51-1"><a href="sec-concepts.html#cb51-1" tabindex="-1"></a><span class="fu">unname</span>(params[<span class="st">"ridgeCondition1"</span>] <span class="sc">-</span> params[<span class="st">"ridgeCondition0.5"</span>])</span></code></pre></div>
<pre><code>## [1] 0.8958655</code></pre>
<p>This value is close to the expected value. Now, the question is how
statistically significant is the estimated log2 fold change.</p>
<div id="hypothesis-testing" class="section level3" number="2.7.1">
<h3>
<span class="header-section-number">2.7.1</span> Hypothesis testing<div class="tooltip"><button class="internal-link-btn" onclick="copy_link('hypothesis-testing')" onmouseout="reset_tooltip('hypothesis-testing-tooltip')"><span class="tooltiptext" id="hypothesis-testing-tooltip">Copy link</span><i class="fa fa-link"></i></button></div>
</h3>
<p>As shown above, the average difference intensity between the 1x and
the 0.5x conditions is provided by <code>ridgeCondition1 - ridgeCondition0.5</code>. This combination of parameters is called a
contrast. We next define a null hypothesis, here that the differences
between the two groups is zero.</p>
<div class="sourceCode" id="cb53"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb53-1"><a href="sec-concepts.html#cb53-1" tabindex="-1"></a>hypothesis <span class="ot">&lt;-</span> <span class="st">"ridgeCondition1 - ridgeCondition0.5 = 0"</span></span></code></pre></div>
<p><code>makeContrast()</code> converts the hypothesis into a formal contrast
matrix with parameter names as rows and hypotheses in columns (you
can specify <a href="sec-concepts.html#sec-multiple_contrasts">multiple hypotheses</a>).</p>
<div class="sourceCode" id="cb54"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb54-1"><a href="sec-concepts.html#cb54-1" tabindex="-1"></a>(L <span class="ot">&lt;-</span> <span class="fu">makeContrast</span>(</span>
<span id="cb54-2"><a href="sec-concepts.html#cb54-2" tabindex="-1"></a>    <span class="st">"ridgeCondition1 - ridgeCondition0.5 = 0"</span>,</span>
<span id="cb54-3"><a href="sec-concepts.html#cb54-3" tabindex="-1"></a>    <span class="fu">c</span>(<span class="st">"ridgeCondition1"</span>, <span class="st">"ridgeCondition0.5"</span>)</span>
<span id="cb54-4"><a href="sec-concepts.html#cb54-4" tabindex="-1"></a>))</span></code></pre></div>
<pre><code>##                   ridgeCondition1 - ridgeCondition0.5
## ridgeCondition1                                     1
## ridgeCondition0.5                                  -1</code></pre>
<p>We can now test our null hypothesis using <code>hypothesisTest()</code> which
takes the <code>QFeatures</code> object with the fitted model and the contrast we
just built (recall that the model estimation has been stored in the
<code>proteins_msqrob</code> set). <code>msqrob2</code> automatically applies the hypothesis
testing to all proteins in the data.</p>
<div class="sourceCode" id="cb56"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb56-1"><a href="sec-concepts.html#cb56-1" tabindex="-1"></a>spikein <span class="ot">&lt;-</span> <span class="fu">hypothesisTest</span>(</span>
<span id="cb56-2"><a href="sec-concepts.html#cb56-2" tabindex="-1"></a>    spikein, <span class="at">i =</span> <span class="st">"proteins_msqrob"</span>, <span class="at">contrast =</span> L,</span>
<span id="cb56-3"><a href="sec-concepts.html#cb56-3" tabindex="-1"></a>    <span class="at">modelColumn =</span> <span class="st">"msqrob_psm_rrilmm"</span></span>
<span id="cb56-4"><a href="sec-concepts.html#cb56-4" tabindex="-1"></a>)</span></code></pre></div>
<p>The results are stored in the set containing the model, here
<code>proteins_msqrob</code>. Let’s retrieve the results from the <code>rowData</code>.</p>
<div class="sourceCode" id="cb57"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb57-1"><a href="sec-concepts.html#cb57-1" tabindex="-1"></a>inference <span class="ot">&lt;-</span> <span class="fu">rowData</span>(spikein[[<span class="st">"proteins_msqrob"</span>]])<span class="sc">$</span><span class="st">"ridgeCondition1 - ridgeCondition0.5"</span></span>
<span id="cb57-2"><a href="sec-concepts.html#cb57-2" tabindex="-1"></a>inference<span class="sc">$</span>Protein <span class="ot">&lt;-</span> <span class="fu">rownames</span>(inference)</span>
<span id="cb57-3"><a href="sec-concepts.html#cb57-3" tabindex="-1"></a>inference<span class="sc">$</span>isUps <span class="ot">&lt;-</span> <span class="fu">grepl</span>(<span class="st">"ups"</span>, inference<span class="sc">$</span>Protein)</span>
<span id="cb57-4"><a href="sec-concepts.html#cb57-4" tabindex="-1"></a><span class="fu">head</span>(inference)</span></code></pre></div>
<pre><code>##              logFC           se         df          t        pval   adjPval Protein isUps
## O00151 -0.02565447 2.156328e-02  471.94804 -1.1897295 0.234750886 0.5788016  O00151 FALSE
## O00220  0.01426040 5.754843e-02   94.48815  0.2477982 0.804828245 1.0000000  O00220 FALSE
## O00244  0.00000000 3.771470e-11   84.16934  0.0000000 1.000000000 1.0000000  O00244 FALSE
## O00299 -0.03165728 1.172145e-02 1380.25430 -2.7008000 0.007001905 0.0365266  O00299 FALSE
## O00330 -0.02898741 3.674550e-02  193.93483 -0.7888696 0.431151554 0.8650669  O00330 FALSE
## O00399          NA           NA         NA         NA          NA        NA  O00399 FALSE</code></pre>
<p>The last row is filled with missing values because data modelling
resulted in a <code>fitError</code> (we will explore in a <a href="sec-concepts.html#sec-fiterror">later
section</a> how we can deal with proteins that could not
be fit).</p>
</div>
<div id="volcano-plots" class="section level3" number="2.7.2">
<h3>
<span class="header-section-number">2.7.2</span> Volcano plots<div class="tooltip"><button class="internal-link-btn" onclick="copy_link('volcano-plots')" onmouseout="reset_tooltip('volcano-plots-tooltip')"><span class="tooltiptext" id="volcano-plots-tooltip">Copy link</span><i class="fa fa-link"></i></button></div>
</h3>
<p>We can use the table above directly to build a volcano plot using
<code>ggplot2</code> functionality. We also highlight which proteins are UPS
standards, known to be differentially abundant by experimental design.</p>
<div class="sourceCode" id="cb59"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb59-1"><a href="sec-concepts.html#cb59-1" tabindex="-1"></a><span class="fu">ggplot</span>(inference) <span class="sc">+</span></span>
<span id="cb59-2"><a href="sec-concepts.html#cb59-2" tabindex="-1"></a>  <span class="fu">aes</span>(<span class="at">x =</span> logFC,</span>
<span id="cb59-3"><a href="sec-concepts.html#cb59-3" tabindex="-1"></a>      <span class="at">y =</span> <span class="sc">-</span><span class="fu">log10</span>(adjPval),</span>
<span id="cb59-4"><a href="sec-concepts.html#cb59-4" tabindex="-1"></a>      <span class="at">color =</span> isUps) <span class="sc">+</span></span>
<span id="cb59-5"><a href="sec-concepts.html#cb59-5" tabindex="-1"></a>  <span class="fu">geom_point</span>() <span class="sc">+</span></span>
<span id="cb59-6"><a href="sec-concepts.html#cb59-6" tabindex="-1"></a>  <span class="fu">scale_color_manual</span>(</span>
<span id="cb59-7"><a href="sec-concepts.html#cb59-7" tabindex="-1"></a>    <span class="at">values =</span> <span class="fu">c</span>(<span class="st">"grey20"</span>, <span class="st">"firebrick"</span>), <span class="at">name =</span> <span class="st">""</span>,</span>
<span id="cb59-8"><a href="sec-concepts.html#cb59-8" tabindex="-1"></a>    <span class="at">labels =</span> <span class="fu">c</span>(<span class="st">"HeLA background"</span>, <span class="st">"UPS standard"</span>)</span>
<span id="cb59-9"><a href="sec-concepts.html#cb59-9" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb59-10"><a href="sec-concepts.html#cb59-10" tabindex="-1"></a>  <span class="fu">ggtitle</span>(<span class="st">"msqrob_psm_rrilm model"</span>,</span>
<span id="cb59-11"><a href="sec-concepts.html#cb59-11" tabindex="-1"></a>          <span class="st">"Hypothesis test: Condition 1x - 0.5x = 0"</span>)</span></code></pre></div>
<p><img src="msqrob2_book_files/figure-html/unnamed-chunk-47-1.png" width="672"></p>
<p>Note, that 64 proteins
are found to be differentially abundant containing almost all UPS
proteins, as expected.</p>
<div class="sourceCode" id="cb60"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb60-1"><a href="sec-concepts.html#cb60-1" tabindex="-1"></a><span class="fu">table</span>(<span class="at">is_significant =</span> inference<span class="sc">$</span>adjPval <span class="sc">&lt;</span> <span class="fl">0.05</span>, </span>
<span id="cb60-2"><a href="sec-concepts.html#cb60-2" tabindex="-1"></a>      <span class="at">is_ups =</span> <span class="fu">grepl</span>(<span class="st">"ups"</span>, inference<span class="sc">$</span>Protein))</span></code></pre></div>
<pre><code>##               is_ups
## is_significant FALSE TRUE
##          FALSE   248    1
##          TRUE     32   32</code></pre>
</div>
<div id="fold-change-distributions" class="section level3" number="2.7.3">
<h3>
<span class="header-section-number">2.7.3</span> Fold change distributions<div class="tooltip"><button class="internal-link-btn" onclick="copy_link('fold-change-distributions')" onmouseout="reset_tooltip('fold-change-distributions-tooltip')"><span class="tooltiptext" id="fold-change-distributions-tooltip">Copy link</span><i class="fa fa-link"></i></button></div>
</h3>
<p>As this is a spike-in study with known ground truth, we can also plot
the log2 fold change distributions against the expected values, in
this case 0 for the HeLa proteins and 1 for the UPS standards.</p>
<div class="sourceCode" id="cb62"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb62-1"><a href="sec-concepts.html#cb62-1" tabindex="-1"></a><span class="fu">ggplot</span>(inference) <span class="sc">+</span></span>
<span id="cb62-2"><a href="sec-concepts.html#cb62-2" tabindex="-1"></a>    <span class="fu">aes</span>(<span class="at">y =</span> logFC,</span>
<span id="cb62-3"><a href="sec-concepts.html#cb62-3" tabindex="-1"></a>        <span class="at">x =</span> isUps,</span>
<span id="cb62-4"><a href="sec-concepts.html#cb62-4" tabindex="-1"></a>        <span class="at">colour =</span> isUps) <span class="sc">+</span></span>
<span id="cb62-5"><a href="sec-concepts.html#cb62-5" tabindex="-1"></a>    <span class="fu">geom_boxplot</span>() <span class="sc">+</span></span>
<span id="cb62-6"><a href="sec-concepts.html#cb62-6" tabindex="-1"></a>    <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">1</span>), <span class="at">colour =</span> <span class="fu">c</span>(<span class="st">"grey20"</span>, <span class="st">"firebrick"</span>)) <span class="sc">+</span></span>
<span id="cb62-7"><a href="sec-concepts.html#cb62-7" tabindex="-1"></a>    <span class="fu">scale_color_manual</span>(</span>
<span id="cb62-8"><a href="sec-concepts.html#cb62-8" tabindex="-1"></a>        <span class="at">values =</span> <span class="fu">c</span>(<span class="st">"grey20"</span>, <span class="st">"firebrick"</span>), <span class="at">name =</span> <span class="st">""</span>,</span>
<span id="cb62-9"><a href="sec-concepts.html#cb62-9" tabindex="-1"></a>        <span class="at">labels =</span> <span class="fu">c</span>(<span class="st">"HeLA background"</span>, <span class="st">"UPS standard"</span>)</span>
<span id="cb62-10"><a href="sec-concepts.html#cb62-10" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb62-11"><a href="sec-concepts.html#cb62-11" tabindex="-1"></a>    <span class="fu">ggtitle</span>(<span class="st">"Distribution of the log2 fold changes"</span>,</span>
<span id="cb62-12"><a href="sec-concepts.html#cb62-12" tabindex="-1"></a>            <span class="st">"Hypothesis test: Condition 1x - 0.5x = 0"</span>)</span></code></pre></div>
<p><img src="msqrob2_book_files/figure-html/unnamed-chunk-49-1.png" width="672"></p>
<p>Estimated log2 fold change for HeLa proteins are closely distributed
around 0, as expected. log2 fold changes for UPS standard proteins are
distributed toward 1, although it is underestimated as reported
previously <span class="citation">(<label for="tufte-mn-11" class="margin-toggle">⊕</label><input type="checkbox" id="tufte-mn-11" class="margin-toggle">Savitski et al. 2011<span class="marginnote">Savitski, Mikhail M, Gavain Sweetman, Manor Askenazi, Jarrod A Marto, Manja Lang, Nico Zinn, and Marcus Bantscheff. 2011. <span>“Delayed Fragmentation and Optimized Isolation Width Settings for Improvement of Protein Identification and Accuracy of Isobaric Mass Tag Quantification on Orbitrap-Type Mass Spectrometers.”</span> <em>Anal. Chem.</em> 83 (23): 8959–67.</span>)</span>.</p>
</div>
<div id="heatmap" class="section level3" number="2.7.4">
<h3>
<span class="header-section-number">2.7.4</span> Heatmap<div class="tooltip"><button class="internal-link-btn" onclick="copy_link('heatmap')" onmouseout="reset_tooltip('heatmap-tooltip')"><span class="tooltiptext" id="heatmap-tooltip">Copy link</span><i class="fa fa-link"></i></button></div>
</h3>
<p>We can also build a heatmap for the significant proteins which are
obtained by filtering the inference table.</p>
<p><strong>TODO</strong> use ComplexHeatmap for building a heatmap?</p>
</div>
<div id="detail-plots" class="section level3" number="2.7.5">
<h3>
<span class="header-section-number">2.7.5</span> Detail plots<div class="tooltip"><button class="internal-link-btn" onclick="copy_link('detail-plots')" onmouseout="reset_tooltip('detail-plots-tooltip')"><span class="tooltiptext" id="detail-plots-tooltip">Copy link</span><i class="fa fa-link"></i></button></div>
</h3>
<p>We can explore the PSM intensities for a protein to validate the
statistical inference results. For example, let’s explore the
intensities for the protein with the most significant difference.</p>
<div class="sourceCode" id="cb63"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb63-1"><a href="sec-concepts.html#cb63-1" tabindex="-1"></a>(targetProtein <span class="ot">&lt;-</span> <span class="fu">rownames</span>(inference)[<span class="fu">which.min</span>(inference<span class="sc">$</span>adjPval)])</span></code></pre></div>
<pre><code>## [1] "P02788ups"</code></pre>
<p>To obtain the required data, we perform a little data manipulation
pipeline:</p>
<ol style="list-style-type: decimal">
<li>We use the <code>QFeatures</code> subsetting functionality to retrieve all data
related to and focusing on the <code>ions</code> set that
contains the peptide ion data used for model fitting.</li>
<li>We use <code>longForm()</code> to convert the object into a table suitable for
plotting.</li>
<li>We remove missing values for plotting.</li>
<li>We reorder the sample identifiers to improve visualisation.</li>
</ol>
<div class="sourceCode" id="cb65"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb65-1"><a href="sec-concepts.html#cb65-1" tabindex="-1"></a>ionData <span class="ot">&lt;-</span> spikein[targetProtein, , <span class="st">"ions"</span>] <span class="sc">|&gt;</span> <span class="co">#1</span></span>
<span id="cb65-2"><a href="sec-concepts.html#cb65-2" tabindex="-1"></a>    <span class="fu">longForm</span>(<span class="at">colvars =</span> <span class="fu">colnames</span>(<span class="fu">colData</span>(spikein)), <span class="co">#2</span></span>
<span id="cb65-3"><a href="sec-concepts.html#cb65-3" tabindex="-1"></a>               <span class="at">rowvars =</span> <span class="fu">c</span>(<span class="st">"Protein.Accessions"</span>, <span class="st">"ionID"</span>)) <span class="sc">|&gt;</span></span>
<span id="cb65-4"><a href="sec-concepts.html#cb65-4" tabindex="-1"></a>    <span class="fu">data.frame</span>() <span class="sc">|&gt;</span></span>
<span id="cb65-5"><a href="sec-concepts.html#cb65-5" tabindex="-1"></a>    <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(value)) <span class="sc">|&gt;</span> <span class="co">#3</span></span>
<span id="cb65-6"><a href="sec-concepts.html#cb65-6" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">colname =</span> <span class="fu">factor</span>(colname, <span class="at">levels =</span> <span class="fu">unique</span>(colname[<span class="fu">order</span>(Condition)]))) <span class="co">#4</span></span></code></pre></div>
<p>Finally, we plot the log2 normalised intensities for each sample.
Since the protein is modelled at the peptide ion level, multiple ion
intensities are recorded in each sample. Each ion is linked across
samples using a grey line. Samples are colored according to UPS
spike-in condition. Finally, we split the plot in facets, one for each
mixture, to visualise the heterogeneity induced by sample preparation.</p>
<div class="sourceCode" id="cb66"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb66-1"><a href="sec-concepts.html#cb66-1" tabindex="-1"></a><span class="fu">ggplot</span>(ionData) <span class="sc">+</span></span>
<span id="cb66-2"><a href="sec-concepts.html#cb66-2" tabindex="-1"></a>    <span class="fu">aes</span>(<span class="at">x =</span> colname,</span>
<span id="cb66-3"><a href="sec-concepts.html#cb66-3" tabindex="-1"></a>        <span class="at">y =</span> value) <span class="sc">+</span></span>
<span id="cb66-4"><a href="sec-concepts.html#cb66-4" tabindex="-1"></a>    <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">group =</span> ionID), <span class="at">linewidth =</span> <span class="fl">0.1</span>) <span class="sc">+</span></span>
<span id="cb66-5"><a href="sec-concepts.html#cb66-5" tabindex="-1"></a>    <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">colour =</span> Condition)) <span class="sc">+</span></span>
<span id="cb66-6"><a href="sec-concepts.html#cb66-6" tabindex="-1"></a>    <span class="fu">facet_grid</span>(<span class="sc">~</span> Mixture, <span class="at">scales =</span> <span class="st">"free"</span>) <span class="sc">+</span></span>
<span id="cb66-7"><a href="sec-concepts.html#cb66-7" tabindex="-1"></a>    <span class="fu">ggtitle</span>(targetProtein) <span class="sc">+</span></span>
<span id="cb66-8"><a href="sec-concepts.html#cb66-8" tabindex="-1"></a>    <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb66-9"><a href="sec-concepts.html#cb66-9" tabindex="-1"></a>    <span class="fu">theme</span>(<span class="at">axis.text.x =</span> <span class="fu">element_blank</span>())</span></code></pre></div>
<p><img src="msqrob2_book_files/figure-html/unnamed-chunk-52-1.png" width="960"></p>
</div>
</div>
<div id="protein-level-models" class="section level2" number="2.8">
<h2>
<span class="header-section-number">2.8</span> Protein-level models<div class="tooltip"><button class="internal-link-btn" onclick="copy_link('protein-level-models')" onmouseout="reset_tooltip('protein-level-models-tooltip')"><span class="tooltiptext" id="protein-level-models-tooltip">Copy link</span><i class="fa fa-link"></i></button></div>
</h2>
<p>Performing the statistical inference for summarisation-based models,
hence modelling protein-level data, is very similar as for the
PSM-based models shown above. Let’s apply the same statistical
inference pipeline for the <code>msqrob_rrilmm</code> model stored in the
<code>QFeatures</code> object.</p>
<div class="sourceCode" id="cb67"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb67-1"><a href="sec-concepts.html#cb67-1" tabindex="-1"></a>L <span class="ot">&lt;-</span> <span class="fu">makeContrast</span>(</span>
<span id="cb67-2"><a href="sec-concepts.html#cb67-2" tabindex="-1"></a>    <span class="st">"ridgeCondition1 - ridgeCondition0.5 = 0"</span>,</span>
<span id="cb67-3"><a href="sec-concepts.html#cb67-3" tabindex="-1"></a>    <span class="fu">c</span>(<span class="st">"ridgeCondition1"</span>, <span class="st">"ridgeCondition0.5"</span>)</span>
<span id="cb67-4"><a href="sec-concepts.html#cb67-4" tabindex="-1"></a>)</span>
<span id="cb67-5"><a href="sec-concepts.html#cb67-5" tabindex="-1"></a>spikein <span class="ot">&lt;-</span> <span class="fu">hypothesisTest</span>(</span>
<span id="cb67-6"><a href="sec-concepts.html#cb67-6" tabindex="-1"></a>    spikein, <span class="at">i =</span> <span class="st">"proteins"</span>, <span class="at">contrast =</span> L,</span>
<span id="cb67-7"><a href="sec-concepts.html#cb67-7" tabindex="-1"></a>    <span class="at">modelColumn =</span> <span class="st">"msqrob_rrilmm"</span></span>
<span id="cb67-8"><a href="sec-concepts.html#cb67-8" tabindex="-1"></a>)</span>
<span id="cb67-9"><a href="sec-concepts.html#cb67-9" tabindex="-1"></a>inferenceProt <span class="ot">&lt;-</span> <span class="fu">rowData</span>(spikein[[<span class="st">"proteins"</span>]])<span class="sc">$</span><span class="st">"ridgeCondition1 - ridgeCondition0.5"</span></span></code></pre></div>
<p>We build the volcano using the same code:</p>
<div class="sourceCode" id="cb68"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb68-1"><a href="sec-concepts.html#cb68-1" tabindex="-1"></a>inferenceProt<span class="sc">$</span>protein <span class="ot">&lt;-</span> <span class="fu">rownames</span>(inferenceProt)</span>
<span id="cb68-2"><a href="sec-concepts.html#cb68-2" tabindex="-1"></a>inferenceProt<span class="sc">$</span>isUps <span class="ot">&lt;-</span> <span class="fu">grepl</span>(<span class="st">"ups"</span>, inferenceProt<span class="sc">$</span>protein)</span>
<span id="cb68-3"><a href="sec-concepts.html#cb68-3" tabindex="-1"></a><span class="fu">ggplot</span>(inferenceProt) <span class="sc">+</span></span>
<span id="cb68-4"><a href="sec-concepts.html#cb68-4" tabindex="-1"></a>    <span class="fu">aes</span>(<span class="at">x =</span> logFC,</span>
<span id="cb68-5"><a href="sec-concepts.html#cb68-5" tabindex="-1"></a>        <span class="at">y =</span> <span class="sc">-</span><span class="fu">log10</span>(adjPval),</span>
<span id="cb68-6"><a href="sec-concepts.html#cb68-6" tabindex="-1"></a>        <span class="at">color =</span> isUps) <span class="sc">+</span></span>
<span id="cb68-7"><a href="sec-concepts.html#cb68-7" tabindex="-1"></a>    <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="sc">-</span><span class="fu">log10</span>(<span class="fl">0.05</span>)) <span class="sc">+</span></span>
<span id="cb68-8"><a href="sec-concepts.html#cb68-8" tabindex="-1"></a>    <span class="fu">geom_point</span>() <span class="sc">+</span></span>
<span id="cb68-9"><a href="sec-concepts.html#cb68-9" tabindex="-1"></a>    <span class="fu">scale_color_manual</span>(</span>
<span id="cb68-10"><a href="sec-concepts.html#cb68-10" tabindex="-1"></a>        <span class="at">values =</span> <span class="fu">c</span>(<span class="st">"grey20"</span>, <span class="st">"firebrick"</span>), <span class="at">name =</span> <span class="st">""</span>,</span>
<span id="cb68-11"><a href="sec-concepts.html#cb68-11" tabindex="-1"></a>        <span class="at">labels =</span> <span class="fu">c</span>(<span class="st">"HeLA background"</span>, <span class="st">"UPS standard"</span>)</span>
<span id="cb68-12"><a href="sec-concepts.html#cb68-12" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb68-13"><a href="sec-concepts.html#cb68-13" tabindex="-1"></a>    <span class="fu">ggtitle</span>(<span class="st">"msqrob_rrilm model"</span>,</span>
<span id="cb68-14"><a href="sec-concepts.html#cb68-14" tabindex="-1"></a>            <span class="st">"Hypothesis test: Condition 1x - 0.5x = 0</span><span class="sc">\n</span><span class="st">Protein-level modelling"</span>)</span></code></pre></div>
<p><img src="msqrob2_book_files/figure-html/unnamed-chunk-54-1.png" width="672"></p>
<p>We plot the fold change distributions:</p>
<div class="sourceCode" id="cb69"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb69-1"><a href="sec-concepts.html#cb69-1" tabindex="-1"></a><span class="fu">ggplot</span>(inferenceProt) <span class="sc">+</span></span>
<span id="cb69-2"><a href="sec-concepts.html#cb69-2" tabindex="-1"></a>    <span class="fu">aes</span>(<span class="at">y =</span> logFC,</span>
<span id="cb69-3"><a href="sec-concepts.html#cb69-3" tabindex="-1"></a>        <span class="at">x =</span> isUps,</span>
<span id="cb69-4"><a href="sec-concepts.html#cb69-4" tabindex="-1"></a>        <span class="at">colour =</span> isUps) <span class="sc">+</span></span>
<span id="cb69-5"><a href="sec-concepts.html#cb69-5" tabindex="-1"></a>    <span class="fu">geom_boxplot</span>() <span class="sc">+</span></span>
<span id="cb69-6"><a href="sec-concepts.html#cb69-6" tabindex="-1"></a>    <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">1</span>), <span class="at">colour =</span> <span class="fu">c</span>(<span class="st">"grey20"</span>, <span class="st">"firebrick"</span>)) <span class="sc">+</span></span>
<span id="cb69-7"><a href="sec-concepts.html#cb69-7" tabindex="-1"></a>    <span class="fu">scale_color_manual</span>(</span>
<span id="cb69-8"><a href="sec-concepts.html#cb69-8" tabindex="-1"></a>        <span class="at">values =</span> <span class="fu">c</span>(<span class="st">"grey20"</span>, <span class="st">"firebrick"</span>), <span class="at">name =</span> <span class="st">""</span>,</span>
<span id="cb69-9"><a href="sec-concepts.html#cb69-9" tabindex="-1"></a>        <span class="at">labels =</span> <span class="fu">c</span>(<span class="st">"HeLA background"</span>, <span class="st">"UPS standard"</span>)</span>
<span id="cb69-10"><a href="sec-concepts.html#cb69-10" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb69-11"><a href="sec-concepts.html#cb69-11" tabindex="-1"></a>    <span class="fu">ggtitle</span>(<span class="st">"Distribution of the log2 fold changes"</span>,</span>
<span id="cb69-12"><a href="sec-concepts.html#cb69-12" tabindex="-1"></a>            <span class="st">"Hypothesis test: Condition 1x - 0.5x = 0</span><span class="sc">\n</span><span class="st">Protein-level modelling"</span>)</span></code></pre></div>
<p><img src="msqrob2_book_files/figure-html/unnamed-chunk-55-1.png" width="672"></p>
<p>Exploring the intensities at the protein level is simplified compared
to PSM-level exploration since every sample now contains a single
observation, the protein intensity.</p>
<div class="sourceCode" id="cb70"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb70-1"><a href="sec-concepts.html#cb70-1" tabindex="-1"></a><span class="fu">data.frame</span>(<span class="at">intensity =</span> <span class="fu">assay</span>(spikein[[<span class="st">"proteins"</span>]])[targetProtein, ],</span>
<span id="cb70-2"><a href="sec-concepts.html#cb70-2" tabindex="-1"></a>           <span class="fu">colData</span>(spikein),</span>
<span id="cb70-3"><a href="sec-concepts.html#cb70-3" tabindex="-1"></a>           <span class="at">colname =</span> <span class="fu">colnames</span>(spikein[[<span class="st">"proteins"</span>]])) <span class="sc">|&gt;</span></span>
<span id="cb70-4"><a href="sec-concepts.html#cb70-4" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">colname =</span> <span class="fu">factor</span>(colname, <span class="at">levels =</span> <span class="fu">unique</span>(colname[<span class="fu">order</span>(Condition)]))) <span class="sc">|&gt;</span></span>
<span id="cb70-5"><a href="sec-concepts.html#cb70-5" tabindex="-1"></a>    <span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb70-6"><a href="sec-concepts.html#cb70-6" tabindex="-1"></a>    <span class="fu">aes</span>(<span class="at">x =</span> colname,</span>
<span id="cb70-7"><a href="sec-concepts.html#cb70-7" tabindex="-1"></a>        <span class="at">y =</span> intensity) <span class="sc">+</span></span>
<span id="cb70-8"><a href="sec-concepts.html#cb70-8" tabindex="-1"></a>    <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">colour =</span> Condition)) <span class="sc">+</span></span>
<span id="cb70-9"><a href="sec-concepts.html#cb70-9" tabindex="-1"></a>    <span class="fu">facet_grid</span>(<span class="sc">~</span> Mixture, <span class="at">scales =</span> <span class="st">"free"</span>) <span class="sc">+</span></span>
<span id="cb70-10"><a href="sec-concepts.html#cb70-10" tabindex="-1"></a>    <span class="fu">ggtitle</span>(targetProtein) <span class="sc">+</span></span>
<span id="cb70-11"><a href="sec-concepts.html#cb70-11" tabindex="-1"></a>    <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb70-12"><a href="sec-concepts.html#cb70-12" tabindex="-1"></a>    <span class="fu">theme</span>(<span class="at">axis.text.x =</span> <span class="fu">element_blank</span>())</span></code></pre></div>
<p><img src="msqrob2_book_files/figure-html/unnamed-chunk-56-1.png" width="672"></p>
<p>Notice how the summarisation-based approach hides the variation
associated with the measurement of different peptide ions within the
same protein, as well as discrepancies between peptide identification
rates across mixtures.</p>
<div id="inference-for-all-pairwise-comparisons-between-conditions" class="section level3" number="2.8.1">
<h3>
<span class="header-section-number">2.8.1</span> Inference for all pairwise comparisons between conditions<div class="tooltip"><button class="internal-link-btn" onclick="copy_link('inference-for-all-pairwise-comparisons-between-conditions')" onmouseout="reset_tooltip('inference-for-all-pairwise-comparisons-between-conditions-tooltip')"><span class="tooltiptext" id="inference-for-all-pairwise-comparisons-between-conditions-tooltip">Copy link</span><i class="fa fa-link"></i></button></div>
</h3>
<p>For a factor variable, we often want to infer on all pairwise
comparisons between the groups. Note, that our models have a fixed
effect component that consist of a single factor and that we have
chosen to suppress the intercept. <code>msqrob2</code> therefore returned models
with a separate model parameter to estimate the mean for every group.</p>
<div class="sourceCode" id="cb71"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb71-1"><a href="sec-concepts.html#cb71-1" tabindex="-1"></a>design_fixed  <span class="ot">&lt;-</span> <span class="fu">model.matrix</span>(<span class="sc">~</span> <span class="dv">0</span> <span class="sc">+</span> Condition, <span class="fu">colData</span>(spikein))</span>
<span id="cb71-2"><a href="sec-concepts.html#cb71-2" tabindex="-1"></a>(param_names_fixed <span class="ot">&lt;-</span> <span class="fu">colnames</span>(design_fixed))</span></code></pre></div>
<pre><code>## [1] "Condition0.125" "Condition0.5"   "Condition0.667" "Condition1"</code></pre>
<p>If we use ridge regression, <code>msqrob2</code> by default will put the prefix
<code>ridge</code> to the parameter names of the fixed effects.</p>
<div class="sourceCode" id="cb73"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb73-1"><a href="sec-concepts.html#cb73-1" tabindex="-1"></a>(param_names_fixed <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">"ridge"</span>, param_names_fixed))</span></code></pre></div>
<pre><code>## [1] "ridgeCondition0.125" "ridgeCondition0.5"   "ridgeCondition0.667" "ridgeCondition1"</code></pre>
<p>We now make all pairwise contrasts. The function <code>combn()</code> can make all
combinations of a vector and we apply the function <code>paste()</code> with the
argument <code>collapse = " - "</code> to these combinations. This makes a vector
of strings specifying all contrasts of interest. Upon pasting “= 0”
to each of the contrasts, all null hypotheses corresponding to the
pairwise comparisons are specified.</p>
<p>Note, that we first sort the parameter names in decreasing order to
ensure that a positive log2 fold change estimate refers to an
upregulation in the highest spike-in condition involved in the
comparison.</p>
<div class="sourceCode" id="cb75"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb75-1"><a href="sec-concepts.html#cb75-1" tabindex="-1"></a>(hypotheses <span class="ot">&lt;-</span> param_names_fixed <span class="sc">|&gt;</span></span>
<span id="cb75-2"><a href="sec-concepts.html#cb75-2" tabindex="-1"></a>     <span class="fu">sort</span>(<span class="at">decreasing =</span> <span class="cn">TRUE</span>) <span class="sc">|&gt;</span></span>
<span id="cb75-3"><a href="sec-concepts.html#cb75-3" tabindex="-1"></a>     <span class="fu">combn</span>(<span class="dv">2</span>, paste, <span class="at">collapse=</span><span class="st">" - "</span>) <span class="sc">|&gt;</span></span>
<span id="cb75-4"><a href="sec-concepts.html#cb75-4" tabindex="-1"></a>     <span class="fu">paste</span>(<span class="st">"= 0"</span>))</span></code></pre></div>
<pre><code>## [1] "ridgeCondition1 - ridgeCondition0.667 = 0"     "ridgeCondition1 - ridgeCondition0.5 = 0"      
## [3] "ridgeCondition1 - ridgeCondition0.125 = 0"     "ridgeCondition0.667 - ridgeCondition0.5 = 0"  
## [5] "ridgeCondition0.667 - ridgeCondition0.125 = 0" "ridgeCondition0.5 - ridgeCondition0.125 = 0"</code></pre>
<p>We now have specified the null hypotheses for all pairwise contrasts
of interest. Below, we will generate the contrast matrix for these six
contrasts.</p>
<div class="sourceCode" id="cb77"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb77-1"><a href="sec-concepts.html#cb77-1" tabindex="-1"></a>(L <span class="ot">&lt;-</span> <span class="fu">makeContrast</span>(hypotheses, <span class="at">parameterNames =</span> param_names_fixed))</span></code></pre></div>
<pre><code>##                     ridgeCondition1 - ridgeCondition0.667 ridgeCondition1 - ridgeCondition0.5
## ridgeCondition0.125                                     0                                   0
## ridgeCondition0.5                                       0                                  -1
## ridgeCondition0.667                                    -1                                   0
## ridgeCondition1                                         1                                   1
##                     ridgeCondition1 - ridgeCondition0.125 ridgeCondition0.667 - ridgeCondition0.5
## ridgeCondition0.125                                    -1                                       0
## ridgeCondition0.5                                       0                                      -1
## ridgeCondition0.667                                     0                                       1
## ridgeCondition1                                         1                                       0
##                     ridgeCondition0.667 - ridgeCondition0.125 ridgeCondition0.5 - ridgeCondition0.125
## ridgeCondition0.125                                        -1                                      -1
## ridgeCondition0.5                                           0                                       1
## ridgeCondition0.667                                         1                                       0
## ridgeCondition1                                             0                                       0</code></pre>
<p>The next step is to perform hypothesis tests for each contrast</p>
<div class="sourceCode" id="cb79"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb79-1"><a href="sec-concepts.html#cb79-1" tabindex="-1"></a>spikein <span class="ot">&lt;-</span> <span class="fu">hypothesisTest</span>(</span>
<span id="cb79-2"><a href="sec-concepts.html#cb79-2" tabindex="-1"></a>    spikein, <span class="at">i =</span> <span class="st">"proteins_msqrob"</span>,</span>
<span id="cb79-3"><a href="sec-concepts.html#cb79-3" tabindex="-1"></a>    <span class="at">contrast =</span> L,</span>
<span id="cb79-4"><a href="sec-concepts.html#cb79-4" tabindex="-1"></a>    <span class="at">modelColumn =</span> <span class="st">"msqrob_psm_rrilmm"</span>,</span>
<span id="cb79-5"><a href="sec-concepts.html#cb79-5" tabindex="-1"></a>    <span class="at">overwrite =</span> <span class="cn">TRUE</span></span>
<span id="cb79-6"><a href="sec-concepts.html#cb79-6" tabindex="-1"></a>)</span></code></pre></div>
<p>Six columns have been added to the row data, one for each contrast.</p>
<div class="sourceCode" id="cb80"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb80-1"><a href="sec-concepts.html#cb80-1" tabindex="-1"></a><span class="fu">colnames</span>(<span class="fu">rowData</span>(spikein[[<span class="st">"proteins_msqrob"</span>]]))</span></code></pre></div>
<pre><code>##  [1] "Checked"                                   "Confidence"                               
##  [3] "Marked.as"                                 "X..Protein.Groups"                        
##  [5] "X..Proteins"                               "Master.Protein.Accessions"                
##  [7] "Master.Protein.Descriptions"               "Protein.Accessions"                       
##  [9] "Protein.Descriptions"                      "Activation.Type"                          
## [11] "MS.Order"                                  "Quan.Info"                                
## [13] "isUps"                                     "nProtsMapped"                             
## [15] "psmRank"                                   ".n"                                       
## [17] "msqrob_psm_rrilmm"                         "ridgeCondition1 - ridgeCondition0.5"      
## [19] "ridgeCondition1 - ridgeCondition0.667"     "ridgeCondition1 - ridgeCondition0.125"    
## [21] "ridgeCondition0.667 - ridgeCondition0.5"   "ridgeCondition0.667 - ridgeCondition0.125"
## [23] "ridgeCondition0.5 - ridgeCondition0.125"</code></pre>
<p>The results of contrast <code>"ridgeCondition1 - ridgeCondition0.5"</code> can be
retrieved as follows.</p>
<div class="sourceCode" id="cb82"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb82-1"><a href="sec-concepts.html#cb82-1" tabindex="-1"></a><span class="fu">head</span>(<span class="fu">rowData</span>(spikein[[<span class="st">"proteins_msqrob"</span>]])[,<span class="st">"ridgeCondition1 - ridgeCondition0.5"</span>])</span></code></pre></div>
<pre><code>##              logFC           se         df          t        pval   adjPval
## O00151 -0.02565447 2.156328e-02  471.94804 -1.1897295 0.234750886 0.5788016
## O00220  0.01426040 5.754843e-02   94.48815  0.2477982 0.804828245 1.0000000
## O00244  0.00000000 3.771470e-11   84.16934  0.0000000 1.000000000 1.0000000
## O00299 -0.03165728 1.172145e-02 1380.25430 -2.7008000 0.007001905 0.0365266
## O00330 -0.02898741 3.674550e-02  193.93483 -0.7888696 0.431151554 0.8650669
## O00399          NA           NA         NA         NA          NA        NA</code></pre>
<p>Note, the we can use the same code to perform the hypothesis tests and
extract the results for the protein-level model.</p>
<div class="sourceCode" id="cb84"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb84-1"><a href="sec-concepts.html#cb84-1" tabindex="-1"></a>spikein <span class="ot">&lt;-</span> <span class="fu">hypothesisTest</span>(</span>
<span id="cb84-2"><a href="sec-concepts.html#cb84-2" tabindex="-1"></a>    spikein, <span class="at">i =</span> <span class="st">"proteins"</span>,</span>
<span id="cb84-3"><a href="sec-concepts.html#cb84-3" tabindex="-1"></a>    <span class="at">contrast =</span> L,</span>
<span id="cb84-4"><a href="sec-concepts.html#cb84-4" tabindex="-1"></a>    <span class="at">modelColumn =</span> <span class="st">"msqrob_rrilmm"</span>,</span>
<span id="cb84-5"><a href="sec-concepts.html#cb84-5" tabindex="-1"></a>    <span class="at">overwrite =</span> <span class="cn">TRUE</span></span>
<span id="cb84-6"><a href="sec-concepts.html#cb84-6" tabindex="-1"></a>)</span></code></pre></div>
<div class="sourceCode" id="cb85"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb85-1"><a href="sec-concepts.html#cb85-1" tabindex="-1"></a><span class="fu">head</span>(<span class="fu">rowData</span>(spikein[[<span class="st">"proteins"</span>]])[,<span class="st">"ridgeCondition1 - ridgeCondition0.5"</span>])</span></code></pre></div>
<pre><code>##               logFC          se       df          t       pval    adjPval
## O00151 -0.011924081 0.020461821 104.6338 -0.5827478 0.56131688 1.00000000
## O00299 -0.029335947 0.012626231 101.4126 -2.3234127 0.02215311 0.13984150
## O00410 -0.018769742 0.010695769 104.1391 -1.7548755 0.08222163 0.35011477
## O00629  0.003514475 0.022285220 102.0382  0.1577043 0.87500146 1.00000000
## O14745 -0.033066476 0.014877552 104.3489 -2.2225750 0.02840203 0.16629597
## O14980 -0.025474090 0.009932402 102.5778 -2.5647462 0.01177273 0.08072916</code></pre>
</div>
</div>
<div id="dealing-with-fiterrors" class="section level2" number="2.9">
<h2>
<span class="header-section-number">2.9</span> Dealing with <code id="sec-fiterror">fitErrors</code>
<div class="tooltip"><button class="internal-link-btn" onclick="copy_link('dealing-with-fiterrors')" onmouseout="reset_tooltip('dealing-with-fiterrors-tooltip')"><span class="tooltiptext" id="dealing-with-fiterrors-tooltip">Copy link</span><i class="fa fa-link"></i></button></div>
</h2>
<p>Missing value patterns in the data may lead to non-estimable
parameters. This is recognised by <code>msqrob2</code> and will lead to
<code>fitError</code>s which is a type of model output where the model could not
be fit. This information is available from the <code>StatModel</code> objects.</p>
<div class="sourceCode" id="cb87"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb87-1"><a href="sec-concepts.html#cb87-1" tabindex="-1"></a><span class="fu">rowData</span>(spikein[[<span class="st">"proteins_msqrob"</span>]])[[<span class="st">"msqrob_psm_rrilmm"</span>]] <span class="sc">|&gt;</span></span>
<span id="cb87-2"><a href="sec-concepts.html#cb87-2" tabindex="-1"></a>    <span class="fu">sapply</span>(<span class="cf">function</span>(x) x<span class="sc">@</span>type) <span class="sc">|&gt;</span></span>
<span id="cb87-3"><a href="sec-concepts.html#cb87-3" tabindex="-1"></a>    <span class="fu">table</span>()</span></code></pre></div>
<pre><code>## 
## fitError     lmer 
##       94      313</code></pre>
<p>We suggest 3 strategies for dealing with these <code>fitError</code>s.</p>
<div id="removing-the-random-effect-of-sample" class="section level3" number="2.9.1">
<h3>
<span class="header-section-number">2.9.1</span> Removing the random effect of sample<div class="tooltip"><button class="internal-link-btn" onclick="copy_link('removing-the-random-effect-of-sample')" onmouseout="reset_tooltip('removing-the-random-effect-of-sample-tooltip')"><span class="tooltiptext" id="removing-the-random-effect-of-sample-tooltip">Copy link</span><i class="fa fa-link"></i></button></div>
</h3>
<p>This strategy only applies for PSM-level models. Some proteins are
difficult to detect and may be quantified by a single peptide ion
species. In these cases, every sample contains a single observation
for the protein and hence no random effect of <code>Run:Channel</code> can be
estimated. While the results for such one-hit wonders are
questionable, we provide <code>msqrobRefit()</code> to refit a new model for a
subset of proteins of interest.</p>
<p><strong>Work in progress</strong>: we plan to include soon the function to perform
the refitting in <code>msqrob2</code>. Below, you can find a prototype of such
functionality. See <code>?msqrobAggregate</code> for documentation of the
arguments.</p>
<div class="sourceCode" id="cb89"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb89-1"><a href="sec-concepts.html#cb89-1" tabindex="-1"></a>msqrobRefit <span class="ot">&lt;-</span> <span class="cf">function</span>(object, formula, i, subset, fcol, name,</span>
<span id="cb89-2"><a href="sec-concepts.html#cb89-2" tabindex="-1"></a>                        modelColumnName, ...) {</span>
<span id="cb89-3"><a href="sec-concepts.html#cb89-3" tabindex="-1"></a>    seti <span class="ot">&lt;-</span> <span class="fu">getWithColData</span>(object, i)</span>
<span id="cb89-4"><a href="sec-concepts.html#cb89-4" tabindex="-1"></a>    setj <span class="ot">&lt;-</span> <span class="fu">getWithColData</span>(object, name)</span>
<span id="cb89-5"><a href="sec-concepts.html#cb89-5" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">any</span>(<span class="sc">!</span>subset <span class="sc">%in%</span> <span class="fu">rowData</span>(seti)[[fcol]]))</span>
<span id="cb89-6"><a href="sec-concepts.html#cb89-6" tabindex="-1"></a>        <span class="fu">stop</span>(<span class="st">"Some entries in 'subset' not found in '"</span>, fcol,</span>
<span id="cb89-7"><a href="sec-concepts.html#cb89-7" tabindex="-1"></a>             <span class="st">"' (rowData of set '"</span>, i, <span class="st">"')"</span>)</span>
<span id="cb89-8"><a href="sec-concepts.html#cb89-8" tabindex="-1"></a>    setjRefit <span class="ot">&lt;-</span> <span class="fu">msqrobAggregate</span>(</span>
<span id="cb89-9"><a href="sec-concepts.html#cb89-9" tabindex="-1"></a>        seti[<span class="fu">rowData</span>(seti)[[fcol]] <span class="sc">%in%</span> subset, ],</span>
<span id="cb89-10"><a href="sec-concepts.html#cb89-10" tabindex="-1"></a>        <span class="at">formula =</span> formula, <span class="at">fcol =</span> fcol, <span class="at">modelColumnName =</span> modelColumnName,</span>
<span id="cb89-11"><a href="sec-concepts.html#cb89-11" tabindex="-1"></a>        ...</span>
<span id="cb89-12"><a href="sec-concepts.html#cb89-12" tabindex="-1"></a>    )</span>
<span id="cb89-13"><a href="sec-concepts.html#cb89-13" tabindex="-1"></a>    <span class="fu">rowData</span>(setj)[[modelColumnName]][subset] <span class="ot">&lt;-</span></span>
<span id="cb89-14"><a href="sec-concepts.html#cb89-14" tabindex="-1"></a>        <span class="fu">rowData</span>(setjRefit)[[modelColumnName]][subset]</span>
<span id="cb89-15"><a href="sec-concepts.html#cb89-15" tabindex="-1"></a>    modelsNew <span class="ot">&lt;-</span> <span class="fu">rowData</span>(setj)[[modelColumnName]]</span>
<span id="cb89-16"><a href="sec-concepts.html#cb89-16" tabindex="-1"></a>    hlp <span class="ot">&lt;-</span> limma<span class="sc">::</span><span class="fu">squeezeVar</span>(</span>
<span id="cb89-17"><a href="sec-concepts.html#cb89-17" tabindex="-1"></a>        <span class="at">var =</span> <span class="fu">vapply</span>(modelsNew, getVar, <span class="fu">numeric</span>(<span class="dv">1</span>)),</span>
<span id="cb89-18"><a href="sec-concepts.html#cb89-18" tabindex="-1"></a>        <span class="at">df =</span> <span class="fu">vapply</span>(modelsNew, getDF, <span class="fu">numeric</span>(<span class="dv">1</span>))</span>
<span id="cb89-19"><a href="sec-concepts.html#cb89-19" tabindex="-1"></a>    )</span>
<span id="cb89-20"><a href="sec-concepts.html#cb89-20" tabindex="-1"></a>    <span class="cf">for</span> (ii <span class="cf">in</span> <span class="fu">seq_along</span>(modelsNew)) {</span>
<span id="cb89-21"><a href="sec-concepts.html#cb89-21" tabindex="-1"></a>        modelsNew[[ii]]<span class="sc">@</span>varPosterior <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(hlp<span class="sc">$</span>var.post[ii])</span>
<span id="cb89-22"><a href="sec-concepts.html#cb89-22" tabindex="-1"></a>        modelsNew[[ii]]<span class="sc">@</span>dfPosterior <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(hlp<span class="sc">$</span>df.prior <span class="sc">+</span> <span class="fu">getDF</span>(modelsNew[[ii]]))</span>
<span id="cb89-23"><a href="sec-concepts.html#cb89-23" tabindex="-1"></a>    }</span>
<span id="cb89-24"><a href="sec-concepts.html#cb89-24" tabindex="-1"></a>    <span class="fu">rowData</span>(object[[name]])[[modelColumnName]] <span class="ot">&lt;-</span> modelsNew</span>
<span id="cb89-25"><a href="sec-concepts.html#cb89-25" tabindex="-1"></a>    object</span>
<span id="cb89-26"><a href="sec-concepts.html#cb89-26" tabindex="-1"></a>}</span></code></pre></div>
<p>In this case, we want to refit a model without a sample effect for
one-hit-wonder proteins. This information can be retrieved from the
aggregation results, using <code>aggcounts()</code>. This getter function
provides the number of features used when performing summarisation for
each protein in each sample.</p>
<div class="sourceCode" id="cb90"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb90-1"><a href="sec-concepts.html#cb90-1" tabindex="-1"></a>counts <span class="ot">&lt;-</span> <span class="fu">aggcounts</span>(spikein[[<span class="st">"proteins_msqrob"</span>]])</span>
<span id="cb90-2"><a href="sec-concepts.html#cb90-2" tabindex="-1"></a>counts[<span class="dv">1</span><span class="sc">:</span><span class="dv">5</span>, <span class="dv">1</span><span class="sc">:</span><span class="dv">5</span>]</span></code></pre></div>
<pre><code>##        161117_SILAC_HeLa_UPS1_TMT10_Mixture1_01.raw_Abundance..127N
## O00151                                                            4
## O00220                                                            1
## O00244                                                            0
## O00299                                                           15
## O00330                                                            2
##        161117_SILAC_HeLa_UPS1_TMT10_Mixture1_01.raw_Abundance..127C
## O00151                                                            4
## O00220                                                            2
## O00244                                                            0
## O00299                                                           15
## O00330                                                            2
##        161117_SILAC_HeLa_UPS1_TMT10_Mixture1_01.raw_Abundance..128N
## O00151                                                            4
## O00220                                                            2
## O00244                                                            0
## O00299                                                           15
## O00330                                                            2
##        161117_SILAC_HeLa_UPS1_TMT10_Mixture1_01.raw_Abundance..128C
## O00151                                                            4
## O00220                                                            1
## O00244                                                            0
## O00299                                                           15
## O00330                                                            2
##        161117_SILAC_HeLa_UPS1_TMT10_Mixture1_01.raw_Abundance..129N
## O00151                                                            4
## O00220                                                            2
## O00244                                                            0
## O00299                                                           15
## O00330                                                            2</code></pre>
<p>One-hit wonder proteins are proteins for which the number of feature
used for summarisation does not exceed 1 peptide ion across samples.</p>
<div class="sourceCode" id="cb92"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb92-1"><a href="sec-concepts.html#cb92-1" tabindex="-1"></a>oneHitProteins <span class="ot">&lt;-</span> <span class="fu">rownames</span>(counts)[<span class="fu">rowMax</span>(counts) <span class="sc">==</span> <span class="dv">1</span>]</span></code></pre></div>
<p>Using <code>msqrobRefit()</code> is very similar to <code>msqrobAggregate()</code>, see here
however that we adapted the formula to remove the random effect for
channel nested within run. We also mention which proteins must be
refit using the <code>subset</code> argument.</p>
<div class="sourceCode" id="cb93"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb93-1"><a href="sec-concepts.html#cb93-1" tabindex="-1"></a>spikein <span class="ot">&lt;-</span> <span class="fu">msqrobRefit</span>(</span>
<span id="cb93-2"><a href="sec-concepts.html#cb93-2" tabindex="-1"></a>    spikein, <span class="at">i =</span> <span class="st">"ions"</span>,</span>
<span id="cb93-3"><a href="sec-concepts.html#cb93-3" tabindex="-1"></a>    <span class="at">subset =</span> oneHitProteins,</span>
<span id="cb93-4"><a href="sec-concepts.html#cb93-4" tabindex="-1"></a>    <span class="at">formula =</span> <span class="sc">~</span> <span class="dv">0</span> <span class="sc">+</span> Condition <span class="sc">+</span> <span class="do">## fixed effect for experimental condition</span></span>
<span id="cb93-5"><a href="sec-concepts.html#cb93-5" tabindex="-1"></a>        <span class="co"># (1 | Channel) + ## fixed effect for channel</span></span>
<span id="cb93-6"><a href="sec-concepts.html#cb93-6" tabindex="-1"></a>        (<span class="dv">1</span> <span class="sc">|</span> Mixture) <span class="sc">+</span> <span class="do">## random effect for mixture</span></span>
<span id="cb93-7"><a href="sec-concepts.html#cb93-7" tabindex="-1"></a>        (<span class="dv">1</span> <span class="sc">|</span> Run ) <span class="sc">+</span> <span class="do">## random effect for run</span></span>
<span id="cb93-8"><a href="sec-concepts.html#cb93-8" tabindex="-1"></a>        (<span class="dv">1</span> <span class="sc">|</span> Run<span class="sc">:</span>ionID), <span class="do">## random effect for PSM nested in MS run</span></span>
<span id="cb93-9"><a href="sec-concepts.html#cb93-9" tabindex="-1"></a>        <span class="do">## random effect for channel nested in run has been removed</span></span>
<span id="cb93-10"><a href="sec-concepts.html#cb93-10" tabindex="-1"></a>    <span class="at">fcol =</span> <span class="st">"Protein.Accessions"</span>,</span>
<span id="cb93-11"><a href="sec-concepts.html#cb93-11" tabindex="-1"></a>    <span class="at">modelColumnName =</span> <span class="st">"msqrob_psm_rrilmm"</span>,</span>
<span id="cb93-12"><a href="sec-concepts.html#cb93-12" tabindex="-1"></a>    <span class="at">name =</span> <span class="st">"proteins_msqrob"</span>,</span>
<span id="cb93-13"><a href="sec-concepts.html#cb93-13" tabindex="-1"></a>    <span class="at">robust =</span> <span class="cn">TRUE</span>, <span class="at">ridge =</span> <span class="cn">TRUE</span></span>
<span id="cb93-14"><a href="sec-concepts.html#cb93-14" tabindex="-1"></a>)</span></code></pre></div>
<p>Let’s see how removing the random effect of channel within run for one-hit-wonder proteins reduced the number of <code>fitError</code>s.</p>
<div class="sourceCode" id="cb94"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb94-1"><a href="sec-concepts.html#cb94-1" tabindex="-1"></a>fitTypes <span class="ot">&lt;-</span> <span class="fu">rowData</span>(spikein[[<span class="st">"proteins_msqrob"</span>]])[[<span class="st">"msqrob_psm_rrilmm"</span>]] <span class="sc">|&gt;</span></span>
<span id="cb94-2"><a href="sec-concepts.html#cb94-2" tabindex="-1"></a>    <span class="fu">sapply</span>(<span class="cf">function</span>(x) x<span class="sc">@</span>type)</span>
<span id="cb94-3"><a href="sec-concepts.html#cb94-3" tabindex="-1"></a><span class="fu">table</span>(fitTypes)</span></code></pre></div>
<pre><code>## fitTypes
## fitError     lmer 
##        1      406</code></pre>
</div>
<div id="manual-inspection" class="section level3" number="2.9.2">
<h3>
<span class="header-section-number">2.9.2</span> Manual inspection<div class="tooltip"><button class="internal-link-btn" onclick="copy_link('manual-inspection')" onmouseout="reset_tooltip('manual-inspection-tooltip')"><span class="tooltiptext" id="manual-inspection-tooltip">Copy link</span><i class="fa fa-link"></i></button></div>
</h3>
<p>One protein is still non-estimable upon refitting and requires
additional data exploration to understand why the model cannot be
estimated. Let us take the protein that cannot be fitted.</p>
<div class="sourceCode" id="cb96"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb96-1"><a href="sec-concepts.html#cb96-1" tabindex="-1"></a>proteinError <span class="ot">&lt;-</span> <span class="fu">names</span>(fitTypes[fitTypes <span class="sc">==</span> <span class="st">"fitError"</span>])[[<span class="dv">1</span>]]</span></code></pre></div>
<p>To understand the problem, we plot the data for that protein using
the same <code>QFeatures</code> pipeline described above.</p>
<div class="sourceCode" id="cb97"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb97-1"><a href="sec-concepts.html#cb97-1" tabindex="-1"></a>ionData <span class="ot">&lt;-</span> spikein[proteinError, , <span class="st">"ions"</span>] <span class="sc">|&gt;</span></span>
<span id="cb97-2"><a href="sec-concepts.html#cb97-2" tabindex="-1"></a>    <span class="fu">longForm</span>(<span class="at">colvars =</span> <span class="fu">colnames</span>(<span class="fu">colData</span>(spikein)),</span>
<span id="cb97-3"><a href="sec-concepts.html#cb97-3" tabindex="-1"></a>               <span class="at">rowvars =</span> <span class="fu">c</span>(<span class="st">"Protein.Accessions"</span>, <span class="st">"ionID"</span>)) <span class="sc">|&gt;</span></span>
<span id="cb97-4"><a href="sec-concepts.html#cb97-4" tabindex="-1"></a>    <span class="fu">data.frame</span>() <span class="sc">|&gt;</span></span>
<span id="cb97-5"><a href="sec-concepts.html#cb97-5" tabindex="-1"></a>    <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(value)) <span class="sc">|&gt;</span></span>
<span id="cb97-6"><a href="sec-concepts.html#cb97-6" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">colname =</span> <span class="fu">factor</span>(colname, <span class="at">levels =</span> <span class="fu">unique</span>(colname[<span class="fu">order</span>(Condition)]))) <span class="co">#4</span></span></code></pre></div>
<p>Hence, we here plot the data in function of the <code>Channel</code>
(x-axis), <code>Condition</code> (colour) and <code>Mixture</code> (shape).</p>
<div class="sourceCode" id="cb98"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb98-1"><a href="sec-concepts.html#cb98-1" tabindex="-1"></a><span class="fu">ggplot</span>(ionData) <span class="sc">+</span></span>
<span id="cb98-2"><a href="sec-concepts.html#cb98-2" tabindex="-1"></a>    <span class="fu">aes</span>(<span class="at">x =</span> colname,</span>
<span id="cb98-3"><a href="sec-concepts.html#cb98-3" tabindex="-1"></a>        <span class="at">y =</span> value) <span class="sc">+</span></span>
<span id="cb98-4"><a href="sec-concepts.html#cb98-4" tabindex="-1"></a>    <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">colour =</span> Condition)) <span class="sc">+</span></span>
<span id="cb98-5"><a href="sec-concepts.html#cb98-5" tabindex="-1"></a>    <span class="fu">facet_grid</span>(<span class="sc">~</span> Mixture, <span class="at">scales =</span> <span class="st">"free"</span>) <span class="sc">+</span></span>
<span id="cb98-6"><a href="sec-concepts.html#cb98-6" tabindex="-1"></a>    <span class="fu">ggtitle</span>(targetProtein) <span class="sc">+</span></span>
<span id="cb98-7"><a href="sec-concepts.html#cb98-7" tabindex="-1"></a>    <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb98-8"><a href="sec-concepts.html#cb98-8" tabindex="-1"></a>    <span class="fu">theme</span>(<span class="at">axis.text.x =</span> <span class="fu">element_blank</span>())</span></code></pre></div>
<p><img src="msqrob2_book_files/figure-html/unnamed-chunk-73-1.png" width="672"></p>
<p>We can immediately spot that PSM intensities are only present in
mixture 3. Hence, the mixed model cannot be fitted with a random
effect for mixture. A solution would be drop the random effect for
mixture, provided that a data analysis expert and/or a field
specialist deems it reasonable. This requires expert intervention to
simplify the model definition based on the available data set so as to
provide valid statistical inference on the research hypotheses.</p>
<p><code>msqrob2</code> flags these problematic proteins instead of defining ad-hoc
heuristics, avoiding potentially misleading conclusions. The expert
can then decide to refit a simpler model using <code>msqrobRefit()</code>.</p>
<p>Note, that the same approach can be applied for summarisation-based
models that start from protein data.</p>
<div class="sourceCode" id="cb99"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb99-1"><a href="sec-concepts.html#cb99-1" tabindex="-1"></a>se <span class="ot">&lt;-</span> <span class="fu">getWithColData</span>(spikein, <span class="st">"proteins"</span>)</span>
<span id="cb99-2"><a href="sec-concepts.html#cb99-2" tabindex="-1"></a><span class="fu">data.frame</span>(<span class="at">intensity =</span> <span class="fu">assay</span>(se)[proteinError, ],</span>
<span id="cb99-3"><a href="sec-concepts.html#cb99-3" tabindex="-1"></a>           <span class="fu">colData</span>(spikein),</span>
<span id="cb99-4"><a href="sec-concepts.html#cb99-4" tabindex="-1"></a>           <span class="at">colname =</span> <span class="fu">colnames</span>(se)) <span class="sc">|&gt;</span></span>
<span id="cb99-5"><a href="sec-concepts.html#cb99-5" tabindex="-1"></a>    <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(intensity)) <span class="sc">|&gt;</span></span>
<span id="cb99-6"><a href="sec-concepts.html#cb99-6" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">colname =</span> <span class="fu">factor</span>(colname, <span class="at">levels =</span> <span class="fu">unique</span>(colname[<span class="fu">order</span>(Condition)]))) <span class="sc">|&gt;</span></span>
<span id="cb99-7"><a href="sec-concepts.html#cb99-7" tabindex="-1"></a>    <span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb99-8"><a href="sec-concepts.html#cb99-8" tabindex="-1"></a>    <span class="fu">aes</span>(<span class="at">x =</span> colname,</span>
<span id="cb99-9"><a href="sec-concepts.html#cb99-9" tabindex="-1"></a>        <span class="at">y =</span> intensity) <span class="sc">+</span></span>
<span id="cb99-10"><a href="sec-concepts.html#cb99-10" tabindex="-1"></a>    <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">colour =</span> Condition)) <span class="sc">+</span></span>
<span id="cb99-11"><a href="sec-concepts.html#cb99-11" tabindex="-1"></a>    <span class="fu">facet_grid</span>(<span class="sc">~</span> Mixture, <span class="at">scales =</span> <span class="st">"free"</span>) <span class="sc">+</span></span>
<span id="cb99-12"><a href="sec-concepts.html#cb99-12" tabindex="-1"></a>    <span class="fu">ggtitle</span>(proteinError, <span class="st">"associated to a fitError</span><span class="sc">\n</span><span class="st">Summarised protein intensities (median polish)"</span>) <span class="sc">+</span></span>
<span id="cb99-13"><a href="sec-concepts.html#cb99-13" tabindex="-1"></a>    <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb99-14"><a href="sec-concepts.html#cb99-14" tabindex="-1"></a>    <span class="fu">theme</span>(<span class="at">axis.text.x =</span> <span class="fu">element_blank</span>())</span></code></pre></div>
<p><img src="msqrob2_book_files/figure-html/unnamed-chunk-74-1.png" width="672"></p>
<p>The same conclusion applies as for the PSM-level data. In fact, this
is the same plot as above since the protein is also a one-hit wonder,
what seriously questions the reliability of the data for protein. This
example illustrates the relevance of <code>msqrob2</code> to safeguard against
automatic model simplification that may be otherwise fall unnoticed by
the user.</p>
</div>
<div id="imputation" class="section level3" number="2.9.3">
<h3>
<span class="header-section-number">2.9.3</span> Imputation<div class="tooltip"><button class="internal-link-btn" onclick="copy_link('imputation')" onmouseout="reset_tooltip('imputation-tooltip')"><span class="tooltiptext" id="imputation-tooltip">Copy link</span><i class="fa fa-link"></i></button></div>
</h3>
<p>The last strategy to deal with fit errors is to impute missing values
so that all models can be estimated. <code>QFeatures</code> provides a large
panel of imputation strategies through <code>impute()</code>. Identifying which
imputation strategy is most suited for this data set is outside the
scope of this vignette, and we here arbitrarily decide to use KNN
imputation.</p>
<div class="sourceCode" id="cb100"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb100-1"><a href="sec-concepts.html#cb100-1" tabindex="-1"></a>(spikein <span class="ot">&lt;-</span> <span class="fu">impute</span>(</span>
<span id="cb100-2"><a href="sec-concepts.html#cb100-2" tabindex="-1"></a>    spikein, <span class="at">i =</span> <span class="st">"ions"</span>, <span class="at">name =</span> <span class="st">"ions_imputed"</span>,</span>
<span id="cb100-3"><a href="sec-concepts.html#cb100-3" tabindex="-1"></a>    <span class="at">method =</span> <span class="st">"knn"</span>, <span class="at">colmax =</span> <span class="dv">1</span></span>
<span id="cb100-4"><a href="sec-concepts.html#cb100-4" tabindex="-1"></a>))</span></code></pre></div>
<pre><code>## An instance of class QFeatures (type: bulk) with 64 sets:
## 
##  [1] Mixture1_01: SummarizedExperiment with 1649 rows and 8 columns 
##  [2] Mixture1_02: SummarizedExperiment with 1644 rows and 8 columns 
##  [3] Mixture1_03: SummarizedExperiment with 1703 rows and 8 columns 
##  ...
##  [62] proteins: SummarizedExperiment with 407 rows and 120 columns 
##  [63] proteins_msqrob: SummarizedExperiment with 407 rows and 120 columns 
##  [64] ions_imputed: SummarizedExperiment with 4066 rows and 120 columns</code></pre>
<p>The function added a new set <code>ions_imputed</code> which we can use to fit
the PSM model.</p>
<div class="sourceCode" id="cb102"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb102-1"><a href="sec-concepts.html#cb102-1" tabindex="-1"></a>spikein <span class="ot">&lt;-</span> <span class="fu">msqrobAggregate</span>(</span>
<span id="cb102-2"><a href="sec-concepts.html#cb102-2" tabindex="-1"></a>    spikein,  <span class="at">i =</span> <span class="st">"ions_imputed"</span>,</span>
<span id="cb102-3"><a href="sec-concepts.html#cb102-3" tabindex="-1"></a>    <span class="at">formula =</span> <span class="sc">~</span> <span class="dv">0</span> <span class="sc">+</span> Condition <span class="sc">+</span> <span class="do">## fixed effect for experimental condition</span></span>
<span id="cb102-4"><a href="sec-concepts.html#cb102-4" tabindex="-1"></a>        <span class="co"># (1 | Channel) + ## random effect for channel</span></span>
<span id="cb102-5"><a href="sec-concepts.html#cb102-5" tabindex="-1"></a>        (<span class="dv">1</span> <span class="sc">|</span> Mixture) <span class="sc">+</span> <span class="do">## random effect for mixture</span></span>
<span id="cb102-6"><a href="sec-concepts.html#cb102-6" tabindex="-1"></a>        (<span class="dv">1</span> <span class="sc">|</span> Run) <span class="sc">+</span> <span class="do">## random effect for run</span></span>
<span id="cb102-7"><a href="sec-concepts.html#cb102-7" tabindex="-1"></a>        (<span class="dv">1</span> <span class="sc">|</span> Run<span class="sc">:</span>Channel) <span class="sc">+</span> <span class="do">## random effect for PSMs from the same protein in a channel of a run</span></span>
<span id="cb102-8"><a href="sec-concepts.html#cb102-8" tabindex="-1"></a>        (<span class="dv">1</span> <span class="sc">|</span> Run<span class="sc">:</span>ionID), <span class="do">## random effect for ions in the same spectrum of an MS run</span></span>
<span id="cb102-9"><a href="sec-concepts.html#cb102-9" tabindex="-1"></a>    <span class="at">fcol =</span> <span class="st">"Protein.Accessions"</span>,</span>
<span id="cb102-10"><a href="sec-concepts.html#cb102-10" tabindex="-1"></a>    <span class="at">modelColumnName =</span> <span class="st">"msqrob_psm_rrilmm"</span>,</span>
<span id="cb102-11"><a href="sec-concepts.html#cb102-11" tabindex="-1"></a>    <span class="at">name =</span> <span class="st">"proteins_msqrob_imputed"</span>,</span>
<span id="cb102-12"><a href="sec-concepts.html#cb102-12" tabindex="-1"></a>    <span class="at">robust =</span> <span class="cn">TRUE</span>, <span class="at">ridge =</span> <span class="cn">TRUE</span></span>
<span id="cb102-13"><a href="sec-concepts.html#cb102-13" tabindex="-1"></a>)</span></code></pre></div>
<p>We here assess how many models have been estimated for all proteins
upon imputation.</p>
<div class="sourceCode" id="cb103"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb103-1"><a href="sec-concepts.html#cb103-1" tabindex="-1"></a><span class="fu">rowData</span>(spikein[[<span class="st">"proteins_msqrob_imputed"</span>]])[[<span class="st">"msqrob_psm_rrilmm"</span>]] <span class="sc">|&gt;</span></span>
<span id="cb103-2"><a href="sec-concepts.html#cb103-2" tabindex="-1"></a>    <span class="fu">sapply</span>(<span class="cf">function</span>(x) x<span class="sc">@</span>type) <span class="sc">|&gt;</span></span>
<span id="cb103-3"><a href="sec-concepts.html#cb103-3" tabindex="-1"></a>    <span class="fu">table</span>()</span></code></pre></div>
<pre><code>## 
## fitError     lmer 
##       59      348</code></pre>
<p>Again <code>fitError</code>s were generated for one-hit-wonder proteins.</p>
<div class="sourceCode" id="cb105"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb105-1"><a href="sec-concepts.html#cb105-1" tabindex="-1"></a>counts <span class="ot">&lt;-</span> <span class="fu">aggcounts</span>(spikein[[<span class="st">"proteins_msqrob_imputed"</span>]])</span>
<span id="cb105-2"><a href="sec-concepts.html#cb105-2" tabindex="-1"></a>oneHitProteins <span class="ot">&lt;-</span> <span class="fu">rownames</span>(counts)[<span class="fu">rowMax</span>(counts) <span class="sc">==</span> <span class="dv">1</span>]</span>
<span id="cb105-3"><a href="sec-concepts.html#cb105-3" tabindex="-1"></a>spikein <span class="ot">&lt;-</span> <span class="fu">msqrobRefit</span>(</span>
<span id="cb105-4"><a href="sec-concepts.html#cb105-4" tabindex="-1"></a>    spikein, <span class="at">i =</span> <span class="st">"ions_imputed"</span>,</span>
<span id="cb105-5"><a href="sec-concepts.html#cb105-5" tabindex="-1"></a>    <span class="at">subset =</span> oneHitProteins,</span>
<span id="cb105-6"><a href="sec-concepts.html#cb105-6" tabindex="-1"></a>    <span class="at">formula =</span> <span class="sc">~</span> <span class="dv">0</span> <span class="sc">+</span> Condition <span class="sc">+</span> <span class="do">## fixed effect for experimental condition</span></span>
<span id="cb105-7"><a href="sec-concepts.html#cb105-7" tabindex="-1"></a>        <span class="co"># (1 | Channel) + ## random effect for channel</span></span>
<span id="cb105-8"><a href="sec-concepts.html#cb105-8" tabindex="-1"></a>        (<span class="dv">1</span> <span class="sc">|</span> Mixture) <span class="sc">+</span> <span class="do">## random effect for mixture</span></span>
<span id="cb105-9"><a href="sec-concepts.html#cb105-9" tabindex="-1"></a>        (<span class="dv">1</span> <span class="sc">|</span> Run ) <span class="sc">+</span> <span class="do">## random effect for run</span></span>
<span id="cb105-10"><a href="sec-concepts.html#cb105-10" tabindex="-1"></a>        (<span class="dv">1</span> <span class="sc">|</span> Run<span class="sc">:</span>ionID), <span class="do">## random effect for PSM nested in MS run</span></span>
<span id="cb105-11"><a href="sec-concepts.html#cb105-11" tabindex="-1"></a>        <span class="do">## random effect for channel nested in run has been removed</span></span>
<span id="cb105-12"><a href="sec-concepts.html#cb105-12" tabindex="-1"></a>    <span class="at">fcol =</span> <span class="st">"Protein.Accessions"</span>,</span>
<span id="cb105-13"><a href="sec-concepts.html#cb105-13" tabindex="-1"></a>    <span class="at">modelColumnName =</span> <span class="st">"msqrob_psm_rrilmm"</span>,</span>
<span id="cb105-14"><a href="sec-concepts.html#cb105-14" tabindex="-1"></a>    <span class="at">name =</span> <span class="st">"proteins_msqrob_imputed"</span>,</span>
<span id="cb105-15"><a href="sec-concepts.html#cb105-15" tabindex="-1"></a>    <span class="at">robust =</span> <span class="cn">TRUE</span>, <span class="at">ridge =</span> <span class="cn">TRUE</span></span>
<span id="cb105-16"><a href="sec-concepts.html#cb105-16" tabindex="-1"></a>)</span>
<span id="cb105-17"><a href="sec-concepts.html#cb105-17" tabindex="-1"></a><span class="fu">rowData</span>(spikein[[<span class="st">"proteins_msqrob_imputed"</span>]])[[<span class="st">"msqrob_psm_rrilmm"</span>]] <span class="sc">|&gt;</span></span>
<span id="cb105-18"><a href="sec-concepts.html#cb105-18" tabindex="-1"></a>    <span class="fu">sapply</span>(<span class="cf">function</span>(x) x<span class="sc">@</span>type) <span class="sc">|&gt;</span></span>
<span id="cb105-19"><a href="sec-concepts.html#cb105-19" tabindex="-1"></a>    <span class="fu">table</span>()</span></code></pre></div>
<pre><code>## 
## lmer 
##  407</code></pre>
<p>Upon refit, no <code>fitError</code>s were generated for any proteins, as expected. Be
mindful that although this approach no longer requires strong
statistical insights, the results upon imputation will be highly
depended on the suitability of the imputation approach.</p>
<p>We can apply the same approach for upon summarisation, starting from
the imputed peptide ion data.</p>
<div class="sourceCode" id="cb107"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb107-1"><a href="sec-concepts.html#cb107-1" tabindex="-1"></a>spikein <span class="ot">&lt;-</span> <span class="fu">aggregateFeatures</span>(</span>
<span id="cb107-2"><a href="sec-concepts.html#cb107-2" tabindex="-1"></a>    spikein, <span class="at">i =</span> <span class="st">"ions_imputed"</span>, <span class="at">name =</span> <span class="st">"proteins_imputed"</span>,</span>
<span id="cb107-3"><a href="sec-concepts.html#cb107-3" tabindex="-1"></a>    <span class="at">fcol =</span> <span class="st">"Protein.Accessions"</span>, <span class="at">fun =</span> MsCoreUtils<span class="sc">::</span>medianPolish,</span>
<span id="cb107-4"><a href="sec-concepts.html#cb107-4" tabindex="-1"></a>    <span class="at">na.rm =</span> <span class="cn">TRUE</span></span>
<span id="cb107-5"><a href="sec-concepts.html#cb107-5" tabindex="-1"></a>)</span>
<span id="cb107-6"><a href="sec-concepts.html#cb107-6" tabindex="-1"></a>spikein <span class="ot">&lt;-</span> <span class="fu">msqrob</span>(</span>
<span id="cb107-7"><a href="sec-concepts.html#cb107-7" tabindex="-1"></a>    spikein,  <span class="at">i =</span> <span class="st">"proteins_imputed"</span>,</span>
<span id="cb107-8"><a href="sec-concepts.html#cb107-8" tabindex="-1"></a>    <span class="at">formula =</span> <span class="sc">~</span> <span class="dv">0</span> <span class="sc">+</span> Condition <span class="sc">+</span> <span class="do">## fixed effect for experimental condition</span></span>
<span id="cb107-9"><a href="sec-concepts.html#cb107-9" tabindex="-1"></a>        <span class="co"># (1 | Channel) + ## random effect for channel</span></span>
<span id="cb107-10"><a href="sec-concepts.html#cb107-10" tabindex="-1"></a>        (<span class="dv">1</span> <span class="sc">|</span> Mixture) <span class="sc">+</span> <span class="do">## random effect for mixture</span></span>
<span id="cb107-11"><a href="sec-concepts.html#cb107-11" tabindex="-1"></a>        (<span class="dv">1</span> <span class="sc">|</span> Run), <span class="do">## random effect for MS run</span></span>
<span id="cb107-12"><a href="sec-concepts.html#cb107-12" tabindex="-1"></a>    <span class="at">robust =</span> <span class="cn">TRUE</span>, <span class="at">ridge =</span> <span class="cn">TRUE</span>,</span>
<span id="cb107-13"><a href="sec-concepts.html#cb107-13" tabindex="-1"></a>    <span class="at">modelColumnName =</span> <span class="st">"msqrob_rrilmm"</span>,</span>
<span id="cb107-14"><a href="sec-concepts.html#cb107-14" tabindex="-1"></a>    <span class="at">overwrite =</span> <span class="cn">TRUE</span></span>
<span id="cb107-15"><a href="sec-concepts.html#cb107-15" tabindex="-1"></a>)</span>
<span id="cb107-16"><a href="sec-concepts.html#cb107-16" tabindex="-1"></a>models <span class="ot">&lt;-</span> <span class="fu">rowData</span>(spikein[[<span class="st">"proteins_imputed"</span>]])[[<span class="st">"msqrob_rrilmm"</span>]]</span>
<span id="cb107-17"><a href="sec-concepts.html#cb107-17" tabindex="-1"></a><span class="fu">table</span>(<span class="fu">sapply</span>(models, <span class="cf">function</span>(x) x<span class="sc">@</span>type))</span></code></pre></div>
<pre><code>## 
## lmer 
##  407</code></pre>
</div>
</div>
<div id="sec-multiple_contrasts" class="section level2" number="2.10">
<h2>
<span class="header-section-number">2.10</span> Testing muliple contrasts at once<div class="tooltip"><button class="internal-link-btn" onclick="copy_link('sec-multiple_contrasts')" onmouseout="reset_tooltip('sec-multiple_contrasts-tooltip')"><span class="tooltiptext" id="sec-multiple_contrasts-tooltip">Copy link</span><i class="fa fa-link"></i></button></div>
</h2>
<p><strong>TODO</strong></p>
</div>
<div id="conclusion" class="section level2" number="2.11">
<h2>
<span class="header-section-number">2.11</span> Conclusion<div class="tooltip"><button class="internal-link-btn" onclick="copy_link('conclusion')" onmouseout="reset_tooltip('conclusion-tooltip')"><span class="tooltiptext" id="conclusion-tooltip">Copy link</span><i class="fa fa-link"></i></button></div>
</h2>
<p>In this vignette, we have demonstrated how to run msqrob2TMT
workflows. Because the packages relies on the <code>QFeatures</code> data class,
we could demonstrate the implementation of a complete pre-processing
workflow: sample filtering, PSM filtering, missing value management,
log2-transformation, normalisation, (optionally) summarisation and
(optionally) imputation.</p>
<p>Once pre-processed, we use the <code>msqrob2</code> package to model all sources
of variability in the MS experiment: effect of treatment of interest,
effect of TMT labelling, effect of the MS acquisition run, and the
effect of replication. We built protein-level models, but we have also
shown that we can build PSM-level models if we also include a spectrum
effect and an effect for channel nested within run.</p>
<p>We showed how to run statistical inference on the modelling results to
retrieve the significance of differentially abundant proteins. We
explored statistical results through volcano plots and boxplots of the
log2 fold changes and visually validated the results for one protein
by plotting the input data. We have shown the inference pipeline is
similar for both PSM-level models and protein-level models.
Furthermore, we illustrated how to streamline the analysis of multiple
hypothesis tests.</p>
<p>Finally, we have demonstrated how to deal with proteins that cannot be
modelled due to missing values. For PSM-level models, we can remove
the random effects for channel within run that cannot be estimated for
one-hit-wonder proteins. We can also manually inspect how missing
values can influence the model design, and refit a simplified model
upon expert’s intervention. Finally, we can impute missing values,
which unlocks model fitting, but imposes strong assumption on the
validity of the imputation approach and the reliability of the
predicted values.</p>

</div>
</div>
<p style="text-align: center;">
<a href="index.html"><button class="btn btn-default">Previous</button></a>
<a href="sec-francisella.html"><button class="btn btn-default">Next</button></a>
</p>
<p class="build-date">Page built: 
2025-09-12
 using 
R version 4.5.1 (2025-06-13)
</p>
</div>
</div>



</body>
</html>
