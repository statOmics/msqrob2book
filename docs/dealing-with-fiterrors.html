<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

<meta charset="utf-8" />
<meta name="generator" content="pandoc" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<meta property="og:title" content="Chapter 8 Dealing with fitErrors | Statistical analysis for proteomics data" />
<meta property="og:type" content="book" />




<meta name="author" content="Christophe Vanderaa, Stijn Vandenbulcke, Lieven Clement" />

<meta name="date" content="2025-09-03" />

<script type="text/x-mathjax-config">
MathJax.Hub.Config({
  TeX: { equationNumbers: { autoNumber: "AMS" } }
});
</script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<meta name="description" content="Chapter 8 Dealing with fitErrors | Statistical analysis for proteomics data">

<title>Chapter 8 Dealing with fitErrors | Statistical analysis for proteomics data</title>

<link href="libs/tufte-css-2015.12.29/tufte.css" rel="stylesheet" />
<link href="libs/tufte-css-2015.12.29/envisioned.css" rel="stylesheet" />
<link href="libs/msmb-css-0/msmb.css" rel="stylesheet" />
<script>
function toggle_visibility(id1, id2) {
var e = document.getElementById(id1);
var f = document.getElementById(id2);

e.style.display = ((e.style.display!='none') ? 'none' : 'block');

if(f.classList.contains('fa-plus-square')) {
    f.classList.add('fa-minus-square')
    f.classList.remove('fa-plus-square')
} else {
    f.classList.add('fa-plus-square')
    f.classList.remove('fa-minus-square')
}

}
</script>
<script>
function copy_link(id) {
  var dummy = document.createElement('input'),
  text = window.location.href.split(/[?#]/)[0] + '#' + id;
  document.body.appendChild(dummy);
  dummy.value = text;
  dummy.select();
  document.execCommand('copy');
  document.body.removeChild(dummy);
  
  var tooltip = document.getElementById(id + '-tooltip');
  tooltip.innerHTML = 'Copied!';
}

function reset_tooltip(id) {
  var tooltip = document.getElementById(id);
  tooltip.innerHTML = 'Copy link';
}
</script>


<style type="text/css">code{white-space: pre;}</style>
<style type="text/css">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }

code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {  background-color: #f8f8f8; }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ef2929; } /* Alert */
code span.an { color: #8f5902; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #204a87; } /* Attribute */
code span.bn { color: #0000cf; } /* BaseN */
code span.cf { color: #204a87; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4e9a06; } /* Char */
code span.cn { color: #8f5902; } /* Constant */
code span.co { color: #8f5902; font-style: italic; } /* Comment */
code span.cv { color: #8f5902; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #8f5902; font-weight: bold; font-style: italic; } /* Documentation */
code span.dt { color: #204a87; } /* DataType */
code span.dv { color: #0000cf; } /* DecVal */
code span.er { color: #a40000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #0000cf; } /* Float */
code span.fu { color: #204a87; font-weight: bold; } /* Function */
code span.im { } /* Import */
code span.in { color: #8f5902; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #204a87; font-weight: bold; } /* Keyword */
code span.op { color: #ce5c00; font-weight: bold; } /* Operator */
code span.ot { color: #8f5902; } /* Other */
code span.pp { color: #8f5902; font-style: italic; } /* Preprocessor */
code span.sc { color: #ce5c00; font-weight: bold; } /* SpecialChar */
code span.ss { color: #4e9a06; } /* SpecialString */
code span.st { color: #4e9a06; } /* String */
code span.va { color: #000000; } /* Variable */
code span.vs { color: #4e9a06; } /* VerbatimString */
code span.wa { color: #8f5902; font-weight: bold; font-style: italic; } /* Warning */
</style>


<style type="text/css">
/* Used with Pandoc 2.11+ new --citeproc when CSL is used */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
  margin-bottom: 0em;
}
.hanging div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}
</style>

<link rel="stylesheet" href="style.css" type="text/css" />

</head>

<body>



<div class="row">
<div class="col-sm-12">
<div id="TOC">
<ul class="navbar">
<li class="msmb"><p class="title">Statistical analysis for proteomics data<p><p class="author">Christophe Vanderaa, Stijn Vandenbulcke, Lieven Clement</p>
<li class="dropdown" style="float:right">
<a href="javascript:void(0)" class="dropbtn">&#x25BE; Chapters</a>
<div class="dropdown-content">
<a href="index.html" id="toc-preamble"><span class="toc-section-number">1</span> Preamble</a>
<a href="statistical-analysis-with-msqrob2.html" id="toc-statistical-analysis-with-msqrob2"><span class="toc-section-number">2</span> Statistical analysis with msqrob2</a>
<a href="load-packages.html" id="toc-load-packages"><span class="toc-section-number">3</span> Load packages</a>
<a href="load-data.html" id="toc-load-data"><span class="toc-section-number">4</span> Load data</a>
<a href="data-preprocessing.html" id="toc-data-preprocessing"><span class="toc-section-number">5</span> Data preprocessing</a>
<a href="modelling-sources-of-variation.html" id="toc-modelling-sources-of-variation"><span class="toc-section-number">6</span> Modelling sources of variation</a>
<a href="statistical-inference.html" id="toc-statistical-inference"><span class="toc-section-number">7</span> Statistical inference</a>
<a id="active-page" href="dealing-with-fiterrors.html" id="toc-dealing-with-fiterrors"><span class="toc-section-number">8</span> Dealing with <code>fitErrors</code></a><ul class="toc-sections">
<li class="toc"><a href="#removing-the-random-effect-of-sample"> Removing the random effect of sample</a></li>
<li class="toc"><a href="#manual-inspection"> Manual inspection</a></li>
<li class="toc"><a href="#imputation"> Imputation</a></li>
</ul>
<a href="conclusion.html" id="toc-conclusion"><span class="toc-section-number">9</span> Conclusion</a>
</div>
</li>
</ul>
</div>
</div>
</div>
<div class="row">
<div class="col-sm-12">
<div id="dealing-with-fiterrors" class="section level1" number="8">
<h1>
<span class="header-section-number">Chapter 8</span> Dealing with <code>fitErrors</code>
</h1>
<p>Missing value patterns in the data may lead to non-estimable
parameters. This is recognised by <code>msqrob2</code> and will lead to
<code>fitError</code>s which is a type of model output where the model could not
be fit. This information is available from the <code>StatModel</code> objects.</p>
<div class="sourceCode" id="cb54"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb54-1"><a href="dealing-with-fiterrors.html#cb54-1" tabindex="-1"></a><span class="fu">rowData</span>(spikein[[<span class="st">"proteins_msqrob"</span>]])[[<span class="st">"msqrob_psm_rrilmm"</span>]] <span class="sc">|&gt;</span></span>
<span id="cb54-2"><a href="dealing-with-fiterrors.html#cb54-2" tabindex="-1"></a>    <span class="fu">sapply</span>(<span class="cf">function</span>(x) x<span class="sc">@</span>type) <span class="sc">|&gt;</span></span>
<span id="cb54-3"><a href="dealing-with-fiterrors.html#cb54-3" tabindex="-1"></a>    <span class="fu">table</span>()</span></code></pre></div>
<p>We suggest 3 strategies for dealing with these <code>fitError</code>s.</p>
<div id="removing-the-random-effect-of-sample" class="section level2" number="8.1">
<h2>
<span class="header-section-number">8.1</span> Removing the random effect of sample<div class="tooltip"><button class="internal-link-btn" onclick="copy_link('removing-the-random-effect-of-sample')" onmouseout="reset_tooltip('removing-the-random-effect-of-sample-tooltip')"><span class="tooltiptext" id="removing-the-random-effect-of-sample-tooltip">Copy link</span><i class="fa fa-link"></i></button></div>
</h2>
<p>This strategy only applies for PSM-level models. Some proteins are
difficult to detect and may be quantified by a single peptide ion
species. In these cases, every sample contains a single observation
for the protein and hence no random effect of <code>Run:Channel</code> can be
estimated. While the results for such one-hit wonders are
questionable, we provide <code>msqrobRefit()</code> to refit a new model for a
subset of proteins of interest.</p>
<p><strong>Work in progress</strong>: we plan to include soon the function to perform
the refitting in <code>msqrob2</code>. Below, you can find a prototype of such
functionality. See <code>?msqrobAggregate</code> for documentation of the
arguments.</p>
<div class="sourceCode" id="cb55"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb55-1"><a href="dealing-with-fiterrors.html#cb55-1" tabindex="-1"></a>msqrobRefit <span class="ot">&lt;-</span> <span class="cf">function</span>(object, formula, i, subset, fcol, name,</span>
<span id="cb55-2"><a href="dealing-with-fiterrors.html#cb55-2" tabindex="-1"></a>                        modelColumnName, ...) {</span>
<span id="cb55-3"><a href="dealing-with-fiterrors.html#cb55-3" tabindex="-1"></a>    seti <span class="ot">&lt;-</span> <span class="fu">getWithColData</span>(object, i)</span>
<span id="cb55-4"><a href="dealing-with-fiterrors.html#cb55-4" tabindex="-1"></a>    setj <span class="ot">&lt;-</span> <span class="fu">getWithColData</span>(object, name)</span>
<span id="cb55-5"><a href="dealing-with-fiterrors.html#cb55-5" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">any</span>(<span class="sc">!</span>subset <span class="sc">%in%</span> <span class="fu">rowData</span>(seti)[[fcol]]))</span>
<span id="cb55-6"><a href="dealing-with-fiterrors.html#cb55-6" tabindex="-1"></a>        <span class="fu">stop</span>(<span class="st">"Some entries in 'subset' not found in '"</span>, fcol,</span>
<span id="cb55-7"><a href="dealing-with-fiterrors.html#cb55-7" tabindex="-1"></a>             <span class="st">"' (rowData of set '"</span>, i, <span class="st">"')"</span>)</span>
<span id="cb55-8"><a href="dealing-with-fiterrors.html#cb55-8" tabindex="-1"></a>    setjRefit <span class="ot">&lt;-</span> <span class="fu">msqrobAggregate</span>(</span>
<span id="cb55-9"><a href="dealing-with-fiterrors.html#cb55-9" tabindex="-1"></a>        seti[<span class="fu">rowData</span>(seti)[[fcol]] <span class="sc">%in%</span> subset, ],</span>
<span id="cb55-10"><a href="dealing-with-fiterrors.html#cb55-10" tabindex="-1"></a>        <span class="at">formula =</span> formula, <span class="at">fcol =</span> fcol, <span class="at">modelColumnName =</span> modelColumnName,</span>
<span id="cb55-11"><a href="dealing-with-fiterrors.html#cb55-11" tabindex="-1"></a>        ...</span>
<span id="cb55-12"><a href="dealing-with-fiterrors.html#cb55-12" tabindex="-1"></a>    )</span>
<span id="cb55-13"><a href="dealing-with-fiterrors.html#cb55-13" tabindex="-1"></a>    <span class="fu">rowData</span>(setj)[[modelColumnName]][subset] <span class="ot">&lt;-</span></span>
<span id="cb55-14"><a href="dealing-with-fiterrors.html#cb55-14" tabindex="-1"></a>        <span class="fu">rowData</span>(setjRefit)[[modelColumnName]][subset]</span>
<span id="cb55-15"><a href="dealing-with-fiterrors.html#cb55-15" tabindex="-1"></a>    modelsNew <span class="ot">&lt;-</span> <span class="fu">rowData</span>(setj)[[modelColumnName]]</span>
<span id="cb55-16"><a href="dealing-with-fiterrors.html#cb55-16" tabindex="-1"></a>    hlp <span class="ot">&lt;-</span> limma<span class="sc">::</span><span class="fu">squeezeVar</span>(</span>
<span id="cb55-17"><a href="dealing-with-fiterrors.html#cb55-17" tabindex="-1"></a>        <span class="at">var =</span> <span class="fu">vapply</span>(modelsNew, getVar, <span class="fu">numeric</span>(<span class="dv">1</span>)),</span>
<span id="cb55-18"><a href="dealing-with-fiterrors.html#cb55-18" tabindex="-1"></a>        <span class="at">df =</span> <span class="fu">vapply</span>(modelsNew, getDF, <span class="fu">numeric</span>(<span class="dv">1</span>))</span>
<span id="cb55-19"><a href="dealing-with-fiterrors.html#cb55-19" tabindex="-1"></a>    )</span>
<span id="cb55-20"><a href="dealing-with-fiterrors.html#cb55-20" tabindex="-1"></a>    <span class="cf">for</span> (ii <span class="cf">in</span> <span class="fu">seq_along</span>(modelsNew)) {</span>
<span id="cb55-21"><a href="dealing-with-fiterrors.html#cb55-21" tabindex="-1"></a>        modelsNew[[ii]]<span class="sc">@</span>varPosterior <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(hlp<span class="sc">$</span>var.post[ii])</span>
<span id="cb55-22"><a href="dealing-with-fiterrors.html#cb55-22" tabindex="-1"></a>        modelsNew[[ii]]<span class="sc">@</span>dfPosterior <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(hlp<span class="sc">$</span>df.prior <span class="sc">+</span> <span class="fu">getDF</span>(modelsNew[[ii]]))</span>
<span id="cb55-23"><a href="dealing-with-fiterrors.html#cb55-23" tabindex="-1"></a>    }</span>
<span id="cb55-24"><a href="dealing-with-fiterrors.html#cb55-24" tabindex="-1"></a>    <span class="fu">rowData</span>(object[[name]])[[modelColumnName]] <span class="ot">&lt;-</span> modelsNew</span>
<span id="cb55-25"><a href="dealing-with-fiterrors.html#cb55-25" tabindex="-1"></a>    object</span>
<span id="cb55-26"><a href="dealing-with-fiterrors.html#cb55-26" tabindex="-1"></a>}</span></code></pre></div>
<p>In this case, we want to refit a model without a sample effect for
one-hit-wonder proteins. This information can be retrieved from the
aggregation results, using <code>aggcounts()</code>. This getter function
provides the number of features used when performing summarisation for
each protein in each sample.</p>
<div class="sourceCode" id="cb56"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb56-1"><a href="dealing-with-fiterrors.html#cb56-1" tabindex="-1"></a>counts <span class="ot">&lt;-</span> <span class="fu">aggcounts</span>(spikein[[<span class="st">"proteins_msqrob"</span>]])</span>
<span id="cb56-2"><a href="dealing-with-fiterrors.html#cb56-2" tabindex="-1"></a>counts[<span class="dv">1</span><span class="sc">:</span><span class="dv">5</span>, <span class="dv">1</span><span class="sc">:</span><span class="dv">5</span>]</span></code></pre></div>
<p>One-hit wonder proteins are proteins for which the number of feature
used for summarisation does not exceed 1 peptide ion across samples.</p>
<div class="sourceCode" id="cb57"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb57-1"><a href="dealing-with-fiterrors.html#cb57-1" tabindex="-1"></a>oneHitProteins <span class="ot">&lt;-</span> <span class="fu">rownames</span>(counts)[<span class="fu">rowMax</span>(counts) <span class="sc">==</span> <span class="dv">1</span>]</span></code></pre></div>
<p>Using <code>msqrobRefit()</code> is very similar to <code>msqrobAggregate()</code>, see here
however that we adapted the formula to remove the random effect for
channel nested within run. We also mention which proteins must be
refit using the <code>subset</code> argument.</p>
<div class="sourceCode" id="cb58"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb58-1"><a href="dealing-with-fiterrors.html#cb58-1" tabindex="-1"></a>spikein <span class="ot">&lt;-</span> <span class="fu">msqrobRefit</span>(</span>
<span id="cb58-2"><a href="dealing-with-fiterrors.html#cb58-2" tabindex="-1"></a>    spikein, <span class="at">i =</span> <span class="st">"ions"</span>,</span>
<span id="cb58-3"><a href="dealing-with-fiterrors.html#cb58-3" tabindex="-1"></a>    <span class="at">subset =</span> oneHitProteins,</span>
<span id="cb58-4"><a href="dealing-with-fiterrors.html#cb58-4" tabindex="-1"></a>    <span class="at">formula =</span> <span class="sc">~</span> <span class="dv">0</span> <span class="sc">+</span> Condition <span class="sc">+</span> <span class="do">## fixed effect for experimental condition</span></span>
<span id="cb58-5"><a href="dealing-with-fiterrors.html#cb58-5" tabindex="-1"></a>        <span class="co"># (1 | Channel) + ## fixed effect for channel</span></span>
<span id="cb58-6"><a href="dealing-with-fiterrors.html#cb58-6" tabindex="-1"></a>        (<span class="dv">1</span> <span class="sc">|</span> Mixture) <span class="sc">+</span> <span class="do">## random effect for mixture</span></span>
<span id="cb58-7"><a href="dealing-with-fiterrors.html#cb58-7" tabindex="-1"></a>        (<span class="dv">1</span> <span class="sc">|</span> Run ) <span class="sc">+</span> <span class="do">## random effect for run</span></span>
<span id="cb58-8"><a href="dealing-with-fiterrors.html#cb58-8" tabindex="-1"></a>        (<span class="dv">1</span> <span class="sc">|</span> Run<span class="sc">:</span>ionID), <span class="do">## random effect for PSM nested in MS run</span></span>
<span id="cb58-9"><a href="dealing-with-fiterrors.html#cb58-9" tabindex="-1"></a>        <span class="do">## random effect for channel nested in run has been removed</span></span>
<span id="cb58-10"><a href="dealing-with-fiterrors.html#cb58-10" tabindex="-1"></a>    <span class="at">fcol =</span> <span class="st">"Protein.Accessions"</span>,</span>
<span id="cb58-11"><a href="dealing-with-fiterrors.html#cb58-11" tabindex="-1"></a>    <span class="at">modelColumnName =</span> <span class="st">"msqrob_psm_rrilmm"</span>,</span>
<span id="cb58-12"><a href="dealing-with-fiterrors.html#cb58-12" tabindex="-1"></a>    <span class="at">name =</span> <span class="st">"proteins_msqrob"</span>,</span>
<span id="cb58-13"><a href="dealing-with-fiterrors.html#cb58-13" tabindex="-1"></a>    <span class="at">robust =</span> <span class="cn">TRUE</span>, <span class="at">ridge =</span> <span class="cn">TRUE</span></span>
<span id="cb58-14"><a href="dealing-with-fiterrors.html#cb58-14" tabindex="-1"></a>)</span></code></pre></div>
<p>Letâ€™s see how removing the random effect of channel within run for one-hit-wonder proteins reduced the number of <code>fitError</code>s.</p>
<div class="sourceCode" id="cb59"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb59-1"><a href="dealing-with-fiterrors.html#cb59-1" tabindex="-1"></a>fitTypes <span class="ot">&lt;-</span> <span class="fu">rowData</span>(spikein[[<span class="st">"proteins_msqrob"</span>]])[[<span class="st">"msqrob_psm_rrilmm"</span>]] <span class="sc">|&gt;</span></span>
<span id="cb59-2"><a href="dealing-with-fiterrors.html#cb59-2" tabindex="-1"></a>    <span class="fu">sapply</span>(<span class="cf">function</span>(x) x<span class="sc">@</span>type)</span>
<span id="cb59-3"><a href="dealing-with-fiterrors.html#cb59-3" tabindex="-1"></a><span class="fu">table</span>(fitTypes)</span></code></pre></div>
</div>
<div id="manual-inspection" class="section level2" number="8.2">
<h2>
<span class="header-section-number">8.2</span> Manual inspection<div class="tooltip"><button class="internal-link-btn" onclick="copy_link('manual-inspection')" onmouseout="reset_tooltip('manual-inspection-tooltip')"><span class="tooltiptext" id="manual-inspection-tooltip">Copy link</span><i class="fa fa-link"></i></button></div>
</h2>
<p>One protein is still non-estimable upon refitting and requires
additional data exploration to understand why the model cannot be
estimated. Let us take the protein that cannot be fitted.</p>
<div class="sourceCode" id="cb60"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb60-1"><a href="dealing-with-fiterrors.html#cb60-1" tabindex="-1"></a>proteinError <span class="ot">&lt;-</span> <span class="fu">names</span>(fitTypes[fitTypes <span class="sc">==</span> <span class="st">"fitError"</span>])[[<span class="dv">1</span>]]</span></code></pre></div>
<p>To understand the problem, we plot the data for that protein using
the same <code>QFeatures</code> pipeline described above.</p>
<div class="sourceCode" id="cb61"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb61-1"><a href="dealing-with-fiterrors.html#cb61-1" tabindex="-1"></a>ionData <span class="ot">&lt;-</span> spikein[proteinError, , <span class="st">"ions"</span>] <span class="sc">|&gt;</span></span>
<span id="cb61-2"><a href="dealing-with-fiterrors.html#cb61-2" tabindex="-1"></a>    <span class="fu">longFormat</span>(<span class="at">colvars =</span> <span class="fu">colnames</span>(<span class="fu">colData</span>(spikein)),</span>
<span id="cb61-3"><a href="dealing-with-fiterrors.html#cb61-3" tabindex="-1"></a>               <span class="at">rowvars =</span> <span class="fu">c</span>(<span class="st">"Protein.Accessions"</span>, <span class="st">"ionID"</span>)) <span class="sc">|&gt;</span></span>
<span id="cb61-4"><a href="dealing-with-fiterrors.html#cb61-4" tabindex="-1"></a>    <span class="fu">data.frame</span>() <span class="sc">|&gt;</span></span>
<span id="cb61-5"><a href="dealing-with-fiterrors.html#cb61-5" tabindex="-1"></a>    <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(value)) <span class="sc">|&gt;</span></span>
<span id="cb61-6"><a href="dealing-with-fiterrors.html#cb61-6" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">colname =</span> <span class="fu">factor</span>(colname, <span class="at">levels =</span> <span class="fu">unique</span>(colname[<span class="fu">order</span>(Condition)]))) <span class="co">#4</span></span></code></pre></div>
<p>Hence, we here plot the data in function of the <code>Channel</code>
(x-axis), <code>Condition</code> (colour) and <code>Mixture</code> (shape).</p>
<div class="sourceCode" id="cb62"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb62-1"><a href="dealing-with-fiterrors.html#cb62-1" tabindex="-1"></a><span class="fu">ggplot</span>(ionData) <span class="sc">+</span></span>
<span id="cb62-2"><a href="dealing-with-fiterrors.html#cb62-2" tabindex="-1"></a>    <span class="fu">aes</span>(<span class="at">x =</span> colname,</span>
<span id="cb62-3"><a href="dealing-with-fiterrors.html#cb62-3" tabindex="-1"></a>        <span class="at">y =</span> value) <span class="sc">+</span></span>
<span id="cb62-4"><a href="dealing-with-fiterrors.html#cb62-4" tabindex="-1"></a>    <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">colour =</span> Condition)) <span class="sc">+</span></span>
<span id="cb62-5"><a href="dealing-with-fiterrors.html#cb62-5" tabindex="-1"></a>    <span class="fu">facet_grid</span>(<span class="sc">~</span> Mixture, <span class="at">scales =</span> <span class="st">"free"</span>) <span class="sc">+</span></span>
<span id="cb62-6"><a href="dealing-with-fiterrors.html#cb62-6" tabindex="-1"></a>    <span class="fu">ggtitle</span>(targetProtein) <span class="sc">+</span></span>
<span id="cb62-7"><a href="dealing-with-fiterrors.html#cb62-7" tabindex="-1"></a>    <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb62-8"><a href="dealing-with-fiterrors.html#cb62-8" tabindex="-1"></a>    <span class="fu">theme</span>(<span class="at">axis.text.x =</span> <span class="fu">element_blank</span>())</span></code></pre></div>
<p>We can immediately spot that PSM intensities are only present in
mixture 3. Hence, the mixed model cannot be fitted with a random
effect for mixture. A solution would be drop the random effect for
mixture, provided that a data analysis expert and/or a field
specialist deems it reasonable. This requires expert intervention to
simplify the model definition based on the available data set so as to
provide valid statistical inference on the research hypotheses.</p>
<p><code>msqrob2</code> flags these problematic proteins instead of defining ad-hoc
heuristics, avoiding potentially misleading conclusions. The expert
can then decide to refit a simpler model using <code>msqrobRefit()</code>.</p>
<p>Note, that the same approach can be applied for summarisation-based
models that start from protein data.</p>
<div class="sourceCode" id="cb63"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb63-1"><a href="dealing-with-fiterrors.html#cb63-1" tabindex="-1"></a>se <span class="ot">&lt;-</span> <span class="fu">getWithColData</span>(spikein, <span class="st">"proteins"</span>)</span>
<span id="cb63-2"><a href="dealing-with-fiterrors.html#cb63-2" tabindex="-1"></a><span class="fu">data.frame</span>(<span class="at">intensity =</span> <span class="fu">assay</span>(se)[proteinError, ],</span>
<span id="cb63-3"><a href="dealing-with-fiterrors.html#cb63-3" tabindex="-1"></a>           <span class="fu">colData</span>(spikein),</span>
<span id="cb63-4"><a href="dealing-with-fiterrors.html#cb63-4" tabindex="-1"></a>           <span class="at">colname =</span> <span class="fu">colnames</span>(se)) <span class="sc">|&gt;</span></span>
<span id="cb63-5"><a href="dealing-with-fiterrors.html#cb63-5" tabindex="-1"></a>    <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(intensity)) <span class="sc">|&gt;</span></span>
<span id="cb63-6"><a href="dealing-with-fiterrors.html#cb63-6" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">colname =</span> <span class="fu">factor</span>(colname, <span class="at">levels =</span> <span class="fu">unique</span>(colname[<span class="fu">order</span>(Condition)]))) <span class="sc">|&gt;</span></span>
<span id="cb63-7"><a href="dealing-with-fiterrors.html#cb63-7" tabindex="-1"></a>    <span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb63-8"><a href="dealing-with-fiterrors.html#cb63-8" tabindex="-1"></a>    <span class="fu">aes</span>(<span class="at">x =</span> colname,</span>
<span id="cb63-9"><a href="dealing-with-fiterrors.html#cb63-9" tabindex="-1"></a>        <span class="at">y =</span> intensity) <span class="sc">+</span></span>
<span id="cb63-10"><a href="dealing-with-fiterrors.html#cb63-10" tabindex="-1"></a>    <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">colour =</span> Condition)) <span class="sc">+</span></span>
<span id="cb63-11"><a href="dealing-with-fiterrors.html#cb63-11" tabindex="-1"></a>    <span class="fu">facet_grid</span>(<span class="sc">~</span> Mixture, <span class="at">scales =</span> <span class="st">"free"</span>) <span class="sc">+</span></span>
<span id="cb63-12"><a href="dealing-with-fiterrors.html#cb63-12" tabindex="-1"></a>    <span class="fu">ggtitle</span>(proteinError, <span class="st">"associated to a fitError</span><span class="sc">\n</span><span class="st">Summarised protein intensities (median polish)"</span>) <span class="sc">+</span></span>
<span id="cb63-13"><a href="dealing-with-fiterrors.html#cb63-13" tabindex="-1"></a>    <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb63-14"><a href="dealing-with-fiterrors.html#cb63-14" tabindex="-1"></a>    <span class="fu">theme</span>(<span class="at">axis.text.x =</span> <span class="fu">element_blank</span>())</span></code></pre></div>
<p>The same conclusion applies as for the PSM-level data. In fact, this
is the same plot as above since the protein is also a one-hit wonder,
what seriously questions the reliability of the data for protein. This
example illustrates the relevance of <code>msqrob2</code> to safeguard against
automatic model simplification that may be otherwise fall unnoticed by
the user.</p>
</div>
<div id="imputation" class="section level2" number="8.3">
<h2>
<span class="header-section-number">8.3</span> Imputation<div class="tooltip"><button class="internal-link-btn" onclick="copy_link('imputation')" onmouseout="reset_tooltip('imputation-tooltip')"><span class="tooltiptext" id="imputation-tooltip">Copy link</span><i class="fa fa-link"></i></button></div>
</h2>
<p>The last strategy to deal with fit errors is to impute missing values
so that all models can be estimated. <code>QFeatures</code> provides a large
panel of imputation strategies through <code>impute()</code>. Identifying which
imputation strategy is most suited for this data set is outside the
scope of this vignette, and we here arbitrarily decide to use KNN
imputation.</p>
<div class="sourceCode" id="cb64"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb64-1"><a href="dealing-with-fiterrors.html#cb64-1" tabindex="-1"></a>(spikein <span class="ot">&lt;-</span> <span class="fu">impute</span>(</span>
<span id="cb64-2"><a href="dealing-with-fiterrors.html#cb64-2" tabindex="-1"></a>    spikein, <span class="at">i =</span> <span class="st">"ions"</span>, <span class="at">name =</span> <span class="st">"ions_imputed"</span>,</span>
<span id="cb64-3"><a href="dealing-with-fiterrors.html#cb64-3" tabindex="-1"></a>    <span class="at">method =</span> <span class="st">"knn"</span>, <span class="at">colmax =</span> <span class="dv">1</span></span>
<span id="cb64-4"><a href="dealing-with-fiterrors.html#cb64-4" tabindex="-1"></a>))</span></code></pre></div>
<p>The function added a new set <code>ions_imputed</code> which we can use to fit
the PSM model.</p>
<div class="sourceCode" id="cb65"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb65-1"><a href="dealing-with-fiterrors.html#cb65-1" tabindex="-1"></a>spikein <span class="ot">&lt;-</span> <span class="fu">msqrobAggregate</span>(</span>
<span id="cb65-2"><a href="dealing-with-fiterrors.html#cb65-2" tabindex="-1"></a>    spikein,  <span class="at">i =</span> <span class="st">"ions_imputed"</span>,</span>
<span id="cb65-3"><a href="dealing-with-fiterrors.html#cb65-3" tabindex="-1"></a>    <span class="at">formula =</span> <span class="sc">~</span> <span class="dv">0</span> <span class="sc">+</span> Condition <span class="sc">+</span> <span class="do">## fixed effect for experimental condition</span></span>
<span id="cb65-4"><a href="dealing-with-fiterrors.html#cb65-4" tabindex="-1"></a>        <span class="co"># (1 | Channel) + ## random effect for channel</span></span>
<span id="cb65-5"><a href="dealing-with-fiterrors.html#cb65-5" tabindex="-1"></a>        (<span class="dv">1</span> <span class="sc">|</span> Mixture) <span class="sc">+</span> <span class="do">## random effect for mixture</span></span>
<span id="cb65-6"><a href="dealing-with-fiterrors.html#cb65-6" tabindex="-1"></a>        (<span class="dv">1</span> <span class="sc">|</span> Run) <span class="sc">+</span> <span class="do">## random effect for run</span></span>
<span id="cb65-7"><a href="dealing-with-fiterrors.html#cb65-7" tabindex="-1"></a>        (<span class="dv">1</span> <span class="sc">|</span> Run<span class="sc">:</span>Channel) <span class="sc">+</span> <span class="do">## random effect for PSMs from the same protein in a channel of a run</span></span>
<span id="cb65-8"><a href="dealing-with-fiterrors.html#cb65-8" tabindex="-1"></a>        (<span class="dv">1</span> <span class="sc">|</span> Run<span class="sc">:</span>ionID), <span class="do">## random effect for ions in the same spectrum of an MS run</span></span>
<span id="cb65-9"><a href="dealing-with-fiterrors.html#cb65-9" tabindex="-1"></a>    <span class="at">fcol =</span> <span class="st">"Protein.Accessions"</span>,</span>
<span id="cb65-10"><a href="dealing-with-fiterrors.html#cb65-10" tabindex="-1"></a>    <span class="at">modelColumnName =</span> <span class="st">"msqrob_psm_rrilmm"</span>,</span>
<span id="cb65-11"><a href="dealing-with-fiterrors.html#cb65-11" tabindex="-1"></a>    <span class="at">name =</span> <span class="st">"proteins_msqrob_imputed"</span>,</span>
<span id="cb65-12"><a href="dealing-with-fiterrors.html#cb65-12" tabindex="-1"></a>    <span class="at">robust =</span> <span class="cn">TRUE</span>, <span class="at">ridge =</span> <span class="cn">TRUE</span></span>
<span id="cb65-13"><a href="dealing-with-fiterrors.html#cb65-13" tabindex="-1"></a>)</span></code></pre></div>
<p>We here assess how many models have been estimated for all proteins
upon imputation.</p>
<div class="sourceCode" id="cb66"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb66-1"><a href="dealing-with-fiterrors.html#cb66-1" tabindex="-1"></a><span class="fu">rowData</span>(spikein[[<span class="st">"proteins_msqrob_imputed"</span>]])[[<span class="st">"msqrob_psm_rrilmm"</span>]] <span class="sc">|&gt;</span></span>
<span id="cb66-2"><a href="dealing-with-fiterrors.html#cb66-2" tabindex="-1"></a>    <span class="fu">sapply</span>(<span class="cf">function</span>(x) x<span class="sc">@</span>type) <span class="sc">|&gt;</span></span>
<span id="cb66-3"><a href="dealing-with-fiterrors.html#cb66-3" tabindex="-1"></a>    <span class="fu">table</span>()</span></code></pre></div>
<p>Again <code>fitError</code>s were generated for one-hit-wonder proteins.</p>
<div class="sourceCode" id="cb67"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb67-1"><a href="dealing-with-fiterrors.html#cb67-1" tabindex="-1"></a>counts <span class="ot">&lt;-</span> <span class="fu">aggcounts</span>(spikein[[<span class="st">"proteins_msqrob_imputed"</span>]])</span>
<span id="cb67-2"><a href="dealing-with-fiterrors.html#cb67-2" tabindex="-1"></a>oneHitProteins <span class="ot">&lt;-</span> <span class="fu">rownames</span>(counts)[<span class="fu">rowMax</span>(counts) <span class="sc">==</span> <span class="dv">1</span>]</span>
<span id="cb67-3"><a href="dealing-with-fiterrors.html#cb67-3" tabindex="-1"></a>spikein <span class="ot">&lt;-</span> <span class="fu">msqrobRefit</span>(</span>
<span id="cb67-4"><a href="dealing-with-fiterrors.html#cb67-4" tabindex="-1"></a>    spikein, <span class="at">i =</span> <span class="st">"ions_imputed"</span>,</span>
<span id="cb67-5"><a href="dealing-with-fiterrors.html#cb67-5" tabindex="-1"></a>    <span class="at">subset =</span> oneHitProteins,</span>
<span id="cb67-6"><a href="dealing-with-fiterrors.html#cb67-6" tabindex="-1"></a>    <span class="at">formula =</span> <span class="sc">~</span> <span class="dv">0</span> <span class="sc">+</span> Condition <span class="sc">+</span> <span class="do">## fixed effect for experimental condition</span></span>
<span id="cb67-7"><a href="dealing-with-fiterrors.html#cb67-7" tabindex="-1"></a>        <span class="co"># (1 | Channel) + ## random effect for channel</span></span>
<span id="cb67-8"><a href="dealing-with-fiterrors.html#cb67-8" tabindex="-1"></a>        (<span class="dv">1</span> <span class="sc">|</span> Mixture) <span class="sc">+</span> <span class="do">## random effect for mixture</span></span>
<span id="cb67-9"><a href="dealing-with-fiterrors.html#cb67-9" tabindex="-1"></a>        (<span class="dv">1</span> <span class="sc">|</span> Run ) <span class="sc">+</span> <span class="do">## random effect for run</span></span>
<span id="cb67-10"><a href="dealing-with-fiterrors.html#cb67-10" tabindex="-1"></a>        (<span class="dv">1</span> <span class="sc">|</span> Run<span class="sc">:</span>ionID), <span class="do">## random effect for PSM nested in MS run</span></span>
<span id="cb67-11"><a href="dealing-with-fiterrors.html#cb67-11" tabindex="-1"></a>        <span class="do">## random effect for channel nested in run has been removed</span></span>
<span id="cb67-12"><a href="dealing-with-fiterrors.html#cb67-12" tabindex="-1"></a>    <span class="at">fcol =</span> <span class="st">"Protein.Accessions"</span>,</span>
<span id="cb67-13"><a href="dealing-with-fiterrors.html#cb67-13" tabindex="-1"></a>    <span class="at">modelColumnName =</span> <span class="st">"msqrob_psm_rrilmm"</span>,</span>
<span id="cb67-14"><a href="dealing-with-fiterrors.html#cb67-14" tabindex="-1"></a>    <span class="at">name =</span> <span class="st">"proteins_msqrob_imputed"</span>,</span>
<span id="cb67-15"><a href="dealing-with-fiterrors.html#cb67-15" tabindex="-1"></a>    <span class="at">robust =</span> <span class="cn">TRUE</span>, <span class="at">ridge =</span> <span class="cn">TRUE</span></span>
<span id="cb67-16"><a href="dealing-with-fiterrors.html#cb67-16" tabindex="-1"></a>)</span>
<span id="cb67-17"><a href="dealing-with-fiterrors.html#cb67-17" tabindex="-1"></a><span class="fu">rowData</span>(spikein[[<span class="st">"proteins_msqrob_imputed"</span>]])[[<span class="st">"msqrob_psm_rrilmm"</span>]] <span class="sc">|&gt;</span></span>
<span id="cb67-18"><a href="dealing-with-fiterrors.html#cb67-18" tabindex="-1"></a>    <span class="fu">sapply</span>(<span class="cf">function</span>(x) x<span class="sc">@</span>type) <span class="sc">|&gt;</span></span>
<span id="cb67-19"><a href="dealing-with-fiterrors.html#cb67-19" tabindex="-1"></a>    <span class="fu">table</span>()</span></code></pre></div>
<p>Upon refit, no <code>fitError</code>s were generated for any proteins, as expected. Be
mindful that although this approach no longer requires strong
statistical insights, the results upon imputation will be highly
depended on the suitability of the imputation approach.</p>
<p>We can apply the same approach for upon summarisation, starting from
the imputed peptide ion data.</p>
<div class="sourceCode" id="cb68"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb68-1"><a href="dealing-with-fiterrors.html#cb68-1" tabindex="-1"></a>spikein <span class="ot">&lt;-</span> <span class="fu">aggregateFeatures</span>(</span>
<span id="cb68-2"><a href="dealing-with-fiterrors.html#cb68-2" tabindex="-1"></a>    spikein, <span class="at">i =</span> <span class="st">"ions_imputed"</span>, <span class="at">name =</span> <span class="st">"proteins_imputed"</span>,</span>
<span id="cb68-3"><a href="dealing-with-fiterrors.html#cb68-3" tabindex="-1"></a>    <span class="at">fcol =</span> <span class="st">"Protein.Accessions"</span>, <span class="at">fun =</span> MsCoreUtils<span class="sc">::</span>medianPolish,</span>
<span id="cb68-4"><a href="dealing-with-fiterrors.html#cb68-4" tabindex="-1"></a>    <span class="at">na.rm =</span> <span class="cn">TRUE</span></span>
<span id="cb68-5"><a href="dealing-with-fiterrors.html#cb68-5" tabindex="-1"></a>)</span>
<span id="cb68-6"><a href="dealing-with-fiterrors.html#cb68-6" tabindex="-1"></a>spikein <span class="ot">&lt;-</span> <span class="fu">msqrob</span>(</span>
<span id="cb68-7"><a href="dealing-with-fiterrors.html#cb68-7" tabindex="-1"></a>    spikein,  <span class="at">i =</span> <span class="st">"proteins_imputed"</span>,</span>
<span id="cb68-8"><a href="dealing-with-fiterrors.html#cb68-8" tabindex="-1"></a>    <span class="at">formula =</span> <span class="sc">~</span> <span class="dv">0</span> <span class="sc">+</span> Condition <span class="sc">+</span> <span class="do">## fixed effect for experimental condition</span></span>
<span id="cb68-9"><a href="dealing-with-fiterrors.html#cb68-9" tabindex="-1"></a>        <span class="co"># (1 | Channel) + ## random effect for channel</span></span>
<span id="cb68-10"><a href="dealing-with-fiterrors.html#cb68-10" tabindex="-1"></a>        (<span class="dv">1</span> <span class="sc">|</span> Mixture) <span class="sc">+</span> <span class="do">## random effect for mixture</span></span>
<span id="cb68-11"><a href="dealing-with-fiterrors.html#cb68-11" tabindex="-1"></a>        (<span class="dv">1</span> <span class="sc">|</span> Run), <span class="do">## random effect for MS run</span></span>
<span id="cb68-12"><a href="dealing-with-fiterrors.html#cb68-12" tabindex="-1"></a>    <span class="at">robust =</span> <span class="cn">TRUE</span>, <span class="at">ridge =</span> <span class="cn">TRUE</span>,</span>
<span id="cb68-13"><a href="dealing-with-fiterrors.html#cb68-13" tabindex="-1"></a>    <span class="at">modelColumnName =</span> <span class="st">"msqrob_rrilmm"</span>,</span>
<span id="cb68-14"><a href="dealing-with-fiterrors.html#cb68-14" tabindex="-1"></a>    <span class="at">overwrite =</span> <span class="cn">TRUE</span></span>
<span id="cb68-15"><a href="dealing-with-fiterrors.html#cb68-15" tabindex="-1"></a>)</span>
<span id="cb68-16"><a href="dealing-with-fiterrors.html#cb68-16" tabindex="-1"></a>models <span class="ot">&lt;-</span> <span class="fu">rowData</span>(spikein[[<span class="st">"proteins_imputed"</span>]])[[<span class="st">"msqrob_rrilmm"</span>]]</span>
<span id="cb68-17"><a href="dealing-with-fiterrors.html#cb68-17" tabindex="-1"></a><span class="fu">table</span>(<span class="fu">sapply</span>(models, <span class="cf">function</span>(x) x<span class="sc">@</span>type))</span></code></pre></div>
</div>
</div>
<p style="text-align: center;">
<a href="statistical-inference.html"><button class="btn btn-default">Previous</button></a>
<a href="conclusion.html"><button class="btn btn-default">Next</button></a>
</p>
<p class="build-date">Page built: 
2025-09-03
 using 
R version 4.5.1 (2025-06-13)
</p>
</div>
</div>



</body>
</html>
