<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

<meta charset="utf-8" />
<meta name="generator" content="pandoc" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<meta property="og:title" content="Chapter 2 Statistical analysis with msqrob2 | Statistical analysis for proteomics data" />
<meta property="og:type" content="book" />




<meta name="author" content="Christophe Vanderaa, Stijn Vandenbulcke, Lieven Clement" />

<meta name="date" content="2025-09-05" />

<script type="text/x-mathjax-config">
MathJax.Hub.Config({
  TeX: { equationNumbers: { autoNumber: "AMS" } }
});
</script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<meta name="description" content="Chapter 2 Statistical analysis with msqrob2 | Statistical analysis for proteomics data">

<title>Chapter 2 Statistical analysis with msqrob2 | Statistical analysis for proteomics data</title>

<link href="libs/tufte-css-2015.12.29/tufte.css" rel="stylesheet" />
<link href="libs/tufte-css-2015.12.29/envisioned.css" rel="stylesheet" />
<link href="libs/msmb-css-0/msmb.css" rel="stylesheet" />
<script>
function toggle_visibility(id1, id2) {
var e = document.getElementById(id1);
var f = document.getElementById(id2);

e.style.display = ((e.style.display!='none') ? 'none' : 'block');

if(f.classList.contains('fa-plus-square')) {
    f.classList.add('fa-minus-square')
    f.classList.remove('fa-plus-square')
} else {
    f.classList.add('fa-plus-square')
    f.classList.remove('fa-minus-square')
}

}
</script>
<script>
function copy_link(id) {
  var dummy = document.createElement('input'),
  text = window.location.href.split(/[?#]/)[0] + '#' + id;
  document.body.appendChild(dummy);
  dummy.value = text;
  dummy.select();
  document.execCommand('copy');
  document.body.removeChild(dummy);
  
  var tooltip = document.getElementById(id + '-tooltip');
  tooltip.innerHTML = 'Copied!';
}

function reset_tooltip(id) {
  var tooltip = document.getElementById(id);
  tooltip.innerHTML = 'Copy link';
}
</script>


<style type="text/css">code{white-space: pre;}</style>
<style type="text/css">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }

code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {  background-color: #f8f8f8; }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ef2929; } /* Alert */
code span.an { color: #8f5902; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #204a87; } /* Attribute */
code span.bn { color: #0000cf; } /* BaseN */
code span.cf { color: #204a87; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4e9a06; } /* Char */
code span.cn { color: #8f5902; } /* Constant */
code span.co { color: #8f5902; font-style: italic; } /* Comment */
code span.cv { color: #8f5902; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #8f5902; font-weight: bold; font-style: italic; } /* Documentation */
code span.dt { color: #204a87; } /* DataType */
code span.dv { color: #0000cf; } /* DecVal */
code span.er { color: #a40000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #0000cf; } /* Float */
code span.fu { color: #204a87; font-weight: bold; } /* Function */
code span.im { } /* Import */
code span.in { color: #8f5902; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #204a87; font-weight: bold; } /* Keyword */
code span.op { color: #ce5c00; font-weight: bold; } /* Operator */
code span.ot { color: #8f5902; } /* Other */
code span.pp { color: #8f5902; font-style: italic; } /* Preprocessor */
code span.sc { color: #ce5c00; font-weight: bold; } /* SpecialChar */
code span.ss { color: #4e9a06; } /* SpecialString */
code span.st { color: #4e9a06; } /* String */
code span.va { color: #000000; } /* Variable */
code span.vs { color: #4e9a06; } /* VerbatimString */
code span.wa { color: #8f5902; font-weight: bold; font-style: italic; } /* Warning */
</style>


<style type="text/css">
/* Used with Pandoc 2.11+ new --citeproc when CSL is used */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
  margin-bottom: 0em;
}
.hanging div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}
</style>

<link rel="stylesheet" href="style.css" type="text/css" />

</head>

<body>



<div class="row">
<div class="col-sm-12">
<div id="TOC">
<ul class="navbar">
<li class="msmb"><p class="title">Statistical analysis for proteomics data<p><p class="author">Christophe Vanderaa, Stijn Vandenbulcke, Lieven Clement</p>
<li class="dropdown" style="float:right">
<a href="javascript:void(0)" class="dropbtn">&#x25BE; Chapters</a>
<div class="dropdown-content">
<a href="index.html" id="toc-preamble"><span class="toc-section-number">1</span> Preamble</a>
<a id="active-page" href="statistical-analysis-with-msqrob2.html" id="toc-statistical-analysis-with-msqrob2"><span class="toc-section-number">2</span> Statistical analysis with msqrob2</a><ul class="toc-sections">
<li class="toc"><a href="#why-msqrob2"> Why msqrob2?</a></li>
<li class="toc"><a href="#load-packages"> Load packages</a></li>
<li class="toc"><a href="#data-import"> Data import</a></li>
<li class="toc"><a href="#data-preprocessing"> Data preprocessing</a></li>
<li class="toc"><a href="#modelling-sources-of-variation"> Modelling sources of variation</a></li>
<li class="toc"><a href="#statistical-inference"> Statistical inference</a></li>
<li class="toc"><a href="#protein-level-models"> Protein-level models</a></li>
<li class="toc"><a href="#dealing-with-fiterrors"> Dealing with <code>fitErrors</code></a></li>
<li class="toc"><a href="#conclusion"> Conclusion</a></li>
</ul>
</div>
</li>
</ul>
</div>
</div>
</div>
<div class="row">
<div class="col-sm-12">
<div id="statistical-analysis-with-msqrob2" class="section level1" number="2">
<h1>
<span class="header-section-number">Chapter 2</span> Statistical analysis with msqrob2</h1>
<p>This chapter explains the important concepts when it comes to
statistical analysis of proteomics data using <code>msqrob2</code>. To illustrate
these concepts, we will use the spike-in study published by
<span class="citation">Huang et al. (<label for="tufte-mn-1" class="margin-toggle">⊕</label><input type="checkbox" id="tufte-mn-1" class="margin-toggle">2020<span class="marginnote">Huang, Ting, Meena Choi, Manuel Tzouros, Sabrina Golling, Nikhil Janak Pandya, Balazs Banfai, Tom Dunkley, and Olga Vitek. 2020. <span>“<span>MSstatsTMT</span>: Statistical Detection of Differentially Abundant Proteins in Experiments with Isobaric Labeling and Multiple Mixtures.”</span> <em>Mol. Cell. Proteomics</em> 19 (10): 1706–23.</span>)</span>. We chose this dataset because</p>
<ol style="list-style-type: decimal">
<li>Spike-in data contain ground truth information about which proteins
are differentially abundant, enabling us to show the impact of
different analysis strategies.</li>
<li>It has been acquired with a TMT-labelling strategy that require a
more complex experimental design. This provides an excellent example
to explain the different sources of variability in an MS experiment
and demonstrate the flexibility of <code>msqrob2</code> to model this
variability.</li>
</ol>
<div id="why-msqrob2" class="section level2" number="2.1">
<h2>
<span class="header-section-number">2.1</span> Why msqrob2?<div class="tooltip"><button class="internal-link-btn" onclick="copy_link('why-msqrob2')" onmouseout="reset_tooltip('why-msqrob2-tooltip')"><span class="tooltiptext" id="why-msqrob2-tooltip">Copy link</span><i class="fa fa-link"></i></button></div>
</h2>
<p>Mass spectrometry (MS)-based proteomics experiments often imposes a
complex correlation structure among observations. Addressing this
correlation is key for correct statistical inference and reliable
biomarker discovery. msqrob2TMT is a set of mixed model-based
workflows tailored toward differential abundance analysis for labelled
MS-based proteomics data. The key features of <code>msqrob2TMT</code> workflows
are:</p>
<ol style="list-style-type: decimal">
<li>Modularity: all core functions rely on the <code>QFeatures</code> class, a
standardised data structure, meaning that output of a function can
be fed as input to any other function. Hence, different functions
are assembled as modular blocks into a complete data analysis
workflows that can be easily adapted to the peculiarities of any
MS-based proteomics data set. Therefore, the approach extends well
beyond the use case presented in this chapter</li>
<li>Flexibility: the <code>msqrob2</code> modelling approach relies on the
<code>lme4::lmer()</code> model specification syntax, meaning that any linear
model can be specified. For fixed effects, this includes modelling
categorical and numerical variables, as well as their interaction.
Moreover, <code>msqrob2</code> can model both sample-specific and
feature-specific (e.g. peptide or protein) covariates, which
unlocks the inference to experiments with arbitrarily complex
designs as well as to correct explicitly for feature-specific
properties.</li>
<li>Performance: thanks to the inclusion of robust ridge regression, we
demonstrated improved performance of <code>msqrob2</code> workflows upon the
competing software <span class="citation">(<label for="tufte-mn-2" class="margin-toggle">⊕</label><input type="checkbox" id="tufte-mn-2" class="margin-toggle">Goeminne, Gevaert, and Clement 2016<span class="marginnote">Goeminne, Ludger J E, Kris Gevaert, and Lieven Clement. 2016. <span>“Peptide-Level Robust Ridge Regression Improves Estimation, Sensitivity, and Specificity in Data-Dependent Quantitative Label-Free Shotgun Proteomics.”</span> <em>Mol. Cell. Proteomics</em> 15 (2): 657–68.</span>; <label for="tufte-mn-3" class="margin-toggle">⊕</label><input type="checkbox" id="tufte-mn-3" class="margin-toggle">Sticker et al. 2020<span class="marginnote">Sticker, Adriaan, Ludger Goeminne, Lennart Martens, and Lieven Clement. 2020. <span>“Robust Summarization and Inference in Proteome-Wide Label-Free Quantification.”</span> <em>Mol. Cell. Proteomics</em> 19 (7): 1209–19.</span>; <label for="tufte-mn-4" class="margin-toggle">⊕</label><input type="checkbox" id="tufte-mn-4" class="margin-toggle">Vandenbulcke et al. 2025<span class="marginnote">Vandenbulcke, Stijn, Christophe Vanderaa, Oliver Crook, Lennart Martens, and Lieven Clement. 2025. <span>“<span>Msqrob2TMT</span>: Robust Linear Mixed Models for Inferring Differential Abundant Proteins in Labeled Experiments with Arbitrarily Complex Design.”</span> <em>Mol. Cell. Proteomics</em> 24 (7): 101002.</span>)</span>.</li>
</ol>
<div class="sourceCode" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb2-1"><a href="statistical-analysis-with-msqrob2.html#cb2-1" tabindex="-1"></a>knitr<span class="sc">::</span>opts_chunk<span class="sc">$</span><span class="fu">set</span>(<span class="at">eval =</span> <span class="cn">FALSE</span>)</span></code></pre></div>
</div>
<div id="load-packages" class="section level2" number="2.2">
<h2>
<span class="header-section-number">2.2</span> Load packages<div class="tooltip"><button class="internal-link-btn" onclick="copy_link('load-packages')" onmouseout="reset_tooltip('load-packages-tooltip')"><span class="tooltiptext" id="load-packages-tooltip">Copy link</span><i class="fa fa-link"></i></button></div>
</h2>
<p>First, we load the <code>msqrob2</code> package, along 2 additional packages for
data manipulation and visualisation.</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb3-1"><a href="statistical-analysis-with-msqrob2.html#cb3-1" tabindex="-1"></a><span class="fu">library</span>(<span class="st">"msqrob2"</span>)</span>
<span id="cb3-2"><a href="statistical-analysis-with-msqrob2.html#cb3-2" tabindex="-1"></a><span class="fu">library</span>(<span class="st">"dplyr"</span>)</span>
<span id="cb3-3"><a href="statistical-analysis-with-msqrob2.html#cb3-3" tabindex="-1"></a><span class="fu">library</span>(<span class="st">"ggplot2"</span>)</span></code></pre></div>
<p><code>msqrob2</code> relies on parallelisation to improve computational speed.
To ensure this vignette can be run regardless of hardware, we will
disable parallelisation. Parallelisation is controlled using the
<code>BiocParallel</code> package.</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb4-1"><a href="statistical-analysis-with-msqrob2.html#cb4-1" tabindex="-1"></a><span class="fu">library</span>(<span class="st">"BiocParallel"</span>)</span>
<span id="cb4-2"><a href="statistical-analysis-with-msqrob2.html#cb4-2" tabindex="-1"></a><span class="fu">register</span>(<span class="fu">SerialParam</span>())</span></code></pre></div>
</div>
<div id="data-import" class="section level2" number="2.3">
<h2>
<span class="header-section-number">2.3</span> Data import<div class="tooltip"><button class="internal-link-btn" onclick="copy_link('data-import')" onmouseout="reset_tooltip('data-import-tooltip')"><span class="tooltiptext" id="data-import-tooltip">Copy link</span><i class="fa fa-link"></i></button></div>
</h2>
<p>The data set used in this chapter is a spike-in experiment
(PXD0015258). It consists of controlled mixtures with known ground
truth. UPS1 peptides at concentrations of 500, 333, 250, and 62.5 fmol
were spiked into 50 g of SILAC HeLa peptides, each in duplicate. These
concentrations form a dilution series of 1, 0.667, 0.5, and 0.125
relative to the highest UPS1 peptide amount (500 fmol). A reference
sample was created by combining the diluted UPS1 peptide samples with
50g of SILAC HeLa peptides. All dilutions and the reference sample
were prepared in duplicate, resulting in a total of ten samples. These
samples were then treated with TMT10-plex reagents and combined before
LC-MS/MS analysis. This protocol was repeated five times, each with
three technical replicates, totaling 15 MS runs.</p>
<div id="getting-the-data" class="section level3" number="2.3.1">
<h3>
<span class="header-section-number">2.3.1</span> Getting the data<div class="tooltip"><button class="internal-link-btn" onclick="copy_link('getting-the-data')" onmouseout="reset_tooltip('getting-the-data-tooltip')"><span class="tooltiptext" id="getting-the-data-tooltip">Copy link</span><i class="fa fa-link"></i></button></div>
</h3>
<p>The data have been deposited by the authors in the <code>MSV000084264</code>
MASSiVE repository, but we will retrieve the timestamped data from our
<a href="https://zenodo.org/records/14767905">Zenodo repository</a>. To
facilitate management of the files, we here
download them using the <code>BiocFileCache</code> package. We need 2 files: the
Skyline identification and quantification table generated by the
authors and the sample annotation files. <code>BiocFileCache</code> ensures that
the files are downloaded once, hence the chunk below will take some
time only the first time you run it.</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb5-1"><a href="statistical-analysis-with-msqrob2.html#cb5-1" tabindex="-1"></a><span class="fu">library</span>(<span class="st">"BiocFileCache"</span>)</span>
<span id="cb5-2"><a href="statistical-analysis-with-msqrob2.html#cb5-2" tabindex="-1"></a>bfc <span class="ot">&lt;-</span> <span class="fu">BiocFileCache</span>()</span>
<span id="cb5-3"><a href="statistical-analysis-with-msqrob2.html#cb5-3" tabindex="-1"></a>psmFile <span class="ot">&lt;-</span> <span class="fu">bfcrpath</span>(bfc, <span class="st">"https://zenodo.org/records/14767905/files/spikein1_psms.txt?download=1"</span>)</span>
<span id="cb5-4"><a href="statistical-analysis-with-msqrob2.html#cb5-4" tabindex="-1"></a>annotFile <span class="ot">&lt;-</span> <span class="fu">bfcrpath</span>(bfc, <span class="st">"https://zenodo.org/records/14767905/files/spikein1_annotations.csv?download=1"</span>)</span></code></pre></div>
<p>Now the files are downloaded, we can load the two tables. We also
perform a little cleanup of the sample annotations to generate the
information needed for downstream data processing.</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb6-1"><a href="statistical-analysis-with-msqrob2.html#cb6-1" tabindex="-1"></a>psms <span class="ot">&lt;-</span> <span class="fu">read.delim</span>(psmFile)</span>
<span id="cb6-2"><a href="statistical-analysis-with-msqrob2.html#cb6-2" tabindex="-1"></a>coldata <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(annotFile)</span>
<span id="cb6-3"><a href="statistical-analysis-with-msqrob2.html#cb6-3" tabindex="-1"></a>coldata <span class="ot">&lt;-</span> coldata[, <span class="fu">c</span>(<span class="st">"Run"</span>, <span class="st">"Channel"</span>, <span class="st">"Condition"</span>, <span class="st">"Mixture"</span>, <span class="st">"TechRepMixture"</span>)]</span>
<span id="cb6-4"><a href="statistical-analysis-with-msqrob2.html#cb6-4" tabindex="-1"></a>coldata<span class="sc">$</span>FileName <span class="ot">&lt;-</span> coldata<span class="sc">$</span>Run</span>
<span id="cb6-5"><a href="statistical-analysis-with-msqrob2.html#cb6-5" tabindex="-1"></a>coldata<span class="sc">$</span>Run <span class="ot">&lt;-</span> <span class="fu">sub</span>(<span class="st">"^.*(Mix.*).raw"</span>, <span class="st">"</span><span class="sc">\\</span><span class="st">1"</span>, coldata<span class="sc">$</span>Run)</span></code></pre></div>
<p>There is a peculiarity with the dataset: the spectra have been
identified with 2 nodes. In one node, the authors searched the
SwissProt database for proteins with static modifications related to
the metabolic labelling, in the other node they searched the Sigma_UPS
protein database without these static modifications. However, some
spectra were identified by both nodes leading to duplicate PSMs. We
here remove these duplicated PSMs that are identification artefacts.</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb7-1"><a href="statistical-analysis-with-msqrob2.html#cb7-1" tabindex="-1"></a>qcols <span class="ot">&lt;-</span> <span class="fu">grep</span>(<span class="st">"Abundance"</span>, <span class="fu">colnames</span>(psms), <span class="at">value =</span> <span class="cn">TRUE</span>)</span>
<span id="cb7-2"><a href="statistical-analysis-with-msqrob2.html#cb7-2" tabindex="-1"></a>duplicatesQuants <span class="ot">&lt;-</span> <span class="fu">duplicated</span>(psms[, qcols]) <span class="sc">|</span> <span class="fu">duplicated</span>(psms[, qcols], <span class="at">fromLast =</span> <span class="cn">TRUE</span>)</span>
<span id="cb7-3"><a href="statistical-analysis-with-msqrob2.html#cb7-3" tabindex="-1"></a>psms <span class="ot">&lt;-</span> psms[<span class="sc">!</span>duplicatesQuants, ]</span></code></pre></div>
<p>We will also subset the data set to reduce computational costs. If you
want to run the analysis on the full data set, you can skip this
chunk. The subsetting will keep all UPS proteins, known to be
differentially abundant by experimental design and we will keep 500
background proteins known to be unchanged across condition.</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb8-1"><a href="statistical-analysis-with-msqrob2.html#cb8-1" tabindex="-1"></a>allProteins <span class="ot">&lt;-</span> <span class="fu">unique</span>(psms<span class="sc">$</span>Protein.Accessions)</span>
<span id="cb8-2"><a href="statistical-analysis-with-msqrob2.html#cb8-2" tabindex="-1"></a>upsProteins <span class="ot">&lt;-</span> <span class="fu">grep</span>(<span class="st">"ups"</span>, allProteins, <span class="at">value =</span> <span class="cn">TRUE</span>)</span>
<span id="cb8-3"><a href="statistical-analysis-with-msqrob2.html#cb8-3" tabindex="-1"></a>helaProteins <span class="ot">&lt;-</span> <span class="fu">grep</span>(<span class="st">"ups"</span>, allProteins, <span class="at">value =</span> <span class="cn">TRUE</span>, <span class="at">invert =</span> <span class="cn">TRUE</span>)</span>
<span id="cb8-4"><a href="statistical-analysis-with-msqrob2.html#cb8-4" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">1234</span>)</span>
<span id="cb8-5"><a href="statistical-analysis-with-msqrob2.html#cb8-5" tabindex="-1"></a>keepProteins <span class="ot">&lt;-</span> <span class="fu">c</span>(upsProteins, <span class="fu">sample</span>(helaProteins, <span class="dv">500</span>))</span>
<span id="cb8-6"><a href="statistical-analysis-with-msqrob2.html#cb8-6" tabindex="-1"></a>psms <span class="ot">&lt;-</span> psms[psms<span class="sc">$</span>Protein.Accessions <span class="sc">%in%</span> keepProteins, ]</span></code></pre></div>
</div>
<div id="converting-to-qfeatures" class="section level3" number="2.3.2">
<h3>
<span class="header-section-number">2.3.2</span> Converting to QFeatures<div class="tooltip"><button class="internal-link-btn" onclick="copy_link('converting-to-qfeatures')" onmouseout="reset_tooltip('converting-to-qfeatures-tooltip')"><span class="tooltiptext" id="converting-to-qfeatures-tooltip">Copy link</span><i class="fa fa-link"></i></button></div>
</h3>
<p>Finally, we combine the data into a <code>QFeatures</code> object. We add two
annotation columns so that the <code>readQFeatures</code> function can link the
PSM to the corresponding quantification column within each run, see
<code>?readQFeatures()</code> for more details.</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb9-1"><a href="statistical-analysis-with-msqrob2.html#cb9-1" tabindex="-1"></a>coldata<span class="sc">$</span>runCol <span class="ot">&lt;-</span> coldata<span class="sc">$</span>FileName</span>
<span id="cb9-2"><a href="statistical-analysis-with-msqrob2.html#cb9-2" tabindex="-1"></a>coldata<span class="sc">$</span>quantCols <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">"Abundance.."</span>, coldata<span class="sc">$</span>Channel)</span>
<span id="cb9-3"><a href="statistical-analysis-with-msqrob2.html#cb9-3" tabindex="-1"></a>spikein <span class="ot">&lt;-</span> <span class="fu">readQFeatures</span>(psms, <span class="at">colData =</span> coldata,</span>
<span id="cb9-4"><a href="statistical-analysis-with-msqrob2.html#cb9-4" tabindex="-1"></a>                         <span class="at">quantCols =</span> <span class="fu">unique</span>(coldata<span class="sc">$</span>quantCols),</span>
<span id="cb9-5"><a href="statistical-analysis-with-msqrob2.html#cb9-5" tabindex="-1"></a>                         <span class="at">runCol =</span> <span class="st">"Spectrum.File"</span>, <span class="at">name =</span> <span class="st">"psms"</span>)</span>
<span id="cb9-6"><a href="statistical-analysis-with-msqrob2.html#cb9-6" tabindex="-1"></a><span class="fu">names</span>(spikein) <span class="ot">&lt;-</span> <span class="fu">sub</span>(<span class="st">"^.*(Mix.*).raw"</span>, <span class="st">"</span><span class="sc">\\</span><span class="st">1"</span>, <span class="fu">names</span>(spikein))</span>
<span id="cb9-7"><a href="statistical-analysis-with-msqrob2.html#cb9-7" tabindex="-1"></a>spikein</span></code></pre></div>
<p>We now have a <code>QFeatures</code> object with 15 sets, each containing data
associated with an MS run.</p>
</div>
</div>
<div id="data-preprocessing" class="section level2" number="2.4">
<h2>
<span class="header-section-number">2.4</span> Data preprocessing<div class="tooltip"><button class="internal-link-btn" onclick="copy_link('data-preprocessing')" onmouseout="reset_tooltip('data-preprocessing-tooltip')"><span class="tooltiptext" id="data-preprocessing-tooltip">Copy link</span><i class="fa fa-link"></i></button></div>
</h2>
<p><code>msqrob2</code> relies on the <code>QFeatures</code> data structure, meaning that we
can directly make use of <code>QFeatures</code>’ data preprocessing
functionality. We will not detail the usage of each function below, but
instead refer to the <code>QFeatures</code>
<a href="https://rformassspectrometry.github.io/QFeatures/articles/Processing.html">documentation</a>.</p>
<div id="sample-filtering" class="section level3" number="2.4.1">
<h3>
<span class="header-section-number">2.4.1</span> Sample filtering<div class="tooltip"><button class="internal-link-btn" onclick="copy_link('sample-filtering')" onmouseout="reset_tooltip('sample-filtering-tooltip')"><span class="tooltiptext" id="sample-filtering-tooltip">Copy link</span><i class="fa fa-link"></i></button></div>
</h3>
<p>We first remove the reference channels. These channels were used by
the MSstatsTMT authors to obtain normalisation factors. However, this
approach ignores the uncertainty associated with the measurement with
these channels, potentially inflating the noise in the samples of
interest. Hence, msqrob2TMT workflows do not use the reference
channels. In practice, we found no impact of reference channel
normalisation on model performance. The information is available from
the <code>colData</code>, under the <code>Condition</code> column. We remove any sample that
is marked as <code>Norm</code>.</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb10-1"><a href="statistical-analysis-with-msqrob2.html#cb10-1" tabindex="-1"></a>spikein <span class="ot">&lt;-</span> <span class="fu">subsetByColData</span>(spikein, spikein<span class="sc">$</span>Condition <span class="sc">!=</span> <span class="st">"Norm"</span>)</span></code></pre></div>
</div>
<div id="psm-filtering" class="section level3" number="2.4.2">
<h3>
<span class="header-section-number">2.4.2</span> PSM filtering<div class="tooltip"><button class="internal-link-btn" onclick="copy_link('psm-filtering')" onmouseout="reset_tooltip('psm-filtering-tooltip')"><span class="tooltiptext" id="psm-filtering-tooltip">Copy link</span><i class="fa fa-link"></i></button></div>
</h3>
<p>The background proteins originate from HeLa cells, which also contain
UPS proteins. The background UPS proteins and the spiked-in UPS
proteins differ in metabolic labelling, so we should be able to
distinguish them. We used the PSM-level data searched with mascot, as
provided by the MSstatsTMT authors who used two mascot identification
nodes. In one node they searched the SwissProt database for proteins
with static modifications related to the metabolic labelling, in the
other node they searched the Sigma_UPS protein database without these
static modifications. Ideally, this should separate the spiked-in UPS
proteins and the UPS proteins from the HeLa cells, however, this is
not always the case. The SwissProt search is expected to return
peptide-spectrum matches (PSMs) for all proteins, including non-UPS
HeLa, UPS HeLa, and spike-in UPS proteins. Conversely, the Sigma_UPS
search is expected to return PSMs exclusively for spike-in UPS
proteins. However, a PSM that matches a UPS protein in the SwissProt
search but is not identified as such in the Sigma_UPS search could
either correctly originate from a HeLa protein or represent a
spiked-in UPS protein that was not recognised as such in the Sigma_UPS
search. Additionally, there are ambiguous PSMs that are not matched to
a UPS protein in the HeLa search but are matched to a UPS protein in
the SwissProt search. To address this, we exclude these ambiguous
proteins from the analysis.</p>
<p>To define amibiguous PSMs, we retrieve the PSM annotations from the
<code>rowData</code> and create a new colum indicating whether a PSM belongs to a
UPS protein or not, based on the protein SwissProt identifiers.</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb11-1"><a href="statistical-analysis-with-msqrob2.html#cb11-1" tabindex="-1"></a>rowdata <span class="ot">&lt;-</span> <span class="fu">rbindRowData</span>(spikein, <span class="fu">names</span>(spikein))</span>
<span id="cb11-2"><a href="statistical-analysis-with-msqrob2.html#cb11-2" tabindex="-1"></a>rowdata<span class="sc">$</span>isUps <span class="ot">&lt;-</span> <span class="st">"no"</span></span>
<span id="cb11-3"><a href="statistical-analysis-with-msqrob2.html#cb11-3" tabindex="-1"></a>isUpsProtein <span class="ot">&lt;-</span> <span class="fu">grepl</span>(<span class="st">"ups"</span>, rowdata<span class="sc">$</span>Protein.Accessions)</span>
<span id="cb11-4"><a href="statistical-analysis-with-msqrob2.html#cb11-4" tabindex="-1"></a>rowdata<span class="sc">$</span>isUps[isUpsProtein] <span class="ot">&lt;-</span> <span class="st">"yes"</span></span></code></pre></div>
<p>Then, we define an ambiguous PSM as a PSM that is marked as UPS by the
SwissProt identifier but not by the Sigma_UPS node (<code>Marked.as</code>
column), and inversely. Ambiguous PSMs are removed.</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb12-1"><a href="statistical-analysis-with-msqrob2.html#cb12-1" tabindex="-1"></a>rowdata<span class="sc">$</span>isUps[<span class="sc">!</span>isUpsProtein <span class="sc">&amp;</span> <span class="fu">grepl</span>(<span class="st">"UPS"</span>, rowdata<span class="sc">$</span>Marked.as)] <span class="ot">&lt;-</span> <span class="st">"amb"</span></span>
<span id="cb12-2"><a href="statistical-analysis-with-msqrob2.html#cb12-2" tabindex="-1"></a>rowdata<span class="sc">$</span>isUps[isUpsProtein <span class="sc">&amp;</span> <span class="sc">!</span><span class="fu">grepl</span>(<span class="st">"UPS"</span>, rowdata<span class="sc">$</span>Marked.as)] <span class="ot">&lt;-</span> <span class="st">"amb"</span></span>
<span id="cb12-3"><a href="statistical-analysis-with-msqrob2.html#cb12-3" tabindex="-1"></a><span class="fu">rowData</span>(spikein) <span class="ot">&lt;-</span> <span class="fu">split</span>(rowdata, rowdata<span class="sc">$</span>assay)</span>
<span id="cb12-4"><a href="statistical-analysis-with-msqrob2.html#cb12-4" tabindex="-1"></a>spikein <span class="ot">&lt;-</span> <span class="fu">filterFeatures</span>(spikein, <span class="sc">~</span> isUps <span class="sc">!=</span> <span class="st">"amb"</span>)</span></code></pre></div>
<p>Next, we remove PSMs that could not be mapped to a protein or that map
to multiple proteins (the protein identifier contains multiple
identifiers separated by a <code>;</code>).</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb13-1"><a href="statistical-analysis-with-msqrob2.html#cb13-1" tabindex="-1"></a>spikein <span class="ot">&lt;-</span> <span class="fu">filterFeatures</span>(</span>
<span id="cb13-2"><a href="statistical-analysis-with-msqrob2.html#cb13-2" tabindex="-1"></a>    spikein, <span class="sc">~</span> Protein.Accessions <span class="sc">!=</span> <span class="st">""</span> <span class="sc">&amp;</span> <span class="do">## Remove failed protein inference</span></span>
<span id="cb13-3"><a href="statistical-analysis-with-msqrob2.html#cb13-3" tabindex="-1"></a>        <span class="sc">!</span><span class="fu">grepl</span>(<span class="st">";"</span>, Protein.Accessions)) <span class="do">## Remove protein groups</span></span></code></pre></div>
<p>We also remove peptide ions that map to a different protein depending
on the run.</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb14-1"><a href="statistical-analysis-with-msqrob2.html#cb14-1" tabindex="-1"></a>rowdata <span class="ot">&lt;-</span> <span class="fu">rbindRowData</span>(spikein, <span class="fu">names</span>(spikein))</span>
<span id="cb14-2"><a href="statistical-analysis-with-msqrob2.html#cb14-2" tabindex="-1"></a>rowdata <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(rowdata) <span class="sc">|&gt;</span></span>
<span id="cb14-3"><a href="statistical-analysis-with-msqrob2.html#cb14-3" tabindex="-1"></a>    <span class="fu">group_by</span>(Annotated.Sequence, Charge) <span class="sc">|&gt;</span></span>
<span id="cb14-4"><a href="statistical-analysis-with-msqrob2.html#cb14-4" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">nProtsMapped =</span> <span class="fu">length</span>(<span class="fu">unique</span>(Protein.Accessions)))</span>
<span id="cb14-5"><a href="statistical-analysis-with-msqrob2.html#cb14-5" tabindex="-1"></a><span class="fu">rowData</span>(spikein) <span class="ot">&lt;-</span> <span class="fu">split</span>(rowdata, rowdata<span class="sc">$</span>assay)</span>
<span id="cb14-6"><a href="statistical-analysis-with-msqrob2.html#cb14-6" tabindex="-1"></a>spikein <span class="ot">&lt;-</span> <span class="fu">filterFeatures</span>(spikein, <span class="sc">~</span> nProtsMapped <span class="sc">==</span> <span class="dv">1</span>)</span></code></pre></div>
<p>We also remove proteins that can only be found in one run as such
proteins may not be trustworthy.</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb15-1"><a href="statistical-analysis-with-msqrob2.html#cb15-1" tabindex="-1"></a>idProteins <span class="ot">&lt;-</span> <span class="fu">lapply</span>(<span class="fu">rowData</span>(spikein), <span class="cf">function</span>(x) <span class="fu">unique</span>(x<span class="sc">$</span>Protein.Accessions))</span>
<span id="cb15-2"><a href="statistical-analysis-with-msqrob2.html#cb15-2" tabindex="-1"></a>idInNRuns <span class="ot">&lt;-</span> <span class="fu">table</span>(<span class="fu">unlist</span>(idProteins))</span>
<span id="cb15-3"><a href="statistical-analysis-with-msqrob2.html#cb15-3" tabindex="-1"></a>oneRunWonders <span class="ot">&lt;-</span> <span class="fu">names</span>(idInNRuns)[idInNRuns <span class="sc">==</span> <span class="dv">1</span>]</span>
<span id="cb15-4"><a href="statistical-analysis-with-msqrob2.html#cb15-4" tabindex="-1"></a>spikein <span class="ot">&lt;-</span> <span class="fu">filterFeatures</span>(spikein, <span class="sc">~</span> <span class="sc">!</span>Protein.Accessions <span class="sc">%in%</span> oneRunWonders)</span></code></pre></div>
<p>Finally, peptide ions that were identified with multiple PSMs in a run are
collapsed to the PSM with the highest summed intensity over the
channels, a strategy that is also used by MSstats.</p>
<p>We therefore</p>
<ol style="list-style-type: decimal">
<li>Make a new variable for ionID in the rowData.</li>
<li>We calculate the <code>rowSums</code> for each ion.</li>
<li>Make a new variable <code>psmRank</code> that ranks the PSMs for each ionID
based on the summed intensity.</li>
<li>We store the new information back in the <code>rowData</code>.</li>
<li>For each ion that maps to multiple PSMs, only keep the PSM with the
highest summed intensity, that is that ranks first.</li>
<li>Filter ions for which the rowSum equals 0.</li>
</ol>
<div class="sourceCode" id="cb16"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb16-1"><a href="statistical-analysis-with-msqrob2.html#cb16-1" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="fu">names</span>(spikein)) {</span>
<span id="cb16-2"><a href="statistical-analysis-with-msqrob2.html#cb16-2" tabindex="-1"></a>    rowdata <span class="ot">&lt;-</span> <span class="fu">rowData</span>(spikein[[i]])</span>
<span id="cb16-3"><a href="statistical-analysis-with-msqrob2.html#cb16-3" tabindex="-1"></a>    rowdata<span class="sc">$</span>ionID <span class="ot">&lt;-</span> <span class="fu">paste0</span>(rowdata<span class="sc">$</span>Annotated.Sequence, rowdata<span class="sc">$</span>Charge) <span class="do">## 1.</span></span>
<span id="cb16-4"><a href="statistical-analysis-with-msqrob2.html#cb16-4" tabindex="-1"></a>    rowdata<span class="sc">$</span>rowSums <span class="ot">&lt;-</span> <span class="fu">rowSums</span>(<span class="fu">assay</span>(spikein[[i]]), <span class="at">na.rm=</span><span class="cn">TRUE</span>) <span class="do">## 2.</span></span>
<span id="cb16-5"><a href="statistical-analysis-with-msqrob2.html#cb16-5" tabindex="-1"></a>    rowdata <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(rowdata) <span class="sc">|&gt;</span></span>
<span id="cb16-6"><a href="statistical-analysis-with-msqrob2.html#cb16-6" tabindex="-1"></a>        <span class="fu">group_by</span>(ionID) <span class="sc">|&gt;</span></span>
<span id="cb16-7"><a href="statistical-analysis-with-msqrob2.html#cb16-7" tabindex="-1"></a>        <span class="fu">mutate</span>(<span class="at">psmRank =</span> <span class="fu">rank</span>(<span class="sc">-</span>rowSums)) <span class="do">## 3.</span></span>
<span id="cb16-8"><a href="statistical-analysis-with-msqrob2.html#cb16-8" tabindex="-1"></a>    <span class="fu">rowData</span>(spikein[[i]]) <span class="ot">&lt;-</span> <span class="fu">DataFrame</span>(rowdata) <span class="do">## 4.</span></span>
<span id="cb16-9"><a href="statistical-analysis-with-msqrob2.html#cb16-9" tabindex="-1"></a>}</span>
<span id="cb16-10"><a href="statistical-analysis-with-msqrob2.html#cb16-10" tabindex="-1"></a>spikein <span class="ot">&lt;-</span> <span class="fu">filterFeatures</span>(spikein, <span class="sc">~</span> psmRank <span class="sc">==</span> <span class="dv">1</span>) <span class="do">## 5.</span></span>
<span id="cb16-11"><a href="statistical-analysis-with-msqrob2.html#cb16-11" tabindex="-1"></a>spikein <span class="ot">&lt;-</span> <span class="fu">filterFeatures</span>(spikein, <span class="sc">~</span> rowSums <span class="sc">&gt;</span> <span class="dv">0</span>) <span class="do">## 6.</span></span></code></pre></div>
</div>
<div id="missing-data-management" class="section level3" number="2.4.3">
<h3>
<span class="header-section-number">2.4.3</span> Missing data management<div class="tooltip"><button class="internal-link-btn" onclick="copy_link('missing-data-management')" onmouseout="reset_tooltip('missing-data-management-tooltip')"><span class="tooltiptext" id="missing-data-management-tooltip">Copy link</span><i class="fa fa-link"></i></button></div>
</h3>
<p>We ensure missing values are properly encoded. Zero values and missing
values have different interpretations. However, zeros may artificially
occur when the quantification threshold lies above the noise level. We
therefore replace any zero by a missing value. We then remove PSMs
with 5 or more missing values out of 10 TMT channels (&gt;= 50%). This is
an arbitrary value that may need to be adjusted depending on the
experiment and the data set.</p>
<div class="sourceCode" id="cb17"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb17-1"><a href="statistical-analysis-with-msqrob2.html#cb17-1" tabindex="-1"></a>spikein <span class="ot">&lt;-</span> <span class="fu">zeroIsNA</span>(spikein, <span class="fu">names</span>(spikein))</span>
<span id="cb17-2"><a href="statistical-analysis-with-msqrob2.html#cb17-2" tabindex="-1"></a>spikein <span class="ot">&lt;-</span> <span class="fu">filterNA</span>(spikein, <span class="fu">names</span>(spikein), <span class="at">pNA =</span> <span class="fl">0.5</span>)</span></code></pre></div>
</div>
<div id="log2-transformation" class="section level3" number="2.4.4">
<h3>
<span class="header-section-number">2.4.4</span> Log2 transformation<div class="tooltip"><button class="internal-link-btn" onclick="copy_link('log2-transformation')" onmouseout="reset_tooltip('log2-transformation-tooltip')"><span class="tooltiptext" id="log2-transformation-tooltip">Copy link</span><i class="fa fa-link"></i></button></div>
</h3>
<p>Next, we log2 transform the intensities.</p>
<div class="sourceCode" id="cb18"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb18-1"><a href="statistical-analysis-with-msqrob2.html#cb18-1" tabindex="-1"></a>sNames <span class="ot">&lt;-</span> <span class="fu">names</span>(spikein)</span>
<span id="cb18-2"><a href="statistical-analysis-with-msqrob2.html#cb18-2" tabindex="-1"></a>spikein <span class="ot">&lt;-</span> <span class="fu">logTransform</span>(</span>
<span id="cb18-3"><a href="statistical-analysis-with-msqrob2.html#cb18-3" tabindex="-1"></a>    spikein, sNames, <span class="at">name =</span> <span class="fu">paste0</span>(sNames, <span class="st">"_log"</span>), <span class="at">base =</span> <span class="dv">2</span></span>
<span id="cb18-4"><a href="statistical-analysis-with-msqrob2.html#cb18-4" tabindex="-1"></a>)</span></code></pre></div>
</div>
<div id="normalisation" class="section level3" number="2.4.5">
<h3>
<span class="header-section-number">2.4.5</span> Normalisation<div class="tooltip"><button class="internal-link-btn" onclick="copy_link('normalisation')" onmouseout="reset_tooltip('normalisation-tooltip')"><span class="tooltiptext" id="normalisation-tooltip">Copy link</span><i class="fa fa-link"></i></button></div>
</h3>
<p>We normalise each TMT channel by subtracting the median intensity
within each run.</p>
<div class="sourceCode" id="cb19"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb19-1"><a href="statistical-analysis-with-msqrob2.html#cb19-1" tabindex="-1"></a>spikein <span class="ot">&lt;-</span> <span class="fu">normalize</span>(</span>
<span id="cb19-2"><a href="statistical-analysis-with-msqrob2.html#cb19-2" tabindex="-1"></a>    spikein, <span class="fu">paste0</span>(sNames, <span class="st">"_log"</span>), <span class="at">name =</span> <span class="fu">paste0</span>(sNames, <span class="st">"_norm"</span>),</span>
<span id="cb19-3"><a href="statistical-analysis-with-msqrob2.html#cb19-3" tabindex="-1"></a>    <span class="at">method =</span> <span class="st">"center.median"</span></span>
<span id="cb19-4"><a href="statistical-analysis-with-msqrob2.html#cb19-4" tabindex="-1"></a>)</span></code></pre></div>
</div>
<div id="summarisation" class="section level3" number="2.4.6">
<h3>
<span class="header-section-number">2.4.6</span> Summarisation<div class="tooltip"><button class="internal-link-btn" onclick="copy_link('summarisation')" onmouseout="reset_tooltip('summarisation-tooltip')"><span class="tooltiptext" id="summarisation-tooltip">Copy link</span><i class="fa fa-link"></i></button></div>
</h3>
<p>In case of the proteins models, we summarise (also referred to as
aggregation) the PSM-level data into protein intensities through
median polish.</p>
<div class="sourceCode" id="cb20"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb20-1"><a href="statistical-analysis-with-msqrob2.html#cb20-1" tabindex="-1"></a>spikein <span class="ot">&lt;-</span> <span class="fu">aggregateFeatures</span>(</span>
<span id="cb20-2"><a href="statistical-analysis-with-msqrob2.html#cb20-2" tabindex="-1"></a>    spikein, <span class="at">i =</span> <span class="fu">paste0</span>(sNames, <span class="st">"_norm"</span>), <span class="at">name =</span> <span class="fu">paste0</span>(sNames, <span class="st">"_proteins"</span>),</span>
<span id="cb20-3"><a href="statistical-analysis-with-msqrob2.html#cb20-3" tabindex="-1"></a>    <span class="at">fcol =</span> <span class="st">"Protein.Accessions"</span>, <span class="at">fun =</span> MsCoreUtils<span class="sc">::</span>medianPolish,</span>
<span id="cb20-4"><a href="statistical-analysis-with-msqrob2.html#cb20-4" tabindex="-1"></a>    <span class="at">na.rm =</span> <span class="cn">TRUE</span></span>
<span id="cb20-5"><a href="statistical-analysis-with-msqrob2.html#cb20-5" tabindex="-1"></a>)</span></code></pre></div>
</div>
<div id="join-assays" class="section level3" number="2.4.7">
<h3>
<span class="header-section-number">2.4.7</span> Join assays<div class="tooltip"><button class="internal-link-btn" onclick="copy_link('join-assays')" onmouseout="reset_tooltip('join-assays-tooltip')"><span class="tooltiptext" id="join-assays-tooltip">Copy link</span><i class="fa fa-link"></i></button></div>
</h3>
<p>Finally, we join the different runs into a single set for ions and for
proteins. Sets are joined by stacking the columns (samples) in a
matrix and rows (features) are matched by the row names. We will join
all log2-normalised ion data in one set and all protein data in
another. First, we need to redefine the rownames for the ion data
using the ion identifier.</p>
<div class="sourceCode" id="cb21"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb21-1"><a href="statistical-analysis-with-msqrob2.html#cb21-1" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="fu">paste0</span>(sNames, <span class="st">"_norm"</span>)) {</span>
<span id="cb21-2"><a href="statistical-analysis-with-msqrob2.html#cb21-2" tabindex="-1"></a>    <span class="fu">rownames</span>(spikein[[i]]) <span class="ot">&lt;-</span> <span class="fu">rowData</span>(spikein[[i]])<span class="sc">$</span>ionID</span>
<span id="cb21-3"><a href="statistical-analysis-with-msqrob2.html#cb21-3" tabindex="-1"></a>}</span></code></pre></div>
<p>We can now join the sets together.</p>
<div class="sourceCode" id="cb22"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb22-1"><a href="statistical-analysis-with-msqrob2.html#cb22-1" tabindex="-1"></a>spikein <span class="ot">&lt;-</span> <span class="fu">joinAssays</span>(spikein, <span class="fu">paste0</span>(sNames, <span class="st">"_norm"</span>), <span class="st">"ions"</span>)</span>
<span id="cb22-2"><a href="statistical-analysis-with-msqrob2.html#cb22-2" tabindex="-1"></a>spikein <span class="ot">&lt;-</span> <span class="fu">joinAssays</span>(spikein, <span class="fu">paste0</span>(sNames, <span class="st">"_proteins"</span>), <span class="st">"proteins"</span>)</span></code></pre></div>
</div>
</div>
<div id="modelling-sources-of-variation" class="section level2" number="2.5">
<h2>
<span class="header-section-number">2.5</span> Modelling sources of variation<div class="tooltip"><button class="internal-link-btn" onclick="copy_link('modelling-sources-of-variation')" onmouseout="reset_tooltip('modelling-sources-of-variation-tooltip')"><span class="tooltiptext" id="modelling-sources-of-variation-tooltip">Copy link</span><i class="fa fa-link"></i></button></div>
</h2>
<p>Proteomics data contain several sources of variation that need to be
accounted for by the model. The code below shows how to run the model
that accounts for all relevant sources of variation in the spike-in
experiment, which we have shown performs best in the Msqrob2TMT
<a href="http://dx.doi.org/10.1101/2024.03.29.587218">paper</a>.</p>
<div class="sourceCode" id="cb23"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb23-1"><a href="statistical-analysis-with-msqrob2.html#cb23-1" tabindex="-1"></a>spikein <span class="ot">&lt;-</span> <span class="fu">msqrobAggregate</span>(</span>
<span id="cb23-2"><a href="statistical-analysis-with-msqrob2.html#cb23-2" tabindex="-1"></a>    spikein,  <span class="at">i =</span> <span class="st">"ions"</span>,</span>
<span id="cb23-3"><a href="statistical-analysis-with-msqrob2.html#cb23-3" tabindex="-1"></a>    <span class="at">formula =</span> <span class="sc">~</span> <span class="dv">0</span> <span class="sc">+</span> Condition <span class="sc">+</span> <span class="do">## fixed effect for experimental condition</span></span>
<span id="cb23-4"><a href="statistical-analysis-with-msqrob2.html#cb23-4" tabindex="-1"></a>        <span class="co"># (1 | Channel) + ## random effect for channel</span></span>
<span id="cb23-5"><a href="statistical-analysis-with-msqrob2.html#cb23-5" tabindex="-1"></a>        (<span class="dv">1</span> <span class="sc">|</span> Mixture) <span class="sc">+</span> <span class="do">## random effect for mixture</span></span>
<span id="cb23-6"><a href="statistical-analysis-with-msqrob2.html#cb23-6" tabindex="-1"></a>        (<span class="dv">1</span> <span class="sc">|</span> Run) <span class="sc">+</span> <span class="do">## random effect for run</span></span>
<span id="cb23-7"><a href="statistical-analysis-with-msqrob2.html#cb23-7" tabindex="-1"></a>        (<span class="dv">1</span> <span class="sc">|</span> Run<span class="sc">:</span>Channel) <span class="sc">+</span> <span class="do">## random effect for PSMs for the same protein in a channel of a run</span></span>
<span id="cb23-8"><a href="statistical-analysis-with-msqrob2.html#cb23-8" tabindex="-1"></a>        (<span class="dv">1</span> <span class="sc">|</span> Run<span class="sc">:</span>ionID), <span class="do">## random effect for ions in the same spectrum of an MS run</span></span>
<span id="cb23-9"><a href="statistical-analysis-with-msqrob2.html#cb23-9" tabindex="-1"></a>    <span class="at">fcol =</span> <span class="st">"Protein.Accessions"</span>,</span>
<span id="cb23-10"><a href="statistical-analysis-with-msqrob2.html#cb23-10" tabindex="-1"></a>    <span class="at">modelColumnName =</span> <span class="st">"msqrob_psms_rrilm"</span>,</span>
<span id="cb23-11"><a href="statistical-analysis-with-msqrob2.html#cb23-11" tabindex="-1"></a>    <span class="at">robust =</span><span class="cn">TRUE</span>, <span class="at">ridge =</span> <span class="cn">TRUE</span></span>
<span id="cb23-12"><a href="statistical-analysis-with-msqrob2.html#cb23-12" tabindex="-1"></a>)</span></code></pre></div>
<p>Note, that we use an encoding without intercept <code>~ 0 +</code>.
This makes it more straightforward to define contrasts for one-way ANOVA designs with a treatment involving a single factor.
Indeed, by suppressing the intercept, a model parameters is estimated for each group.
Otherwise, <code>msqrob2</code> selects one of the groups as the reference group, for which its model parameter is absorbed in the intercept.</p>
<p>We will now build up the model by progressively adding the
different sources of variation.</p>
<div id="effect-of-treatment-of-interest" class="section level3" number="2.5.1">
<h3>
<span class="header-section-number">2.5.1</span> Effect of treatment of interest<div class="tooltip"><button class="internal-link-btn" onclick="copy_link('effect-of-treatment-of-interest')" onmouseout="reset_tooltip('effect-of-treatment-of-interest-tooltip')"><span class="tooltiptext" id="effect-of-treatment-of-interest-tooltip">Copy link</span><i class="fa fa-link"></i></button></div>
</h3>
<p>We model the source of variation induced by the experimental
treatment of interest as a fixed effect, which we consider non-random,
i.e. the treatment effect is assumed to be the same in repeated
experiments, but it is unknown and has to be estimated. When modelling
a typical label-free experiment at the protein level, the model boils
down to a linear model, again we suppress the index for protein:</p>
<p><span class="math display">\[
y_r = \mathbf{x}^T_r \boldsymbol{\beta} + \epsilon_r,
\]</span></p>
<p>with <span class="math inline">\(y_r\)</span> the <span class="math inline">\(\log_2\)</span>-normalized protein intensities in run r;
<span class="math inline">\(\mathbf{x}_r\)</span> a vector with the covariate pattern for the sample in
run <span class="math inline">\(r\)</span> encoding the intercept, treatment, potential batch effects and
confounders; <span class="math inline">\(\boldsymbol{\beta}\)</span> the vector of parameters that model the
association between the covariates and the outcome; and <span class="math inline">\(\epsilon_r\)</span>
the residuals reflecting variation that is not captured by the fixed
effects. Note that <span class="math inline">\(\mathbf{x}_r\)</span> allows for a flexible
parameterization of the treatment beyond a single covariate, i.e. including a 1 for the intercept,
continuous and categorical variables as well as their interactions.
For all models considered in this work, we assume the residuals to be
independent and identically distributed (i.i.d) according to a normal
distribution with zero mean and constant variance, i.e. <span class="math inline">\(\epsilon_{r}
\sim N(0,\sigma_\epsilon^2)\)</span>, that can differ from protein to protein.</p>
<p>Using <code>msqrob2</code>, the model translates into the following code:</p>
<div class="sourceCode" id="cb24"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb24-1"><a href="statistical-analysis-with-msqrob2.html#cb24-1" tabindex="-1"></a>spikein <span class="ot">&lt;-</span> <span class="fu">msqrob</span>(</span>
<span id="cb24-2"><a href="statistical-analysis-with-msqrob2.html#cb24-2" tabindex="-1"></a>    spikein,  <span class="at">i =</span> <span class="st">"proteins"</span>,</span>
<span id="cb24-3"><a href="statistical-analysis-with-msqrob2.html#cb24-3" tabindex="-1"></a>    <span class="at">formula =</span> <span class="sc">~</span>  <span class="dv">0</span> <span class="sc">+</span> Condition, <span class="do">## fixed effect for experimental condition</span></span>
<span id="cb24-4"><a href="statistical-analysis-with-msqrob2.html#cb24-4" tabindex="-1"></a>    <span class="at">robust =</span> <span class="cn">TRUE</span>, <span class="at">ridge =</span> <span class="cn">TRUE</span>,</span>
<span id="cb24-5"><a href="statistical-analysis-with-msqrob2.html#cb24-5" tabindex="-1"></a>    <span class="at">modelColumnName =</span> <span class="st">"msqrob_rrilm"</span></span>
<span id="cb24-6"><a href="statistical-analysis-with-msqrob2.html#cb24-6" tabindex="-1"></a>)</span></code></pre></div>
<p>The function takes the <code>QFeatures</code> object, extracts the quantitative
values from the <code>"proteins"</code> set generated during summarisation, and
fits a simple linear model with <code>Condition</code> as covariate, which is
automatically retrieved from <code>colData(spikein)</code>.
We also enabled M-estimation (<code>robust = TRUE</code>) for improved robustness against
outliers and ridge penalisation (<code>ridge = TRUE</code>) to stabilise the
parameter estimation. The fitting results are available in the
<code>msqrob_rrilm</code> column of the <code>rowData</code>. More specifically, the
function will store the modelling output for each protein in a
<code>statModel</code> object, which are then saved in the <code>rowData</code>, one model
per row. We will see in a later section how to perform statistical
inference on the estimated parameters</p>
<div class="sourceCode" id="cb25"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb25-1"><a href="statistical-analysis-with-msqrob2.html#cb25-1" tabindex="-1"></a>models <span class="ot">&lt;-</span> <span class="fu">rowData</span>(spikein[[<span class="st">"proteins"</span>]])[[<span class="st">"msqrob_rrilm"</span>]]</span>
<span id="cb25-2"><a href="statistical-analysis-with-msqrob2.html#cb25-2" tabindex="-1"></a>models[<span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>]</span></code></pre></div>
<p>Note, that we use an encoding without intercept <code>~ 0 +</code>.
This makes it more straightforward to define contrasts for one-way ANOVA designs with a treatment involving a single factor.
Indeed, by suppressing the intercept, a model parameters is estimated for each group.
Otherwise, <code>msqrob2</code> selects one of the groups as the reference group, for which its model parameter is absorbed in the intercept.</p>
</div>
<div id="effect-of-tmt-channel-and-run" class="section level3" number="2.5.2">
<h3>
<span class="header-section-number">2.5.2</span> Effect of TMT channel and run<div class="tooltip"><button class="internal-link-btn" onclick="copy_link('effect-of-tmt-channel-and-run')" onmouseout="reset_tooltip('effect-of-tmt-channel-and-run-tooltip')"><span class="tooltiptext" id="effect-of-tmt-channel-and-run-tooltip">Copy link</span><i class="fa fa-link"></i></button></div>
</h3>
<p>As label-free experiments contain only a single sample per run,
run-specific effects will be absorbed in the residuals. However, the
data analysis of labeled experiments, e.g. using TMT multiplexing,
involving multiple MS runs has to account for run- and label-specific
effects, explicitly. If all treatments are present in each run, and if
channel swaps are performed so as to avoid confounding between channel
and treatment, then the model parameters can be estimated using fixed
channel and run effects. Indeed, for these designs run acts as a
blocking variable as all treatment effects can be estimated within
each run.</p>
<p>However, for more complex designs this is no longer possible and the
uncertainty in the estimation of the mean model parameters can involve
both within and between channel and run variability. For these designs
we can resort to mixed models where the channel and run effect are
modelled using random effects, i.e. they are considered as a random
sample from the population of all possible runs (channel labels),
which are assumed to be i.i.d normally distributed with mean 0 and
constant variance, <span class="math inline">\(u_r \sim N(0,\sigma^{2,\text{run}})\)</span>
(<span class="math inline">\(u_{channel} \sim N(0,\sigma^{2,\text{channel}})\)</span>). The use of random
effects thus models the correlation in the data, explicitly. Indeed,
protein intensities that are measured within the same run (channel)
will be more similar than protein intensities between runs (channels).</p>
<p>Hence, the model is extended to:</p>
<p><span class="math display">\[
y_{rc} =
\mathbf{x}^T_{rc} \boldsymbol{\beta} + u_c^\text{channel} + u_r^\text{run} +
\epsilon_{rc}
\]</span>
with <span class="math inline">\(y_{rc}\)</span> the normalised <span class="math inline">\(\log_2\)</span> protein intensities in run <span class="math inline">\(r\)</span>
and channel <span class="math inline">\(c\)</span>, <span class="math inline">\(u_c^\text{channel}\)</span> the effect introduced by
the label of channel <span class="math inline">\(c\)</span>, and <span class="math inline">\(u_r^\text{run}\)</span> the effect for MS run
<span class="math inline">\(r\)</span>.</p>
<p>This translates in the following code:</p>
<div class="sourceCode" id="cb26"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb26-1"><a href="statistical-analysis-with-msqrob2.html#cb26-1" tabindex="-1"></a>spikein <span class="ot">&lt;-</span> <span class="fu">msqrob</span>(</span>
<span id="cb26-2"><a href="statistical-analysis-with-msqrob2.html#cb26-2" tabindex="-1"></a>    spikein,  <span class="at">i =</span> <span class="st">"proteins"</span>,</span>
<span id="cb26-3"><a href="statistical-analysis-with-msqrob2.html#cb26-3" tabindex="-1"></a>    <span class="at">formula =</span> <span class="sc">~</span>  <span class="dv">0</span> <span class="sc">+</span> Condition <span class="sc">+</span> <span class="do">## fixed effect for experimental condition</span></span>
<span id="cb26-4"><a href="statistical-analysis-with-msqrob2.html#cb26-4" tabindex="-1"></a>        <span class="co"># (1 | Channel) + ## random effect for channel</span></span>
<span id="cb26-5"><a href="statistical-analysis-with-msqrob2.html#cb26-5" tabindex="-1"></a>        (<span class="dv">1</span> <span class="sc">|</span> Run), <span class="do">## random effect for MS run</span></span>
<span id="cb26-6"><a href="statistical-analysis-with-msqrob2.html#cb26-6" tabindex="-1"></a>    <span class="at">robust =</span> <span class="cn">TRUE</span>, <span class="at">ridge =</span> <span class="cn">TRUE</span>,</span>
<span id="cb26-7"><a href="statistical-analysis-with-msqrob2.html#cb26-7" tabindex="-1"></a>    <span class="at">modelColumnName =</span> <span class="st">"msqrob_rrilmm"</span></span>
<span id="cb26-8"><a href="statistical-analysis-with-msqrob2.html#cb26-8" tabindex="-1"></a>    )</span></code></pre></div>
<p>Note here that we have commented out the random effect for channel. In
practice, normalisation already removes part of the channel effect and
is sufficient. You can experiment this yourself by removing the
comment sign <code>#</code> in front of <code>(1 | Channel) +</code> across the vignette,
and see how the results may change.</p>
</div>
<div id="effect-of-replication" class="section level3" number="2.5.3">
<h3>
<span class="header-section-number">2.5.3</span> Effect of replication<div class="tooltip"><button class="internal-link-btn" onclick="copy_link('effect-of-replication')" onmouseout="reset_tooltip('effect-of-replication-tooltip')"><span class="tooltiptext" id="effect-of-replication-tooltip">Copy link</span><i class="fa fa-link"></i></button></div>
</h3>
<p>Some experiments also include technical replication where a TMT
mixture can be acquired multiple times. This again will induce
correlation. Indeed, protein intensities from the same mixture will be
more alike than those of different mixtures. Hence, we also include a
random effect to account for this pseudo-replication, i.e.
<span class="math inline">\(u^\text{mix}_m \sim N(0, \sigma^{2,\text{mix}})\)</span>. The model thus
extends to:</p>
<p><span class="math display">\[
y_{rcm} =
\mathbf{x}^T_{rcm} \boldsymbol{\beta} +  u_{c}^\text{channel} +
u_r^\text{run} + u_m^\text{mix} + \epsilon_{rcm}
\]</span></p>
<p>with <span class="math inline">\(m\)</span> the index for mixture.</p>
<p>The model translates to the following code:</p>
<div class="sourceCode" id="cb27"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb27-1"><a href="statistical-analysis-with-msqrob2.html#cb27-1" tabindex="-1"></a>spikein <span class="ot">&lt;-</span> <span class="fu">msqrob</span>(</span>
<span id="cb27-2"><a href="statistical-analysis-with-msqrob2.html#cb27-2" tabindex="-1"></a>    spikein,  <span class="at">i =</span> <span class="st">"proteins"</span>,</span>
<span id="cb27-3"><a href="statistical-analysis-with-msqrob2.html#cb27-3" tabindex="-1"></a>    <span class="at">formula =</span> <span class="sc">~</span>  <span class="dv">0</span> <span class="sc">+</span> Condition <span class="sc">+</span> <span class="do">## fixed effect for experimental condition</span></span>
<span id="cb27-4"><a href="statistical-analysis-with-msqrob2.html#cb27-4" tabindex="-1"></a>        <span class="co"># (1 | Channel) + ## random effect for channel</span></span>
<span id="cb27-5"><a href="statistical-analysis-with-msqrob2.html#cb27-5" tabindex="-1"></a>        (<span class="dv">1</span> <span class="sc">|</span> Run) <span class="sc">+</span> <span class="do">## random effect for MS run</span></span>
<span id="cb27-6"><a href="statistical-analysis-with-msqrob2.html#cb27-6" tabindex="-1"></a>        (<span class="dv">1</span> <span class="sc">|</span> Mixture), <span class="do">## random effect for mixture</span></span>
<span id="cb27-7"><a href="statistical-analysis-with-msqrob2.html#cb27-7" tabindex="-1"></a>    <span class="at">robust =</span> <span class="cn">TRUE</span>, <span class="at">ridge =</span> <span class="cn">TRUE</span>,</span>
<span id="cb27-8"><a href="statistical-analysis-with-msqrob2.html#cb27-8" tabindex="-1"></a>    <span class="at">modelColumnName =</span> <span class="st">"msqrob_rrilmm"</span>,</span>
<span id="cb27-9"><a href="statistical-analysis-with-msqrob2.html#cb27-9" tabindex="-1"></a>    <span class="at">overwrite =</span> <span class="cn">TRUE</span></span>
<span id="cb27-10"><a href="statistical-analysis-with-msqrob2.html#cb27-10" tabindex="-1"></a>)</span></code></pre></div>
<p>We use <code>overwrite = TRUE</code> to overwrite the previous results in the
<code>rowData</code>.</p>
</div>
<div id="psm-level-modelling" class="section level3" number="2.5.4">
<h3>
<span class="header-section-number">2.5.4</span> PSM-level modelling<div class="tooltip"><button class="internal-link-btn" onclick="copy_link('psm-level-modelling')" onmouseout="reset_tooltip('psm-level-modelling-tooltip')"><span class="tooltiptext" id="psm-level-modelling-tooltip">Copy link</span><i class="fa fa-link"></i></button></div>
</h3>
<p>Above, we modelled the data at the protein level. However, we could
also directly estimate the treatment effect from PSM-level data. This
will again induce additional levels of correlation. Indeed, the
intensities for the different reporter ions in a TMT run within the
same spectrum (PSM) will be more similar than the intensities between
PSMs. We therefore need to add a random effect term to account for the
within PSM correlation structure, i.e. <span class="math inline">\(u^\text{PSM}_{rp} \sim
N(0,\sigma^{2,\text{PSM}})\)</span>. Moreover, in each channel of a run
multiple PSM intensities are picked up for each protein.
Hence, intensities from different PSMs for a protein in the same channel of a run will be more alike
than intensities of different PSMs for the same protein between
channels of runs, and we will address this correlation with a channel-specific
random effect nested in run, i.e. <span class="math inline">\(u_{rc}^{channel} \sim
N(0,\sigma^{2,\text{channel}})\)</span>. The model then becomes:</p>
<p><span class="math display">\[
y_{rcmp} =
\mathbf{x}^T_{rcmp} \beta + u_{c}^\text{channel} +
u_r^\text{run} + u_m^\text{mix}  +
u_{rc}^\text{channel} + u_{rp}^\text{PSM} + \epsilon_{rcmp}
\]</span>
with <span class="math inline">\(y_{rcmp}\)</span> the <span class="math inline">\(\log_2\)</span>-normalized PSM intensities for run <span class="math inline">\(r\)</span>
with label <span class="math inline">\(c\)</span> in mixture <span class="math inline">\(m\)</span> and peptide ion <span class="math inline">\(p\)</span>. Note, that the peptide ion random
effect is also nested within each run since each spectrum is described
by run-specific characteristics.</p>
<p>The model translates to the code below. Note that we here no longer
use <code>msqrob()</code>, but <code>msqrobAggregate()</code>. The latter will combine
annotations from the <code>colData</code> (i.e. <code>"Condition"</code>, <code>"Channel"</code>,
<code>"Run"</code>, <code>"Mixture"</code>) and from the <code>rowData</code> (i.e.
<code>"ionID"</code>). Moreover, we need to tell the function how the PSM-level
data is grouped to protein data through the <code>fcol</code> argument, here we
will group PSMs by the <code>Protein.Accessions</code>.</p>
<div class="sourceCode" id="cb28"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb28-1"><a href="statistical-analysis-with-msqrob2.html#cb28-1" tabindex="-1"></a>spikein <span class="ot">&lt;-</span> <span class="fu">msqrobAggregate</span>(</span>
<span id="cb28-2"><a href="statistical-analysis-with-msqrob2.html#cb28-2" tabindex="-1"></a>    spikein,  <span class="at">i =</span> <span class="st">"ions"</span>,</span>
<span id="cb28-3"><a href="statistical-analysis-with-msqrob2.html#cb28-3" tabindex="-1"></a>    <span class="at">formula =</span> <span class="sc">~</span>  <span class="dv">0</span> <span class="sc">+</span> Condition <span class="sc">+</span> <span class="do">## fixed effect for experimental condition</span></span>
<span id="cb28-4"><a href="statistical-analysis-with-msqrob2.html#cb28-4" tabindex="-1"></a>        <span class="co"># (1 | Channel) + ## random effect for channel</span></span>
<span id="cb28-5"><a href="statistical-analysis-with-msqrob2.html#cb28-5" tabindex="-1"></a>        (<span class="dv">1</span> <span class="sc">|</span> Run) <span class="sc">+</span> <span class="do">## random effect for Run</span></span>
<span id="cb28-6"><a href="statistical-analysis-with-msqrob2.html#cb28-6" tabindex="-1"></a>        (<span class="dv">1</span> <span class="sc">|</span> Mixture) <span class="sc">+</span> <span class="do">## random effect for mixture</span></span>
<span id="cb28-7"><a href="statistical-analysis-with-msqrob2.html#cb28-7" tabindex="-1"></a>        (<span class="dv">1</span> <span class="sc">|</span> Run<span class="sc">:</span>Channel) <span class="sc">+</span> <span class="do">## random effect for channel nested in run</span></span>
<span id="cb28-8"><a href="statistical-analysis-with-msqrob2.html#cb28-8" tabindex="-1"></a>        (<span class="dv">1</span> <span class="sc">|</span> Run<span class="sc">:</span>ionID), <span class="do">## random effect for ion nested in run</span></span>
<span id="cb28-9"><a href="statistical-analysis-with-msqrob2.html#cb28-9" tabindex="-1"></a>    <span class="at">fcol =</span> <span class="st">"Protein.Accessions"</span>,</span>
<span id="cb28-10"><a href="statistical-analysis-with-msqrob2.html#cb28-10" tabindex="-1"></a>    <span class="at">modelColumnName =</span> <span class="st">"msqrob_psm_rrilmm"</span>,</span>
<span id="cb28-11"><a href="statistical-analysis-with-msqrob2.html#cb28-11" tabindex="-1"></a>    <span class="at">name =</span> <span class="st">"proteins_msqrob"</span>,</span>
<span id="cb28-12"><a href="statistical-analysis-with-msqrob2.html#cb28-12" tabindex="-1"></a>    <span class="at">robust =</span> <span class="cn">TRUE</span>, <span class="at">ridge =</span> <span class="cn">TRUE</span></span>
<span id="cb28-13"><a href="statistical-analysis-with-msqrob2.html#cb28-13" tabindex="-1"></a>)</span></code></pre></div>
<p>So, we built the model shown at the beginning of this section,
effectively accounting for all sources of variation in TMT-based
proteomics data.</p>
</div>
</div>
<div id="statistical-inference" class="section level2" number="2.6">
<h2>
<span class="header-section-number">2.6</span> Statistical inference<div class="tooltip"><button class="internal-link-btn" onclick="copy_link('statistical-inference')" onmouseout="reset_tooltip('statistical-inference-tooltip')"><span class="tooltiptext" id="statistical-inference-tooltip">Copy link</span><i class="fa fa-link"></i></button></div>
</h2>
<p>Now we have modelled our data, we can use the model output to assess
the amplitude of an effect of interest and its statistical
significance.</p>
<div id="retrieving-results" class="section level3" number="2.6.1">
<h3>
<span class="header-section-number">2.6.1</span> Retrieving results<div class="tooltip"><button class="internal-link-btn" onclick="copy_link('retrieving-results')" onmouseout="reset_tooltip('retrieving-results-tooltip')"><span class="tooltiptext" id="retrieving-results-tooltip">Copy link</span><i class="fa fa-link"></i></button></div>
</h3>
<p>With <code>getCoef()</code>, we can retrieve the estimated model parameters. We
will focus on the last model as an illustration, but the same approach
applies for any model estimated by <code>msqrob()</code> or <code>msqrobAggregate()</code>.
We start with extracting the model output, stored as <code>StatModel</code>
objects, from the <code>rowData</code>. Next, <code>getCoef()</code> retrieves the estimated
model parameters:</p>
<div class="sourceCode" id="cb29"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb29-1"><a href="statistical-analysis-with-msqrob2.html#cb29-1" tabindex="-1"></a>models <span class="ot">&lt;-</span> <span class="fu">rowData</span>(spikein[[<span class="st">"proteins_msqrob"</span>]])<span class="sc">$</span>msqrob_psm_rrilmm</span>
<span id="cb29-2"><a href="statistical-analysis-with-msqrob2.html#cb29-2" tabindex="-1"></a>params <span class="ot">&lt;-</span> <span class="fu">getCoef</span>(models[[<span class="dv">1</span>]])</span>
<span id="cb29-3"><a href="statistical-analysis-with-msqrob2.html#cb29-3" tabindex="-1"></a><span class="fu">head</span>(params)</span></code></pre></div>
<p>The PSM model estimated parameters to model the
fixed and random effects. However, we are interested, for this data
set, in the parameters that model the effect of <code>Condition</code>.</p>
<div class="sourceCode" id="cb30"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb30-1"><a href="statistical-analysis-with-msqrob2.html#cb30-1" tabindex="-1"></a>params[<span class="fu">grep</span>(<span class="st">"Condition"</span>, <span class="fu">names</span>(params))]</span></code></pre></div>
<p>Note the <code>"ridge"</code> tag in front of the parameter names that indicates
the parameters have been estimated using ridge penalisation. For this
protein we can see that the effects of condition are very close to
zero, as expected since the protein is part of the HeLa background.
However, we can explore the parameters for one of the UPS proteins.</p>
<div class="sourceCode" id="cb31"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb31-1"><a href="statistical-analysis-with-msqrob2.html#cb31-1" tabindex="-1"></a>params <span class="ot">&lt;-</span> <span class="fu">getCoef</span>(models[[<span class="st">"O00762ups"</span>]])</span>
<span id="cb31-2"><a href="statistical-analysis-with-msqrob2.html#cb31-2" tabindex="-1"></a>params[<span class="fu">grep</span>(<span class="st">"Condition"</span>, <span class="fu">names</span>(params))]</span></code></pre></div>
<p>Let’s know verify the result provide the expected fold change. To do
so we define a contrast, that is a parameter combination that provide
an answer to the research question, for instance for the average
log2 difference in intensity between condition 1x and condition 0.5x.
Since this is a benchmark study, the obvious answer is <span class="math inline">\(log_2(1) -
log_2(0.5) = 1\)</span>.</p>
<div class="sourceCode" id="cb32"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb32-1"><a href="statistical-analysis-with-msqrob2.html#cb32-1" tabindex="-1"></a><span class="fu">unname</span>(params[<span class="st">"ridgeCondition1"</span>] <span class="sc">-</span> params[<span class="st">"ridgeCondition0.5"</span>])</span></code></pre></div>
<p>This value is close to the expected value. Now, the question is how
statistically significant is the estimated log2 fold change. <code>msqrob2</code> provides
a user friendly interface to allow computing contrast of interest and
performing statistical inference. We first define the contrast using
<code>makeContrast()</code>. The first argument is the null hypothesis to test,
here that the average difference between condition 1x and 0.5x is 0.
The second argument points to the parameters that are involved to
perform the test.</p>
<div class="sourceCode" id="cb33"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb33-1"><a href="statistical-analysis-with-msqrob2.html#cb33-1" tabindex="-1"></a>(L <span class="ot">&lt;-</span> <span class="fu">makeContrast</span>(</span>
<span id="cb33-2"><a href="statistical-analysis-with-msqrob2.html#cb33-2" tabindex="-1"></a>    <span class="st">"ridgeCondition1 - ridgeCondition0.5 = 0"</span>,</span>
<span id="cb33-3"><a href="statistical-analysis-with-msqrob2.html#cb33-3" tabindex="-1"></a>    <span class="fu">c</span>(<span class="st">"ridgeCondition1"</span>, <span class="st">"ridgeCondition0.5"</span>)</span>
<span id="cb33-4"><a href="statistical-analysis-with-msqrob2.html#cb33-4" tabindex="-1"></a>))</span></code></pre></div>
<p>We can now test our null hypothesis using <code>hypothesisTest()</code> which
takes the <code>QFeatures</code> object with the fitted model and the contrast we
just built. Again, the results are stored in the set containing the
model, here <code>proteins_msqrob</code></p>
<div class="sourceCode" id="cb34"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb34-1"><a href="statistical-analysis-with-msqrob2.html#cb34-1" tabindex="-1"></a>spikein <span class="ot">&lt;-</span> <span class="fu">hypothesisTest</span>(</span>
<span id="cb34-2"><a href="statistical-analysis-with-msqrob2.html#cb34-2" tabindex="-1"></a>    spikein, <span class="at">i =</span> <span class="st">"proteins_msqrob"</span>, <span class="at">contrast =</span> L,</span>
<span id="cb34-3"><a href="statistical-analysis-with-msqrob2.html#cb34-3" tabindex="-1"></a>    <span class="at">modelColumn =</span> <span class="st">"msqrob_psm_rrilmm"</span></span>
<span id="cb34-4"><a href="statistical-analysis-with-msqrob2.html#cb34-4" tabindex="-1"></a>)</span></code></pre></div>
<p>Let’s retrieve the results from the <code>rowData</code>.</p>
<div class="sourceCode" id="cb35"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb35-1"><a href="statistical-analysis-with-msqrob2.html#cb35-1" tabindex="-1"></a>htest <span class="ot">&lt;-</span> <span class="fu">rowData</span>(spikein[[<span class="st">"proteins_msqrob"</span>]])<span class="sc">$</span><span class="st">"ridgeCondition1 - ridgeCondition0.5"</span></span>
<span id="cb35-2"><a href="statistical-analysis-with-msqrob2.html#cb35-2" tabindex="-1"></a><span class="fu">head</span>(htest)</span></code></pre></div>
<p>The last row is filled with missing values because data modelling
resulted in a <code>fitError</code>. We will explore in a later section how we
can deal with proteins that could not be fit.</p>
</div>
<div id="volcano-plots" class="section level3" number="2.6.2">
<h3>
<span class="header-section-number">2.6.2</span> Volcano plots<div class="tooltip"><button class="internal-link-btn" onclick="copy_link('volcano-plots')" onmouseout="reset_tooltip('volcano-plots-tooltip')"><span class="tooltiptext" id="volcano-plots-tooltip">Copy link</span><i class="fa fa-link"></i></button></div>
</h3>
<p>We can use the table above directly to build a volcano plot using
<code>ggplot2</code> functionality. We also highlight which proteins are UPS
standards, known from the experimental design to be differentially
abundant.</p>
<div class="sourceCode" id="cb36"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb36-1"><a href="statistical-analysis-with-msqrob2.html#cb36-1" tabindex="-1"></a>htest<span class="sc">$</span>protein <span class="ot">&lt;-</span> <span class="fu">rownames</span>(htest)</span>
<span id="cb36-2"><a href="statistical-analysis-with-msqrob2.html#cb36-2" tabindex="-1"></a>htest<span class="sc">$</span>isUps <span class="ot">&lt;-</span> <span class="fu">grepl</span>(<span class="st">"ups"</span>, htest<span class="sc">$</span>protein)</span>
<span id="cb36-3"><a href="statistical-analysis-with-msqrob2.html#cb36-3" tabindex="-1"></a><span class="fu">ggplot</span>(htest) <span class="sc">+</span></span>
<span id="cb36-4"><a href="statistical-analysis-with-msqrob2.html#cb36-4" tabindex="-1"></a>    <span class="fu">aes</span>(<span class="at">x =</span> logFC,</span>
<span id="cb36-5"><a href="statistical-analysis-with-msqrob2.html#cb36-5" tabindex="-1"></a>        <span class="at">y =</span> <span class="sc">-</span><span class="fu">log10</span>(adjPval),</span>
<span id="cb36-6"><a href="statistical-analysis-with-msqrob2.html#cb36-6" tabindex="-1"></a>        <span class="at">color =</span> isUps) <span class="sc">+</span></span>
<span id="cb36-7"><a href="statistical-analysis-with-msqrob2.html#cb36-7" tabindex="-1"></a>    <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="sc">-</span><span class="fu">log10</span>(<span class="fl">0.05</span>)) <span class="sc">+</span></span>
<span id="cb36-8"><a href="statistical-analysis-with-msqrob2.html#cb36-8" tabindex="-1"></a>    <span class="fu">geom_point</span>() <span class="sc">+</span></span>
<span id="cb36-9"><a href="statistical-analysis-with-msqrob2.html#cb36-9" tabindex="-1"></a>    <span class="fu">scale_color_manual</span>(</span>
<span id="cb36-10"><a href="statistical-analysis-with-msqrob2.html#cb36-10" tabindex="-1"></a>        <span class="at">values =</span> <span class="fu">c</span>(<span class="st">"grey20"</span>, <span class="st">"firebrick"</span>), <span class="at">name =</span> <span class="st">""</span>,</span>
<span id="cb36-11"><a href="statistical-analysis-with-msqrob2.html#cb36-11" tabindex="-1"></a>        <span class="at">labels =</span> <span class="fu">c</span>(<span class="st">"HeLA background"</span>, <span class="st">"UPS standard"</span>)</span>
<span id="cb36-12"><a href="statistical-analysis-with-msqrob2.html#cb36-12" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb36-13"><a href="statistical-analysis-with-msqrob2.html#cb36-13" tabindex="-1"></a>    <span class="fu">ggtitle</span>(<span class="st">"msqrob_psm_rrilm model"</span>,</span>
<span id="cb36-14"><a href="statistical-analysis-with-msqrob2.html#cb36-14" tabindex="-1"></a>            <span class="st">"Hypothesis test: Condition 1x - 0.5x = 0"</span>)</span></code></pre></div>
</div>
<div id="fold-change-distributions" class="section level3" number="2.6.3">
<h3>
<span class="header-section-number">2.6.3</span> Fold change distributions<div class="tooltip"><button class="internal-link-btn" onclick="copy_link('fold-change-distributions')" onmouseout="reset_tooltip('fold-change-distributions-tooltip')"><span class="tooltiptext" id="fold-change-distributions-tooltip">Copy link</span><i class="fa fa-link"></i></button></div>
</h3>
<p>As this is a spike-in study with known ground truth, we can also plot
the log2 fold change distributions against the expected values, in
this case 0 for the HeLa proteins and 1 for the UPS standards.</p>
<div class="sourceCode" id="cb37"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb37-1"><a href="statistical-analysis-with-msqrob2.html#cb37-1" tabindex="-1"></a><span class="fu">ggplot</span>(htest) <span class="sc">+</span></span>
<span id="cb37-2"><a href="statistical-analysis-with-msqrob2.html#cb37-2" tabindex="-1"></a>    <span class="fu">aes</span>(<span class="at">y =</span> logFC,</span>
<span id="cb37-3"><a href="statistical-analysis-with-msqrob2.html#cb37-3" tabindex="-1"></a>        <span class="at">x =</span> isUps,</span>
<span id="cb37-4"><a href="statistical-analysis-with-msqrob2.html#cb37-4" tabindex="-1"></a>        <span class="at">colour =</span> isUps) <span class="sc">+</span></span>
<span id="cb37-5"><a href="statistical-analysis-with-msqrob2.html#cb37-5" tabindex="-1"></a>    <span class="fu">geom_boxplot</span>() <span class="sc">+</span></span>
<span id="cb37-6"><a href="statistical-analysis-with-msqrob2.html#cb37-6" tabindex="-1"></a>    <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">1</span>), <span class="at">colour =</span> <span class="fu">c</span>(<span class="st">"grey20"</span>, <span class="st">"firebrick"</span>)) <span class="sc">+</span></span>
<span id="cb37-7"><a href="statistical-analysis-with-msqrob2.html#cb37-7" tabindex="-1"></a>    <span class="fu">scale_color_manual</span>(</span>
<span id="cb37-8"><a href="statistical-analysis-with-msqrob2.html#cb37-8" tabindex="-1"></a>        <span class="at">values =</span> <span class="fu">c</span>(<span class="st">"grey20"</span>, <span class="st">"firebrick"</span>), <span class="at">name =</span> <span class="st">""</span>,</span>
<span id="cb37-9"><a href="statistical-analysis-with-msqrob2.html#cb37-9" tabindex="-1"></a>        <span class="at">labels =</span> <span class="fu">c</span>(<span class="st">"HeLA background"</span>, <span class="st">"UPS standard"</span>)</span>
<span id="cb37-10"><a href="statistical-analysis-with-msqrob2.html#cb37-10" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb37-11"><a href="statistical-analysis-with-msqrob2.html#cb37-11" tabindex="-1"></a>    <span class="fu">ggtitle</span>(<span class="st">"Distribution of the log2 fold changes"</span>,</span>
<span id="cb37-12"><a href="statistical-analysis-with-msqrob2.html#cb37-12" tabindex="-1"></a>            <span class="st">"Hypothesis test: Condition 1x - 0.5x = 0"</span>)</span></code></pre></div>
<p>Estimated log2 fold change for HeLa proteins are closely distributed
around 0, as expected. log2 fold changes for UPS standard proteins are
distributed toward 1, although it is underestimated as reported
previously (<a href="https://doi.org/10.1021/ac201760x">Savitski et al.
2011</a>).</p>
</div>
<div id="visual-validation" class="section level3" number="2.6.4">
<h3>
<span class="header-section-number">2.6.4</span> Visual validation<div class="tooltip"><button class="internal-link-btn" onclick="copy_link('visual-validation')" onmouseout="reset_tooltip('visual-validation-tooltip')"><span class="tooltiptext" id="visual-validation-tooltip">Copy link</span><i class="fa fa-link"></i></button></div>
</h3>
<p>We can explore the PSM intensities for a protein to validate the
statistical inference results. For example, let’s explore the
intensities for the protein with the most significant difference.</p>
<div class="sourceCode" id="cb38"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb38-1"><a href="statistical-analysis-with-msqrob2.html#cb38-1" tabindex="-1"></a>(targetProtein <span class="ot">&lt;-</span> <span class="fu">rownames</span>(htest)[<span class="fu">which.min</span>(htest<span class="sc">$</span>adjPval)])</span></code></pre></div>
<p>To obtain the required data, we perform a little data manipulation
pipeline:</p>
<ol style="list-style-type: decimal">
<li>We use the <code>QFeatures</code> subsetting functionality to retrieve all data
related to and focusing on the <code>ions</code> set that
contains the peptide ion data used for model fitting.</li>
<li>We use <code>longFormat()</code> to convert the object into a table suitable for
plotting.</li>
<li>We remove missing values for plotting.</li>
<li>We reorder the sample identifiers to improve visualisation.</li>
</ol>
<div class="sourceCode" id="cb39"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb39-1"><a href="statistical-analysis-with-msqrob2.html#cb39-1" tabindex="-1"></a>ionData <span class="ot">&lt;-</span> spikein[targetProtein, , <span class="st">"ions"</span>] <span class="sc">|&gt;</span> <span class="co">#1</span></span>
<span id="cb39-2"><a href="statistical-analysis-with-msqrob2.html#cb39-2" tabindex="-1"></a>    <span class="fu">longFormat</span>(<span class="at">colvars =</span> <span class="fu">colnames</span>(<span class="fu">colData</span>(spikein)), <span class="co">#2</span></span>
<span id="cb39-3"><a href="statistical-analysis-with-msqrob2.html#cb39-3" tabindex="-1"></a>               <span class="at">rowvars =</span> <span class="fu">c</span>(<span class="st">"Protein.Accessions"</span>, <span class="st">"ionID"</span>)) <span class="sc">|&gt;</span></span>
<span id="cb39-4"><a href="statistical-analysis-with-msqrob2.html#cb39-4" tabindex="-1"></a>    <span class="fu">data.frame</span>() <span class="sc">|&gt;</span></span>
<span id="cb39-5"><a href="statistical-analysis-with-msqrob2.html#cb39-5" tabindex="-1"></a>    <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(value)) <span class="sc">|&gt;</span> <span class="co">#3</span></span>
<span id="cb39-6"><a href="statistical-analysis-with-msqrob2.html#cb39-6" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">colname =</span> <span class="fu">factor</span>(colname, <span class="at">levels =</span> <span class="fu">unique</span>(colname[<span class="fu">order</span>(Condition)]))) <span class="co">#4</span></span></code></pre></div>
<p>Finally, we plot the log2 normalised intensities for each sample.
Since the protein is modelled at the peptide ion level, multiple ion
intensities are recorded in each sample. Each ion is linked across
samples using a grey line. Samples are colored according to UPS
spike-in condition. Finally, we split the plot in facets, one for each
mixture, to visualise the heterogeneity induced by sample preparation.</p>
<div class="sourceCode" id="cb40"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb40-1"><a href="statistical-analysis-with-msqrob2.html#cb40-1" tabindex="-1"></a><span class="fu">ggplot</span>(ionData) <span class="sc">+</span></span>
<span id="cb40-2"><a href="statistical-analysis-with-msqrob2.html#cb40-2" tabindex="-1"></a>    <span class="fu">aes</span>(<span class="at">x =</span> colname,</span>
<span id="cb40-3"><a href="statistical-analysis-with-msqrob2.html#cb40-3" tabindex="-1"></a>        <span class="at">y =</span> value) <span class="sc">+</span></span>
<span id="cb40-4"><a href="statistical-analysis-with-msqrob2.html#cb40-4" tabindex="-1"></a>    <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">group =</span> ionID), <span class="at">linewidth =</span> <span class="fl">0.1</span>) <span class="sc">+</span></span>
<span id="cb40-5"><a href="statistical-analysis-with-msqrob2.html#cb40-5" tabindex="-1"></a>    <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">colour =</span> Condition)) <span class="sc">+</span></span>
<span id="cb40-6"><a href="statistical-analysis-with-msqrob2.html#cb40-6" tabindex="-1"></a>    <span class="fu">facet_grid</span>(<span class="sc">~</span> Mixture, <span class="at">scales =</span> <span class="st">"free"</span>) <span class="sc">+</span></span>
<span id="cb40-7"><a href="statistical-analysis-with-msqrob2.html#cb40-7" tabindex="-1"></a>    <span class="fu">ggtitle</span>(targetProtein) <span class="sc">+</span></span>
<span id="cb40-8"><a href="statistical-analysis-with-msqrob2.html#cb40-8" tabindex="-1"></a>    <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb40-9"><a href="statistical-analysis-with-msqrob2.html#cb40-9" tabindex="-1"></a>    <span class="fu">theme</span>(<span class="at">axis.text.x =</span> <span class="fu">element_blank</span>())</span></code></pre></div>
</div>
</div>
<div id="protein-level-models" class="section level2" number="2.7">
<h2>
<span class="header-section-number">2.7</span> Protein-level models<div class="tooltip"><button class="internal-link-btn" onclick="copy_link('protein-level-models')" onmouseout="reset_tooltip('protein-level-models-tooltip')"><span class="tooltiptext" id="protein-level-models-tooltip">Copy link</span><i class="fa fa-link"></i></button></div>
</h2>
<p>Performing the statistical inference for summarisation-based models,
hence modelling protein-level data, is very similar as for the
PSM-based models shown above. Let’s apply the same statistical
inference pipeline for the <code>msqrob_rrilmm</code> model stored in the
<code>QFeatures</code> object.</p>
<div class="sourceCode" id="cb41"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb41-1"><a href="statistical-analysis-with-msqrob2.html#cb41-1" tabindex="-1"></a>L <span class="ot">&lt;-</span> <span class="fu">makeContrast</span>(</span>
<span id="cb41-2"><a href="statistical-analysis-with-msqrob2.html#cb41-2" tabindex="-1"></a>    <span class="st">"ridgeCondition1 - ridgeCondition0.5 = 0"</span>,</span>
<span id="cb41-3"><a href="statistical-analysis-with-msqrob2.html#cb41-3" tabindex="-1"></a>    <span class="fu">c</span>(<span class="st">"ridgeCondition1"</span>, <span class="st">"ridgeCondition0.5"</span>)</span>
<span id="cb41-4"><a href="statistical-analysis-with-msqrob2.html#cb41-4" tabindex="-1"></a>)</span>
<span id="cb41-5"><a href="statistical-analysis-with-msqrob2.html#cb41-5" tabindex="-1"></a>spikein <span class="ot">&lt;-</span> <span class="fu">hypothesisTest</span>(</span>
<span id="cb41-6"><a href="statistical-analysis-with-msqrob2.html#cb41-6" tabindex="-1"></a>    spikein, <span class="at">i =</span> <span class="st">"proteins"</span>, <span class="at">contrast =</span> L,</span>
<span id="cb41-7"><a href="statistical-analysis-with-msqrob2.html#cb41-7" tabindex="-1"></a>    <span class="at">modelColumn =</span> <span class="st">"msqrob_rrilmm"</span></span>
<span id="cb41-8"><a href="statistical-analysis-with-msqrob2.html#cb41-8" tabindex="-1"></a>)</span>
<span id="cb41-9"><a href="statistical-analysis-with-msqrob2.html#cb41-9" tabindex="-1"></a>htestProt <span class="ot">&lt;-</span> <span class="fu">rowData</span>(spikein[[<span class="st">"proteins"</span>]])<span class="sc">$</span><span class="st">"ridgeCondition1 - ridgeCondition0.5"</span></span></code></pre></div>
<p>We build the volcano using the same code:</p>
<div class="sourceCode" id="cb42"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb42-1"><a href="statistical-analysis-with-msqrob2.html#cb42-1" tabindex="-1"></a>htestProt<span class="sc">$</span>protein <span class="ot">&lt;-</span> <span class="fu">rownames</span>(htestProt)</span>
<span id="cb42-2"><a href="statistical-analysis-with-msqrob2.html#cb42-2" tabindex="-1"></a>htestProt<span class="sc">$</span>isUps <span class="ot">&lt;-</span> <span class="fu">grepl</span>(<span class="st">"ups"</span>, htestProt<span class="sc">$</span>protein)</span>
<span id="cb42-3"><a href="statistical-analysis-with-msqrob2.html#cb42-3" tabindex="-1"></a><span class="fu">ggplot</span>(htestProt) <span class="sc">+</span></span>
<span id="cb42-4"><a href="statistical-analysis-with-msqrob2.html#cb42-4" tabindex="-1"></a>    <span class="fu">aes</span>(<span class="at">x =</span> logFC,</span>
<span id="cb42-5"><a href="statistical-analysis-with-msqrob2.html#cb42-5" tabindex="-1"></a>        <span class="at">y =</span> <span class="sc">-</span><span class="fu">log10</span>(adjPval),</span>
<span id="cb42-6"><a href="statistical-analysis-with-msqrob2.html#cb42-6" tabindex="-1"></a>        <span class="at">color =</span> isUps) <span class="sc">+</span></span>
<span id="cb42-7"><a href="statistical-analysis-with-msqrob2.html#cb42-7" tabindex="-1"></a>    <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="sc">-</span><span class="fu">log10</span>(<span class="fl">0.05</span>)) <span class="sc">+</span></span>
<span id="cb42-8"><a href="statistical-analysis-with-msqrob2.html#cb42-8" tabindex="-1"></a>    <span class="fu">geom_point</span>() <span class="sc">+</span></span>
<span id="cb42-9"><a href="statistical-analysis-with-msqrob2.html#cb42-9" tabindex="-1"></a>    <span class="fu">scale_color_manual</span>(</span>
<span id="cb42-10"><a href="statistical-analysis-with-msqrob2.html#cb42-10" tabindex="-1"></a>        <span class="at">values =</span> <span class="fu">c</span>(<span class="st">"grey20"</span>, <span class="st">"firebrick"</span>), <span class="at">name =</span> <span class="st">""</span>,</span>
<span id="cb42-11"><a href="statistical-analysis-with-msqrob2.html#cb42-11" tabindex="-1"></a>        <span class="at">labels =</span> <span class="fu">c</span>(<span class="st">"HeLA background"</span>, <span class="st">"UPS standard"</span>)</span>
<span id="cb42-12"><a href="statistical-analysis-with-msqrob2.html#cb42-12" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb42-13"><a href="statistical-analysis-with-msqrob2.html#cb42-13" tabindex="-1"></a>    <span class="fu">ggtitle</span>(<span class="st">"msqrob_rrilm model"</span>,</span>
<span id="cb42-14"><a href="statistical-analysis-with-msqrob2.html#cb42-14" tabindex="-1"></a>            <span class="st">"Hypothesis test: Condition 1x - 0.5x = 0</span><span class="sc">\n</span><span class="st">Protein-level modelling"</span>)</span></code></pre></div>
<p>We plot the fold change distributions:</p>
<div class="sourceCode" id="cb43"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb43-1"><a href="statistical-analysis-with-msqrob2.html#cb43-1" tabindex="-1"></a><span class="fu">ggplot</span>(htestProt) <span class="sc">+</span></span>
<span id="cb43-2"><a href="statistical-analysis-with-msqrob2.html#cb43-2" tabindex="-1"></a>    <span class="fu">aes</span>(<span class="at">y =</span> logFC,</span>
<span id="cb43-3"><a href="statistical-analysis-with-msqrob2.html#cb43-3" tabindex="-1"></a>        <span class="at">x =</span> isUps,</span>
<span id="cb43-4"><a href="statistical-analysis-with-msqrob2.html#cb43-4" tabindex="-1"></a>        <span class="at">colour =</span> isUps) <span class="sc">+</span></span>
<span id="cb43-5"><a href="statistical-analysis-with-msqrob2.html#cb43-5" tabindex="-1"></a>    <span class="fu">geom_boxplot</span>() <span class="sc">+</span></span>
<span id="cb43-6"><a href="statistical-analysis-with-msqrob2.html#cb43-6" tabindex="-1"></a>    <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">1</span>), <span class="at">colour =</span> <span class="fu">c</span>(<span class="st">"grey20"</span>, <span class="st">"firebrick"</span>)) <span class="sc">+</span></span>
<span id="cb43-7"><a href="statistical-analysis-with-msqrob2.html#cb43-7" tabindex="-1"></a>    <span class="fu">scale_color_manual</span>(</span>
<span id="cb43-8"><a href="statistical-analysis-with-msqrob2.html#cb43-8" tabindex="-1"></a>        <span class="at">values =</span> <span class="fu">c</span>(<span class="st">"grey20"</span>, <span class="st">"firebrick"</span>), <span class="at">name =</span> <span class="st">""</span>,</span>
<span id="cb43-9"><a href="statistical-analysis-with-msqrob2.html#cb43-9" tabindex="-1"></a>        <span class="at">labels =</span> <span class="fu">c</span>(<span class="st">"HeLA background"</span>, <span class="st">"UPS standard"</span>)</span>
<span id="cb43-10"><a href="statistical-analysis-with-msqrob2.html#cb43-10" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb43-11"><a href="statistical-analysis-with-msqrob2.html#cb43-11" tabindex="-1"></a>    <span class="fu">ggtitle</span>(<span class="st">"Distribution of the log2 fold changes"</span>,</span>
<span id="cb43-12"><a href="statistical-analysis-with-msqrob2.html#cb43-12" tabindex="-1"></a>            <span class="st">"Hypothesis test: Condition 1x - 0.5x = 0</span><span class="sc">\n</span><span class="st">Protein-level modelling"</span>)</span></code></pre></div>
<p>Exploring the intensities at the protein level is simplified compared
to PSM-level exploration since every sample now contains a single
observation, the protein intensity.</p>
<div class="sourceCode" id="cb44"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb44-1"><a href="statistical-analysis-with-msqrob2.html#cb44-1" tabindex="-1"></a><span class="fu">data.frame</span>(<span class="at">intensity =</span> <span class="fu">assay</span>(spikein[[<span class="st">"proteins"</span>]])[targetProtein, ],</span>
<span id="cb44-2"><a href="statistical-analysis-with-msqrob2.html#cb44-2" tabindex="-1"></a>           <span class="fu">colData</span>(spikein),</span>
<span id="cb44-3"><a href="statistical-analysis-with-msqrob2.html#cb44-3" tabindex="-1"></a>           <span class="at">colname =</span> <span class="fu">colnames</span>(spikein[[<span class="st">"proteins"</span>]])) <span class="sc">|&gt;</span></span>
<span id="cb44-4"><a href="statistical-analysis-with-msqrob2.html#cb44-4" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">colname =</span> <span class="fu">factor</span>(colname, <span class="at">levels =</span> <span class="fu">unique</span>(colname[<span class="fu">order</span>(Condition)]))) <span class="sc">|&gt;</span></span>
<span id="cb44-5"><a href="statistical-analysis-with-msqrob2.html#cb44-5" tabindex="-1"></a>    <span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb44-6"><a href="statistical-analysis-with-msqrob2.html#cb44-6" tabindex="-1"></a>    <span class="fu">aes</span>(<span class="at">x =</span> colname,</span>
<span id="cb44-7"><a href="statistical-analysis-with-msqrob2.html#cb44-7" tabindex="-1"></a>        <span class="at">y =</span> intensity) <span class="sc">+</span></span>
<span id="cb44-8"><a href="statistical-analysis-with-msqrob2.html#cb44-8" tabindex="-1"></a>    <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">colour =</span> Condition)) <span class="sc">+</span></span>
<span id="cb44-9"><a href="statistical-analysis-with-msqrob2.html#cb44-9" tabindex="-1"></a>    <span class="fu">facet_grid</span>(<span class="sc">~</span> Mixture, <span class="at">scales =</span> <span class="st">"free"</span>) <span class="sc">+</span></span>
<span id="cb44-10"><a href="statistical-analysis-with-msqrob2.html#cb44-10" tabindex="-1"></a>    <span class="fu">ggtitle</span>(targetProtein) <span class="sc">+</span></span>
<span id="cb44-11"><a href="statistical-analysis-with-msqrob2.html#cb44-11" tabindex="-1"></a>    <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb44-12"><a href="statistical-analysis-with-msqrob2.html#cb44-12" tabindex="-1"></a>    <span class="fu">theme</span>(<span class="at">axis.text.x =</span> <span class="fu">element_blank</span>())</span></code></pre></div>
<p>Notice how the summarisation-based approach hides the variation
associated with the measurement of different peptide ions within the
same protein, as well as discrepancies between peptide identification
rates across mixtures.</p>
<div id="inference-for-all-pairwise-comparisons-between-conditions" class="section level3" number="2.7.1">
<h3>
<span class="header-section-number">2.7.1</span> Inference for all pairwise comparisons between conditions<div class="tooltip"><button class="internal-link-btn" onclick="copy_link('inference-for-all-pairwise-comparisons-between-conditions')" onmouseout="reset_tooltip('inference-for-all-pairwise-comparisons-between-conditions-tooltip')"><span class="tooltiptext" id="inference-for-all-pairwise-comparisons-between-conditions-tooltip">Copy link</span><i class="fa fa-link"></i></button></div>
</h3>
<p>For a factor variable, we often want to infer on all pairwise
comparisons between the groups. Note, that our models have a fixed
effect component that consist of a single factor and that we have
chosen to suppress the intercept. <code>msqrob2</code> therefore returned models
with a separate model parameter to estimate the mean for every group.</p>
<div class="sourceCode" id="cb45"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb45-1"><a href="statistical-analysis-with-msqrob2.html#cb45-1" tabindex="-1"></a>design_fixed  <span class="ot">&lt;-</span> <span class="fu">model.matrix</span>(<span class="sc">~</span> <span class="dv">0</span> <span class="sc">+</span> Condition, <span class="fu">colData</span>(spikein))</span>
<span id="cb45-2"><a href="statistical-analysis-with-msqrob2.html#cb45-2" tabindex="-1"></a>(param_names_fixed <span class="ot">&lt;-</span> <span class="fu">colnames</span>(design_fixed))</span></code></pre></div>
<p>If we use ridge regression, <code>msqrob2</code> by default will put the prefix
<code>ridge</code> to the parameter names of the fixed effects.</p>
<div class="sourceCode" id="cb46"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb46-1"><a href="statistical-analysis-with-msqrob2.html#cb46-1" tabindex="-1"></a>(param_names_fixed <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">"ridge"</span>, param_names_fixed))</span></code></pre></div>
<p>We now make all pairwise contrasts. The function <code>combn()</code> can make all
combinations of a vector and we apply the function <code>paste()</code> with the
argument <code>collapse = " - "</code> to these combinations. This makes a vector
of strings specifying all contrasts of interest. Upon pasting “= 0”
to each of the contrasts, all null hypotheses corresponding to the
pairwise comparisons are specified.</p>
<p>Note, that we first sort the parameter names in decreasing order to
ensure that a positive log2 fold change estimate refers to an
upregulation in the highest spike-in condition involved in the
comparison.</p>
<div class="sourceCode" id="cb47"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb47-1"><a href="statistical-analysis-with-msqrob2.html#cb47-1" tabindex="-1"></a>(hypotheses <span class="ot">&lt;-</span> param_names_fixed <span class="sc">|&gt;</span></span>
<span id="cb47-2"><a href="statistical-analysis-with-msqrob2.html#cb47-2" tabindex="-1"></a>     <span class="fu">sort</span>(<span class="at">decreasing =</span> <span class="cn">TRUE</span>) <span class="sc">|&gt;</span></span>
<span id="cb47-3"><a href="statistical-analysis-with-msqrob2.html#cb47-3" tabindex="-1"></a>     <span class="fu">combn</span>(<span class="dv">2</span>, paste, <span class="at">collapse=</span><span class="st">" - "</span>) <span class="sc">|&gt;</span></span>
<span id="cb47-4"><a href="statistical-analysis-with-msqrob2.html#cb47-4" tabindex="-1"></a>     <span class="fu">paste</span>(<span class="st">"= 0"</span>))</span></code></pre></div>
<p>We now have specified the null hypotheses for all pairwise contrasts
of interest. Below, we will generate the contrast matrix for these six
contrasts.</p>
<div class="sourceCode" id="cb48"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb48-1"><a href="statistical-analysis-with-msqrob2.html#cb48-1" tabindex="-1"></a>(L <span class="ot">&lt;-</span> <span class="fu">makeContrast</span>(hypotheses, <span class="at">parameterNames =</span> param_names_fixed))</span></code></pre></div>
<p>The next step is to perform hypothesis tests for each contrast</p>
<div class="sourceCode" id="cb49"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb49-1"><a href="statistical-analysis-with-msqrob2.html#cb49-1" tabindex="-1"></a>spikein <span class="ot">&lt;-</span> <span class="fu">hypothesisTest</span>(</span>
<span id="cb49-2"><a href="statistical-analysis-with-msqrob2.html#cb49-2" tabindex="-1"></a>    spikein, <span class="at">i =</span> <span class="st">"proteins_msqrob"</span>,</span>
<span id="cb49-3"><a href="statistical-analysis-with-msqrob2.html#cb49-3" tabindex="-1"></a>    <span class="at">contrast =</span> L,</span>
<span id="cb49-4"><a href="statistical-analysis-with-msqrob2.html#cb49-4" tabindex="-1"></a>    <span class="at">modelColumn =</span> <span class="st">"msqrob_psm_rrilmm"</span>,</span>
<span id="cb49-5"><a href="statistical-analysis-with-msqrob2.html#cb49-5" tabindex="-1"></a>    <span class="at">overwrite =</span> <span class="cn">TRUE</span></span>
<span id="cb49-6"><a href="statistical-analysis-with-msqrob2.html#cb49-6" tabindex="-1"></a>)</span></code></pre></div>
<p>Six columns have been added to the row data, one for each contrast.</p>
<div class="sourceCode" id="cb50"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb50-1"><a href="statistical-analysis-with-msqrob2.html#cb50-1" tabindex="-1"></a><span class="fu">colnames</span>(<span class="fu">rowData</span>(spikein[[<span class="st">"proteins_msqrob"</span>]]))</span></code></pre></div>
<p>The results of contrast <code>"ridgeCondition1 - ridgeCondition0.5"</code> can be
retrieved as follows.</p>
<div class="sourceCode" id="cb51"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb51-1"><a href="statistical-analysis-with-msqrob2.html#cb51-1" tabindex="-1"></a><span class="fu">head</span>(<span class="fu">rowData</span>(spikein[[<span class="st">"proteins_msqrob"</span>]])[,<span class="st">"ridgeCondition1 - ridgeCondition0.5"</span>])</span></code></pre></div>
<p>Note, the we can use the same code to perform the hypothesis tests and
extract the results for the protein-level model.</p>
<div class="sourceCode" id="cb52"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb52-1"><a href="statistical-analysis-with-msqrob2.html#cb52-1" tabindex="-1"></a>spikein <span class="ot">&lt;-</span> <span class="fu">hypothesisTest</span>(</span>
<span id="cb52-2"><a href="statistical-analysis-with-msqrob2.html#cb52-2" tabindex="-1"></a>    spikein, <span class="at">i =</span> <span class="st">"proteins"</span>,</span>
<span id="cb52-3"><a href="statistical-analysis-with-msqrob2.html#cb52-3" tabindex="-1"></a>    <span class="at">contrast =</span> L,</span>
<span id="cb52-4"><a href="statistical-analysis-with-msqrob2.html#cb52-4" tabindex="-1"></a>    <span class="at">modelColumn =</span> <span class="st">"msqrob_rrilmm"</span>,</span>
<span id="cb52-5"><a href="statistical-analysis-with-msqrob2.html#cb52-5" tabindex="-1"></a>    <span class="at">overwrite =</span> <span class="cn">TRUE</span></span>
<span id="cb52-6"><a href="statistical-analysis-with-msqrob2.html#cb52-6" tabindex="-1"></a>)</span></code></pre></div>
<div class="sourceCode" id="cb53"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb53-1"><a href="statistical-analysis-with-msqrob2.html#cb53-1" tabindex="-1"></a><span class="fu">head</span>(<span class="fu">rowData</span>(spikein[[<span class="st">"proteins"</span>]])[,<span class="st">"ridgeCondition1 - ridgeCondition0.5"</span>])</span></code></pre></div>
</div>
</div>
<div id="dealing-with-fiterrors" class="section level2" number="2.8">
<h2>
<span class="header-section-number">2.8</span> Dealing with <code>fitErrors</code>
<div class="tooltip"><button class="internal-link-btn" onclick="copy_link('dealing-with-fiterrors')" onmouseout="reset_tooltip('dealing-with-fiterrors-tooltip')"><span class="tooltiptext" id="dealing-with-fiterrors-tooltip">Copy link</span><i class="fa fa-link"></i></button></div>
</h2>
<p>Missing value patterns in the data may lead to non-estimable
parameters. This is recognised by <code>msqrob2</code> and will lead to
<code>fitError</code>s which is a type of model output where the model could not
be fit. This information is available from the <code>StatModel</code> objects.</p>
<div class="sourceCode" id="cb54"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb54-1"><a href="statistical-analysis-with-msqrob2.html#cb54-1" tabindex="-1"></a><span class="fu">rowData</span>(spikein[[<span class="st">"proteins_msqrob"</span>]])[[<span class="st">"msqrob_psm_rrilmm"</span>]] <span class="sc">|&gt;</span></span>
<span id="cb54-2"><a href="statistical-analysis-with-msqrob2.html#cb54-2" tabindex="-1"></a>    <span class="fu">sapply</span>(<span class="cf">function</span>(x) x<span class="sc">@</span>type) <span class="sc">|&gt;</span></span>
<span id="cb54-3"><a href="statistical-analysis-with-msqrob2.html#cb54-3" tabindex="-1"></a>    <span class="fu">table</span>()</span></code></pre></div>
<p>We suggest 3 strategies for dealing with these <code>fitError</code>s.</p>
<div id="removing-the-random-effect-of-sample" class="section level3" number="2.8.1">
<h3>
<span class="header-section-number">2.8.1</span> Removing the random effect of sample<div class="tooltip"><button class="internal-link-btn" onclick="copy_link('removing-the-random-effect-of-sample')" onmouseout="reset_tooltip('removing-the-random-effect-of-sample-tooltip')"><span class="tooltiptext" id="removing-the-random-effect-of-sample-tooltip">Copy link</span><i class="fa fa-link"></i></button></div>
</h3>
<p>This strategy only applies for PSM-level models. Some proteins are
difficult to detect and may be quantified by a single peptide ion
species. In these cases, every sample contains a single observation
for the protein and hence no random effect of <code>Run:Channel</code> can be
estimated. While the results for such one-hit wonders are
questionable, we provide <code>msqrobRefit()</code> to refit a new model for a
subset of proteins of interest.</p>
<p><strong>Work in progress</strong>: we plan to include soon the function to perform
the refitting in <code>msqrob2</code>. Below, you can find a prototype of such
functionality. See <code>?msqrobAggregate</code> for documentation of the
arguments.</p>
<div class="sourceCode" id="cb55"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb55-1"><a href="statistical-analysis-with-msqrob2.html#cb55-1" tabindex="-1"></a>msqrobRefit <span class="ot">&lt;-</span> <span class="cf">function</span>(object, formula, i, subset, fcol, name,</span>
<span id="cb55-2"><a href="statistical-analysis-with-msqrob2.html#cb55-2" tabindex="-1"></a>                        modelColumnName, ...) {</span>
<span id="cb55-3"><a href="statistical-analysis-with-msqrob2.html#cb55-3" tabindex="-1"></a>    seti <span class="ot">&lt;-</span> <span class="fu">getWithColData</span>(object, i)</span>
<span id="cb55-4"><a href="statistical-analysis-with-msqrob2.html#cb55-4" tabindex="-1"></a>    setj <span class="ot">&lt;-</span> <span class="fu">getWithColData</span>(object, name)</span>
<span id="cb55-5"><a href="statistical-analysis-with-msqrob2.html#cb55-5" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">any</span>(<span class="sc">!</span>subset <span class="sc">%in%</span> <span class="fu">rowData</span>(seti)[[fcol]]))</span>
<span id="cb55-6"><a href="statistical-analysis-with-msqrob2.html#cb55-6" tabindex="-1"></a>        <span class="fu">stop</span>(<span class="st">"Some entries in 'subset' not found in '"</span>, fcol,</span>
<span id="cb55-7"><a href="statistical-analysis-with-msqrob2.html#cb55-7" tabindex="-1"></a>             <span class="st">"' (rowData of set '"</span>, i, <span class="st">"')"</span>)</span>
<span id="cb55-8"><a href="statistical-analysis-with-msqrob2.html#cb55-8" tabindex="-1"></a>    setjRefit <span class="ot">&lt;-</span> <span class="fu">msqrobAggregate</span>(</span>
<span id="cb55-9"><a href="statistical-analysis-with-msqrob2.html#cb55-9" tabindex="-1"></a>        seti[<span class="fu">rowData</span>(seti)[[fcol]] <span class="sc">%in%</span> subset, ],</span>
<span id="cb55-10"><a href="statistical-analysis-with-msqrob2.html#cb55-10" tabindex="-1"></a>        <span class="at">formula =</span> formula, <span class="at">fcol =</span> fcol, <span class="at">modelColumnName =</span> modelColumnName,</span>
<span id="cb55-11"><a href="statistical-analysis-with-msqrob2.html#cb55-11" tabindex="-1"></a>        ...</span>
<span id="cb55-12"><a href="statistical-analysis-with-msqrob2.html#cb55-12" tabindex="-1"></a>    )</span>
<span id="cb55-13"><a href="statistical-analysis-with-msqrob2.html#cb55-13" tabindex="-1"></a>    <span class="fu">rowData</span>(setj)[[modelColumnName]][subset] <span class="ot">&lt;-</span></span>
<span id="cb55-14"><a href="statistical-analysis-with-msqrob2.html#cb55-14" tabindex="-1"></a>        <span class="fu">rowData</span>(setjRefit)[[modelColumnName]][subset]</span>
<span id="cb55-15"><a href="statistical-analysis-with-msqrob2.html#cb55-15" tabindex="-1"></a>    modelsNew <span class="ot">&lt;-</span> <span class="fu">rowData</span>(setj)[[modelColumnName]]</span>
<span id="cb55-16"><a href="statistical-analysis-with-msqrob2.html#cb55-16" tabindex="-1"></a>    hlp <span class="ot">&lt;-</span> limma<span class="sc">::</span><span class="fu">squeezeVar</span>(</span>
<span id="cb55-17"><a href="statistical-analysis-with-msqrob2.html#cb55-17" tabindex="-1"></a>        <span class="at">var =</span> <span class="fu">vapply</span>(modelsNew, getVar, <span class="fu">numeric</span>(<span class="dv">1</span>)),</span>
<span id="cb55-18"><a href="statistical-analysis-with-msqrob2.html#cb55-18" tabindex="-1"></a>        <span class="at">df =</span> <span class="fu">vapply</span>(modelsNew, getDF, <span class="fu">numeric</span>(<span class="dv">1</span>))</span>
<span id="cb55-19"><a href="statistical-analysis-with-msqrob2.html#cb55-19" tabindex="-1"></a>    )</span>
<span id="cb55-20"><a href="statistical-analysis-with-msqrob2.html#cb55-20" tabindex="-1"></a>    <span class="cf">for</span> (ii <span class="cf">in</span> <span class="fu">seq_along</span>(modelsNew)) {</span>
<span id="cb55-21"><a href="statistical-analysis-with-msqrob2.html#cb55-21" tabindex="-1"></a>        modelsNew[[ii]]<span class="sc">@</span>varPosterior <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(hlp<span class="sc">$</span>var.post[ii])</span>
<span id="cb55-22"><a href="statistical-analysis-with-msqrob2.html#cb55-22" tabindex="-1"></a>        modelsNew[[ii]]<span class="sc">@</span>dfPosterior <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(hlp<span class="sc">$</span>df.prior <span class="sc">+</span> <span class="fu">getDF</span>(modelsNew[[ii]]))</span>
<span id="cb55-23"><a href="statistical-analysis-with-msqrob2.html#cb55-23" tabindex="-1"></a>    }</span>
<span id="cb55-24"><a href="statistical-analysis-with-msqrob2.html#cb55-24" tabindex="-1"></a>    <span class="fu">rowData</span>(object[[name]])[[modelColumnName]] <span class="ot">&lt;-</span> modelsNew</span>
<span id="cb55-25"><a href="statistical-analysis-with-msqrob2.html#cb55-25" tabindex="-1"></a>    object</span>
<span id="cb55-26"><a href="statistical-analysis-with-msqrob2.html#cb55-26" tabindex="-1"></a>}</span></code></pre></div>
<p>In this case, we want to refit a model without a sample effect for
one-hit-wonder proteins. This information can be retrieved from the
aggregation results, using <code>aggcounts()</code>. This getter function
provides the number of features used when performing summarisation for
each protein in each sample.</p>
<div class="sourceCode" id="cb56"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb56-1"><a href="statistical-analysis-with-msqrob2.html#cb56-1" tabindex="-1"></a>counts <span class="ot">&lt;-</span> <span class="fu">aggcounts</span>(spikein[[<span class="st">"proteins_msqrob"</span>]])</span>
<span id="cb56-2"><a href="statistical-analysis-with-msqrob2.html#cb56-2" tabindex="-1"></a>counts[<span class="dv">1</span><span class="sc">:</span><span class="dv">5</span>, <span class="dv">1</span><span class="sc">:</span><span class="dv">5</span>]</span></code></pre></div>
<p>One-hit wonder proteins are proteins for which the number of feature
used for summarisation does not exceed 1 peptide ion across samples.</p>
<div class="sourceCode" id="cb57"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb57-1"><a href="statistical-analysis-with-msqrob2.html#cb57-1" tabindex="-1"></a>oneHitProteins <span class="ot">&lt;-</span> <span class="fu">rownames</span>(counts)[<span class="fu">rowMax</span>(counts) <span class="sc">==</span> <span class="dv">1</span>]</span></code></pre></div>
<p>Using <code>msqrobRefit()</code> is very similar to <code>msqrobAggregate()</code>, see here
however that we adapted the formula to remove the random effect for
channel nested within run. We also mention which proteins must be
refit using the <code>subset</code> argument.</p>
<div class="sourceCode" id="cb58"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb58-1"><a href="statistical-analysis-with-msqrob2.html#cb58-1" tabindex="-1"></a>spikein <span class="ot">&lt;-</span> <span class="fu">msqrobRefit</span>(</span>
<span id="cb58-2"><a href="statistical-analysis-with-msqrob2.html#cb58-2" tabindex="-1"></a>    spikein, <span class="at">i =</span> <span class="st">"ions"</span>,</span>
<span id="cb58-3"><a href="statistical-analysis-with-msqrob2.html#cb58-3" tabindex="-1"></a>    <span class="at">subset =</span> oneHitProteins,</span>
<span id="cb58-4"><a href="statistical-analysis-with-msqrob2.html#cb58-4" tabindex="-1"></a>    <span class="at">formula =</span> <span class="sc">~</span> <span class="dv">0</span> <span class="sc">+</span> Condition <span class="sc">+</span> <span class="do">## fixed effect for experimental condition</span></span>
<span id="cb58-5"><a href="statistical-analysis-with-msqrob2.html#cb58-5" tabindex="-1"></a>        <span class="co"># (1 | Channel) + ## fixed effect for channel</span></span>
<span id="cb58-6"><a href="statistical-analysis-with-msqrob2.html#cb58-6" tabindex="-1"></a>        (<span class="dv">1</span> <span class="sc">|</span> Mixture) <span class="sc">+</span> <span class="do">## random effect for mixture</span></span>
<span id="cb58-7"><a href="statistical-analysis-with-msqrob2.html#cb58-7" tabindex="-1"></a>        (<span class="dv">1</span> <span class="sc">|</span> Run ) <span class="sc">+</span> <span class="do">## random effect for run</span></span>
<span id="cb58-8"><a href="statistical-analysis-with-msqrob2.html#cb58-8" tabindex="-1"></a>        (<span class="dv">1</span> <span class="sc">|</span> Run<span class="sc">:</span>ionID), <span class="do">## random effect for PSM nested in MS run</span></span>
<span id="cb58-9"><a href="statistical-analysis-with-msqrob2.html#cb58-9" tabindex="-1"></a>        <span class="do">## random effect for channel nested in run has been removed</span></span>
<span id="cb58-10"><a href="statistical-analysis-with-msqrob2.html#cb58-10" tabindex="-1"></a>    <span class="at">fcol =</span> <span class="st">"Protein.Accessions"</span>,</span>
<span id="cb58-11"><a href="statistical-analysis-with-msqrob2.html#cb58-11" tabindex="-1"></a>    <span class="at">modelColumnName =</span> <span class="st">"msqrob_psm_rrilmm"</span>,</span>
<span id="cb58-12"><a href="statistical-analysis-with-msqrob2.html#cb58-12" tabindex="-1"></a>    <span class="at">name =</span> <span class="st">"proteins_msqrob"</span>,</span>
<span id="cb58-13"><a href="statistical-analysis-with-msqrob2.html#cb58-13" tabindex="-1"></a>    <span class="at">robust =</span> <span class="cn">TRUE</span>, <span class="at">ridge =</span> <span class="cn">TRUE</span></span>
<span id="cb58-14"><a href="statistical-analysis-with-msqrob2.html#cb58-14" tabindex="-1"></a>)</span></code></pre></div>
<p>Let’s see how removing the random effect of channel within run for one-hit-wonder proteins reduced the number of <code>fitError</code>s.</p>
<div class="sourceCode" id="cb59"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb59-1"><a href="statistical-analysis-with-msqrob2.html#cb59-1" tabindex="-1"></a>fitTypes <span class="ot">&lt;-</span> <span class="fu">rowData</span>(spikein[[<span class="st">"proteins_msqrob"</span>]])[[<span class="st">"msqrob_psm_rrilmm"</span>]] <span class="sc">|&gt;</span></span>
<span id="cb59-2"><a href="statistical-analysis-with-msqrob2.html#cb59-2" tabindex="-1"></a>    <span class="fu">sapply</span>(<span class="cf">function</span>(x) x<span class="sc">@</span>type)</span>
<span id="cb59-3"><a href="statistical-analysis-with-msqrob2.html#cb59-3" tabindex="-1"></a><span class="fu">table</span>(fitTypes)</span></code></pre></div>
</div>
<div id="manual-inspection" class="section level3" number="2.8.2">
<h3>
<span class="header-section-number">2.8.2</span> Manual inspection<div class="tooltip"><button class="internal-link-btn" onclick="copy_link('manual-inspection')" onmouseout="reset_tooltip('manual-inspection-tooltip')"><span class="tooltiptext" id="manual-inspection-tooltip">Copy link</span><i class="fa fa-link"></i></button></div>
</h3>
<p>One protein is still non-estimable upon refitting and requires
additional data exploration to understand why the model cannot be
estimated. Let us take the protein that cannot be fitted.</p>
<div class="sourceCode" id="cb60"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb60-1"><a href="statistical-analysis-with-msqrob2.html#cb60-1" tabindex="-1"></a>proteinError <span class="ot">&lt;-</span> <span class="fu">names</span>(fitTypes[fitTypes <span class="sc">==</span> <span class="st">"fitError"</span>])[[<span class="dv">1</span>]]</span></code></pre></div>
<p>To understand the problem, we plot the data for that protein using
the same <code>QFeatures</code> pipeline described above.</p>
<div class="sourceCode" id="cb61"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb61-1"><a href="statistical-analysis-with-msqrob2.html#cb61-1" tabindex="-1"></a>ionData <span class="ot">&lt;-</span> spikein[proteinError, , <span class="st">"ions"</span>] <span class="sc">|&gt;</span></span>
<span id="cb61-2"><a href="statistical-analysis-with-msqrob2.html#cb61-2" tabindex="-1"></a>    <span class="fu">longFormat</span>(<span class="at">colvars =</span> <span class="fu">colnames</span>(<span class="fu">colData</span>(spikein)),</span>
<span id="cb61-3"><a href="statistical-analysis-with-msqrob2.html#cb61-3" tabindex="-1"></a>               <span class="at">rowvars =</span> <span class="fu">c</span>(<span class="st">"Protein.Accessions"</span>, <span class="st">"ionID"</span>)) <span class="sc">|&gt;</span></span>
<span id="cb61-4"><a href="statistical-analysis-with-msqrob2.html#cb61-4" tabindex="-1"></a>    <span class="fu">data.frame</span>() <span class="sc">|&gt;</span></span>
<span id="cb61-5"><a href="statistical-analysis-with-msqrob2.html#cb61-5" tabindex="-1"></a>    <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(value)) <span class="sc">|&gt;</span></span>
<span id="cb61-6"><a href="statistical-analysis-with-msqrob2.html#cb61-6" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">colname =</span> <span class="fu">factor</span>(colname, <span class="at">levels =</span> <span class="fu">unique</span>(colname[<span class="fu">order</span>(Condition)]))) <span class="co">#4</span></span></code></pre></div>
<p>Hence, we here plot the data in function of the <code>Channel</code>
(x-axis), <code>Condition</code> (colour) and <code>Mixture</code> (shape).</p>
<div class="sourceCode" id="cb62"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb62-1"><a href="statistical-analysis-with-msqrob2.html#cb62-1" tabindex="-1"></a><span class="fu">ggplot</span>(ionData) <span class="sc">+</span></span>
<span id="cb62-2"><a href="statistical-analysis-with-msqrob2.html#cb62-2" tabindex="-1"></a>    <span class="fu">aes</span>(<span class="at">x =</span> colname,</span>
<span id="cb62-3"><a href="statistical-analysis-with-msqrob2.html#cb62-3" tabindex="-1"></a>        <span class="at">y =</span> value) <span class="sc">+</span></span>
<span id="cb62-4"><a href="statistical-analysis-with-msqrob2.html#cb62-4" tabindex="-1"></a>    <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">colour =</span> Condition)) <span class="sc">+</span></span>
<span id="cb62-5"><a href="statistical-analysis-with-msqrob2.html#cb62-5" tabindex="-1"></a>    <span class="fu">facet_grid</span>(<span class="sc">~</span> Mixture, <span class="at">scales =</span> <span class="st">"free"</span>) <span class="sc">+</span></span>
<span id="cb62-6"><a href="statistical-analysis-with-msqrob2.html#cb62-6" tabindex="-1"></a>    <span class="fu">ggtitle</span>(targetProtein) <span class="sc">+</span></span>
<span id="cb62-7"><a href="statistical-analysis-with-msqrob2.html#cb62-7" tabindex="-1"></a>    <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb62-8"><a href="statistical-analysis-with-msqrob2.html#cb62-8" tabindex="-1"></a>    <span class="fu">theme</span>(<span class="at">axis.text.x =</span> <span class="fu">element_blank</span>())</span></code></pre></div>
<p>We can immediately spot that PSM intensities are only present in
mixture 3. Hence, the mixed model cannot be fitted with a random
effect for mixture. A solution would be drop the random effect for
mixture, provided that a data analysis expert and/or a field
specialist deems it reasonable. This requires expert intervention to
simplify the model definition based on the available data set so as to
provide valid statistical inference on the research hypotheses.</p>
<p><code>msqrob2</code> flags these problematic proteins instead of defining ad-hoc
heuristics, avoiding potentially misleading conclusions. The expert
can then decide to refit a simpler model using <code>msqrobRefit()</code>.</p>
<p>Note, that the same approach can be applied for summarisation-based
models that start from protein data.</p>
<div class="sourceCode" id="cb63"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb63-1"><a href="statistical-analysis-with-msqrob2.html#cb63-1" tabindex="-1"></a>se <span class="ot">&lt;-</span> <span class="fu">getWithColData</span>(spikein, <span class="st">"proteins"</span>)</span>
<span id="cb63-2"><a href="statistical-analysis-with-msqrob2.html#cb63-2" tabindex="-1"></a><span class="fu">data.frame</span>(<span class="at">intensity =</span> <span class="fu">assay</span>(se)[proteinError, ],</span>
<span id="cb63-3"><a href="statistical-analysis-with-msqrob2.html#cb63-3" tabindex="-1"></a>           <span class="fu">colData</span>(spikein),</span>
<span id="cb63-4"><a href="statistical-analysis-with-msqrob2.html#cb63-4" tabindex="-1"></a>           <span class="at">colname =</span> <span class="fu">colnames</span>(se)) <span class="sc">|&gt;</span></span>
<span id="cb63-5"><a href="statistical-analysis-with-msqrob2.html#cb63-5" tabindex="-1"></a>    <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(intensity)) <span class="sc">|&gt;</span></span>
<span id="cb63-6"><a href="statistical-analysis-with-msqrob2.html#cb63-6" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">colname =</span> <span class="fu">factor</span>(colname, <span class="at">levels =</span> <span class="fu">unique</span>(colname[<span class="fu">order</span>(Condition)]))) <span class="sc">|&gt;</span></span>
<span id="cb63-7"><a href="statistical-analysis-with-msqrob2.html#cb63-7" tabindex="-1"></a>    <span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb63-8"><a href="statistical-analysis-with-msqrob2.html#cb63-8" tabindex="-1"></a>    <span class="fu">aes</span>(<span class="at">x =</span> colname,</span>
<span id="cb63-9"><a href="statistical-analysis-with-msqrob2.html#cb63-9" tabindex="-1"></a>        <span class="at">y =</span> intensity) <span class="sc">+</span></span>
<span id="cb63-10"><a href="statistical-analysis-with-msqrob2.html#cb63-10" tabindex="-1"></a>    <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">colour =</span> Condition)) <span class="sc">+</span></span>
<span id="cb63-11"><a href="statistical-analysis-with-msqrob2.html#cb63-11" tabindex="-1"></a>    <span class="fu">facet_grid</span>(<span class="sc">~</span> Mixture, <span class="at">scales =</span> <span class="st">"free"</span>) <span class="sc">+</span></span>
<span id="cb63-12"><a href="statistical-analysis-with-msqrob2.html#cb63-12" tabindex="-1"></a>    <span class="fu">ggtitle</span>(proteinError, <span class="st">"associated to a fitError</span><span class="sc">\n</span><span class="st">Summarised protein intensities (median polish)"</span>) <span class="sc">+</span></span>
<span id="cb63-13"><a href="statistical-analysis-with-msqrob2.html#cb63-13" tabindex="-1"></a>    <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb63-14"><a href="statistical-analysis-with-msqrob2.html#cb63-14" tabindex="-1"></a>    <span class="fu">theme</span>(<span class="at">axis.text.x =</span> <span class="fu">element_blank</span>())</span></code></pre></div>
<p>The same conclusion applies as for the PSM-level data. In fact, this
is the same plot as above since the protein is also a one-hit wonder,
what seriously questions the reliability of the data for protein. This
example illustrates the relevance of <code>msqrob2</code> to safeguard against
automatic model simplification that may be otherwise fall unnoticed by
the user.</p>
</div>
<div id="imputation" class="section level3" number="2.8.3">
<h3>
<span class="header-section-number">2.8.3</span> Imputation<div class="tooltip"><button class="internal-link-btn" onclick="copy_link('imputation')" onmouseout="reset_tooltip('imputation-tooltip')"><span class="tooltiptext" id="imputation-tooltip">Copy link</span><i class="fa fa-link"></i></button></div>
</h3>
<p>The last strategy to deal with fit errors is to impute missing values
so that all models can be estimated. <code>QFeatures</code> provides a large
panel of imputation strategies through <code>impute()</code>. Identifying which
imputation strategy is most suited for this data set is outside the
scope of this vignette, and we here arbitrarily decide to use KNN
imputation.</p>
<div class="sourceCode" id="cb64"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb64-1"><a href="statistical-analysis-with-msqrob2.html#cb64-1" tabindex="-1"></a>(spikein <span class="ot">&lt;-</span> <span class="fu">impute</span>(</span>
<span id="cb64-2"><a href="statistical-analysis-with-msqrob2.html#cb64-2" tabindex="-1"></a>    spikein, <span class="at">i =</span> <span class="st">"ions"</span>, <span class="at">name =</span> <span class="st">"ions_imputed"</span>,</span>
<span id="cb64-3"><a href="statistical-analysis-with-msqrob2.html#cb64-3" tabindex="-1"></a>    <span class="at">method =</span> <span class="st">"knn"</span>, <span class="at">colmax =</span> <span class="dv">1</span></span>
<span id="cb64-4"><a href="statistical-analysis-with-msqrob2.html#cb64-4" tabindex="-1"></a>))</span></code></pre></div>
<p>The function added a new set <code>ions_imputed</code> which we can use to fit
the PSM model.</p>
<div class="sourceCode" id="cb65"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb65-1"><a href="statistical-analysis-with-msqrob2.html#cb65-1" tabindex="-1"></a>spikein <span class="ot">&lt;-</span> <span class="fu">msqrobAggregate</span>(</span>
<span id="cb65-2"><a href="statistical-analysis-with-msqrob2.html#cb65-2" tabindex="-1"></a>    spikein,  <span class="at">i =</span> <span class="st">"ions_imputed"</span>,</span>
<span id="cb65-3"><a href="statistical-analysis-with-msqrob2.html#cb65-3" tabindex="-1"></a>    <span class="at">formula =</span> <span class="sc">~</span> <span class="dv">0</span> <span class="sc">+</span> Condition <span class="sc">+</span> <span class="do">## fixed effect for experimental condition</span></span>
<span id="cb65-4"><a href="statistical-analysis-with-msqrob2.html#cb65-4" tabindex="-1"></a>        <span class="co"># (1 | Channel) + ## random effect for channel</span></span>
<span id="cb65-5"><a href="statistical-analysis-with-msqrob2.html#cb65-5" tabindex="-1"></a>        (<span class="dv">1</span> <span class="sc">|</span> Mixture) <span class="sc">+</span> <span class="do">## random effect for mixture</span></span>
<span id="cb65-6"><a href="statistical-analysis-with-msqrob2.html#cb65-6" tabindex="-1"></a>        (<span class="dv">1</span> <span class="sc">|</span> Run) <span class="sc">+</span> <span class="do">## random effect for run</span></span>
<span id="cb65-7"><a href="statistical-analysis-with-msqrob2.html#cb65-7" tabindex="-1"></a>        (<span class="dv">1</span> <span class="sc">|</span> Run<span class="sc">:</span>Channel) <span class="sc">+</span> <span class="do">## random effect for PSMs from the same protein in a channel of a run</span></span>
<span id="cb65-8"><a href="statistical-analysis-with-msqrob2.html#cb65-8" tabindex="-1"></a>        (<span class="dv">1</span> <span class="sc">|</span> Run<span class="sc">:</span>ionID), <span class="do">## random effect for ions in the same spectrum of an MS run</span></span>
<span id="cb65-9"><a href="statistical-analysis-with-msqrob2.html#cb65-9" tabindex="-1"></a>    <span class="at">fcol =</span> <span class="st">"Protein.Accessions"</span>,</span>
<span id="cb65-10"><a href="statistical-analysis-with-msqrob2.html#cb65-10" tabindex="-1"></a>    <span class="at">modelColumnName =</span> <span class="st">"msqrob_psm_rrilmm"</span>,</span>
<span id="cb65-11"><a href="statistical-analysis-with-msqrob2.html#cb65-11" tabindex="-1"></a>    <span class="at">name =</span> <span class="st">"proteins_msqrob_imputed"</span>,</span>
<span id="cb65-12"><a href="statistical-analysis-with-msqrob2.html#cb65-12" tabindex="-1"></a>    <span class="at">robust =</span> <span class="cn">TRUE</span>, <span class="at">ridge =</span> <span class="cn">TRUE</span></span>
<span id="cb65-13"><a href="statistical-analysis-with-msqrob2.html#cb65-13" tabindex="-1"></a>)</span></code></pre></div>
<p>We here assess how many models have been estimated for all proteins
upon imputation.</p>
<div class="sourceCode" id="cb66"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb66-1"><a href="statistical-analysis-with-msqrob2.html#cb66-1" tabindex="-1"></a><span class="fu">rowData</span>(spikein[[<span class="st">"proteins_msqrob_imputed"</span>]])[[<span class="st">"msqrob_psm_rrilmm"</span>]] <span class="sc">|&gt;</span></span>
<span id="cb66-2"><a href="statistical-analysis-with-msqrob2.html#cb66-2" tabindex="-1"></a>    <span class="fu">sapply</span>(<span class="cf">function</span>(x) x<span class="sc">@</span>type) <span class="sc">|&gt;</span></span>
<span id="cb66-3"><a href="statistical-analysis-with-msqrob2.html#cb66-3" tabindex="-1"></a>    <span class="fu">table</span>()</span></code></pre></div>
<p>Again <code>fitError</code>s were generated for one-hit-wonder proteins.</p>
<div class="sourceCode" id="cb67"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb67-1"><a href="statistical-analysis-with-msqrob2.html#cb67-1" tabindex="-1"></a>counts <span class="ot">&lt;-</span> <span class="fu">aggcounts</span>(spikein[[<span class="st">"proteins_msqrob_imputed"</span>]])</span>
<span id="cb67-2"><a href="statistical-analysis-with-msqrob2.html#cb67-2" tabindex="-1"></a>oneHitProteins <span class="ot">&lt;-</span> <span class="fu">rownames</span>(counts)[<span class="fu">rowMax</span>(counts) <span class="sc">==</span> <span class="dv">1</span>]</span>
<span id="cb67-3"><a href="statistical-analysis-with-msqrob2.html#cb67-3" tabindex="-1"></a>spikein <span class="ot">&lt;-</span> <span class="fu">msqrobRefit</span>(</span>
<span id="cb67-4"><a href="statistical-analysis-with-msqrob2.html#cb67-4" tabindex="-1"></a>    spikein, <span class="at">i =</span> <span class="st">"ions_imputed"</span>,</span>
<span id="cb67-5"><a href="statistical-analysis-with-msqrob2.html#cb67-5" tabindex="-1"></a>    <span class="at">subset =</span> oneHitProteins,</span>
<span id="cb67-6"><a href="statistical-analysis-with-msqrob2.html#cb67-6" tabindex="-1"></a>    <span class="at">formula =</span> <span class="sc">~</span> <span class="dv">0</span> <span class="sc">+</span> Condition <span class="sc">+</span> <span class="do">## fixed effect for experimental condition</span></span>
<span id="cb67-7"><a href="statistical-analysis-with-msqrob2.html#cb67-7" tabindex="-1"></a>        <span class="co"># (1 | Channel) + ## random effect for channel</span></span>
<span id="cb67-8"><a href="statistical-analysis-with-msqrob2.html#cb67-8" tabindex="-1"></a>        (<span class="dv">1</span> <span class="sc">|</span> Mixture) <span class="sc">+</span> <span class="do">## random effect for mixture</span></span>
<span id="cb67-9"><a href="statistical-analysis-with-msqrob2.html#cb67-9" tabindex="-1"></a>        (<span class="dv">1</span> <span class="sc">|</span> Run ) <span class="sc">+</span> <span class="do">## random effect for run</span></span>
<span id="cb67-10"><a href="statistical-analysis-with-msqrob2.html#cb67-10" tabindex="-1"></a>        (<span class="dv">1</span> <span class="sc">|</span> Run<span class="sc">:</span>ionID), <span class="do">## random effect for PSM nested in MS run</span></span>
<span id="cb67-11"><a href="statistical-analysis-with-msqrob2.html#cb67-11" tabindex="-1"></a>        <span class="do">## random effect for channel nested in run has been removed</span></span>
<span id="cb67-12"><a href="statistical-analysis-with-msqrob2.html#cb67-12" tabindex="-1"></a>    <span class="at">fcol =</span> <span class="st">"Protein.Accessions"</span>,</span>
<span id="cb67-13"><a href="statistical-analysis-with-msqrob2.html#cb67-13" tabindex="-1"></a>    <span class="at">modelColumnName =</span> <span class="st">"msqrob_psm_rrilmm"</span>,</span>
<span id="cb67-14"><a href="statistical-analysis-with-msqrob2.html#cb67-14" tabindex="-1"></a>    <span class="at">name =</span> <span class="st">"proteins_msqrob_imputed"</span>,</span>
<span id="cb67-15"><a href="statistical-analysis-with-msqrob2.html#cb67-15" tabindex="-1"></a>    <span class="at">robust =</span> <span class="cn">TRUE</span>, <span class="at">ridge =</span> <span class="cn">TRUE</span></span>
<span id="cb67-16"><a href="statistical-analysis-with-msqrob2.html#cb67-16" tabindex="-1"></a>)</span>
<span id="cb67-17"><a href="statistical-analysis-with-msqrob2.html#cb67-17" tabindex="-1"></a><span class="fu">rowData</span>(spikein[[<span class="st">"proteins_msqrob_imputed"</span>]])[[<span class="st">"msqrob_psm_rrilmm"</span>]] <span class="sc">|&gt;</span></span>
<span id="cb67-18"><a href="statistical-analysis-with-msqrob2.html#cb67-18" tabindex="-1"></a>    <span class="fu">sapply</span>(<span class="cf">function</span>(x) x<span class="sc">@</span>type) <span class="sc">|&gt;</span></span>
<span id="cb67-19"><a href="statistical-analysis-with-msqrob2.html#cb67-19" tabindex="-1"></a>    <span class="fu">table</span>()</span></code></pre></div>
<p>Upon refit, no <code>fitError</code>s were generated for any proteins, as expected. Be
mindful that although this approach no longer requires strong
statistical insights, the results upon imputation will be highly
depended on the suitability of the imputation approach.</p>
<p>We can apply the same approach for upon summarisation, starting from
the imputed peptide ion data.</p>
<div class="sourceCode" id="cb68"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb68-1"><a href="statistical-analysis-with-msqrob2.html#cb68-1" tabindex="-1"></a>spikein <span class="ot">&lt;-</span> <span class="fu">aggregateFeatures</span>(</span>
<span id="cb68-2"><a href="statistical-analysis-with-msqrob2.html#cb68-2" tabindex="-1"></a>    spikein, <span class="at">i =</span> <span class="st">"ions_imputed"</span>, <span class="at">name =</span> <span class="st">"proteins_imputed"</span>,</span>
<span id="cb68-3"><a href="statistical-analysis-with-msqrob2.html#cb68-3" tabindex="-1"></a>    <span class="at">fcol =</span> <span class="st">"Protein.Accessions"</span>, <span class="at">fun =</span> MsCoreUtils<span class="sc">::</span>medianPolish,</span>
<span id="cb68-4"><a href="statistical-analysis-with-msqrob2.html#cb68-4" tabindex="-1"></a>    <span class="at">na.rm =</span> <span class="cn">TRUE</span></span>
<span id="cb68-5"><a href="statistical-analysis-with-msqrob2.html#cb68-5" tabindex="-1"></a>)</span>
<span id="cb68-6"><a href="statistical-analysis-with-msqrob2.html#cb68-6" tabindex="-1"></a>spikein <span class="ot">&lt;-</span> <span class="fu">msqrob</span>(</span>
<span id="cb68-7"><a href="statistical-analysis-with-msqrob2.html#cb68-7" tabindex="-1"></a>    spikein,  <span class="at">i =</span> <span class="st">"proteins_imputed"</span>,</span>
<span id="cb68-8"><a href="statistical-analysis-with-msqrob2.html#cb68-8" tabindex="-1"></a>    <span class="at">formula =</span> <span class="sc">~</span> <span class="dv">0</span> <span class="sc">+</span> Condition <span class="sc">+</span> <span class="do">## fixed effect for experimental condition</span></span>
<span id="cb68-9"><a href="statistical-analysis-with-msqrob2.html#cb68-9" tabindex="-1"></a>        <span class="co"># (1 | Channel) + ## random effect for channel</span></span>
<span id="cb68-10"><a href="statistical-analysis-with-msqrob2.html#cb68-10" tabindex="-1"></a>        (<span class="dv">1</span> <span class="sc">|</span> Mixture) <span class="sc">+</span> <span class="do">## random effect for mixture</span></span>
<span id="cb68-11"><a href="statistical-analysis-with-msqrob2.html#cb68-11" tabindex="-1"></a>        (<span class="dv">1</span> <span class="sc">|</span> Run), <span class="do">## random effect for MS run</span></span>
<span id="cb68-12"><a href="statistical-analysis-with-msqrob2.html#cb68-12" tabindex="-1"></a>    <span class="at">robust =</span> <span class="cn">TRUE</span>, <span class="at">ridge =</span> <span class="cn">TRUE</span>,</span>
<span id="cb68-13"><a href="statistical-analysis-with-msqrob2.html#cb68-13" tabindex="-1"></a>    <span class="at">modelColumnName =</span> <span class="st">"msqrob_rrilmm"</span>,</span>
<span id="cb68-14"><a href="statistical-analysis-with-msqrob2.html#cb68-14" tabindex="-1"></a>    <span class="at">overwrite =</span> <span class="cn">TRUE</span></span>
<span id="cb68-15"><a href="statistical-analysis-with-msqrob2.html#cb68-15" tabindex="-1"></a>)</span>
<span id="cb68-16"><a href="statistical-analysis-with-msqrob2.html#cb68-16" tabindex="-1"></a>models <span class="ot">&lt;-</span> <span class="fu">rowData</span>(spikein[[<span class="st">"proteins_imputed"</span>]])[[<span class="st">"msqrob_rrilmm"</span>]]</span>
<span id="cb68-17"><a href="statistical-analysis-with-msqrob2.html#cb68-17" tabindex="-1"></a><span class="fu">table</span>(<span class="fu">sapply</span>(models, <span class="cf">function</span>(x) x<span class="sc">@</span>type))</span></code></pre></div>
</div>
</div>
<div id="conclusion" class="section level2" number="2.9">
<h2>
<span class="header-section-number">2.9</span> Conclusion<div class="tooltip"><button class="internal-link-btn" onclick="copy_link('conclusion')" onmouseout="reset_tooltip('conclusion-tooltip')"><span class="tooltiptext" id="conclusion-tooltip">Copy link</span><i class="fa fa-link"></i></button></div>
</h2>
<p>In this vignette, we have demonstrated how to run msqrob2TMT
workflows. Because the packages relies on the <code>QFeatures</code> data class,
we could demonstrate the implementation of a complete pre-processing
workflow: sample filtering, PSM filtering, missing value management,
log2-transformation, normalisation, (optionally) summarisation and
(optionally) imputation.</p>
<p>Once pre-processed, we use the <code>msqrob2</code> package to model all sources
of variability in the MS experiment: effect of treatment of interest,
effect of TMT labelling, effect of the MS acquisition run, and the
effect of replication. We built protein-level models, but we have also
shown that we can build PSM-level models if we also include a spectrum
effect and an effect for channel nested within run.</p>
<p>We showed how to run statistical inference on the modelling results to
retrieve the significance of differentially abundant proteins. We
explored statistical results through volcano plots and boxplots of the
log2 fold changes and visually validated the results for one protein
by plotting the input data. We have shown the inference pipeline is
similar for both PSM-level models and protein-level models.
Furthermore, we illustrated how to streamline the analysis of multiple
hypothesis tests.</p>
<p>Finally, we have demonstrated how to deal with proteins that cannot be
modelled due to missing values. For PSM-level models, we can remove
the random effects for channel within run that cannot be estimated for
one-hit-wonder proteins. We can also manually inspect how missing
values can influence the model design, and refit a simplified model
upon expert’s intervention. Finally, we can impute missing values,
which unlocks model fitting, but imposes strong assumption on the
validity of the imputation approach and the reliability of the
predicted values.</p>

</div>
</div>
<p style="text-align: center;">
<a href="index.html"><button class="btn btn-default">Previous</button></a>
</p>
<p class="build-date">Page built: 
2025-09-05
 using 
R version 4.5.1 (2025-06-13)
</p>
</div>
</div>



</body>
</html>
