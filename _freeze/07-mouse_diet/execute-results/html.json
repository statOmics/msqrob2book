{
  "hash": "4ad4d24338ad3a9eb16b4fb0c10f7745",
  "result": {
    "engine": "knitr",
    "markdown": "# The mouse diet use case: a Skyline TMT DDA dataset {#sec-mouse-diet}\n\n\n::: {.cell}\n\n:::\n\n\n## Introduction\n\nIf you never used `msqrob2`, we suggest to familiarise yourself with\nthe [basic concepts chapter](#sec-basics) first. Note that TMT\nexperiments imposes complex designs, hence we also suggest reading the\n[advanced concepts chapter](#sec-advanced).\n\nWe will demonstrate the msqrob2TMT workflow, a data processing and\nmodelling workflow dedicated to the analysis of TMT-based proteomics\ndatasets. We will demonstrated the workflow using the study published\nby @Plubell2017-th, illustrating the statistical concepts using a\nreal-life use case.\n\nSince this chapter uses a real-life study, we cannot objectively\nassess the results. The [advanced concepts chapter](#sec-advances)\ndemonstrates an msqrob2TMT analysis with ground truth information.\n\nBefore delving further into the use case, let us prepare our\ncomputational environment.\n\n## Load packages\n\nFirst, we load the `msqrob2` package and additional packages for data\nmanipulation and visualisation.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(\"msqrob2\")\nlibrary(\"ggplot2\")\nlibrary(\"patchwork\")\nlibrary(\"ggrepel\")\nlibrary(\"dplyr\")\n```\n:::\n\n\nWe also configure the [parallelisation](#sec-parallel) framework.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(\"BiocParallel\")\nregister(SerialParam())\n```\n:::\n\n\n## Load data\n\n### Experimental context{#sec-exp_design_mouse}\n\nThe data used in this vignette has been published by @Plubell2017-th\n(PXD005953). The objective of the experiment was to explore the impact\nof low-fat and high-fat diets on the proteomic content of adipose\ntissue in mice. It also assesses whether the duration of the diet may\nimpact the results. The authors assigned twenty mice into four groups\n(5 mice per group) based on their diet, either low-fat (LF) or\nhigh-fat (HF), and the duration of the diet, which was classified as\nshort (8 weeks) or long (18 weeks). Samples from the epididymal\nadipose tissue were extracted from each mice. The samples were then\nrandomly distributed across three TMT 10-plex mixtures for analysis.\nIn each mixture, two reference labels were used, each containing\npooled samples that included a range of peptides from all the samples.\nNot all labels were used, leading to an unbalanced design. Each TMT\n10-plex mixture was fractionated into nine parts, resulting in a total\nof 27 MS runs.\n\n\n::: {.cell}\n::: {.cell-output-display}\n![Overview of the experimental design. Taken from Plubell et al. 2017.](figs/mouse_experiment.png){width=353}\n:::\n:::\n\n\n### Getting the data\n\nThe data were reanalyzed by @Huang2020-lu and have been deposited in\nthe `MSV000084264` MASSiVE repository, but we will retrieve the\ntimestamped data from our [Zenodo\nrepository](https://zenodo.org/records/14767905). We need 2 files: the\nSkyline identification and quantification table generated by the\nauthors and the sample annotation files^[note that these files are\n[locally cached](#sec-caching)].\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(\"BiocFileCache\")\nbfc <- BiocFileCache()\npsmFile <- bfcrpath(bfc, \"https://zenodo.org/records/14767905/files/mouse_psms.txt?download=1\")\nannotFile <- bfcrpath(bfc, \"https://zenodo.org/records/14767905/files/mouse_annotations.csv?download=1\")\n```\n:::\n\n\nThis analysis starts with the [PSM table](#sec-psm_table). Note that\ncolumns that start with `\"Abundance.\"` contain the quantitative values\nfor each TMT label.\n\n\n::: {.cell}\n\n```{.r .cell-code}\npsms <- read.delim(psmFile)\n```\n:::\n\n\n::: {.cell}\n::: {.cell-output-display}\n\n\n|Checked |Confidence |Identifying.Node |PSM.Ambiguity |Annotated.Sequence    |Modifications                   | X..Protein.Groups| X..Proteins|Master.Protein.Accessions |Master.Protein.Descriptions |Protein.Accessions     |Protein.Descriptions                                                                                                                                                                                                                  | X..Missed.Cleavages| Charge| DeltaScore| DeltaCn| Rank| Search.Engine.Rank| m.z..Da.| MH...Da.| Theo..MH...Da.| DeltaM..ppm.| Deltam.z..Da.|Activation.Type |MS.Order | Isolation.Interference....| Average.Reporter.S.N| Ion.Inject.Time..ms.| RT..min.| First.Scan|Spectrum.File                                                     |File.ID | Abundance..126| Abundance..127N| Abundance..127C| Abundance..128N| Abundance..128C| Abundance..129N| Abundance..129C| Abundance..130N| Abundance..130C| Abundance..131|Quan.Info | Ions.Score| Identity.Strict| Identity.Relaxed| Expectation.Value| Percolator.q.Value| Percolator.PEP|\n|:-------|:----------|:----------------|:-------------|:---------------------|:-------------------------------|-----------------:|-----------:|:-------------------------|:---------------------------|:----------------------|:-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|-------------------:|------:|----------:|-------:|----:|------------------:|--------:|--------:|--------------:|------------:|-------------:|:---------------|:--------|--------------------------:|--------------------:|--------------------:|--------:|----------:|:-----------------------------------------------------------------|:-------|--------------:|---------------:|---------------:|---------------:|---------------:|---------------:|---------------:|---------------:|---------------:|--------------:|:---------|----------:|---------------:|----------------:|-----------------:|------------------:|--------------:|\n|False   |High       |Mascot (A2)      |Unambiguous   |[K].aIDILDR.[SM]      |N-Term(TMT6plex)                |                 1|           1|                          |                            |Q61084                 |Mitogen-activated protein kinase kinase kinase 3 OS=Mus musculus GN=Map3k3 PE=1 SV=1                                                                                                                                                  |                   0|      2|          0|       0|    1|                  1| 522.8161| 1044.625|       1044.625|        -0.14|      -0.00008|CID             |MS2      |                   2.279464|                 10.5|               42.390|  63.4111|      16103|PAMI-194_Mouse_U-Dd_TMT_40ug_28pctACN_25cm_120min_20160426_OT.raw |F3.6    |       2382.454|        2429.068|        2707.243|        3317.650|        5035.093|       3031.7993|       4808.5522|        2583.115|        3103.613|       2795.283|NA        |         40|              25|               18|         0.0003802|          0.0008956|      0.0111900|\n|False   |High       |Mascot (C2)      |Unambiguous   |[K].aLEENNNFSk.[M]    |N-Term(TMT6plex); K10(TMT6plex) |                 1|           1|                          |                            |P55821                 |Stathmin-2 OS=Mus musculus GN=Stmn2 PE=1 SV=1                                                                                                                                                                                         |                   0|      2|         NA|       0|    1|                  2| 812.4410| 1623.875|       1623.874|         0.26|       0.00021|CID             |MS2      |                  20.489330|                  0.8|              116.000|  38.9028|       7622|PAMI-176_Mouse_A-J_TMT_40ug_22pctACN_25cm_120min_20160223_OT.raw  |F1.3    |       1112.530|              NA|              NA|              NA|              NA|        389.5883|        963.0698|              NA|              NA|             NA|NA        |         49|              29|               22|         0.0000932|          0.0000000|      0.0000510|\n|False   |High       |Mascot (C2)      |Rejected      |[K].eMISDIk.[F]       |N-Term(TMT6plex); K7(TMT6plex)  |                 0|           1|                          |                            |Q5SQM0                 |Echinoderm microtubule-associated protein-like 6 OS=Mus musculus GN=Eml6 PE=2 SV=1                                                                                                                                                    |                   0|      2|          0|       0|    1|                  1| 647.3786| 1293.750|       1293.749|         0.84|       0.00054|CID             |MS2      |                  62.114720|                 25.4|               50.658|  45.5494|      10094|PAMI-176_Mouse_A-J_TMT_40ug_24pctACN_25cm_120min_20160223_OT.raw  |F1.4    |       8606.559|       10042.301|        7976.240|        5196.599|        9381.061|      12227.7070|       6418.2720|        5791.740|        9665.493|       5747.680|NA        |         11|              28|               21|         0.5635688|          0.0016120|      0.0284500|\n|False   |High       |Mascot (C2)      |Unambiguous   |[KR].iIDFGLAR.[HQRT]  |N-Term(TMT6plex)                |                 4|           3|                          |                            |Q3UIZ8; Q5SUV5; Q8VCR8 |Myosin light chain kinase 3 OS=Mus musculus GN=Mylk3 PE=1 SV=1; Myosin light chain kinase family member 4 OS=Mus musculus GN=Mylk4 PE=1 SV=2; Myosin light chain kinase 2, skeletal/cardiac muscle OS=Mus musculus GN=Mylk2 PE=1 SV=2 |                   0|      2|          0|       0|    1|                  1| 567.3476| 1133.688|       1133.688|        -0.09|      -0.00005|CID             |MS2      |                  30.288610|                 13.5|               41.830|  70.4334|      19108|PAMI-176_Mouse_A-J_TMT_40ug_30pctACN_25cm_120min_20160223_OT.raw  |F1.7    |       4964.429|        5950.643|        3133.549|        3321.042|        2914.397|       3274.3197|       3284.3334|        4714.300|        3846.105|       5461.438|NA        |         41|              24|               17|         0.0002663|          0.0000983|      0.0004159|\n|False   |High       |Mascot (B2)      |Unambiguous   |[KR].iQLWDTAGQER.[FY] |N-Term(TMT6plex)                |                 7|           1|                          |                            |O35963                 |Ras-related protein Rab-33B OS=Mus musculus GN=Rab33b PE=1 SV=1                                                                                                                                                                       |                   0|      3|         NA|       0|    1|                  2| 515.9459| 1545.823|       1545.822|         0.49|       0.00025|CID             |MS2      |                  14.174430|                  5.2|              116.000|  63.1792|      15687|PAMI-176_Mouse_K-T_TMT_40ug_26pctACN_25cm_120min_20160223_OT.raw  |F2.5    |       2202.812|        1313.995|        1942.837|        2381.060|        1443.969|       1701.8316|        968.0946|        1867.904|         910.823|       1371.243|NA        |         28|              28|               21|         0.0092083|          0.0000000|      0.0000261|\n|False   |High       |Mascot (A2)      |Unambiguous   |[K].aIDILDR.[SM]      |N-Term(TMT6plex)                |                 1|           1|                          |                            |Q61084                 |Mitogen-activated protein kinase kinase kinase 3 OS=Mus musculus GN=Map3k3 PE=1 SV=1                                                                                                                                                  |                   0|      2|          0|       0|    1|                  1| 522.8161| 1044.625|       1044.625|        -0.14|      -0.00008|CID             |MS2      |                  21.614820|                 19.0|              116.000|  62.4027|      15935|PAMI-194_Mouse_U-Dd_TMT_40ug_26pctACN_25cm_120min_20160426_OT.raw |F3.5    |       6064.501|        3790.208|        4328.930|        6528.889|        6080.098|       7705.8087|       7836.0572|        4606.420|        5347.845|       5869.469|NA        |         42|              25|               18|         0.0002350|          0.0005618|      0.0067230|\n\n\n:::\n:::\n\n\nWe also load the [annotation table](#sec-annotation_table). Each row\nin the annotation table contains information for one sample (the table\nbelow shows the first 6 rows).\n\n\n::: {.cell}\n\n```{.r .cell-code}\ncoldata <- read.csv(annotFile)\n```\n:::\n\n\n::: {.cell}\n::: {.cell-output-display}\n\n\n|Channel |Condition |Run                                                              |BioReplicate            |Mixture            |Fraction                           | TechRepMixture|\n|:-------|:---------|:----------------------------------------------------------------|:-----------------------|:------------------|:----------------------------------|--------------:|\n|126     |Long_LF   |PAMI-176_Mouse_A-J_TMT_40ug_30pctACN_25cm_120min_20160223_OT.raw |PAMI-176_Mouse_A-J.X126 |PAMI-176_Mouse_A-J |40ug_30pctACN_25cm_120min_20160223 |              1|\n|126     |Long_LF   |PAMI-176_Mouse_A-J_TMT_40ug_28pctACN_25cm_120min_20160223_OT.raw |PAMI-176_Mouse_A-J.X126 |PAMI-176_Mouse_A-J |40ug_28pctACN_25cm_120min_20160223 |              1|\n|126     |Long_LF   |PAMI-176_Mouse_A-J_TMT_40ug_90pctACN_25cm_120min_20160223_OT.raw |PAMI-176_Mouse_A-J.X126 |PAMI-176_Mouse_A-J |40ug_90pctACN_25cm_120min_20160223 |              1|\n|126     |Long_LF   |PAMI-176_Mouse_A-J_TMT_40ug_40pctACN_25cm_120min_20160223_OT.raw |PAMI-176_Mouse_A-J.X126 |PAMI-176_Mouse_A-J |40ug_40pctACN_25cm_120min_20160223 |              1|\n|126     |Long_LF   |PAMI-176_Mouse_A-J_TMT_40ug_22pctACN_25cm_120min_20160223_OT.raw |PAMI-176_Mouse_A-J.X126 |PAMI-176_Mouse_A-J |40ug_22pctACN_25cm_120min_20160223 |              1|\n|126     |Long_LF   |PAMI-176_Mouse_A-J_TMT_40ug_24pctACN_25cm_120min_20160223_OT.raw |PAMI-176_Mouse_A-J.X126 |PAMI-176_Mouse_A-J |40ug_24pctACN_25cm_120min_20160223 |              1|\n\n\n:::\n:::\n\n\nWe perform a little cleanup of the sample annotations to generate the\ninformation needed for later data modelling, namely \n\n1. We extract the diet type from the condition variable.\n2. We extract the diet duration from the condition variable. \n3. We rename the `Channel` column to `Label` for more clarity with the\n   main text.\n\n\n::: {.cell}\n\n```{.r .cell-code}\ncoldata$Duration <- gsub(\"_.*\", \"\", coldata$Condition) ## 1.\ncoldata$Diet <- gsub(\".*_\", \"\", coldata$Condition) ## 2.\ncolnames(coldata)[1] <- \"Label\" ## 3.\n```\n:::\n\n\nWe will also subset the data set to reduce computational costs. If you\nwant to run the vignette on the full data set, you can skip this\nchunk. We here randomly sample 500 proteins from the experiment.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nproteinIds <- unique(psms$Protein.Accessions)\nset.seed(1234)\npsms <- psms[psms$Protein.Accessions %in% sample(proteinIds, 500), ]\n```\n:::\n\n\n### The `QFeatures` data class\n\nWe combine the two tables into a [`QFeatures` object](#sec-qfeatures).\nWe need to point to the column containing the run information. For the\nannotation table, this is simply the `Run` column. For the Skyline\ntable, this is the `Spectrum.File` column. We also add a `quantCols`\ncolumn in the annotation table. We also simply the run names upon\nconversion for conciseness.\n\n\n::: {.cell}\n\n```{.r .cell-code}\ncoldata$runCol <- coldata$Run\ncoldata$quantCols <- paste0(\"Abundance..\", coldata$Label)\nmouse <- readQFeatures(psms, colData = coldata,\n                       quantCols = unique(coldata$quantCols),\n                       runCol = \"Spectrum.File\", name = \"psms\")\nnames(mouse) <- sub(\"^.*(Mouse.*ACN).*raw\", \"\\\\1\", names(mouse))\nmouse\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nAn instance of class QFeatures (type: bulk) with 27 sets:\n\n [1] Mouse_A-J_TMT_40ug_14pctACN: SummarizedExperiment with 198 rows and 10 columns \n [2] Mouse_A-J_TMT_40ug_20pctACN: SummarizedExperiment with 481 rows and 10 columns \n [3] Mouse_A-J_TMT_40ug_22pctACN: SummarizedExperiment with 514 rows and 10 columns \n ...\n [25] Mouse_U-Dd_TMT_40ug_30pctACN: SummarizedExperiment with 726 rows and 10 columns \n [26] Mouse_U-Dd_TMT_40ug_40pctACN: SummarizedExperiment with 566 rows and 10 columns \n [27] Mouse_U-Dd_TMT_40ug_90pctACN: SummarizedExperiment with 251 rows and 10 columns \n```\n\n\n:::\n:::\n\n\nWe now have a `QFeatures` object with 27 sets, each containing data\nassociated with an MS run. \n\n## Data preprocessing\n\n`msqrob2` relies on the `QFeatures` data structure, meaning that we\ncan directly make use of `QFeatures`' data preprocessing\nfunctionality (see also the `QFeatures`\n[documentation](https://rformassspectrometry.github.io/QFeatures/articles/Processing.html)).\n\n### Encoding missing values\n\nPeptides with zero intensities are missing peptides and should be\nrepresent with a `NA` value rather than `0` (see [Encoding missing\nvalues]).\n\n\n::: {.cell}\n\n```{.r .cell-code}\nmouse <- zeroIsNA(mouse, names(mouse))\n```\n:::\n\n\n### Sample filtering\n\nWe remove the reference samples that were used by the MSstatsTMT\nauthors to obtain normalisation factors since msqrob2TMT workflows do\nnot require normalisation from reference label. The information\nabout which samples are normalisation samples is available from the\n`colData`, in the `Condition` column.\n\n\n::: {.cell}\n\n```{.r .cell-code}\ntable(mouse$Condition)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n\n Long_HF  Long_LF   Long_M     Norm Short_HF Short_LF \n      45       45       36       54       45       45 \n```\n\n\n:::\n:::\n\n\nWe remove any sample that is marked as `Norm`. We also remove sample\nthat are annotated as `Long_M` since we could not find documentation\nfor this group.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nmouse <- subsetByColData(\n    mouse, mouse$Condition != \"Norm\" & mouse$Condition != \"Long_M\"\n)\n```\n:::\n\n\n### PSM filtering\n\nWe [filter features](#sec-filter) for which more than 70% of the\nintensities are missing in a run. We keep the spectrum as soon as the\nreporter ions are observed in at least 3 out of 10 TMT labels of the\nrun (same cut-off as applied in @Huang2020-lu).\n\n\n::: {.cell}\n\n```{.r .cell-code}\nmouse <- filterNA(mouse, names(mouse), pNA = 0.7) ## 2.\n```\n:::\n\n\nWe next remove PSMs that could not be mapped to a protein or that map\nto multiple proteins (the protein identifier contains multiple\nidentifiers separated by a `;`). We use `filterFeatures()` that will\nkeep the row that fulfill the condition below. Note that\n`Protein.Accessions` is a column generated by Skyline that is\navailable in the `rowData`.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nmouse <- filterFeatures(\n    mouse, ~ Protein.Accessions != \"\" & ## Remove failed protein inference\n        !grepl(\";\", Protein.Accessions)) ## Remove protein groups\n```\n:::\n\n\nPeptide ions that were identified with multiple PSMs in a run are\ncollapsed to the PSM with the highest summed intensity over the\nlabels, a strategy that is also used by MSstats. We will again use\n`filterFeatures()`, but the highest summed intensity for each PSM \nis not available in the `rowData`, so we need to create it manually.\n\nWe therefore loop over each set:\n\n1. Make a new variable for ionID in the `rowData`, which is defined as\n   the peptide sequence and its charge.\n2. We calculate the `rowSums` for each ion.\n3. Make a new variable `psmRank` that ranks the PSMs for each ion\n   based on the summed intensity.\n4. We store the new information back in the `rowData`.\n5. We keep the PSM with the highest summed intensity, that is that\n   ranks first (note that PSM unique to an ion will always rank \n   first).\n\n\n::: {.cell}\n\n```{.r .cell-code}\nfor (i in names(mouse)) {\n    rowdata <- rowData(mouse[[i]])\n    rowdata$ionID <- paste0(rowdata$Annotated.Sequence, rowdata$Charge) ## 1.\n    rowdata$rowSums <- rowSums(assay(mouse[[i]]), na.rm = TRUE) ## 2.\n    rowdata <- data.frame(rowdata) |>\n        group_by(ionID) |>\n        mutate(psmRank = rank(-rowSums)) ## 3.\n    rowData(mouse[[i]]) <- DataFrame(rowdata) ## 4.\n}\nmouse <- filterFeatures(mouse, ~ psmRank == 1) ## 5.\n```\n:::\n\n\nSo, we implicitly collapsed the PSM-level data into **peptide-ion**\ndata, where each row represents a PSM, but also a unique ion within a\nrun. So we will refer to the data as  \"ion-level\".\n\n### Standard preprocessing workflow\n\nWe can now prepare the data for modelling. The workflow ensures the\ndata complies to `msqrob2`'s requirements:\n\n1. Intensities are log-transformed.\n2. Samples are normalised.\n3. (optionally) PSMs intensities are summarised into protein abundance\n   values for protein-level workflows.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nsNames <- names(mouse)\nmouse <- logTransform( ## 1.\n    mouse, sNames, name = paste0(sNames, \"_log\"), base = 2\n)\nmouse <- normalize( ## 2.\n    mouse, paste0(sNames, \"_log\"), name = paste0(sNames, \"_norm\"),\n    method = \"center.median\"\n)\nmouse <- aggregateFeatures( ## 3.\n    mouse, i = paste0(sNames, \"_norm\"), name = paste0(sNames, \"_proteins\"),\n    fcol = \"Protein.Accessions\", fun = MsCoreUtils::medianPolish,\n    na.rm=TRUE\n)\n```\n:::\n\n\nWe conclude the preprocessing by joining the assays of the different\nruns in a single ion set for ion-level models. In order to correctly\nmatch peptide ions across rus, we use `ionID` as a row identifier.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nmouse <- joinAssays(mouse, paste0(sNames, \"_norm\"), fcol = \"ionID\", \"ions_norm\")\n```\n:::\n\n\nWe also join the protein sets for protein-level models. We omit `fcol`\nand will merge rows based on their row name (protein identifier).\n\n\n::: {.cell}\n\n```{.r .cell-code}\nmouse <- joinAssays(mouse, paste0(sNames, \"_proteins\"), \"proteins\")\n```\n:::\n\n\n## Data exploration\n\nAs [described above](#sec-exp_design_mouse), the samples originate from mice\nthat were either subject to a low-fat (`LF`) or high-fat (`HF`) diet.\nMoreover, each diet was maintained for a short duration\n(`Short`) or a long duration (`Long`). Note that each group contains 5\nmice but the peptides from each sample have been fractionated in 9\nfractions, leading to 45 units per group.\n\nIn this case, we are interested in the effects of diet type and the\neffect of diet duration. The table below confirms we have a balanced\ndesign for each condition.\n\n\n::: {.cell}\n\n```{.r .cell-code}\ntable(Diet = mouse$Diet, Duration = mouse$Duration)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n    Duration\nDiet Long Short\n  HF   45    45\n  LF   45    45\n```\n\n\n:::\n:::\n\n\nFurthermore, there are potential unwanted sources of variation: the\nexperimental unit (i.e. the mouse, `BioReplicate`), the fraction\n(`Fraction`), the run (`Run`), the TMT mixture (`Mixture`).\n\nWe will explore the main sources of variation in the\ndata (see [Data exploration]). Unfortunately, the peptide ion\ndata contains too many missing values and cannot be explored using\nstandard dimension reduction approaches. `omicsGMF` [@Segers2025-ce]\nprovides an interesting alternative, but is still in its early stage\nand will not be included here. We will therefore run a MDS analysis on\nthe protein-level data instead, which contains less missing values.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(\"scater\")\nse <- getWithColData(mouse, \"proteins\") |> \n  as(\"SingleCellExperiment\") |> \n  runMDS(exprs_values = 1)\n```\n:::\n\n\nWe can now plot the MDS and colour each sample based on different\npotential sources of variation.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nplotMDS(se, colour_by = \"Run\") + ggtitle(\"Coloured by Run\") +\n  scale_colour_manual(values = rainbow(27)) +\n  plotMDS(se, colour_by = \"Fraction\") + ggtitle(\"Coloured by Fraction\") +\n  plotMDS(se, colour_by = \"BioReplicate\") + ggtitle(\"Coloured by BioReplicate\") +\n  plotMDS(se, colour_by = \"Mixture\") + ggtitle(\"Coloured by Mixture\") +\n  plotMDS(se, colour_by = \"Diet\") + ggtitle(\"Coloured by Diet\") +\n  plotMDS(se, colour_by = \"Duration\") + ggtitle(\"Coloured by Duration\") &\n  theme(legend.position = \"none\") \n```\n\n::: {.cell-output-display}\n![](07-mouse_diet_files/figure-html/unnamed-chunk-23-1.png){width=672}\n:::\n:::\n\n\nThe data exploration leads to several observations: \n\n- The strongest source of variation is associated with the MS \n  acquisition run. \n- Part of this run effect is influenced by which fraction it contains\n  since samples from the same fraction tend to be closer than samples from different\n  fractions. (**TODO DISCUSS**)\n- It is difficult to identify an effect of mouse (biological\n  replicate) because every run contains distinct mice. However, this\n  does not exclude an effect of mice which has been identified as a\n  potential source of variation and hence should still be modelled. (**TODO DISCUSS**)\n- There is potentially also an effect of TMT mixture since samples\n  from the same mixtures tend to cluster together (in the center of\n  the plot). However, this effect are more subtle to detect and\n  difficult to disentangle from the run and fraction effects.\n- Although again very subtle, we can see within each run that samples\n  from the mice with the same diet tends to group together. However,\n  these effects are overwhelmed by the run effects. An effect of\n  duration is to subtle to pinpoint from the current data exploration.\n\nData modelling disentangles the different sources of variation, given\ntheir are properly defined in the model, hence the next section. \n\n## Data modelling\n\nThe preprocessed data can now be modelled to answer biologically\nrelevant questions. \n\n### Sources of variation\n\nProteomics data contain several sources of variation that need to be\naccounted for by the model:\n\n1. **Treatment of interest**: we model the source of variation induced\n   by the experimental treatment of interest as a **fixed effect**.\n   Fixed effects are effect that are considered non-random, i.e. the\n   treatment effect is assumed to be the same and reproducible across\n   repeated experiments, but it is unknown and has to be estimated. We\n   will include `Diet` as a fixed effect that models the fact that a\n   change in diet type can induce changes in protein abundance.\n   Similarly, we also include `Duration` as a fixed effect to model\n   the change in protein abundance induces by the diet duration.\n   Finally, we will also include an interaction between the two\n   variables allowing that the changes in protein abundance induced by\n   diet type can be different whether the mice were fed for a short or\n   long duration.\n\n2. **Pseudo-replication**: the experiment involves biological\n   replication as the adipose tissue extracts were sampled from 20\n   mice (5 mice per Diet x Duration combination). The tissue from each\n   mouse was prepared in a single TMT mixture, but each mixture was\n   acquired in 9 fractions, so we have 9 measures for each mice. While\n   the treatment is applied at the mice level (experimental unit), we\n   actually measure 9 fractions as an outcome (observational unit). We\n   refer to **pseudo-replication** when the observational unit is\n   different from the experimental unit. We therefore need to account\n   for the potential correlation among pseudo-replicates\n   from the same mouse compared to between different mice. These\n   effects are typically modelled as [random\n   effects](#sec-random_effect), and are assumed to be i.i.d normally\n   distributed with mean 0 and constant variance, $u_{mouse} \\sim\n   N(0,\\sigma^{2,\\text{mouse}})$. This random effect \n   models the correlation of the log2-intensities of pseudo replicates, explicitly.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlength(unique(mouse$BioReplicate))\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] 20\n```\n\n\n:::\n:::\n\n\n3. **Labelling effects**: the 20 mouse adipose tissue samples have been\n   labelled using 18-plex TMT. We can expect that samples measured\n   within the same TMT label may be more similar than samples\n   measured within different TMT labels. Since these effects may not\n   be reproducible from one experiment to another, for instance\n   because each TMT kit may potentially contain different impurity\n   ratios, we can account for this source of variation using a random effect\n   for TMT label.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlength(unique(mouse$Label))\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] 10\n```\n\n\n:::\n:::\n\n\n4. **Mixture effects**: the 20 mouse samples were assigned to one out\n   of 3 mixtures. Again, we expect that protein intensities from the same\n   mixture will be more alike than those of different mixtures. Hence,\n   we will add a random effect for mixture.\n\n\n::: {.cell}\n\n```{.r .cell-code}\ntable(mouse$Mixture)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n\n PAMI-176_Mouse_A-J  PAMI-176_Mouse_K-T PAMI-194_Mouse_U-Dd \n                 54                  63                  63 \n```\n\n\n:::\n:::\n\n\n5. **Run effects**: log2-intensities that are measured within the \n   same run will be more similar than log2-intensities between\n   runs. We will use a random effect for run to explicitly model this\n   correlation in the data. Note that each sample has been acquired in\n   9 fractions, each fraction being measured in a separate run.\n   Accounting for the effects of run will also absorb the effects of\n   fraction.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlength(unique(mouse$Run))\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] 27\n```\n\n\n:::\n:::\n\n\n6. **Spectrum effects**: we will directly estimate the treatment effect\n   at the protein-level from ion-level data. This will again induce\n   additional levels of correlation. The intensities for the different\n   TMT labels in the same spectrum (PSM) within a run will be\n   more similar than the intensities between spectra. We therefore\n   need to add a random effect term to account for the within spectrum\n   correlation structure. Note that a spectrum here contains the data\n   from one peptide ion within a run. Hence, modelling a random effect\n   for spectrum boils down to modelling a random effect for peptide\n   ion nested within run.\n\n7. **Labelling effects nested in run**: modelling the data at the\n   ion-level also implies that a label in a run contains multiple\n   ion intensities for each protein. Hence, intensities from different\n   peptide ions for a protein with the same label within a run will be\n   more alike than intensities of different PSMs for the same protein\n   with different labels and/or runs, and we will address this\n   correlation with a random effect for label nested in run.\n\n`msqrob2` workflows rely on linear mixed models, which are models that\ncan estimate and predict fixed and random effects, respectively.\n\nNow we have identified the sources of variation, we can define a\nmodel. We will model the main effects for `Diet` and `Duration`, and a\n`Diet:Duration` interaction, to account for proteins for which the\n`Diet` effect changes according to `Duration`, and vice versa, which\ncan be written as `Diet + Duration + Diet:Duration`, shortened into\n`Diet * Duration`. Adding the technical sources of variation, the\nmodel becomes.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nmodel <- ~ Diet * Duration + ## (1) fixed effect for Diet and Duration with interaction\n  (1 | BioReplicate) +  ## (2) random effect for biological replicate (mouse)      \n  (1 | Label) + ## (3) random effect for label\n  (1 | Mixture) + ## (4) random effect for mixture\n  (1 | Run) + ## (5) random effect for MS run\n  (1 | Run:ionID) + ## (6) random effect for spectrum, i.e. ionID nested in run\n  (1 | Run:Label)  ## (7) random effect for label nested in MS run\n```\n:::\n\n\nWe can run the `msqrob2` statistical workflow.\n\n### Model estimation\n\nWe estimate the peptide-ion-level model with `msqrobAggregate()` \n(see [the modelling section](#sec-run_model)). Recall that\nvariables defined in `model` are automatically retrieved from the\n`colData` (`\"Diet\"`, `\"Duration\"`, `\"Label\"`, `\"Mixture\"`) and\nfrom the `rowData` (`\"ionID\"`). We also enable M-estimation\n(`robust = TRUE`) for improved robustness against outliers and ridge\npenalisation (`ridge = TRUE`) to stabilise the parameter estimation.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nmouse <- msqrobAggregate(\n    mouse, i = \"ions_norm\",\n    formula = model,\n    fcol = \"Protein.Accessions\",\n    modelColumnName = \"msqrob_ion\",\n    name = \"proteins_msqrob\",\n    ridge = TRUE, robust = TRUE\n)\n```\n:::\n\n\nOnce the model is estimated, we can start answering biological\nquestions.\n\n### Hypothesis testing\n\nIn this section, you will learn how to convert a biological question\ninto a statistical hypothesis.\n\n#### Difference between low fat and high fat diet after short duration\n\nA first question one can ask is: how are protein abundance affected by\ndiet when only considering a short diet duration? We need to convert\nthis question in a combination of the model parameters, also referred\nto as a contrast. To aid defining contrasts, we will visualise the\nexperimental design using the `ExploreModelMatrix` package. \nNote that with ExploreModelMatrix we can only visualise fixed effects\npart of the model. This is fine as the mean protein abundances can\nonly systematically differ from each other according to the\nmain effects for `Diet` and `Duration` and the `Diet:Duration` interaction.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(\"ExploreModelMatrix\")\nvd <- VisualizeDesign(\n    sampleData =  colData(mouse),\n    designFormula = ~ Diet * Duration,\n    textSizeFitted = 4\n)\nvd$plotlist[[1]]\n```\n\n::: {.cell-output-display}\n![ ](07-mouse_diet_files/figure-html/mouse_diet_VisualizeDesign-1.png){width=672}\n:::\n:::\n\n\nAssessing the difference between low-fat and high-fat diets for short\nduration boils down to assessing the difference between the `Short_LF` and\n`Short_HF`. The mean for the short low-fat diet group is defined by\n`(Intercept) + DietLF + DurationShort + DietLF:DurationShort`. The\nmean for the short high-fat diet group is defined by `(Intercept) +\nDurationShort`. The difference between the two results in the\ncontrast below:\n\n\n::: {.cell}\n\n```{.r .cell-code}\ncontrast <- \"ridgeDietLF + ridgeDietLF:DurationShort\"\n```\n:::\n\n\nNote that because we used ridge regression for modelling, we need to\nprefix the parameter names with `ridge`. We can further specify the\nnull hypothesis, that is we are interest whether the differences \nbetween the two groups is different from zero.\n\n\n::: {.cell}\n\n```{.r .cell-code}\n(hypothesis1 <- paste(contrast, \"= 0\"))\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] \"ridgeDietLF + ridgeDietLF:DurationShort = 0\"\n```\n\n\n:::\n:::\n\n\nWe next use `makeContrast()` to build a contrast matrix.\n\n\n::: {.cell}\n\n```{.r .cell-code}\n(L <- makeContrast(\n    hypothesis1,\n    parameterNames = c(\"ridgeDietLF\",\"ridgeDurationShort\",\"ridgeDietLF:DurationShort\")\n))\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n                          ridgeDietLF + ridgeDietLF:DurationShort\nridgeDietLF                                                     1\nridgeDurationShort                                              0\nridgeDietLF:DurationShort                                       1\n```\n\n\n:::\n:::\n\n\nWe can now test our null hypothesis.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nmouse <- hypothesisTest(\n    mouse, i = \"proteins_msqrob\", L, modelColumn = \"msqrob_ion\"\n)\n```\n:::\n\n\nLet us retrieve the result table from the `rowData`. Note that the\nmodel column is named after the column names of the contrast matrix `L`.\n\n\n::: {.cell}\n\n```{.r .cell-code}\ninference <- rowData(mouse[[\"proteins_msqrob\"]])[[colnames(L)]]\ninference$Protein <- rownames(inference)\nhead(inference, 10)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n               logFC           se       df             t      pval adjPval\nA2AJB7  3.491872e-09 9.284189e-05 67.35093  3.761096e-05 0.9999701       1\nA2AJK6            NA           NA       NA            NA        NA      NA\nA2AQP0            NA           NA       NA            NA        NA      NA\nA2AWP8            NA           NA       NA            NA        NA      NA\nA6H8H2            NA           NA       NA            NA        NA      NA\nB1AVY7            NA           NA       NA            NA        NA      NA\nB2RSH2  2.296647e-09 8.045105e-05 52.17788  2.854713e-05 0.9999773       1\nC0HKD8            NA           NA       NA            NA        NA      NA\nD3Z5L6            NA           NA       NA            NA        NA      NA\nE9Q5C9 -1.798058e-09 6.822108e-05 29.11140 -2.635634e-05 0.9999792       1\n       Protein\nA2AJB7  A2AJB7\nA2AJK6  A2AJK6\nA2AQP0  A2AQP0\nA2AWP8  A2AWP8\nA6H8H2  A6H8H2\nB1AVY7  B1AVY7\nB2RSH2  B2RSH2\nC0HKD8  C0HKD8\nD3Z5L6  D3Z5L6\nE9Q5C9  E9Q5C9\n```\n\n\n:::\n:::\n\n\nThe table contains the hypothesis testing results for every protein.\nNotice that several rows contain missing values. This is because data\nmodelling resulted in a `fitError`. The model cannot be estimated for\nsome proteins either because of patterns in missing values, or because a protein was measured from a single peptide ion\nalleviating the estimation of spectrum effects (see [how to deal with\n`fitError`s](#sec-fiterror)).\n\nWe can use the table above directly to build a volcano plot using\n`ggplot2` functionality.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nggplot(inference) +\n    aes(x = logFC, y = -log10(pval), color = adjPval < 0.05) +\n    geom_text_repel(data = filter(inference, adjPval < 0.05),\n                    aes(label = Protein)) +\n    geom_point() +\n    ggtitle(\"Statistical inference on differences between LF and HF (short duration)\",\n            paste(\"Hypothesis test:\", gsub(\"ridgeCondition\", \"\", colnames(L)), \"= 0\"))\n```\n\n::: {.cell-output-display}\n![ ](07-mouse_diet_files/figure-html/mouse_diet_volcano_short-1.png){width=672}\n:::\n:::\n\n\nIn this example (remember this is a subset of the complete data set),\nonly a few proteins pass the significance threshold of 5%. Let us\nvisualise the protein with the largest fold change.\n\n\n::: {.cell}\n\n```{.r .cell-code}\n(targetProtein <- rownames(inference)[which.max(inference$logFC)])\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] \"Q5SWU9\"\n```\n\n\n:::\n:::\n\n\nTo obtain the required data, we perform a little data manipulation\npipeline:\n\n1. We use the `QFeatures` subsetting functionality to retrieve all\n   data related to Q5SWU9 and focusing on the `ions_norm`\n   set that contains the preprocessed peptide ion data used for\n   modelling.\n2. We use `longForm()` to convert the object into a table suitable\n   for plotting.\n3. We remove missing values for plotting and focus only on the data\n   with short diet duration.\n4. We reorder the sample identifiers to improve visualisation.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nionData <- mouse[targetProtein, , \"ions_norm\"] |> #1\n    longForm(colvars = colnames(colData(mouse)), #2\n               rowvars = c(\"Protein.Accessions\", \"ionID\")) |>\n    data.frame() |>\n    filter(!is.na(value) & Duration == \"Short\") |> #3\n    mutate(colname = factor(colname, levels = unique(colname[order(Condition)]))) #4\n```\n:::\n\n\nWe can now plot the log normalised intensities. Since the protein is\nmodelled at the peptide ion level, multiple ion intensities are\nrecorded in each sample. Each ion is linked across samples using a\ngrey line. Samples are coloured according to the diet type. Finally,\nwe split the plot in facets, one for each mixture, to visualise the\nheterogeneity induced by different pools of mice.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nggplot(ionData) +\n    aes(x = colname,\n        y = value) +\n    geom_line(aes(group = ionID), linewidth = 0.1) +\n    geom_point(aes(colour = Condition)) +\n    facet_grid(~ Mixture, scales = \"free\") +\n    labs(x = \"Sample\", y = \"log2 intensity\") +\n    ggtitle(targetProtein) +\n    theme_minimal() +\n    theme(axis.text.x = element_blank())\n```\n\n::: {.cell-output-display}\n![ ](07-mouse_diet_files/figure-html/mouse_diet_detail_short-1.png){width=672}\n:::\n:::\n\n\nThe statistical analysis revealed a significant increase (positive log\nfold change) of the abundance for Q5SWU9 in the group fed\nwith a low-fat diet compared to the high-fat diet fed group (upon\nearly diet duration). This finding can be visually validated as there\nis a systematic increase in peptide ion intensities between the\nlow-fat diet group (blue) compared to the high-fat diet group (red).\n\n#### Difference between low fat and high fat diet after long duration\n\nThe second question one can ask is what proteins are affected by diet\nwhen only considering, this time, a long diet duration. Following the\nsame approach as above, the contrast becomes.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nhypothesis2 <- \"ridgeDietLF = 0\"\n```\n:::\n\n\nWe run the same statistical analysis pipeline as above.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nL <- makeContrast(\n    hypothesis2,\n    parameterNames = c(\"ridgeDietLF\",\"ridgeDurationShort\",\"ridgeDietLF:DurationShort\")\n)\nmouse <- hypothesisTest(\n    mouse, i = \"proteins_msqrob\", L, modelColumn = \"msqrob_ion\"\n)\ninference <- rowData(mouse[[\"proteins_msqrob\"]])[[colnames(L)]]\ninference$Protein <- rownames(inference)\n```\n:::\n\n\nAnd we plot the results.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nggplot(inference) +\n    aes(x = logFC, y = -log10(pval), color = adjPval < 0.05) +\n    geom_text_repel(data = filter(inference, adjPval < 0.05),\n                    aes(label = Protein)) +\n    geom_point() +\n    ggtitle(\"Statistical inference on differences between LF and HF (long duration)\",\n            paste(\"Hypothesis test:\", gsub(\"ridgeCondition\", \"\", colnames(L)), \"= 0\"))\n```\n\n::: {.cell-output-display}\n![ ](07-mouse_diet_files/figure-html/mouse_diet_volcano_long-1.png){width=672}\n:::\n:::\n\n\nAgain, only a few proteins come out differentially abundant between\nthe two diets, but after a long diet duration. Surprisingly, there\nis only a small overlap between differential protein after short\nduration and after long duration. One hypothesis is that there is not\nsufficient data to detect a reliable difference. A solution would be\nto combine both short and long diet duration to retrieve an averaged\nsystematic effect between diets that combine all available data.\nAnother hypothesis is that diet duration may influence the effect of\ndiet on the protein abundances. We will explore the two hypothesis in\nthe following two sub-sections.\n\n#### Average difference between low fat and high fat diet\n\nOne may want to identify the set of proteins that are systematically\ndifferentially abundant between diets, irrespective of the duration.\nTo answer this question, we want to infer on the average difference\nbetween group `LF` and group `HF`. The average low-fat diet is defined\nby `((Intercept) + DietLF + DurationShort + DietLF:DurationShort +\n(Intercept) + DietLF)/2`. The average high-fat diet group is defined\nby `((Intercept) + DurationShort + (Intercept))/2`. The difference\nbetween the two results in the hypothesis below:\n\n\n::: {.cell}\n\n```{.r .cell-code}\nhypothesis3 <- \"ridgeDietLF + (ridgeDietLF:DurationShort)/2 = 0\"\n```\n:::\n\n\nWe next run again the same statistical analysis pipeline as above.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nL <- makeContrast(\n    hypothesis3,\n    parameterNames = c(\"ridgeDietLF\",\"ridgeDurationShort\",\"ridgeDietLF:DurationShort\")\n)\nmouse <- hypothesisTest(\n    mouse, i = \"proteins_msqrob\", L, modelColumn = \"msqrob_ion\"\n)\ninference <- rowData(mouse[[\"proteins_msqrob\"]])[[colnames(L)]]\ninference$Protein <- rownames(inference)\n```\n:::\n\n\nAnd we plot the results.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nggplot(inference) +\n    aes(x = logFC, y = -log10(pval), color = adjPval < 0.05) +\n    geom_text_repel(data = filter(inference, adjPval < 0.05),\n                    aes(label = Protein)) +\n    geom_point() +\n    ggtitle(\"Statistical inference on average difference between LF and HF\",\n            paste(\"Hypothesis test:\", gsub(\"ridgeCondition\", \"\", colnames(L)), \"= 0\"))\n```\n\n::: {.cell-output-display}\n![ ](07-mouse_diet_files/figure-html/mouse_diet_volcano_average-1.png){width=672}\n:::\n:::\n\n\nWe find much more significant proteins when combining all available\ndata to infer the differences between low-fat and high-fat diets,\nirrespective of duration. We also retrieve a good overlap between this\nset of significant proteins and the two previous sets, indicating\nthat more data helped improving the statistical power.\n\n#### Interaction: does the diet effect change according to duration?\n\nWe will now explore whether the effect of diet on protein abundance\nmay be affected by duration, i.e. we want to infer on the difference\nof differences. The difference between hypothesis 1 and 2 is `(DietLF\n+ DietLF:DurationShort) - (DietLF)` and results in the hypothesis\nbelow:\n\n\n::: {.cell}\n\n```{.r .cell-code}\nhypothesis4 <- \"ridgeDietLF:DurationShort = 0\"\n```\n:::\n\n\nWe can proceed with the same statistical pipeline.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nL <- makeContrast(\n    hypothesis4,\n    parameterNames = c(\"ridgeDietLF\",\"ridgeDurationShort\",\"ridgeDietLF:DurationShort\")\n)\nmouse <- hypothesisTest(\n    mouse, i = \"proteins_msqrob\", L, modelColumn = \"msqrob_ion\"\n)\ninference <- rowData(mouse[[\"proteins_msqrob\"]])[[colnames(L)]]\ninference$Protein <- rownames(inference)\n```\n:::\n\n\nAnd we plot the results.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nggplot(inference) +\n    aes(x = logFC, y = -log10(pval), color = adjPval < 0.05) +\n    geom_text_repel(data = filter(inference, adjPval < 0.05),\n                    aes(label = Protein)) +\n    geom_point() +\n    ggtitle(\"Statistical inference on the effect of duration on the differences between diets\",\n            paste(\"Hypothesis test:\", gsub(\"ridgeCondition\", \"\", colnames(L)), \"= 0\"))\n```\n\n::: {.cell-output-display}\n![ ](07-mouse_diet_files/figure-html/mouse_diet_volcano_interaction-1.png){width=672}\n:::\n:::\n\n\nThere are only 3 proteins for which the effect of\ndiet changes according to the duration. Let us visually explore this changes for the most significant\nprotein.\n\n\n::: {.cell}\n\n```{.r .cell-code}\n(targetProtein <- rownames(inference)[which.min(inference$adjPval)])\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] \"Q924P3\"\n```\n\n\n:::\n:::\n\n\nWe use again `Qfeatures`'s data manipulation pipeline.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nionData <- mouse[targetProtein, , \"ions_norm\"] |> #1\n    longForm(colvars = colnames(colData(mouse)), #2\n               rowvars = c(\"Protein.Accessions\", \"ionID\")) |>\n    data.frame() |>\n    filter(!is.na(value)) |> #3\n    mutate(colname = factor(colname, levels = unique(colname[order(Condition)]))) #4\n```\n:::\n\n\nAnd we explore the peptide ion data by visualising the differences\nbetween LF and HF separately for each mixture and diet duration in\norder to highlight changes in direction between these differences\naccording to duration. We link data points belonging to the same\npeptide ion using a grey line.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nggplot(ionData) +\n    aes(x = colname,\n        y = value) +\n    geom_line(aes(group = ionID), linewidth = 0.1) +\n    geom_point(aes(colour = Diet)) +\n    facet_grid(Mixture ~ Duration, scales = \"free\") +\n    labs(x = \"Sample\", y = \"log2 intensity\") +\n    ggtitle(targetProtein) +\n    theme_minimal() +\n    theme(axis.text.x = element_blank())\n```\n\n::: {.cell-output-display}\n![ ](07-mouse_diet_files/figure-html/mouse_diet_detail_interaction-1.png){width=672}\n:::\n:::\n\n\nThe graph hints towards a slight increase in protein abundance in the\nlow-fat diet group compared to the high-fat diet group during a short\ndiet duration, but this increase disappears after a long diet\nduration. However, the visual inspection of the results also shows\nthat the result rely on sparse and highly unbalanced data. The results\nmay hence require further experimental validation.\n\nNote that we performed the statistical analysis for each hypothesis\nseparately. However, `msqrob2` can assess multiple hypotheses at once.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nL <- makeContrast(\n    c(hypothesis1, hypothesis2, hypothesis3, hypothesis4),\n    parameterNames = c(\"ridgeDietLF\",\"ridgeDurationShort\",\"ridgeDietLF:DurationShort\")\n)\nmouse <- hypothesisTest(\n    mouse, i = \"proteins_msqrob\", L,\n    modelColumn = \"msqrob_ion\", overwrite = TRUE\n)\n```\n:::\n\n\nNote that since we already generated results for the contrast, we\noverwrite the results with the argument `overwrite = TRUE`.\n\nWe retrieve the inference tables from the `rowData` to generate the\nvolcano plot.\n\n\n::: {.cell}\n\n```{.r .cell-code}\ninferenceTables <- rowData(mouse[[\"proteins_msqrob\"]])[, colnames(L)]\n```\n:::\n\n\nWe here use a `lapply()` loop to generate the plots. The code chunk is\nelaborate, but follows the same structure as in the previous section.\nThis generates a list of volcano plots, one for each hypothesis.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nvolcanoPlots <- lapply(colnames(inferenceTables), function(i) {\n    inference <- inferenceTables[[i]]\n    inference$Protein <- rownames(inference)\n    ggplot(inference) +\n        aes(x = logFC, y = -log10(pval), color = adjPval < 0.05) +\n        geom_text_repel(data = filter(inference, adjPval < 0.05),\n                        aes(label = Protein)) +\n        geom_point() +\n        ggtitle(\"Hypothesis test:\",\n                paste(gsub(\"ridge\", \"\", i), \"= 0\"))\n})\n```\n:::\n\n\nWe combine all the plots in a single figure using the `patchwork`\npackages.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nwrap_plots(volcanoPlots)\n```\n\n::: {.cell-output-display}\n![ ](07-mouse_diet_files/figure-html/mouse_diet_volcano_all-1.png){width=768}\n:::\n:::\n\n\n### Protein-level model\n\nThis section illustrates data modelling starting from protein data \ninstead of ion data.\n\nHere, the workflow will use the summarised peptide ion intensities, as\nperformed during the preprocessing. Note, that we no longer have\nmultiple quantitative values for a protein in the same label of a run.\nHence, we can omit the nested effects for label and ionID in run.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nmodelSum <- ~ Diet * Duration + ## fixed effect for Diet and Duration with interaction\n        (1 | Label) + ## (1) random effect for label\n        (1 | Mixture) + ## (2) random effect for mixture\n        (1 | Run) + ## (3) random effect for MS run\n        (1 | BioReplicate)  ## (6) random effect for biorepeat (mouse)\n```\n:::\n\n\nFor protein-level modelling, we use `msqrob()` instead of\n`msqrobAggregate()`, but their function arguments closely overlap.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nmouse <- msqrob(\n    mouse, i = \"proteins\",\n    formula = modelSum,\n    modelColumnName = \"msqrob_rrilmm\",\n    ridge = TRUE, robust = TRUE\n)\n```\n:::\n\n\nWe perform hypothesis tests for the early, late, average and\ninteraction effects. Note that the contrasts remain unchanged.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nmouse <- hypothesisTest(\n    mouse, i = \"proteins\", L, modelColumn = \"msqrob_rrilmm\"\n)\n```\n:::\n\n\nThe inference tables were all stored in the `rowData` as separate\ncolumns, like previously.\n\n\n::: {.cell}\n\n```{.r .cell-code}\ninferenceTablesSum <- rowData(mouse[[\"proteins\"]])[, colnames(L)]\n```\n:::\n\n\nWe here use again the `lapply()` loop that generates the list of\nvolcano plots, one for each hypothesis.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nvolcanoPlotsSum <- lapply(names(inferenceTablesSum), function(i) {\n    inference <- inferenceTablesSum[[i]]\n    inference$Protein <- rownames(inference)\n    ggplot(inference) +\n        aes(x = logFC, y = -log10(pval), color = adjPval < 0.05) +\n        geom_text_repel(data = filter(inference, adjPval < 0.05),\n                        aes(label = Protein)) +\n        geom_point() +\n        ggtitle(\"Hypothesis test:\",\n                paste(gsub(\"tests_|ridge\", \"\", i), \"= 0\"))\n})\n```\n:::\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nwrap_plots(volcanoPlotsSum)\n```\n\n::: {.cell-output-display}\n![ ](07-mouse_diet_files/figure-html/mouse_diet_volcano_all_proteins-1.png){width=768}\n:::\n:::\n\n\n## Conclusion\n\nIn this chapter, we have demonstrated the application of msqrob2TMT\nworkflows on a real-life case study.\n\nThe preprocessing workflow relies on the the `QFeatures` package. The\npackage provides functionality to carry out many steps like data\nfiltering, missing values management, normalisation,\nlog-transformation, imputation, summarisation, etc. The functions also\nprovide different methods for each step, meaning that the\npreprocessing pipeline can be easily adapted to the researcher's\nneeds based on their experiment and data set.\n\nOnce preprocessed, we used the `msqrob2` package to model all sources\nof variability as identified from the experimental design (and in part\nvalidated by data exploration): effect of diet and duration, effect of\nthe MS acquisition run, effect of TMT mixture, effect of spectrum, and\neffect of sample. Modelling these different sources of variability\nallows to correctly infer changes in protein abundances between groups\nof interest while using ion-level data, although we also illustrate\nhow to model the data at the protein level.\n\nThe experiment aims to understand the proteomic changes in mouse\nadipose tissue that occur upon feeding the mice with low-fat or\nhigh-fat diets, during a short or a long duration. We showed how to\nmodel the effect of these two factors using main effects and an interaction, which allows that the effect of diet can change according to the duration, and vice versa. We also showed how to translate biological\nquestions into statistical hypothesis and corresponding contrast matrices using our\nmsqrob2TMT workflow. \n\nA unique\nfeature of `msqrob2` is that its flexible approach can include more\nthan 2 variables (with multiple interaction terms) as well as\nincluding numerical variables, which may be essential in other\nexperimental contexts.\n\nModelling TMT-based data with biological replication leads to one of\nthe most complex designs. These have to be further complexified with\nupcoming single-cell proteomics design where a new source of\nvariability arises as cells belonging to the same experimental unit\n(subject or cell culture) are more similar than cells belonging to\ndifferent experimental units. However, the model simplifies for other\nuse cases. For instance, we saw how a protein-level model upon\naggregation simplifies the model. However, spectrum effects can no\nlonger be accounted for. This means that an appropriate summarisation\napproach is needed to correctly account for these spectrum effects\nwhen computing the protein-level summaries. Median polish (exemplified here) or\nrobust summary do account for this, at least partially depending on\nthe experimental design. \n\nLabel-free experiments, which do not perform\nchemical labelling of the samples, do not contain labelling effects\nwhich therefore are omitted. Moreover, every sample is acquired as\npart of a single run hence no run effect can be modelled. This\nsimplified model is easier to understand but bear in mind that these sources of variation (eg. spectrum effects or run effect)  end up in the residual variance, which might reduce statistical power.\n\nHence, we here demonstrated the power and flexibility of `msqrob2` and\nthe msqrob2TMT workflows to help researchers answer\nbiologically-relevant questions from their MS proteomics data.\n",
    "supporting": [],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}